 Abs:SUB Abs(REAL A,T,D,C)
 !***** DON'T REMOVE THIS LINE *************************************
 !
 !  Type : Algorithm
 !  Name : ABS
 !  Vers : 1
 !  Desc : Calculate ABS(A)*T/D
 !  Date : 11/05/2003
 !  Time : 13:29:15
 !  User : wat
 !
 !***** DON'T REMOVE THIS LINE *************************************
 !
 !  Input Variables:
 !
 !     #  Name            Type Size     Description
 !    --- --------------- ---- -------- --------------------------------
 !    Measurement Parameters:
 !      1 A               R    -        ABS(A)
 !      2 T               R    -        ABS(A)*T
 !      3 D               R    -        ABS(A)/D
 !
 !  Output Variables:
 !
 !     #  Name            Type Size     Description
 !    --- --------------- ---- -------- --------------------------------
 !    Output Parameters:
 !      1 C               R    -        C=ABS(A)*T/D
 !
 !***** DON'T REMOVE THIS LINE *************************************
   OPTION BASE 1 !***** DON'T REMOVE THIS LINE *****
   C=ABS(A)*T/D
 SUBEND
 Betapnp:SUB Betapnp(REAL Vbe,Vce,INTEGER Unit,REAL T,D,INTEGER Pins(*),Adc,REAL Iv,INTEGER Integ,REAL Hold,Ibrng,Icrng,Ib,Ic,Betapnp)
 !***** DON'T REMOVE THIS LINE *************************************
 !
 !  Type : Algorithm
 !  Name : BETAPNP
 !  Vers : 1
 !  Desc : PNP Ic Ib Beta current measurement at specified bias poin
 !       : t.
 !  Date : 03/29/2005
 !  Time : 12:16:52
 !  User : wat
 !
 !***** DON'T REMOVE THIS LINE *************************************
 !
 !  Input Variables:
 !
 !     #  Name            Type Size     Description
 !    --- --------------- ---- -------- --------------------------------
 !    Measurement Parameters:
 !      1 VBE             R    -        Base TO Emitter BIAS
 !      2 VCE             R    -        Collector TO Emitter BIAS
 !      3 UNIT            I    -        0: MKS, 1:pA, 2:uA, 3:mA
 !      4 T               R    -        *T
 !      5 D               R    -        /D
 !
 !    Device Terminals:
 !      1 B               I    -        Base TERMINAL
 !      2 C               I    -        Collector TERMINAL
 !      3 E               I    -        Emitter TERMINAL
 !
 !    Device Parameters:
 !      1 ADC             I    -        ADC TYPE (0:HI-SPEED, 1:HI-RESOL
 !      2 IV              R    -        SAMPLING NUMBER WHEN MANUAL INTE
 !      3 INTEG           I    -        INTEGRATION TIME (0:MAN, 1:S, 2:
 !      4 HOLD            R    -        HOLD TIME BEFORE STARTS SWEEP ME
 !      5 IBRNG           R    -        Bias CURRENT MEASUREMENT RANGE (
 !      6 ICRNG           R    -        Collet CURRENT MEASUREMENT RANGE
 !
 !  Output Variables:
 !
 !     #  Name            Type Size     Description
 !    --- --------------- ---- -------- --------------------------------
 !    Output Parameters:
 !      1 IB              R    -        Base CURRENT
 !      2 IC              R    -        Collector CURRENT
 !      3 BETAPNP         R    -        Ic/Ib
 !
 !***** DON'T REMOVE THIS LINE *************************************
   OPTION BASE 1                  !***** DON'T REMOVE THIS LINE *****
   DISP "in BETAPNP"
       !
   INTEGER E,B,C,Statb,Statc
       !
   B=Pins(1)
   C=Pins(2)
   E=Pins(3)
       ! Connect device
   Connect(FNGnd,B,C,E)
   Connect(FNPort(0,1),B)
   Connect(FNPort(0,2),C)
       ! ADC mode
   Set_smu_ch(B,Adc,0)
   Set_adc(Adc,Integ,Iv)
   Set_smu_ch(C,Adc,0)
   Set_adc(Adc,Integ,Iv)
       ! Spot measurement
   Force_v(C,Vce,Vce,.1)
   Force_v(B,Vbe,Vbe,.1)
   Wait_th(Hold)
   Measure_i(B,Ib,Ibrng)
   Measure_i(C,Ic,Icrng)
   Betapnp=Ic/(Ib+1.E-31)
   Port_status(B,Statb)
   Port_status(C,Statc)
       !
   Ic=Ic*T/D
   Ib=Ib*T/D
   SELECT Unit
   CASE 0
     Ic=Ic                        !:unit: A
     Ib=Ib
   CASE 1
     Ic=Ic*1.E+12                 !:unit: pA
     Ib=Ib*1.E+12
   CASE 2
     Ic=Ic*1.E+6                  !:unit: uA
     Ib=Ib*1.E+6
   CASE 3
     Ic=Ic*1.E+3                  !:unit: mA
     Ib=Ib*1.E+3
   CASE ELSE
     Ic=Ic                        !:unit: A
     Ib=Ib
   END SELECT
   PRINT "Ic=";Ic,"Statc";Statc
   PRINT "Ib=";Ib,"Statb";Statb
       !Disable ports and pins
   Disable_port
   Connect
 SUBEND
 Betapnp_qct:SUB Betapnp_qct(REAL Vbe,Vce,INTEGER Unit,REAL Ie,Velimit,T,D,INTEGER Pins(*),Adc,REAL Iv,INTEGER Integ,REAL Hold,Ibrng,Icrng,Verng,Ib,Ic,Betapnp,Ve)
 !***** DON'T REMOVE THIS LINE *************************************
 !
 !  Type : Algorithm
 !  Name : BETAPNP_QCT
 !  Vers : 1
 !  Desc : PNP Ic Ib Beta current measurement at specified bias poin
 !       : t.
 !  Date : 09/01/2008
 !  Time : 13:05:33
 !  User : wat
 !
 !***** DON'T REMOVE THIS LINE *************************************
 !
 !  Input Variables:
 !
 !     #  Name            Type Size     Description
 !    --- --------------- ---- -------- --------------------------------
 !    Measurement Parameters:
 !      1 VBE             R    -        Base TO Emitter BIAS
 !      2 VCE             R    -        Collector TO Emitter BIAS
 !      3 UNIT            I    -        0: MKS, 1:pA, 2:uA, 3:mA
 !      4 IE              R    -        Current forced in Emitter
 !      5 VELIMIT         R    -        Voltage limit in measuring Emitt
 !      6 T               R    -        *T
 !      7 D               R    -        /D
 !
 !    Device Terminals:
 !      1 B               I    -        Base TERMINAL
 !      2 C               I    -        Collector TERMINAL
 !      3 E               I    -        Emitter TERMINAL
 !      4 Psub            I    -        Substrate TERMINAL
 !
 !    Device Parameters:
 !      1 ADC             I    -        ADC TYPE (0:HI-SPEED, 1:HI-RESOL
 !      2 IV              R    -        SAMPLING NUMBER WHEN MANUAL INTE
 !      3 INTEG           I    -        INTEGRATION TIME (0:MAN, 1:S, 2:
 !      4 HOLD            R    -        HOLD TIME BEFORE STARTS SWEEP ME
 !      5 IBRNG           R    -        Bias CURRENT MEASUREMENT RANGE (
 !      6 ICRNG           R    -        Collet CURRENT MEASUREMENT RANGE
 !      7 VERNG           R    -        Emitter voltage measurement rang
 !
 !  Output Variables:
 !
 !     #  Name            Type Size     Description
 !    --- --------------- ---- -------- --------------------------------
 !    Output Parameters:
 !      1 IB              R    -        Base CURRENT
 !      2 IC              R    -        Collector CURRENT
 !      3 BETAPNP         R    -        Ic/Ib
 !      4 VE              R    -        Emitter Voltage
 !
 !***** DON'T REMOVE THIS LINE *************************************
   OPTION BASE 1                      !***** DON'T REMOVE THIS LINE *****
   DISP "in BETAPNP"
                                      !
   INTEGER E,B,C,Statb,Statc,State,Psub
                                      !
   B=Pins(1)
   C=Pins(2)
   E=Pins(3)
   Psub=Pins(4)
                                      ! Connect device
   IF Psub>0 THEN 
     Connect(FNGnd,B,C,E,Psub)
   ELSE
     Connect(FNGnd,B,C,E)
   END IF
   Connect(FNPort(0,1),B)
   Connect(FNPort(0,2),C)
   Connect(FNPort(0,4),E)
                                      ! ADC mode
   Set_smu_ch(B,Adc,0)
   Set_adc(Adc,Integ,Iv)
   Set_smu_ch(C,Adc,0)
   Set_adc(Adc,Integ,Iv)
   Set_smu_ch(E,Adc,0)
   Set_adc(Adc,Integ,Iv)
                                      ! Spot measurement
   Force_v(C,Vce,Vce,.1)
   Force_v(B,Vbe,Vbe,.1)
   Force_i(E,Ie,Ie,Velimit)
   Wait_th(Hold)
   Measure_i(B,Ib,Ibrng)
   Measure_i(C,Ic,Icrng)
   Measure_v(E,Ve,Verng)
   Betapnp=Ic/(Ib+1.E-24)
   Port_status(B,Statb)
   Port_status(C,Statc)
   Port_status(E,State)
                                      !
   Ic=Ic*T/D
   Ib=Ib*T/D
   SELECT Unit
   CASE 0
     Ic=Ic                              !:unit: A
     Ib=Ib
   CASE 1
     Ic=Ic*1.E+12                       !:unit: pA
     Ib=Ib*1.E+12
   CASE 2
     Ic=Ic*1.E+6                        !:unit: uA
     Ib=Ib*1.E+6
   CASE 3
     Ic=Ic*1.E+3                        !:unit: mA
     Ib=Ib*1.E+3
   CASE ELSE
     Ic=Ic                              !:unit: A
     Ib=Ib
   END SELECT
   PRINT "Ic=";Ic,"Statc";Statc
   PRINT "Ib=";Ib,"Statb";Statb
   PRINT "State";State
                                      !Disable ports and pins
   Disable_port
   Connect
 SUBEND
 Betapnp_tb:SUB Betapnp_tb(REAL Vbe,Vce,INTEGER Unit,REAL Ie,Velimit,W,L,INTEGER Pins(*),Adc,REAL Iv,INTEGER Integ,REAL Hold,Ibrng,Icrng,Verng,Ib,Ic,Betapnp,Ve)
 !***** DON'T REMOVE THIS LINE *************************************
 !
 !  Type : Algorithm
 !  Name : BETAPNP_TB
 !  Vers : 1
 !  Desc : PNP Ic Ib Beta current measurement at specified bias poin
 !       : t. Base on BETAPNP_QCT
 !  Date : 05/15/2019
 !  Time : 17:33:09
 !  User : keysight
 !
 !***** DON'T REMOVE THIS LINE *************************************
 !
 !  Input Variables:
 !
 !     #  Name            Type Size     Description
 !    --- --------------- ---- -------- --------------------------------
 !    Measurement Parameters:
 !      1 VBE             R    -        Base TO Emitter BIAS
 !      2 VCE             R    -        Collector TO Emitter BIAS
 !      3 UNIT            I    -        0: A, 1:pA, 2:uA, 3:mA,4:LOG10
 !      4 IE              R    -        Current forced in Emitter
 !      5 VELIMIT         R    -        Voltage limit in measuring Emitt
 !      6 W               R    -        *W
 !      7 L               R    -        /L
 !
 !    Device Terminals:
 !      1 B               I    -        Base TERMINAL
 !      2 C               I    -        Collector TERMINAL
 !      3 E               I    -        Emitter TERMINAL
 !      4 Psub            I    -        Substrate TERMINAL
 !
 !    Device Parameters:
 !      1 ADC             I    -        ADC TYPE (0:HI-SPEED, 1:HI-RESOL
 !      2 IV              R    -        SAMPLING NUMBER WHEN MANUAL INTE
 !      3 INTEG           I    -        INTEGRATION TIME (0:MAN, 1:S, 2:
 !      4 HOLD            R    -        HOLD TIME BEFORE STARTS SWEEP ME
 !      5 IBRNG           R    -        Bias CURRENT MEASUREMENT RANGE (
 !      6 ICRNG           R    -        Collet CURRENT MEASUREMENT RANGE
 !      7 VERNG           R    -        Emitter voltage measurement rang
 !
 !  Output Variables:
 !
 !     #  Name            Type Size     Description
 !    --- --------------- ---- -------- --------------------------------
 !    Output Parameters:
 !      1 IB              R    -        Base CURRENT
 !      2 IC              R    -        Collector CURRENT
 !      3 BETAPNP         R    -        Ic/Ib
 !      4 VE              R    -        Emitter Voltage
 !
 !***** DON'T REMOVE THIS LINE *************************************
   OPTION BASE 1                  !***** DON'T REMOVE THIS LINE *****
   ON ERROR GOSUB System_error
   DISP "in BETAPNP_TB"
        !
   INTEGER E,B,C,Statb,Statc,State,Psub
        !
   B=Pins(1)
   C=Pins(2)
   E=Pins(3)
   Psub=Pins(4)
        ! Connect device
   IF Psub>0 THEN 
     Connect(FNGnd,B,C,E,Psub)
   ELSE
     Connect(FNGnd,B,C,E)
   END IF
   Connect(FNPort(0,1),B)
   Connect(FNPort(0,2),C)
   Connect(FNPort(0,4),E)
        ! ADC mode
   Set_smu_ch(B,Adc,0)
   Set_adc(Adc,Integ,Iv)
   Set_smu_ch(C,Adc,0)
   Set_adc(Adc,Integ,Iv)
   Set_smu_ch(E,Adc,0)
   Set_adc(Adc,Integ,Iv)
        ! Spot measurement
   Force_v(C,Vce,Vce,.1)
   Force_v(B,Vbe,Vbe,.1)
   Force_i(E,Ie,Ie,Velimit)
   Wait_th(Hold)
   Measure_i(B,Ib,Ibrng)
   Measure_i(C,Ic,Icrng)
   Measure_v(E,Ve,Verng)
   Betapnp=Ic/(Ib+1.E-28)
   Port_status(B,Statb)
   Port_status(C,Statc)
   Port_status(E,State)
        !
   Ic=Ic*W/L
   Ib=Ib*W/L
   SELECT Unit
   CASE 0
     Ic=Ic                        !:unit: A
     Ib=Ib
   CASE 1
     Ic=Ic*1.E+12                 !:unit: pA
     Ib=Ib*1.E+12
   CASE 2
     Ic=Ic*1.E+6                  !:unit: uA
     Ib=Ib*1.E+6
   CASE 3
     Ic=Ic*1.E+3                  !:unit: mA
     Ib=Ib*1.E+3
   CASE 4
     Ic=LGT(ABS(Ic)+1.E-30)       !:unit: LOG10
     Ib=LGT(ABS(Ib)+1.E-30)
   END SELECT
   PRINT "Ic=";Ic,"Statc";Statc
   PRINT "Ib=";Ib,"Statb";Statb
   PRINT "State";State
        !Disable ports and pins
  !-----------------------------------------------
   GOSUB Disconnect
   SUBEXIT
  !********Error handling Block*******
 System_error:                                  !system error handling
   Ic=ERRN*1.E+32
   Ib=ERRN*1.E+32
   PRINT ERRN;ERRM$
   GOSUB Disconnect
   SUBEXIT
  !*************** Hardware Clean Block************
 Disconnect:                      ! Disable used port, disconnect pins
   Disable_port
   Connect
   OFF ERROR 
  !
 SUBEND
 Betapnp_va:SUB Betapnp_va(REAL Ib,Vc,Ve,INTEGER Unit,REAL T,D,INTEGER Pins(*),Adc,REAL Iv,INTEGER Integ,REAL Hold,Icrng,Ic)
 !***** DON'T REMOVE THIS LINE *************************************
 !
 !  Type : Algorithm
 !  Name : BETAPNP_VA
 !  Vers : 1
 !  Desc : PNP Ic Ib Beta current measurement at specified bias poin
 !       : t.
 !  Date : 09/01/2008
 !  Time : 13:05:33
 !  User : wat
 !
 !***** DON'T REMOVE THIS LINE *************************************
 !
 !  Input Variables:
 !
 !     #  Name            Type Size     Description
 !    --- --------------- ---- -------- --------------------------------
 !    Measurement Parameters:
 !      1 IB              R    -        Current forced in Base
 !      2 VC              R    -        Collector TO Emitter BIAS
 !      3 VE              R    -        Emitter Bias
 !      4 UNIT            I    -        0: MKS, 1:pA, 2:uA, 3:mA
 !      5 T               R    -        *T
 !      6 D               R    -        /D
 !
 !    Device Terminals:
 !      1 B               I    -        Base TERMINAL
 !      2 C               I    -        Collector TERMINAL
 !      3 E               I    -        Emitter TERMINAL
 !      4 PSub            I    -        Substrate TERMINAL
 !
 !    Device Parameters:
 !      1 ADC             I    -        ADC TYPE (0:HI-SPEED, 1:HI-RESOL
 !      2 IV              R    -        SAMPLING NUMBER WHEN MANUAL INTE
 !      3 INTEG           I    -        INTEGRATION TIME (0:MAN, 1:S, 2:
 !      4 HOLD            R    -        HOLD TIME BEFORE STARTS SWEEP ME
 !      5 ICRNG           R    -        Collet CURRENT MEASUREMENT RANGE
 !
 !  Output Variables:
 !
 !     #  Name            Type Size     Description
 !    --- --------------- ---- -------- --------------------------------
 !    Output Parameters:
 !      1 IC              R    -        Collector CURRENT
 !
 !***** DON'T REMOVE THIS LINE *************************************
   OPTION BASE 1                      !***** DON'T REMOVE THIS LINE *****
   DISP "in BETAPNP"
                                      !
   INTEGER E,B,C,Statb,Statc,Psub
                                      !
   B=Pins(1)
   C=Pins(2)
   E=Pins(3)
   Psub=Pins(4)
                                      ! Connect device
   IF Psub>0 THEN 
     Connect(FNGnd,B,C,E,Psub)
   ELSE
     Connect(FNGnd,B,C,E)
   END IF
   Connect(FNPort(0,1),B)
   Connect(FNPort(0,2),C)
   Connect(FNPort(0,3),E)
                                      ! ADC mode
   Set_smu_ch(B,Adc,0)
   Set_adc(Adc,Integ,Iv)
   Set_smu_ch(C,Adc,0)
   Set_adc(Adc,Integ,Iv)
   Set_smu_ch(E,Adc,0)
   Set_adc(Adc,Integ,Iv)
                                      ! Spot measurement
   Force_v(C,Vc,Vc,.1)
   Force_i(B,Ib,Ib,20)
   Force_v(E,Ve,Ve,.1)
   Wait_th(Hold)
     !Measure_i(B,Ib,Ibrng)
   Measure_i(C,Ic,Icrng)
     !Betapnp=Ic/(Ib+1E-24)
     !Port_status(B,Statb)
   Port_status(C,Statc)
                                      !
   Ic=Ic*T/D
     !Ib=Ib*T/D
   SELECT Unit
   CASE 0
     Ic=Ic                              !:unit: A
      ! Ib=Ib
   CASE 1
     Ic=Ic*1.E+12                       !:unit: pA
      ! Ib=Ib*1.E+12
   CASE 2
     Ic=Ic*1.E+6                        !:unit: uA
      ! Ib=Ib*1.E+6
   CASE 3
     Ic=Ic*1.E+3                        !:unit: mA
      ! Ib=Ib*1.E+3
   CASE ELSE
     Ic=Ic                              !:unit: A
      ! Ib=Ib
   END SELECT
   PRINT "Ic=";Ic,"Statc";Statc
     !PRINT "Ib=";Ib,"Statb";Statb
                                      !Disable ports and pins
   Disable_port
   Connect
 SUBEND
 Bvcbo_std:SUB Bvcbo_std(REAL Veb,Ilimit,Vc_start,Vc_stop,INTEGER Vc_point,REAL Delay_s,INTEGER Pins(*),REAL Bvcbo)
 !***** DON'T REMOVE THIS LINE *************************************
 !
 !  Type : Algorithm
 !  Name : bvcbo_std
 !  Vers : 1
 !  Desc : Description for this Algorithm spec.
 !  Date : 11/24/2022
 !  Time : 18:37:49
 !  User : wat
 !
 !***** DON'T REMOVE THIS LINE *************************************
 !
 !  Input Variables:
 !
 !     #  Name            Type Size     Description
 !    --- --------------- ---- -------- --------------------------------
 !    Measurement Parameters:
 !      1 veb             R    -
 !      2 Ilimit          R    -
 !      3 vc_start        R    -
 !      4 vc_stop         R    -
 !      5 vc_point        I    -
 !      6 delay_s         R    -
 !
 !    Device Terminals:
 !      1 collector       I    -
 !      2 emitter         I    -
 !      3 base            I    -
 !      4 subst           I    -
 !
 !  Output Variables:
 !
 !     #  Name            Type Size     Description
 !    --- --------------- ---- -------- --------------------------------
 !    Output Parameters:
 !      1 bvcbo           R    -
 !
 !***** DON'T REMOVE THIS LINE *************************************
   OPTION BASE 1                     !***** DON'T REMOVE THIS LINE *****
   INTEGER Collector,Emitter,Base,Subst
   Collector=Pins(1)
   Emitter=Pins(2)
   Base=Pins(3)
   Subst=Pins(4)
   REAL Ie1
   INTEGER I
   REAL Vc(200)
   REAL Ib(200)
   Connect(FNPort(0,5),Emitter)                        ! change from 1 to 3
   Connect(FNPort(0,4),Collector)                       ! change from 2 to 4
   Connect(FNPort(0,2),Base,Subst)                     ! change from 9 to 2
   Force_v(FNPort(0,2),0,0,1.0E-3)                        ! add this line
                        ! SET ADC mode
                        !
   Set_smu_ch(FNPort(0,5),0)
   Set_adc(0,1)
                        !
   Force_v(FNPort(0,5),Veb,Veb,.01)
   Wait_th(.01)
   Measure_i(FNPort(0,5),Ie1)
   Set_iv(FNPort(0,4),1,Vc_stop,Vc_start,Vc_stop,Vc_point,0,Delay_s,Ilimit)
   Sweep_iv(FNPort(0,5),2,0,Ie(*),Vc(*))
   FOR I=1 TO Vc_point
     !IF (Ib(I)*Ib1<=0) THEN
     IF (Ie(I)*Ie1<=0) THEN 
       !Bvceo=Vc(I)
       Bvcbo=Vc(I)
       GOTO Disconnect
     ELSE
       Bvceo=1.0E+22
     END IF
   NEXT I
 Disconnect:                       !
   Disable_port
   Connect
 SUBEND
 Bvceo_spot:SUB Bvceo_spot(REAL Vbe,Ilimit,Vc_start,Vc_stop,INTEGER Vc_point,REAL Delay_s,INTEGER Vskip,REAL Itarget,INTEGER Pins(*),REAL Bvceo)
 !***** DON'T REMOVE THIS LINE *************************************
 !
 !  Type : Algorithm
 !  Name : bvceo_spot
 !  Vers : 1
 !  Desc : Description for this Algorithm spec.
 !  Date : 02/06/2023
 !  Time : 19:08:24
 !  User : wat
 !
 !***** DON'T REMOVE THIS LINE *************************************
 !
 !  Input Variables:
 !
 !     #  Name            Type Size     Description
 !    --- --------------- ---- -------- --------------------------------
 !    Measurement Parameters:
 !      1 vbe             R    -
 !      2 Ilimit          R    -
 !      3 vc_start        R    -
 !      4 vc_stop         R    -
 !      5 vc_point        I    -
 !      6 delay_s         R    -
 !      7 vskip           I    -
 !      8 itarget         R    -
 !
 !    Device Terminals:
 !      1 collector       I    -
 !      2 emitter         I    -
 !      3 base            I    -
 !      4 subst           I    -
 !
 !  Output Variables:
 !
 !     #  Name            Type Size     Description
 !    --- --------------- ---- -------- --------------------------------
 !    Output Parameters:
 !      1 bvceo           R    -
 !
 !***** DON'T REMOVE THIS LINE *************************************
   OPTION BASE 1                     !***** DON'T REMOVE THIS LINE *****
   INTEGER Collector,Emitter,Base,Subst
   Collector=Pins(1)
   Emitter=Pins(2)
   Base=Pins(3)
   Subst=Pins(4)
   REAL Ib1
   INTEGER I
   REAL Vc(200)
   REAL Ib(200)
   IF Base<>0 THEN CALL Connect(FNPort(0,5),Base)
   IF Collector<>0 THEN CALL Connect(FNPort(0,4),Collector)
   IF Subst<>0 THEN CALL Connect(FNPort(0,2),Emitter,Subst)
  !Force_v(FNPort(0,2),0,0,1.0E-3)                        ! add this line
                        ! SET ADC mode
                        !
   Set_smu_ch(FNPort(0,4),0)
   Set_adc(0,1)
                        !
  !Set_lsearch(Collector,Base,8,Vc_start,Vc_stop,Vc_point,Itarget,0,.01,Vskip,1)
   Set_lsearch(Collector,Base,8,Vc_start,Vc_stop,Vc_point,Itarget,0,.01)
   Search(Bvceo,Stat)
   PRINT "bvceo=";Bvceo,"Stat=";Stat
  !Force_v(FNPort(0,5),Vbe,Vbe,.01)
  !Wait_th(.01)
  !Measure_i(FNPort(0,5),Ib1)
  !Set_iv(FNPort(0,4),1,Vc_stop,Vc_start,Vc_stop,Vc_point,0,Delay_s,Ilimit)
  !Sweep_iv(FNPort(0,5),2,0,Ib(*),Vc(*))
  !FOR I=1 TO Vc_point
    !IF (Ib(I)*Ib1<=0) THEN
      !Bvceo=Vc(I)
      !GOTO Disconnect
    !ELSE
      !Bvceo=1.0E+22
    !END IF
  !NEXT I
 Disconnect:                       !
   Disable_port
   Connect
 SUBEND
 Bvceo_std:SUB Bvceo_std(REAL Vbe,Ilimit,Vc_start,Vc_stop,INTEGER Vc_point,REAL Delay_s,INTEGER Pins(*),REAL Bvceo)
 !***** DON'T REMOVE THIS LINE *************************************
 !
 !  Type : Algorithm
 !  Name : bvceo_std
 !  Vers : 1
 !  Desc : Description for this Algorithm spec.
 !  Date : 02/16/2005
 !  Time : 16:14:44
 !  User : specs
 !
 !***** DON'T REMOVE THIS LINE *************************************
 !
 !  Input Variables:
 !
 !     #  Name            Type Size     Description
 !    --- --------------- ---- -------- --------------------------------
 !    Measurement Parameters:
 !      1 vbe             R    -
 !      2 Ilimit          R    -
 !      3 vc_start        R    -
 !      4 vc_stop         R    -
 !      5 vc_point        I    -
 !      6 delay_s         R    -
 !
 !    Device Terminals:
 !      1 collector       I    -
 !      2 emitter         I    -
 !      3 base            I    -
 !      4 subst           I    -
 !
 !  Output Variables:
 !
 !     #  Name            Type Size     Description
 !    --- --------------- ---- -------- --------------------------------
 !    Output Parameters:
 !      1 bvceo           R    -
 !
 !***** DON'T REMOVE THIS LINE *************************************
   OPTION BASE 1                     !***** DON'T REMOVE THIS LINE *****
   INTEGER Collector,Emitter,Base,Subst
   Collector=Pins(1)
   Emitter=Pins(2)
   Base=Pins(3)
   Subst=Pins(4)
   REAL Ib1
   INTEGER I
   REAL Vc(200)
   REAL Ib(200)
   Connect(FNPort(0,5),Base)                        ! change from 1 to 3
   Connect(FNPort(0,4),Collector)                       ! change from 2 to 4
   Connect(FNPort(0,2),Emitter,Subst)                     ! change from 9 to 2
   Force_v(FNPort(0,2),0,0,1.0E-3)                        ! add this line
                        ! SET ADC mode
                        !
   Set_smu_ch(FNPort(0,5),0)
   Set_adc(0,1)
                        !
   Force_v(FNPort(0,5),Vbe,Vbe,.01)
   Wait_th(.01)
   Measure_i(FNPort(0,5),Ib1)
   Set_iv(FNPort(0,4),1,Vc_stop,Vc_start,Vc_stop,Vc_point,0,Delay_s,Ilimit)
   Sweep_iv(FNPort(0,5),2,0,Ib(*),Vc(*))
   FOR I=1 TO Vc_point
     IF (Ib(I)*Ib1<=0) THEN 
       Bvceo=Vc(I)
       GOTO Disconnect
     ELSE
       Bvceo=1.0E+22
     END IF
   NEXT I
 Disconnect:                       !
   Disable_port
   Connect
 SUBEND
 Bvd:SUB Bvd(REAL Vg,Vdmin,Vdmax,Vdstep,Idtarg,Icomp,INTEGER Pins(*),Adc,REAL Iv,INTEGER Integ,Vdskip,Rsearch,D_path$,D_file$,REAL Bv)
 !***** DON'T REMOVE THIS LINE *************************************
 !
 !  Type : Algorithm
 !  Name : Bvd
 !  Vers : 1
 !  Desc : Drain to source punchthrough voltage with gate and well g
 !       : rounded
 !  Date : 03/26/2019
 !  Time : 11:44:07
 !  User : keysight
 !
 !***** DON'T REMOVE THIS LINE *************************************
 !
 !  Input Variables:
 !
 !     #  Name            Type Size     Description
 !    --- --------------- ---- -------- --------------------------------
 !    Measurement Parameters:
 !      1 VG              R    -        BIAS VOLTAGE ON GATE
 !      2 VDMIN           R    -        START DRAIN VOLTAGE
 !      3 VDMAX           R    -        STOP DRAIN VOLTAGE
 !      4 VDSTEP          R    -        STEP DRAIN VOLTAGE
 !      5 IDTARG          R    -        TARGET DRAIN CURRENT
 !      6 Icomp           R    -        Compliance of Vg
 !
 !    Device Terminals:
 !      1 DRAIN           I    -        DRAIN TERMINAL
 !      2 GATE            I    -        GATE TERMINAL
 !      3 SOURCE          I    -        SOURCE TERMINAL
 !      4 BULK            I    -        WELL OR BULK
 !
 !    Device Parameters:
 !      1 ADC             I    -        ADC TYPE (0:HI-SPEED, 1:HI-RESOL
 !      2 IV              R    -        SAMPLING NUMBER WHEN MANUAL INTE
 !      3 INTEG           I    -        INTEGRATION TIME (0:MAN, 1:S, 2:
 !      4 VDSKIP          I    -        FOR CALCULATING THE LARGE STEP
 !      5 RSEARCH         I    -        0: OFF, 1:ON
 !      6 D_path          S    -        SAVE FILE PATH
 !      7 D_file          S    -        SAVE FILE NAME
 !
 !  Output Variables:
 !
 !     #  Name            Type Size     Description
 !    --- --------------- ---- -------- --------------------------------
 !    Output Parameters:
 !      1 BV              R    -        DRAIN TO SOURCE PUNCHTHROUGH VOL
 !
 !***** DON'T REMOVE THIS LINE *************************************
   OPTION BASE 1                  !***** DON'T REMOVE THIS LINE *****
   DISP "in Bvd"
  !
   INTEGER Gate,Drain,Source,Bulk,Stat
   REAL Vd(1500),Id(1500)
    !
   Drain=Pins(1)
   Gate=Pins(2)
   Source=Pins(3)
   Bulk=Pins(4)
    ! Connect device terminals
   Connect(FNGnd,Gate,Drain,Source,Bulk)
   Connect(FNPort(0,1),Drain)
   Connect(FNPort(0,2),Gate)
   Connect(FNPort(0,4),Bulk)
    ! ADC mode
   Set_smu_ch(Drain,Adc,0)
   Set_adc(Adc,Integ,Iv)
  !Set_wait_time(Ss,Sm)
    ! Search measurement
   IF Gate>0 THEN CALL Force_v(Gate,Vg,Vg,1.E-3)
   Set_lsearch(Drain,Drain,8,Vdmin,Vdmax,Vdstep,Idtarg,0,Icomp,0,Vdskip,1)
   IF Rsearch=0 THEN 
     Search(Bv,Stat)
    !
     PRINT "Bv=";Bv,"Stat=";Stat
     IF Stat<>0 THEN Bv=Vdmax
     GOTO End
   END IF
            !
   IF Rsearch<>0 THEN 
     Step=1
     LOOP
       Rsearch(Vd(Step),Stat,Id(Step))
     EXIT IF Stat<>0
       Step=Step+1
     END LOOP
     Rsearch_stop
     Bv=Vd(Step)
     PRINT "Bv=";Vd(Step),"Stat=";Stat
     !
 Save_file: !
     ON ERROR GOTO Nofile
     ASSIGN @File TO D_path$&"/"&D_file$&".csv";APPEND
     OFF ERROR 
            !
     OUTPUT @File USING "K,K";"Vg=";Vg;",";"Idtarget=";Idtarg
     OUTPUT @File USING "K,K";"Vdmin=";Vdmin;",";"Vdmax=";Vdmax;",";"Vdstep=";Vdstep
     OUTPUT @File USING "K,K";"Step Number";",";"Vdrain";",";"Idrain"
            !
     INTEGER I
     FOR I=1 TO Step
       OUTPUT @File USING "K,K";I;",";Vd(I);",";Id(I)
     NEXT I
            !
     ASSIGN @File TO *
     GOTO End
       !
 Nofile:     !
     CREATE D_path$&"/"&D_file$&".csv",2
     GOTO Save_file
   END IF
 End:   !
   Disable_port
   Connect
 SUBEND
 Bvd_tb:SUB Bvd_tb(REAL Mode,Type,Vg,Vfstart,Vfmin,Vfmax,Vfstep,Hold,Itarget,Sp,W,INTEGER Pins(*),Adc,REAL Iv,INTEGER Integ,Vfskip,REAL Icomp,Bv)
 !***** DON'T REMOVE THIS LINE *************************************
 !
 !  Type : Algorithm
 !  Name : Bvd_TB
 !  Vers : 1
 !  Desc : Drain to source punchthrough voltage with gate and well g
 !       : rounded
 !       : 2002/3/18
 !       : 2014 TB alg base on Bvd
 !  Date : 11/07/2014
 !  Time : 15:45:24
 !  User : wat
 !
 !***** DON'T REMOVE THIS LINE *************************************
 !
 !  Input Variables:
 !
 !     #  Name            Type Size     Description
 !    --- --------------- ---- -------- --------------------------------
 !    Measurement Parameters:
 !      1 MODE            R    -        0: for drain ; 1 for gate
 !      2 Type            R    -        1:Nmos;  -1:Pmos
 !      3 VG              R    -        BIAS VOLTAGE ON GATE WHEN MEASUR
 !      4 Vfstart         R    -        -1: Nmos Vfstart from "-" and Pm
 !      5 VFMIN           R    -        START DRAIN  OR GATE VOLTAGE
 !      6 VFMAX           R    -        STOP DRAIN OR GATE VOLTAGE
 !      7 VFSTEP          R    -        STEP DRAIN OR GATE VOLTAGE
 !      8 HOLD            R    -        WAIT TIME BEFORE MEASURE
 !      9 ITARGET         R    -        TARGET CURRENT
 !     10 SP              R    -        SP=0 then Itarget=Type*ABS(Itarg
 !     11 W               R    -        TARGET*W
 !
 !    Device Terminals:
 !      1 DRAIN           I    -        DRAIN TERMINAL
 !      2 GATE            I    -        GATE TERMINAL
 !      3 SOURCE          I    -        SOURCE TERMINAL
 !      4 BULK            I    -        WELL OR BULK
 !
 !    Device Parameters:
 !      1 ADC             I    -        ADC TYPE (0:HI-SPEED, 1:HI-RESOL
 !      2 IV              R    -        SAMPLING NUMBER WHEN MANUAL INTE
 !      3 INTEG           I    -        INTEGRATION TIME (0:MAN, 1:S, 2:
 !      4 VFSKIP          I    -        FOR CALCULATING THE LARGE STEP
 !      5 ICOMP           R    -        Compliance of Ig or Id
 !
 !  Output Variables:
 !
 !     #  Name            Type Size     Description
 !    --- --------------- ---- -------- --------------------------------
 !    Output Parameters:
 !      1 BV              R    -        DRAIN TO SOURCE PUNCHTHROUGH VOL
 !
 !***** DON'T REMOVE THIS LINE *************************************
   OPTION BASE 1                   !***** DON'T REMOVE THIS LINE *****
   DISP "in Bvd"
   !
   INTEGER Gate,Drain,Source,Bulk,Stat
     !
   Drain=Pins(1)
   Gate=Pins(2)
   Source=Pins(3)
   Bulk=Pins(4)
     ! Connect device terminals
   Connect(FNGnd,Gate,Drain,Source,Bulk)
   Connect(FNPort(0,1),Drain)
   Connect(FNPort(0,2),Gate)
   Connect(FNPort(0,5),Bulk)
     ! ADC mode
   Itarget=Type*ABS(Itarget)*W
   IF Sp=1 THEN 
     Itarget=Itarget
   END IF
   Vfmin=Type*ABS(Vfmin)*Vfstart
   Vfmax=Type*ABS(Vfmax)
   Vfstep=ABS(Vfstep)
   IF Mode=0 THEN                      ! Drain to source punch through
     Set_smu_ch(Drain,Adc,0)
     Set_adc(Adc,Integ,Iv)
   !Set_wait_time(Ss,Sm)
     ! Search measurement
     IF Gate>0 THEN CALL Force_v(Gate,Vg,Vg,1.E-3)
     Set_lsearch(Drain,Drain,8,Vfmin,Vfmax,Vfstep,Itarget,0,Icomp,0,Vfskip,1)
   END IF
   IF Mode=1 THEN                 ! Gate to sub punch  through
     Set_smu_ch(Gate,Adc,0)
     Set_adc(Adc,Integ,Iv)
     Set_lsearch(Gate,Gate,8,Vfmin,Vfmax,Vfstep,Itarget,0,Icomp,0,Vfskip,1)
   END IF
   Wait_th(Hold)
   Search(Bv,Stat)
     !
   PRINT "Bv=",Bv;"Stat=",Stat
   IF Stat<>0 THEN Bv=Vfmax
     !
     ! Disable ports and pins
   Disable_port
   Connect
 SUBEND
 Bvdb:SUB Bvdb(REAL Vg,Vdmin,Vdmax,Vdstep,Vb,Idtarg,Icomp,INTEGER Pins(*),Adc,REAL Iv,INTEGER Integ,Vdskip,REAL Bv)
 !***** DON'T REMOVE THIS LINE *************************************
 !
 !  Type : Algorithm
 !  Name : Bvdb
 !  Vers : 1
 !  Desc : include s1 and s2. wat_standard QD Drain to source puncht
 !       : hrough voltage with gate and well grounded
 !       : 2002/3/18
 !  Date : 01/15/2010
 !  Time : 15:34:33
 !  User : wat
 !
 !***** DON'T REMOVE THIS LINE *************************************
 !
 !  Input Variables:
 !
 !     #  Name            Type Size     Description
 !    --- --------------- ---- -------- --------------------------------
 !    Measurement Parameters:
 !      1 VG              R    -        BIAS VOLTAGE ON GATE
 !      2 VDMIN           R    -        START DRAIN VOLTAGE
 !      3 VDMAX           R    -        STOP DRAIN VOLTAGE
 !      4 VDSTEP          R    -        STEP DRAIN VOLTAGE
 !      5 VB              R    -        BIAS VOLTAGE ON BULK
 !      6 IDTARG          R    -        TARGET DRAIN CURRENT
 !      7 Icomp           R    -        Compliance of Vg
 !
 !    Device Terminals:
 !      1 DRAIN           I    -        DRAIN TERMINAL
 !      2 GATE            I    -        GATE TERMINAL
 !      3 SOURCE          I    -        SOURCE TERMINAL
 !      4 BULK            I    -        WELL OR BULK
 !      5 SOURCE1         I    -        SOURCE TERMINAL1
 !
 !    Device Parameters:
 !      1 ADC             I    -        ADC TYPE (0:HI-SPEED, 1:HI-RESOL
 !      2 IV              R    -        SAMPLING NUMBER WHEN MANUAL INTE
 !      3 INTEG           I    -        INTEGRATION TIME (0:MAN, 1:S, 2:
 !      4 VDSKIP          I    -        FOR CALCULATING THE LARGE STEP
 !
 !  Output Variables:
 !
 !     #  Name            Type Size     Description
 !    --- --------------- ---- -------- --------------------------------
 !    Output Parameters:
 !      1 BV              R    -        DRAIN TO SOURCE PUNCHTHROUGH VOL
 !
 !***** DON'T REMOVE THIS LINE *************************************
   OPTION BASE 1                       !***** DON'T REMOVE THIS LINE *****
   DISP "in Bvdb"
      !
   INTEGER Gate,Drain,Source,Bulk,Source1,Stat
                                      !
   Drain=Pins(1)
   Gate=Pins(2)
   Source=Pins(3)
   Bulk=Pins(4)
   Source1=Pins(5)
                                      ! Connect device terminals
   IF Source>0 AND Source1>0 THEN 
     Connect(FNGnd,Gate,Drain,Source,Source1,Bulk)
   END IF
   IF Source>0 AND Source1=0 THEN 
     Connect(FNGnd,Gate,Drain,Source,Bulk)
   ELSE
     Connect(FNGnd,Gate,Drain,Bulk)
   END IF
   Connect(FNPort(0,1),Drain)
   Connect(FNPort(0,2),Gate)
   Connect(FNPort(0,4),Bulk)
                                      ! ADC mode
   Set_smu_ch(Drain,Adc,0)
   Set_adc(Adc,Integ,Iv)
      !Set_wait_time(Ss,Sm)
                                      ! Search measurement
   IF Gate>0 THEN CALL Force_v(Gate,Vg,Vg,1.E-3)
   IF Bulk>0 THEN CALL Force_v(Bulk,Vb,Vb,1.E-3)
   Set_lsearch(Drain,Drain,8,Vdmin,Vdmax,Vdstep,Idtarg,0,Icomp,0,Vdskip,1)
   Search(Bv,Stat)
                                      !
   PRINT "Bv=",Bv;"Stat",Stat
   IF Stat<>0 THEN Bv=Vdmax
                                      !
                                      ! Disable ports and pins
   Disable_port
   Connect
 SUBEND
 Bvds:SUB Bvds(INTEGER P,REAL W,L,Idcri,Vdstart,Vbs,INTEGER Flag,Mode,Pins(*),REAL Bvds)
 !***** DON'T REMOVE THIS LINE *************************************
 !
 !  Type : Algorithm
 !  Name : BVDS
 !  Vers : 1
 !  Desc : Measure the source to drain punch-through/ breakdown volt
 !       : age
 !  Date : 09/26/2006
 !  Time : 09:23:41
 !  User : wat
 !
 !***** DON'T REMOVE THIS LINE *************************************
 !
 !  Input Variables:
 !
 !     #  Name            Type Size     Description
 !    --- --------------- ---- -------- --------------------------------
 !    Measurement Parameters:
 !      1 P               I    -        1:NMOS, -1:PMOS
 !      2 W               R    -        Channel Width
 !      3 L               R    -        Channel Length
 !      4 IDCRI           R    -        Test current density
 !      5 VDSTART         R    -        Drain start voltage
 !      6 VBS             R    -        Body voltage
 !      7 FLAG            I    -        Normalize flag, 1: IDCRI is curr
 !      8 MODE            I    -        Measurement Mode, 0: Force curre
 !
 !    Device Terminals:
 !      1 D               I    -        Drain terminal
 !      2 G               I    -        Gate Terminal
 !      3 S               I    -        Source terminal
 !      4 B               I    -        Bulk terminal
 !
 !  Output Variables:
 !
 !     #  Name            Type Size     Description
 !    --- --------------- ---- -------- --------------------------------
 !    Output Parameters:
 !      1 BVDS            R    -        Source/Drain Punch-Through Break
 !
 !***** DON'T REMOVE THIS LINE *************************************
   OPTION BASE 1 !***** DON'T REMOVE THIS LINE *****
   ON ERROR GOSUB System_error
   !T=TIMEDATE
   !PRINT "TIME=",T
   DISP "Bvds"
   INTEGER Drain,Gate,Source,Bulk
   !
   !Set_smu_ch(FNPort(0,1),0,0)
   !Set_smu(1)
   !Set_adc(0,1)
   !
   Drain=Pins(1)
   Gate=Pins(2)
   Source=Pins(3)
   Bulk=Pins(4)
   !
   IF Idcri<0 THEN GOSUB Par_error
   IF W<=0 OR L<=0 THEN GOSUB Par_error
   IF P<>-1 AND P<>1 THEN GOSUB Par_error
   !
   !----------------- connection ---------------------------------
   IF Drain<=0 OR Source<=0 OR Gate<=0 OR Bulk<=0 THEN GOSUB Par_error
   Connect(FNPort(0,9),Drain,Gate,Source,Bulk)
   Connect(FNPort(0,1),Drain)
   Connect(FNPort(0,2),Bulk)
   !
   !
   IF Flag=1 THEN                         ! normalize
     IF Idcri=0 THEN 
       Idcri=1.E-7*W
     ELSE
       Idcri=Idcri*W
     END IF
   ELSE
     IF Idcri=0 THEN 
       Idcri=1.E-7
     ELSE
       Idcri=Idcri
     END IF
   END IF
   !
   IF Idcri>1.E-5 THEN GOSUB Par_error
   IF Idcri=1.E-5 THEN GOSUB Par_error
   !Idcri=Idcri*P
   Vstep=.05
   !
   Set_smu_ch(Drain,1,0)
   Set_adc(1,2)
   !
   IF Mode=0 THEN 
     Idcri=Idcri*P
     Force_i(Drain,Idcri,Idcri,50)
     Force_v(Bulk,Vbs,Vbs,1.E-2)
     Wait_th(.01)
     Measure_v(Drain,Bvds,0)
   END IF
   !
   IF Mode=1 THEN 
     I=1
     REPEAT
       Vsta=Vdstart*P+(I-1)*Vstep*P
       Idcri=Idcri
   !
       Force_v(Drain,Vsta,Vsta,1.0E-6)
       Force_v(Bulk,Vbs,Vbs,1.E-2)
       Wait_th(.01)
       Measure_i(Drain,Imeas,1.E-7)
       I=I+1
       PRINT "Vmeas=";Vsta,"Imeas=";Imeas
     UNTIL (ABS(Vsta)=12 OR ABS(Imeas)=Idcri OR ABS(Imeas)>Idcri)
     Bvds=Vsta
   END IF
   PRINT "Bvds=";Bvds
   !
   GOSUB Disconnect
   SUBEXIT
   !***Error Handling Block******************************************
 System_error:    ! System Error Handing
   Bvds=ERRN*1.E+32
   PRINT ERRN;ERRM$
   GOSUB Disconnect
   SUBEXIT
 Par_error:    ! User defined Error Hanging
   Bvds=2.E+30
   GOSUB Disconnect
   SUBEXIT
 Meas_error:    ! Set output flag values for smu error
   Bvds=3.E+30
   GOSUB Disconnect
   SUBEXIT
   !***Hardware Clean Block******************************************
 Disconnect:    ! Disables used ports, disconnects pins.
   Disable_port
   Connect
   OFF ERROR 
   !
   !T=TIMEDATE-T
   !PRINT "TIME=",T
 SUBEND
 Bvds_v_3t:SUB Bvds_v_3t(INTEGER P,REAL Vdmin,Vdmax,Vdstep,Idcri,Icomp,INTEGER Pins(*),Adc,REAL Iv,INTEGER Integ,Vdskip,REAL Bv)
 !***** DON'T REMOVE THIS LINE *************************************
 !
 !  Type : Algorithm
 !  Name : BVDS_V_3T
 !  Vers : 1
 !  Desc : Drain to source punchthrough voltage with gate and well g
 !       : rounded
 !       : 2002/3/18
 !  Date : 11/10/2004
 !  Time : 08:35:18
 !  User : wat
 !
 !***** DON'T REMOVE THIS LINE *************************************
 !
 !  Input Variables:
 !
 !     #  Name            Type Size     Description
 !    --- --------------- ---- -------- --------------------------------
 !    Measurement Parameters:
 !      1 P               I    -        1:NMOS, -1:PMOS
 !      2 VDMIN           R    -        START DRAIN VOLTAGE
 !      3 VDMAX           R    -        STOP DRAIN VOLTAGE
 !      4 VDSTEP          R    -        STEP DRAIN VOLTAGE
 !      5 IDCRI           R    -        TARGET DRAIN CURRENT
 !      6 ICOMP           R    -        Compliance of Vd
 !
 !    Device Terminals:
 !      1 D               I    -        DRAIN TERMINAL
 !      2 G               I    -        GATE TERMINAL
 !      3 B               I    -        WELL OR BULK
 !
 !    Device Parameters:
 !      1 ADC             I    -        ADC TYPE (0:HI-SPEED, 1:HI-RESOL
 !      2 IV              R    -        SAMPLING NUMBER WHEN MANUAL INTE
 !      3 INTEG           I    -        INTEGRATION TIME (0:MAN, 1:S, 2:
 !      4 VDSKIP          I    -        FOR CALCULATING THE LARGE STEP
 !
 !  Output Variables:
 !
 !     #  Name            Type Size     Description
 !    --- --------------- ---- -------- --------------------------------
 !    Output Parameters:
 !      1 BV              R    -        DRAIN TO SOURCE PUNCHTHROUGH VOL
 !
 !***** DON'T REMOVE THIS LINE *************************************
   OPTION BASE 1                        !***** DON'T REMOVE THIS LINE *****
   DISP "in Bvds_v_3t"
       !
   INTEGER Gate,Drain,Bulk,Stat
                                       !
   Drain=Pins(1)
   Gate=Pins(2)
   Bulk=Pins(3)
                                       ! Connect device terminals
   Connect(FNPort(0,9),Gate,Drain,Bulk)
   Connect(FNPort(0,1),Drain)
       !Connect(FNPort(0,2),Gate)
       !Connect(FNPort(0,4),Bulk)
                                       ! ADC mode
   Set_smu_ch(Drain,Adc,0)
   Set_adc(Adc,Integ,Iv)
       !Set_wait_time(Ss,Sm)
   Vmax=Vdmax*P
   Idtarg=Idcri*P
                                       ! Search measurement
   Set_lsearch(Drain,Drain,8,Vdmin,Vmax,Vdstep,Idtarg,0,Icomp,0,Vdskip,1)
   Search(Bv,Stat)
                                       !
   PRINT "Bv=",Bv;"Stat",Stat
   IF Stat<>0 THEN Bv=Vdmax
                                       !
                                       ! Disable ports and pins
   Disable_port
   Connect
 SUBEND
 Bvebo_std:SUB Bvebo_std(REAL Vcb,Ilimit,Ve_start,Ve_stop,INTEGER Ve_point,REAL Delay_s,INTEGER Pins(*),REAL Bvebo)
 !***** DON'T REMOVE THIS LINE *************************************
 !
 !  Type : Algorithm
 !  Name : bvebo_std
 !  Vers : 1
 !  Desc : Description for this Algorithm spec.
 !  Date : 11/24/2022
 !  Time : 18:56:13
 !  User : wat
 !
 !***** DON'T REMOVE THIS LINE *************************************
 !
 !  Input Variables:
 !
 !     #  Name            Type Size     Description
 !    --- --------------- ---- -------- --------------------------------
 !    Measurement Parameters:
 !      1 vcb             R    -
 !      2 Ilimit          R    -
 !      3 ve_start        R    -
 !      4 ve_stop         R    -
 !      5 ve_point        I    -
 !      6 delay_s         R    -
 !
 !    Device Terminals:
 !      1 collector       I    -
 !      2 emitter         I    -
 !      3 base            I    -
 !      4 subst           I    -
 !
 !  Output Variables:
 !
 !     #  Name            Type Size     Description
 !    --- --------------- ---- -------- --------------------------------
 !    Output Parameters:
 !      1 bvebo           R    -
 !
 !***** DON'T REMOVE THIS LINE *************************************
   OPTION BASE 1                     !***** DON'T REMOVE THIS LINE *****
   INTEGER Collector,Emitter,Base,Subst
   Collector=Pins(1)
   Emitter=Pins(2)
   Base=Pins(3)
   Subst=Pins(4)
   REAL Ic1
   INTEGER I
   REAL Ve(200)
   REAL Ic(200)
   Connect(FNPort(0,5),Collector)                   ! change from 1 to 3
   Connect(FNPort(0,4),Emitter)                ! change from 2 to 4
   Connect(FNPort(0,2),Base,Subst)                     ! change from 9 to 2
   Force_v(FNPort(0,2),0,0,1.0E-3)                        ! add this line
                        ! SET ADC mode
                        !
   Set_smu_ch(FNPort(0,5),0)
   Set_adc(0,1)
                        !
   Force_v(FNPort(0,5),Vcb,Vcb,.01)
   Wait_th(.01)
   Measure_i(FNPort(0,5),Ic1)
   Set_iv(FNPort(0,4),1,Ve_stop,Ve_start,Ve_stop,Ve_point,0,Delay_s,Ilimit)
   Sweep_iv(FNPort(0,5),2,0,Ic(*),Ve(*))
   FOR I=1 TO Ve_point
     IF (Ic(I)*Ic1<=0) THEN 
       Bvebo=Vc(I)
       GOTO Disconnect
     ELSE
       Bvebo=1.0E+22
     END IF
   NEXT I
 Disconnect:                       !
   Disable_port
   Connect
 SUBEND
 Bvox:SUB Bvox(REAL Vgmin,Vgmax,Vgstep,Igtarg,INTEGER Pins(*),Adc,REAL Iv,INTEGER Integ,Vgskip,Mode,REAL Wait,Bv)
 !***** DON'T REMOVE THIS LINE *************************************
 !
 !  Type : Algorithm
 !  Name : Bvox
 !  Vers : 1
 !  Desc : Oxide breakdown voltage measurement, use search to seach
 !       : value
 !  Date : 06/20/2003
 !  Time : 10:13:04
 !  User : wat
 !
 !***** DON'T REMOVE THIS LINE *************************************
 !
 !  Input Variables:
 !
 !     #  Name            Type Size     Description
 !    --- --------------- ---- -------- --------------------------------
 !    Measurement Parameters:
 !      1 VGMIN           R    -        VG START VOLTAGE
 !      2 VGMAX           R    -        VG STOP VOLTAGE
 !      3 VGSTEP          R    -        VG STEP VOLTAGE
 !      4 IGTARG          R    -        IG TARGET CURRENT
 !
 !    Device Terminals:
 !      1 DRAIN           I    -
 !      2 GATE            I    -        GATE TERMINAL
 !      3 SOURCE          I    -
 !      4 BULK            I    -        WELL OR BULK
 !
 !    Device Parameters:
 !      1 ADC             I    -        ADC TYPE (0:HI-SPEED, 1:HI-RESOL
 !      2 IV              R    -        SAMPLING NUMBER WHEN MANUAL INTE
 !      3 INTEG           I    -        INTEGRATION TIME (0:MAN. 1:S, 2:
 !      4 VGSKIP          I    -        FOR CALCULATING THE LARGE STEP
 !      5 MODE            I    -        SEARCH MODE
 !      6 WAIT            R    -        WAIT TIME
 !
 !  Output Variables:
 !
 !     #  Name            Type Size     Description
 !    --- --------------- ---- -------- --------------------------------
 !    Output Parameters:
 !      1 BV              R    -        BREAKDOWN VOLTAGE
 !
 !***** DON'T REMOVE THIS LINE *************************************
   OPTION BASE 1                    !***** DON'T REMOVE THIS LINE *****
   DISP "in BVOX"
                                    !
   INTEGER Drain,Gate,Source,Bulk,Stat
                                    !
   Drain=Pins(1)
   Gate=Pins(2)
   Source=Pins(3)
   Bulk=Pins(4)
                                    ! Connect device
   IF Drain>0 THEN 
     Connect(FNGnd,Drain)
   END IF
   IF Source>0 THEN 
     Connect(FNGnd,Source)
   END IF
   Connect(FNGnd,Gate,Bulk)
   Connect(FNPort(0,1),Gate)
                                    ! ADC mode
   Set_smu_ch(Gate,Adc,0)
   Set_adc(Adc,Integ,Iv)
   ! Set_wait_time(Ss,Sm)
                                    ! Search
   Set_lsearch(Gate,Gate,Mode,Vgmin,Vgmax,Vgstep,Igtarg,0,.01,0,Vgskip,1)
   Wait_th(Wait)
   Search(Bv,Stat,Ig)
   PRINT "Bv=";Bv,"Stat";Stat
   IF Stat<>0 THEN Bv=Vgmax
                                    ! Disable ports and pins
   Disable_port
   Connect
 SUBEND
 Bvs:SUB Bvs(REAL Vg,Vsmin,Vsmax,Vsstep,Istarg,Icomp,INTEGER Pins(*),Adc,REAL Iv,INTEGER Integ,Vsskip,Rsearch,D_path$,D_file$,REAL Bv)
 !***** DON'T REMOVE THIS LINE *************************************
 !
 !  Type : Algorithm
 !  Name : Bvs
 !  Vers : 1
 !  Desc : Drain to source punchthrough voltage with gate and well g
 !       : rounded
 !  Date : 12/19/2022
 !  Time : 18:11:55
 !  User : wat
 !
 !***** DON'T REMOVE THIS LINE *************************************
 !
 !  Input Variables:
 !
 !     #  Name            Type Size     Description
 !    --- --------------- ---- -------- --------------------------------
 !    Measurement Parameters:
 !      1 VG              R    -        BIAS VOLTAGE ON GATE
 !      2 VSMIN           R    -        START SOURCE VOLTAGE
 !      3 VSMAX           R    -        STOP SOURCE VOLTAGE
 !      4 VSSTEP          R    -        STEP SOURCE VOLTAGE
 !      5 ISTARG          R    -        TARGET SOURCE CURRENT
 !      6 Icomp           R    -        Compliance of Vg
 !
 !    Device Terminals:
 !      1 DRAIN           I    -        DRAIN TERMINAL
 !      2 GATE            I    -        GATE TERMINAL
 !      3 SOURCE          I    -        SOURCE TERMINAL
 !      4 BULK            I    -        WELL OR BULK
 !
 !    Device Parameters:
 !      1 ADC             I    -        ADC TYPE (0:HI-SPEED, 1:HI-RESOL
 !      2 IV              R    -        SAMPLING NUMBER WHEN MANUAL INTE
 !      3 INTEG           I    -        INTEGRATION TIME (0:MAN, 1:S, 2:
 !      4 VSSKIP          I    -        FOR CALCULATING THE LARGE STEP
 !      5 RSEARCH         I    -        0: OFF, 1:ON
 !      6 D_path          S    -        SAVE FILE PATH
 !      7 D_file          S    -        SAVE FILE NAME
 !
 !  Output Variables:
 !
 !     #  Name            Type Size     Description
 !    --- --------------- ---- -------- --------------------------------
 !    Output Parameters:
 !      1 BV              R    -        DRAIN TO SOURCE PUNCHTHROUGH VOL
 !
 !***** DON'T REMOVE THIS LINE *************************************
   OPTION BASE 1                  !***** DON'T REMOVE THIS LINE *****
   DISP "in Bvs"
  !
   INTEGER Gate,Drain,Source,Bulk,Stat
   REAL Vd(1500),Id(1500)
    !
   Drain=Pins(1)
   Gate=Pins(2)
   Source=Pins(3)
   Bulk=Pins(4)
    ! Connect device terminals
   Connect(FNGnd,Gate,Drain,Source,Bulk)
  !Connect(FNPort(0,1),Drain)
   Connect(FNPort(0,1),Source)
   Connect(FNPort(0,2),Gate)
   Connect(FNPort(0,4),Bulk)
    ! ADC mode
  !Set_smu_ch(Drain,Adc,0)
   Set_smu_ch(Source,Adc,0)
   Set_adc(Adc,Integ,Iv)
  !Set_wait_time(Ss,Sm)
    ! Search measurement
   IF Gate>0 THEN CALL Force_v(Gate,Vg,Vg,1.E-3)
  !Set_lsearch(Drain,Drain,8,Vdmin,Vdmax,Vdstep,Idtarg,0,Icomp,0,Vdskip,1)
   Set_lsearch(Source,Source,8,Vsmin,Vsmax,Vsstep,Istarg,0,Icomp,0,Vsskip,1)
   IF Rsearch=0 THEN 
     Search(Bvs,Stat)
    !
     PRINT "Bvs=";Bvs,"Stat=";Stat
     IF Stat<>0 THEN Bvs=Vdmax
     GOTO End
   END IF
            !
  !IF Rsearch<>0 THEN
    !Step=1
    !LOOP
      !Rsearch(Vd(Step),Stat,Id(Step))
    !EXIT IF Stat<>0
      !Step=Step+1
    !END LOOP
    !Rsearch_stop
    !Bv=Vd(Step)
    !PRINT "Bv=";Vd(Step),"Stat=";Stat
     !
 !Save_file: !
    !ON ERROR GOTO Nofile
    !ASSIGN @File TO D_path$&"/"&D_file$&".csv";APPEND
    !OFF ERROR
            !
    !OUTPUT @File USING "K,K";"Vg=";Vg;",";"Idtarget=";Idtarg
    !OUTPUT @File USING "K,K";"Vdmin=";Vdmin;",";"Vdmax=";Vdmax;",";"Vdstep=";Vdstep
    !OUTPUT @File USING "K,K";"Step Number";",";"Vdrain";",";"Idrain"
            !
    !INTEGER I
    !FOR I=1 TO Step
      !OUTPUT @File USING "K,K";I;",";Vd(I);",";Id(I)
    !NEXT I
            !
    !ASSIGN @File TO *
   GOTO End
       !
 !Nofile:     !
    !CREATE D_path$&"/"&D_file$&".csv",2
    !GOTO Save_file
  !END IF
 End:   !
   Disable_port
   Connect
 SUBEND
 Calc_log10:SUB Calc_log10(REAL Input,Inh,Inl,Output)
 !***** DON'T REMOVE THIS LINE *************************************
 !
 !  Type : Algorithm
 !  Name : CALC_LOG10
 !  Vers : 1
 !  Desc : IFD logarithm of base 10 of one absolute value of one par
 !       : ameter
 !  Date : 09/03/2003
 !  Time : 11:28:44
 !  User : wat
 !
 !***** DON'T REMOVE THIS LINE *************************************
 !
 !  Input Variables:
 !
 !     #  Name            Type Size     Description
 !    --- --------------- ---- -------- --------------------------------
 !    Measurement Parameters:
 !      1 Input           R    -        Input Variable
 !      2 Inh             R    -        Input high limit
 !      3 Inl             R    -        Input low limit
 !
 !  Output Variables:
 !
 !     #  Name            Type Size     Description
 !    --- --------------- ---- -------- --------------------------------
 !    Output Parameters:
 !      1 Output          R    -        Output variable of LOG10
 !
 !***** DON'T REMOVE THIS LINE *************************************
   OPTION BASE 1      !***** DON'T REMOVE THIS LINE *****
   ON ERROR GOTO System_error
    !
   IF ABS(Input)>1.E+99 THEN GOTO Par_error
   IF Input<0 THEN GOTO Par_error
    !
   Output=LGT(ABS(Input))
   SUBEXIT
    !
 System_error:        !
   OFF ERROR 
   Output=ERRN*(1.E+33)
   PRINT "Alg. Calculation ERRN:";ERRN,"ERRM$:";ERRM$
   SUBEXIT
    !
 Par_error:            !
   Output=2.E+32
   SUBEXIT
    !
 SUBEND
 Calculation:SUB Calculation(REAL Input,Inh,Inl,Output)
 !***** DON'T REMOVE THIS LINE *************************************
 !
 !  Type : Algorithm
 !  Name : Calculation
 !  Vers : 1
 !  Desc : IFD This algorithm only checks the input againts inh and
 !       : inl and returns the value
 !  Date : 09/03/2003
 !  Time : 11:28:44
 !  User : wat
 !
 !***** DON'T REMOVE THIS LINE *************************************
 !
 !  Input Variables:
 !
 !     #  Name            Type Size     Description
 !    --- --------------- ---- -------- --------------------------------
 !    Measurement Parameters:
 !      1 Input           R    -        Input Variable
 !      2 Inh             R    -        Input high limit
 !      3 Inl             R    -        Input low limit
 !
 !  Output Variables:
 !
 !     #  Name            Type Size     Description
 !    --- --------------- ---- -------- --------------------------------
 !    Output Parameters:
 !      1 Output          R    -        Output variable
 !
 !***** DON'T REMOVE THIS LINE *************************************
   OPTION BASE 1    !***** DON'T REMOVE THIS LINE *****
   ON ERROR GOTO System_error
   !
   IF ABS(Input)>1.E+99 THEN GOTO Par_error
   IF Input<Inl OR Input>Inh THEN GOTO Par_error
   !
   Output=Input
   SUBEXIT
   !
 System_error:         !
   OFF ERROR 
   Output=ERRN*(1.E+33)
   PRINT "Alg. Calculation ERRN:";ERRN,"ERRM$:";ERRM$
   SUBEXIT
   !
 Par_error:             !
   Output=2.E+32
   SUBEXIT
   !
 SUBEND
 Cap_tox:SUB Cap_tox(REAL Vf,Area,C0,Darea,INTEGER Pins(*),REAL Sl,Freq,INTEGER Integ,REAL E0,Ed,Offset,Tox,Cap,G)
 !***** DON'T REMOVE THIS LINE *************************************
 !
 !  Type : Algorithm
 !  Name : Cap_tox
 !  Vers : 1
 !  Desc : Capacitance measurement at given bias. Returns capacitanc
 !       : e, conductance and
 !       : oxide thickness.
 !  Date : 05/28/2003
 !  Time : 15:18:28
 !  User : wat
 !
 !***** DON'T REMOVE THIS LINE *************************************
 !
 !  Input Variables:
 !
 !     #  Name            Type Size     Description
 !    --- --------------- ---- -------- --------------------------------
 !    Measurement Parameters:
 !      1 VF              R    -        VOLTAGE TO APPLY
 !      2 AREA            R    -        AREA OF ACTIVE REGION
 !      3 C0              R    -        offset capacitance of probe-card
 !      4 Darea           R    -        Cap/Darea for pf/um2
 !
 !    Device Terminals:
 !      1 H               I    -        CMH ( recommend to bulk/sub or c
 !      2 L               I    -        CML ( recommend to gate/drain )
 !
 !    Device Parameters:
 !      1 SL              R    -        TEST SIGNAL LEVEL
 !      2 FREQ            R    -        MEASUREMENT FREQUENCY
 !      3 INTEG           I    -        INTEGRATION TIME (1:S, 2:M, 3:L)
 !      4 E0              R    -        Permitivity of free space ( F/cm
 !      5 ED              R    -        DIELECTRIC CONSTANT OF INSULATOR
 !      6 Offset          R    -
 !
 !  Output Variables:
 !
 !     #  Name            Type Size     Description
 !    --- --------------- ---- -------- --------------------------------
 !    Output Parameters:
 !      1 TOX             R    -        OXIDE THICKNESS
 !      2 CAP             R    -        OXIDE CAPACITANCE
 !      3 G               R    -        OXIDE CONDUCTANCE
 !
 !***** DON'T REMOVE THIS LINE *************************************
   OPTION BASE 1                  !***** DON'T REMOVE THIS LINE *****
   DISP "in Cap_tox"
     !
   INTEGER H,L,Stat
   REAL C
   DIM St$[256],Err$[256]
     !
   H=Pins(1)
   L=Pins(2)
   Connect(FNGnd,H,L)
     !
   IF C0=0 THEN 
     Prober_down(St$,Err$)      ! Chuck Down to measure offset C0
     IF St$<>"OK" THEN 
       Tox=999
       SUBEXIT
     ELSE
       Connect(FNPort(1,7),H) ! connect device
       Connect(FNPort(1,8),L)
       Set_cmu84(Integ,Sl)
       Set_freq(H,Freq)
       Force_v(H,Vf,Vf,.1)
       Wait_th(.1)
       Measure_cmu84(C0)
       PRINT "offset C0=";C0
     END IF
     Prober_up(St$,Err$)        ! Chuck Up
   END IF
     !
   Wait_th(.1)
   Connect(FNPort(1,7),H)
   Connect(FNPort(1,8),L)
   Set_cmu84(Integ,Sl)
   Set_freq(H,Freq)
   Force_v(H,Vf,Vf,.1)
   Wait_th(.1)
   Measure_cmu84(C,G)
   PRINT "offset C0=";C0
   PRINT "Cap total=";C,"G=";G
   C=C-C0
   Port_status(H,Stat)
   PRINT "Cm =";C," stat=",Stat
        ! Calculate Tox
   IF C<>0 THEN                      !
     Tox=Ed*E0*Area/C+Offset       ! E0: F/cm   = F/(1.0E+8)A
   ELSE                              ! Area: um^2 = (1.0E+4)^2 A^2
     Tox=999                       !            =1.0E+8 A^2
     SUBEXIT
   END IF
   PRINT "Tox=",Tox;" Anstrom"       !
        ! So Tox unit = A
   Cap=C*1.0E+12/Darea               ! Cap unit : pF
        !
   SELECT Stat
   CASE 1
     PRINT " Analog bridge is unbalanced"
   CASE 2
     PRINT " A/D converter is not working"
   CASE 3
     PRINT " Signal source is overloaded"
   CASE 4
     PRINT " Automatic level control (ALC) is unable to keep constant level"
   END SELECT
        ! Disconnect
   Disable_port
   Connect
 SUBEND
 Cap_tox_bias:SUB Cap_tox_bias(REAL Vf,Area,C0,Darea,Vsub,INTEGER Pins(*),REAL Sl,Freq,INTEGER Integ,REAL E0,Ed,Offset,Tox,Cap,G)
 !***** DON'T REMOVE THIS LINE *************************************
 !
 !  Type : Algorithm
 !  Name : Cap_tox_bias
 !  Vers : 1
 !  Desc : Capacitance measurement at given bias. Returns capacitanc
 !       : e, conductance and
 !       : oxide thickness.
 !  Date : 10/18/2009
 !  Time : 19:52:39
 !  User : wat
 !
 !***** DON'T REMOVE THIS LINE *************************************
 !
 !  Input Variables:
 !
 !     #  Name            Type Size     Description
 !    --- --------------- ---- -------- --------------------------------
 !    Measurement Parameters:
 !      1 VF              R    -        VOLTAGE TO APPLY
 !      2 AREA            R    -        AREA OF ACTIVE REGION
 !      3 C0              R    -        offset capacitance of probe-card
 !      4 Darea           R    -        Cap/Darea for pf/um2
 !      5 VSUB            R    -        VOLTAGE TO BIAS
 !
 !    Device Terminals:
 !      1 H               I    -        CMH ( recommend to bulk/sub or c
 !      2 L               I    -        CML ( recommend to gate/drain )
 !      3 SUB             I    -        SUB
 !
 !    Device Parameters:
 !      1 SL              R    -        TEST SIGNAL LEVEL
 !      2 FREQ            R    -        MEASUREMENT FREQUENCY
 !      3 INTEG           I    -        INTEGRATION TIME (1:S, 2:M, 3:L)
 !      4 E0              R    -        Permitivity of free space ( F/cm
 !      5 ED              R    -        DIELECTRIC CONSTANT OF INSULATOR
 !      6 Offset          R    -
 !
 !  Output Variables:
 !
 !     #  Name            Type Size     Description
 !    --- --------------- ---- -------- --------------------------------
 !    Output Parameters:
 !      1 TOX             R    -        OXIDE THICKNESS
 !      2 CAP             R    -        OXIDE CAPACITANCE
 !      3 G               R    -        OXIDE CONDUCTANCE
 !
 !***** DON'T REMOVE THIS LINE *************************************
   OPTION BASE 1                     !***** DON'T REMOVE THIS LINE *****
   DISP "in Cap_tox"
                                    !
   INTEGER H,L,Sub,Stat
   REAL C
   DIM St$[256],Err$[256]
                                    !
   H=Pins(1)
   L=Pins(2)
   Sub=Pins(3)
   Connect(FNGnd,H,L,Sub)
   ! Connect(FNPort(0,1),Sub)
   ! Force_v(Sub,Vsub,Vsub,.1)
                                    !
   IF C0=0 THEN 
     Prober_down(St$,Err$)          ! Chuck Down to measure offset C0
     IF St$<>"OK" THEN 
       Tox=999
       SUBEXIT
     ELSE
       Connect(FNPort(1,7),H)       ! connect device
      ! Connect(FNPort(0,3),Sub)
       Connect(FNPort(1,8),L)
       Set_cmu84(Integ,Sl)
       Set_freq(H,Freq)
       Force_v(H,Vf,Vf,.1)
      ! Force_v(Sub,Vsub,Vsub,.1)
       Wait_th(.1)
       Measure_cmu84(C0)
       PRINT "offset C0=";C0
     END IF
     Prober_up(St$,Err$)            ! Chuck Up
   END IF
                                    !
   Wait_th(.1)
   Connect(FNPort(1,7),H,Sub)
    !Connect(FNPort(0,3),Sub)
   Connect(FNPort(1,8),L)
   Set_cmu84(Integ,Sl)
   Set_freq(H,Freq)
   Force_v(H,Vf,Vf,.1)
    !Force_v(Sub,Vsub,Vsub,.1)
   Wait_th(.1)
   Measure_cmu84(C,G)
   PRINT "offset C0=";C0
   PRINT "Cap total=";C,"G=";G
   C=C-C0
   Port_status(H,Stat)
   PRINT "Cm =";C," stat=",Stat
                                       ! Calculate Tox
   IF C<>0 THEN                         !
     Tox=Ed*E0*Area/C+Offset           ! E0: F/cm   = F/(1.0E+8)A
   ELSE                                 ! Area: um^2 = (1.0E+4)^2 A^2
     Tox=999                           !            =1.0E+8 A^2
     SUBEXIT
   END IF
   PRINT "Tox=",Tox;" Anstrom"          !
                                       ! So Tox unit = A
   Cap=C*1.0E+12/Darea                  ! Cap unit : pF
                                       !
   SELECT Stat
   CASE 1
     PRINT " Analog bridge is unbalanced"
   CASE 2
     PRINT " A/D converter is not working"
   CASE 3
     PRINT " Signal source is overloaded"
   CASE 4
     PRINT " Automatic level control (ALC) is unable to keep constant level"
   END SELECT
                                       ! Disconnect
   Disable_port
   Connect
 SUBEND
 Cap_tox_mos:SUB Cap_tox_mos(REAL Vg,Area,C0,Darea,INTEGER Pins(*),REAL Sl,Freq,INTEGER Integ,REAL E0,Ed,Offset,Tox,Cap,Go)
 !***** DON'T REMOVE THIS LINE *************************************
 !
 !  Type : Algorithm
 !  Name : Cap_tox_mos
 !  Vers : 1
 !  Desc : Capacitance measurement at given bias. Returns capacitanc
 !       : e, conductance and
 !       : oxide thickness.
 !  Date : 04/06/2023
 !  Time : 15:31:33
 !  User : specs
 !
 !***** DON'T REMOVE THIS LINE *************************************
 !
 !  Input Variables:
 !
 !     #  Name            Type Size     Description
 !    --- --------------- ---- -------- --------------------------------
 !    Measurement Parameters:
 !      1 VG              R    -        VOLTAGE TO GATE
 !      2 AREA            R    -        AREA OF ACTIVE REGION
 !      3 C0              R    -        offset capacitance of probe-card
 !      4 Darea           R    -        Cap/Darea for pf/um2
 !
 !    Device Terminals:
 !      1 D               I    -        DRAIN TERMINAL
 !      2 G               I    -        GATE TERMINAL
 !      3 S               I    -        SOURCE TERMINAL
 !      4 B               I    -        WELL OR BULK
 !
 !    Device Parameters:
 !      1 SL              R    -        TEST SIGNAL LEVEL
 !      2 FREQ            R    -        MEASUREMENT FREQUENCY
 !      3 INTEG           I    -        INTEGRATION TIME (1:S, 2:M, 3:L)
 !      4 E0              R    -        Permitivity of free space ( F/cm
 !      5 ED              R    -        DIELECTRIC CONSTANT OF INSULATOR
 !      6 Offset          R    -
 !
 !  Output Variables:
 !
 !     #  Name            Type Size     Description
 !    --- --------------- ---- -------- --------------------------------
 !    Output Parameters:
 !      1 TOX             R    -        OXIDE THICKNESS
 !      2 CAP             R    -        OXIDE CAPACITANCE
 !      3 GO              R    -        OXIDE CONDUCTANCE
 !
 !***** DON'T REMOVE THIS LINE *************************************
   OPTION BASE 1                  !***** DON'T REMOVE THIS LINE *****
   DISP "in Cap_tox"
     !
   INTEGER D,G,S,B,Stat
   !INTEGER Stat
   REAL C
   DIM St$[256],Err$[256]
     !
  !----------------------------------------------------------------------
  !Connect pins
  !----------------------------------------------------------------------
   D=Pins(1)
   G=Pins(2)
   S=Pins(3)
   B=Pins(4)
  !----------------------------------------------------------------------
  !
  !----------------------------------------------------------------------
  !Discharging
  !----------------------------------------------------------------------
   IF D<>0 THEN CALL Connect(FNGnd,D)
   IF G<>0 THEN CALL Connect(FNGnd,G)
   IF S<>0 THEN CALL Connect(FNGnd,S)
   IF B<>0 THEN CALL Connect(FNGnd,B)
  !----------------------------------------------------------------------
     !
   IF C0=0 THEN 
     Prober_down(St$,Err$)       ! Chuck Down to measure offset C0
     IF St$<>"OK" THEN 
       Tox=999
       SUBEXIT
     ELSE
  !----------------------------------------------------------------------
  !Connect CMU
  !----------------------------------------------------------------------
       IF D<>0 THEN CALL Connect(FNPort(1,7),G) !CMH
       IF S<>0 THEN CALL Connect(FNPort(1,8),D) !CML
       IF G<>0 THEN CALL Connect(FNPort(1,8),S) !CML
  !----------------------------------------------------------------------
  !
       Set_cmu84(Integ,Sl)
       Set_freq(G,Freq)
       Force_v(G,Vg,Vg,.1)
       PRINT "G=";G
       Wait_th(.1)
       Measure_cmu84(C0)         !Measure C0
       PRINT "offset C0=";C0
     END IF
     Prober_up(St$,Err$)                        ! Chuck Up
   END IF
     !
   Wait_th(.1)
  !----------------------------------------------------------------------
  !Connect CMU
  !----------------------------------------------------------------------
   IF D<>0 THEN CALL Connect(FNPort(1,7),G)     !CMH
   IF S<>0 THEN CALL Connect(FNPort(1,8),D)     !CML
   IF G<>0 THEN CALL Connect(FNPort(1,8),S)     !CML
  !----------------------------------------------------------------------
  !
   Set_cmu84(Integ,Sl)
   Set_freq(G,Freq)
   Force_v(G,Vg,Vg,.1)
   Wait_th(.1)
   Measure_cmu84(C,Go)
   PRINT "offset C0=";C0
   PRINT "Cap total=";C,"G=";Go       !Measure total C
   C=C-C0
   Port_status(G,Stat)
   PRINT "Cm =";C," stat=",Stat
   !---------------------------------------------------------------------
   !Output
   !---------------------------------------------------------------------
   IF C<>0 THEN 
     Tox=Ed*E0*Area/C+Offset         ! E0: F/cm   = F/(1.0E+8)A
   ELSE                              ! Area: um^2 = (1.0E+4)^2 A^2
     Tox=999                         !            =1.0E+8 A^2
     SUBEXIT
   END IF
   PRINT "Tox=",Tox;" Anstrom"
        ! So Tox unit = A
   Cap=C*1.0E+12/Darea               ! Cap unit : pF
        !
   SELECT Stat
   CASE 1
     PRINT " Analog bridge is unbalanced"
   CASE 2
     PRINT " A/D converter is not working"
   CASE 3
     PRINT " Signal source is overloaded"
   CASE 4
     PRINT " Automatic level control (ALC) is unable to keep constant level"
   END SELECT
   !--------------------------------------------------------------------------------------
   ! Disconnect
   !--------------------------------------------------------------------------------------
   Disable_port
   Connect
 SUBEND
 Cap_tox_tb:SUB Cap_tox_tb(REAL Vf,Area,C0,Darea,Hold,INTEGER Pins(*),REAL Sl,Freq,INTEGER Integ,REAL E0,Ed,Offset,Tox,Cap,G)
 !***** DON'T REMOVE THIS LINE *************************************
 !
 !  Type : Algorithm
 !  Name : Cap_tox_TB
 !  Vers : 1
 !  Desc : Capacitance measurement at given bias. Returns capacitanc
 !       : e, conductance and
 !       : oxide thickness.
 !       : 2014 base on Cap_tox set up TB alg
 !  Date : 11/07/2014
 !  Time : 16:22:11
 !  User : wat
 !
 !***** DON'T REMOVE THIS LINE *************************************
 !
 !  Input Variables:
 !
 !     #  Name            Type Size     Description
 !    --- --------------- ---- -------- --------------------------------
 !    Measurement Parameters:
 !      1 VF              R    -        VOLTAGE TO APPLY
 !      2 AREA            R    -        AREA OF ACTIVE REGION
 !      3 C0              R    -        offset capacitance of probe-card
 !      4 Darea           R    -        Cap/Darea for pf/um2
 !      5 hold            R    -        Delay time before measure
 !
 !    Device Terminals:
 !      1 H               I    -        CMH ( recommend to bulk/sub or c
 !      2 L               I    -        CML ( recommend to gate/drain )
 !
 !    Device Parameters:
 !      1 SL              R    -        TEST SIGNAL LEVEL
 !      2 FREQ            R    -        MEASUREMENT FREQUENCY
 !      3 INTEG           I    -        INTEGRATION TIME (1:S, 2:M, 3:L)
 !      4 E0              R    -        Permitivity of free space ( F/cm
 !      5 ED              R    -        DIELECTRIC CONSTANT OF INSULATOR
 !      6 Offset          R    -
 !
 !  Output Variables:
 !
 !     #  Name            Type Size     Description
 !    --- --------------- ---- -------- --------------------------------
 !    Output Parameters:
 !      1 TOX             R    -        OXIDE THICKNESS
 !      2 CAP             R    -        OXIDE CAPACITANCE
 !      3 G               R    -        OXIDE CONDUCTANCE
 !
 !***** DON'T REMOVE THIS LINE *************************************
   OPTION BASE 1                  !***** DON'T REMOVE THIS LINE *****
   DISP "in Cap_tox"
         !
   INTEGER H,L,Stat
   REAL C
   DIM St$[256],Err$[256]
         !
   H=Pins(1)
   L=Pins(2)
   Connect(FNGnd,H,L)
   Wait_th(.001)
         !
   IF C0=0 THEN 
     Prober_down(St$,Err$)      ! Chuck Down to measure offset C0
     IF St$<>"OK" THEN 
       Tox=999
       SUBEXIT
     ELSE
       Connect(FNPort(1,7),H) ! connect device
       Connect(FNPort(1,8),L)
       Set_cmu84(Integ,Sl)
       Set_freq(H,Freq)
       Force_v(H,Vf,Vf,.1)
       Wait_th(.001)
       Measure_cmu84(C0)
       PRINT "offset C0=";C0
     END IF
     Prober_up(St$,Err$)        ! Chuck Up
   END IF
         !
  !ait_th(.002)
   Connect(FNPort(1,7),H)
   Connect(FNPort(1,8),L)
   Set_cmu84(Integ,Sl)
   Set_freq(H,Freq)
   Force_v(H,Vf,Vf,.1)
   Wait_th(Hold)
   Measure_cmu84(C,G)
   PRINT "offset C0=";C0
   PRINT "Cap total=";C,"G=";G
   C=C-C0
   Port_status(H,Stat)
   PRINT "Cm =";C," stat=",Stat
            ! Calculate Tox
   IF C<>0 THEN                      !
     Tox=Ed*E0*Area/C+Offset       ! E0: F/cm   = F/(1.0E+8)A
   ELSE                              ! Area: um^2 = (1.0E+4)^2 A^2
     Tox=999                       !            =1.0E+8 A^2
     SUBEXIT
   END IF
   PRINT "Tox=",Tox;" Anstrom"       !
            ! So Tox unit = A
   Cap=C*1.0E+12/Darea               ! Cap unit : pF
            !
   SELECT Stat
   CASE 1
     PRINT " Analog bridge is unbalanced"
   CASE 2
     PRINT " A/D converter is not working"
   CASE 3
     PRINT " Signal source is overloaded"
   CASE 4
     PRINT " Automatic level control (ALC) is unable to keep constant level"
   END SELECT
            ! Disconnect
   Disable_port
   Connect
 SUBEND
 Curve_4i_v_r:SUB Curve_4i_v_r(REAL Vmin,Vmax,Vstep,INTEGER Pins(*),Adc,REAL Iv,INTEGER Integ,REAL Hold,D_path$,D_file$)
 !***** DON'T REMOVE THIS LINE *************************************
 !
 !  Type : Algorithm
 !  Name : Curve_4I_V_R
 !  Vers : 1
 !  Desc : Id vs Vd curve
 !  Date : 02/06/2023
 !  Time : 15:39:32
 !  User : wat
 !
 !***** DON'T REMOVE THIS LINE *************************************
 !
 !  Input Variables:
 !
 !     #  Name            Type Size     Description
 !    --- --------------- ---- -------- --------------------------------
 !    Measurement Parameters:
 !      1 VMIN            R    -        START SWEEP VOLTAGE ON HIGH
 !      2 VMAX            R    -        END SWEEP VOLTAGE ON HIGH
 !      3 VSTEP           R    -
 !
 !    Device Terminals:
 !      1 BULK            I    -
 !      2 H               I    -
 !      3 L               I    -
 !
 !    Device Parameters:
 !      1 ADC             I    -        1,ADC TYPE (0:HI-SPEED, 1:HI-RES
 !      2 IV              R    -        SAMPLING NUMBER WHEN MANUAL INTE
 !      3 INTEG           I    -        1,2,3,INTEGRATION TIME (0:MAN, 1
 !      4 HOLD            R    -        HOLD TIME BEFORE STARTS SWEEP ME
 !      5 D_path          S    -
 !      6 D_file          S    -
 !
 !  Output Variables:
 !
 !***** DON'T REMOVE THIS LINE *************************************
   OPTION BASE 1
             !
   INTEGER Steps
   Steps=ABS(Vmax-Vmin)/Vstep+1
         !
   INTEGER H,L,Bulk
   H=Pins(1)
   L=Pins(2)
   Bulk=Pins(3)                                  !
         !
    !--------------------------------------------------------------------------------
    !Discharge
    !--------------------------------------------------------------------------------
   IF H<>0 THEN CALL Connect(FNPort(0,9),H)
   IF L<>0 THEN CALL Connect(FNPort(0,9),L)
   IF Bulk<>0 THEN CALL Connect(FNPort(0,9),Bulk)
    !--------------------------------------------------------------------------------
    !
    !--------------------------------------------------------------------------------
    !Connect Pins
    !--------------------------------------------------------------------------------
   IF H<>0 THEN CALL Connect(FNPort(0,1),H)
   IF L<>0 THEN CALL Connect(FNPort(0,2),L)
         !
        !Set_smu_ch(Drain,Adc,O)
   Set_adc(Adc,Integ,Iv)
                                                 !
         !
   INTEGER Mode,Stop_mode
   REAL Range,Delay,Compliance,P_comp
         !
   Mode=1
   Range=0
   Delay=0.
   Compliance=.1
   P_comp=2
   Stop_mode=1
         !
   Set_iv(H,Mode,Range,Vmin,Vmax,Steps,Hold,Delay,Compliance,P_comp,Stop_mode)
         !
   REAL Im(1500),Vsweep(1500),R(1500)
   !INTEGER Port(4)
   !Port(1)=FNPort(0,1)
   !Port(2)=FNPort(0,2)
   !Port(3)=FNPort(0,3)
   !Port(4)=FNPort(0,4)
   !REAL Meas_range(4)
   !Meas_range(1)=0
   !Meas_range(2)=0
   !Meas_range(3)=0
   !Meas_range(4)=0
   REAL Meas_range
   Meas_range=0
         !
   !Sweep_miv(Port(*),Meas_range(*),Id(*),Ig(*),Is(*),Ib(*),Vsweep(*))
   INTEGER Meas_mode
   Meas_mode=2
   Sweep_iv(H,Meas_mode,Meas_range,Im(*),Vsweep(*))
         !
         !
 Save_file:              !
   ON ERROR GOTO Nofile
   ASSIGN @File TO D_path$&"/"&D_file$&".cv";APPEND
   OFF ERROR 
   !OUTPUT @File USING "K,K";"Vgs=";Vg
   !OUTPUT @File USING "K,K";"Vdmin=";Vdmin;",";"Vdmax=";Vdmax;",";"Vdstep=";Vdstep
   OUTPUT @File USING "K,K";"Vmin=";Vmin;",";"Vmax=";Vmax;",";"Vstep=";Vstep
   !OUTPUT @File USING "K,K";"Step Number";",";"Vd";",";"Id";",Ig";",Is";",Ib"
   OUTPUT @File USING "K,K";"Step Number";",";"V";",";"I";",";"R"
              !
   INTEGER I
   FOR I=1 TO Steps
     !OUTPUT @File USING "K,K";I;",";Vsweep(I);",";Id(I);",";Ig(I);",";Is(I);",";Ib(I)
     IF Im(I)<>0 THEN 
       R(I)=Vsweep(I)/Im(I)
     ELSE
       R(I)=999
     END IF
     OUTPUT @File USING "K,K";I;",";Vsweep(I);",";Im(I);",";R(I)
   NEXT I
              !
   ASSIGN @File TO *
         !
         !
   Disable_port
   Connect
                                                 !
   SUBEXIT
 Nofile:       !
   CREATE D_path$&"/"&D_file$&".cv",2
   GOTO Save_file
 SUBEND
 Curve_4i_vd:SUB Curve_4i_vd(REAL Vg,Vdmin,Vdmax,Vdstep,Vs,Vb,INTEGER Pins(*),Adc,REAL Iv,INTEGER Integ,REAL Hold,D_path$,D_file$)
 !***** DON'T REMOVE THIS LINE *************************************
 !
 !  Type : Algorithm
 !  Name : Curve_4I_Vd
 !  Vers : 1
 !  Desc : Id vs Vd curve
 !  Date : 11/25/2022
 !  Time : 12:59:30
 !  User : wat
 !
 !***** DON'T REMOVE THIS LINE *************************************
 !
 !  Input Variables:
 !
 !     #  Name            Type Size     Description
 !    --- --------------- ---- -------- --------------------------------
 !    Measurement Parameters:
 !      1 VG              R    -
 !      2 VDMIN           R    -        START SWEEP VOLTAGE ON HIGH
 !      3 VDMAX           R    -        END SWEEP VOLTAGE ON HIGH
 !      4 VDSTEP          R    -
 !      5 VS              R    -        VOLTAGE ON SOURCE
 !      6 VB              R    -        VOLTAGE ON BULK
 !
 !    Device Terminals:
 !      1 DRAIN           I    -
 !      2 GATE            I    -
 !      3 SOURCE          I    -
 !      4 BULK            I    -
 !
 !    Device Parameters:
 !      1 ADC             I    -        1,ADC TYPE (0:HI-SPEED, 1:HI-RES
 !      2 IV              R    -        SAMPLING NUMBER WHEN MANUAL INTE
 !      3 INTEG           I    -        1,2,3,INTEGRATION TIME (0:MAN, 1
 !      4 HOLD            R    -        HOLD TIME BEFORE STARTS SWEEP ME
 !      5 D_path          S    -
 !      6 D_file          S    -
 !
 !  Output Variables:
 !
 !***** DON'T REMOVE THIS LINE *************************************
   OPTION BASE 1
             !
   INTEGER Steps
   Steps=ABS(Vdmax-Vdmin)/Vdstep+1
         !
   INTEGER Drain,Gate,Source,Bulk
   Drain=Pins(1)
   Gate=Pins(2)
   Source=Pins(3)
   Bulk=Pins(4)                                   !
         !
   Connect(FNGnd,Drain,Gate,Source,Bulk)
   Connect(FNPort(0,1),Drain)
   Connect(FNPort(0,2),Gate)
   Connect(FNPort(0,3),Source)
   Connect(FNPort(0,4),Bulk)
         !
        !Set_smu_ch(Drain,Adc,O)
   Set_adc(Adc,Integ,Iv)
                                                 !
   Force_v(Gate,Vg,Vg,.1)
   Force_v(Source,Vs,Vs,.1)
   Force_v(Bulk,Vb,Vb,.1)
         !
   INTEGER Mode,Stop_mode
   REAL Range,Delay,Compliance,P_comp
         !
   Mode=1
   Range=0
   Delay=0.
   Compliance=.1
   P_comp=2
   Stop_mode=1
         !
   Set_iv(Drain,Mode,Range,Vdmin,Vdmax,Steps,Hold,Delay,Compliance,P_comp,Stop_mode)
         !
   REAL Id(1500),Ig(1500),Is(1500),Ib(1500),Vsweep(1500)
   INTEGER Port(4)
   Port(1)=FNPort(0,1)
   Port(2)=FNPort(0,2)
   Port(3)=FNPort(0,3)
   Port(4)=FNPort(0,4)
   REAL Meas_range(4)
   Meas_range(1)=0
   Meas_range(2)=0
   Meas_range(3)=0
   Meas_range(4)=0
         !
   Sweep_miv(Port(*),Meas_range(*),Id(*),Ig(*),Is(*),Ib(*),Vsweep(*))
         !
         !
 Save_file:              !
   ON ERROR GOTO Nofile
   ASSIGN @File TO D_path$&"/"&D_file$&".cv";APPEND
   OFF ERROR 
   OUTPUT @File USING "K,K";"Vgs=";Vg
   OUTPUT @File USING "K,K";"Vdmin=";Vdmin;",";"Vdmax=";Vdmax;",";"Vdstep=";Vdstep
   OUTPUT @File USING "K,K";"Step Number";",";"Vd";",";"Id";",Ig";",Is";",Ib"
              !
   INTEGER I
   FOR I=1 TO Steps
     OUTPUT @File USING "K,K";I;",";Vsweep(I);",";Id(I);",";Ig(I);",";Is(I);",";Ib(I)
   NEXT I
              !
   ASSIGN @File TO *
         !
         !
   Disable_port
   Connect
                                                 !
   SUBEXIT
 Nofile:       !
   CREATE D_path$&"/"&D_file$&".cv",2
   GOTO Save_file
 SUBEND
 Curve_4i_vg:SUB Curve_4i_vg(REAL Vd,Vgmin,Vgmax,Vgstep,Vs,Vb,INTEGER Pins(*),Adc,REAL Iv,INTEGER Integ,REAL Hold,D_path$,D_file$)
 !***** DON'T REMOVE THIS LINE *************************************
 !
 !  Type : Algorithm
 !  Name : Curve_4I_Vg
 !  Vers : 1
 !  Desc : Id vs Vd curve
 !  Date : 10/13/2008
 !  Time : 17:17:41
 !  User : wat
 !
 !***** DON'T REMOVE THIS LINE *************************************
 !
 !  Input Variables:
 !
 !     #  Name            Type Size     Description
 !    --- --------------- ---- -------- --------------------------------
 !    Measurement Parameters:
 !      1 VD              R    -
 !      2 VGMIN           R    -        START SWEEP VOLTAGE ON HIGH
 !      3 VGMAX           R    -        END SWEEP VOLTAGE ON HIGH
 !      4 VGSTEP          R    -
 !      5 VS              R    -        VOLTAGE ON SOURCE
 !      6 VB              R    -        VOLTAGE ON BULK
 !
 !    Device Terminals:
 !      1 DRAIN           I    -
 !      2 GATE            I    -
 !      3 SOURCE          I    -
 !      4 BULK            I    -
 !
 !    Device Parameters:
 !      1 ADC             I    -        1,ADC TYPE (0:HI-SPEED, 1:HI-RES
 !      2 IV              R    -        SAMPLING NUMBER WHEN MANUAL INTE
 !      3 INTEG           I    -        1,2,3,INTEGRATION TIME (0:MAN, 1
 !      4 HOLD            R    -        HOLD TIME BEFORE STARTS SWEEP ME
 !      5 D_path          S    -
 !      6 D_file          S    -
 !
 !  Output Variables:
 !
 !***** DON'T REMOVE THIS LINE *************************************
   OPTION BASE 1
             !
   INTEGER Steps
   Steps=ABS(Vgmax-Vgmin)/Vgstep+1
         !
   INTEGER Drain,Gate,Source,Bulk
   Drain=Pins(1)
   Gate=Pins(2)
   Source=Pins(3)
   Bulk=Pins(4)                                   !
         !
   Connect(FNGnd,Drain,Gate,Source,Bulk)
   Connect(FNPort(0,1),Drain)
   Connect(FNPort(0,2),Gate)
   Connect(FNPort(0,3),Source)
   Connect(FNPort(0,4),Bulk)
         !
        !Set_smu_ch(Drain,Adc,O)
   Set_adc(Adc,Integ,Iv)
                                                 !
   Force_v(Drain,Vd,Vd,.1)
   Force_v(Source,Vs,Vs,.1)
   Force_v(Bulk,Vb,Vb,.1)
         !
   INTEGER Mode,Stop_mode
   REAL Range,Delay,Compliance,P_comp
         !
   Mode=1
   Range=0
   Delay=0.
   Compliance=.1
   P_comp=2
   Stop_mode=1
         !
   Set_iv(Gate,Mode,Range,Vgmin,Vgmax,Steps,Hold,Delay,Compliance,P_comp,Stop_mode)
         !
   REAL Id(1500),Ig(1500),Is(1500),Ib(1500),Vsweep(1500)
   INTEGER Port(4)
   Port(1)=FNPort(0,1)
   Port(2)=FNPort(0,2)
   Port(3)=FNPort(0,3)
   Port(4)=FNPort(0,4)
   REAL Meas_range(4)
   Meas_range(1)=0
   Meas_range(2)=0
   Meas_range(3)=0
   Meas_range(4)=0
         !
   Sweep_miv(Port(*),Meas_range(*),Id(*),Ig(*),Is(*),Ib(*),Vsweep(*))
         !
         !
 Save_file:              !
   ON ERROR GOTO Nofile
   ASSIGN @File TO D_path$&"/"&D_file$&".cv";APPEND
   OFF ERROR 
   OUTPUT @File USING "K,K";"Vds=";Vd
   OUTPUT @File USING "K,K";"Vgmin=";Vgmin;",";"Vgmax=";Vgmax;",";"Vgstep=";Vgstep
   OUTPUT @File USING "K,K";"Step Number";",";"Vg";",";"Id";",Ig";",Is";",Ib"
              !
   INTEGER I
   FOR I=1 TO Steps
     OUTPUT @File USING "K,K";I;",";Vsweep(I);",";Id(I);",";Ig(I);",";Is(I);",";Ib(I)
   NEXT I
              !
   ASSIGN @File TO *
         !
         !
   Disable_port
   Connect
                                                 !
   SUBEXIT
 Nofile:       !
   CREATE D_path$&"/"&D_file$&".cv",2
   GOTO Save_file
 SUBEND
 Curve_cv84:SUB Curve_cv84(REAL Vf_start,Vf_stop,Vf,INTEGER Steps,REAL C0,De,INTEGER Pins(*),REAL Sl,Freq,INTEGER Integ,REAL E0,Ed,Offset,D_path$,D_file$)
 !***** DON'T REMOVE THIS LINE *************************************
 !
 !  Type : Algorithm
 !  Name : Curve_CV84
 !  Vers : 1
 !  Desc : Capacitance measurement at given bias. Returns capacitanc
 !       : e, conductance and
 !       : oxide thickness.
 !  Date : 06/11/2009
 !  Time : 11:16:08
 !  User : elt
 !
 !***** DON'T REMOVE THIS LINE *************************************
 !
 !  Input Variables:
 !
 !     #  Name            Type Size     Description
 !    --- --------------- ---- -------- --------------------------------
 !    Measurement Parameters:
 !      1 VF_START        R    -        START SWEEP VOLTAGE
 !      2 VF_STOP         R    -        STOP SWEEP VOLTAGE
 !      3 VF              R    -        VOLTAGE for Measure C0
 !      4 STEPS           I    -        SWEEP STEPS COUNTS
 !      5 C0              R    -        offset capacitance of probe-card
 !      6 De              R    -        Delay time before measure
 !
 !    Device Terminals:
 !      1 H               I    -        CMH ( recommend to bulk/sub or c
 !      2 L               I    -        CML ( recommend to gate/drain )
 !      3 Bulk            I    -        Bulk
 !
 !    Device Parameters:
 !      1 SL              R    -        TEST SIGNAL LEVEL
 !      2 FREQ            R    -        MEASUREMENT FREQUENCY
 !      3 INTEG           I    -        INTEGRATION TIME (1:S, 2:M, 3:L)
 !      4 E0              R    -        Permitivity of free space ( F/cm
 !      5 ED              R    -        DIELECTRIC CONSTANT OF INSULATOR
 !      6 Offset          R    -
 !      7 D_path          S    -
 !      8 D_file          S    -
 !
 !  Output Variables:
 !
 !***** DON'T REMOVE THIS LINE *************************************
   OPTION BASE 1                      !***** DON'T REMOVE THIS LINE *****
   DISP "in Cap_tox"
                                      !
   INTEGER H,L,Bulk,Stat
     !Steps=ABS(Vf_stop-Vf_start)/Vf_step+1
     !REAL C
   DIM St$[256],Err$[256]
                                      !
   H=Pins(1)
   L=Pins(2)
   Bulk=Pins(3)
   Connect(FNGnd,H,L)
   IF Bulk<>0 THEN CALL Connect(FNPort(0,9),Bulk)
   Wait_th(.1)
                                      !
   IF C0=0 THEN 
     Prober_down(St$,Err$)            ! Chuck Down to measure offset C0
     IF St$<>"OK" THEN 
       Tox=999
       PRINT "Tox=999"
       SUBEXIT
     ELSE
       Connect(FNPort(1,7),H)         ! connect device
       Connect(FNPort(1,8),L)
       Set_cmu84(Integ,Sl)
       Set_freq(H,Freq)
       Force_v(H,Vf,Vf,.1)
       Wait_th(.1)
       Measure_cmu84(C0)
       PRINT "offset C0=";C0
     END IF
     Prober_up(St$,Err$)              ! Chuck Up
   END IF
                                      !
   Wait_th(.1)
   Connect(FNPort(1,7),H)
   Connect(FNPort(1,8),L)
   Set_cmu84(Integ,Sl)
   Set_freq(H,Freq)
   REAL Ht,Dt
   Ht=0
   Dt=.001
   Set_cv84(Vf_start,Vf_stop,Steps,Ht,Dt)
     !Force_v(H,Vf,Vf,.1)
   Wait_th(De)
   INTEGER Stats(1500)
   REAL Cap(1500),Cond(1500),Bias(1500),Mrange
   Mrange=0
   Sweep_cv84(Mrange,Cap(*),Cond(*),Bias(*))
     !Measure_cmu84(C,G)
 Save_file:      !
   ON ERROR GOTO Nofile
   ASSIGN @File TO D_path$&"/"&D_file$&".cv";APPEND
   OFF ERROR 
   OUTPUT @File USING "K,K";"VF_START=";Vf_start
   OUTPUT @File USING "K,K";"VF_STOP=";Vf_stop
   OUTPUT @File USING "K,K";"Step=";Steps
   OUTPUT @File USING "K,K";"C0=";C0
   OUTPUT @File USING "K,K";"Step No.";",";"Capacitance";",";"Conductance";",";"Bias"
   INTEGER I
   FOR I=1 TO Steps
     OUTPUT @File USING "K,K";I;",";Cap(I)-C0;",";Cond(I);",";Bias(I)
   NEXT I
   ASSIGN @File TO *
        !
        !
                                         ! Disconnect
   Disable_port
   Connect
   SUBEXIT
 Nofile:      !
   CREATE D_path$&"/"&D_file$&".cv",2
   GOTO Save_file
 SUBEND
 Curve_cv84_mos:SUB Curve_cv84_mos(REAL Vf_start,Vf_stop,Vf,INTEGER Steps,REAL C0,De,INTEGER Pins(*),REAL Sl,Freq,INTEGER Integ,REAL E0,Ed,Offset,D_path$,D_file$)
 !***** DON'T REMOVE THIS LINE *************************************
 !
 !  Type : Algorithm
 !  Name : Curve_CV84_MOS
 !  Vers : 1
 !  Desc : Capacitance measurement at given bias. Returns capacitanc
 !       : e, conductance and
 !       : oxide thickness.
 !  Date : 04/06/2023
 !  Time : 16:30:59
 !  User : specs
 !
 !***** DON'T REMOVE THIS LINE *************************************
 !
 !  Input Variables:
 !
 !     #  Name            Type Size     Description
 !    --- --------------- ---- -------- --------------------------------
 !    Measurement Parameters:
 !      1 VF_START        R    -        START SWEEP VOLTAGE
 !      2 VF_STOP         R    -        STOP SWEEP VOLTAGE
 !      3 VF              R    -        VOLTAGE for Measure C0
 !      4 STEPS           I    -        SWEEP STEPS COUNTS
 !      5 C0              R    -        offset capacitance of probe-card
 !      6 De              R    -        Delay time before measure
 !
 !    Device Terminals:
 !      1 D               I    -        DRAIN TERMINAL
 !      2 G               I    -        GATE TERMINAL
 !      3 S               I    -        SOURCE TERMINAL
 !      4 B               I    -        WELL OR BULK
 !
 !    Device Parameters:
 !      1 SL              R    -        TEST SIGNAL LEVEL
 !      2 FREQ            R    -        MEASUREMENT FREQUENCY
 !      3 INTEG           I    -        INTEGRATION TIME (1:S, 2:M, 3:L)
 !      4 E0              R    -        Permitivity of free space ( F/cm
 !      5 ED              R    -        DIELECTRIC CONSTANT OF INSULATOR
 !      6 Offset          R    -
 !      7 D_path          S    -
 !      8 D_file          S    -
 !
 !  Output Variables:
 !
 !***** DON'T REMOVE THIS LINE *************************************
   OPTION BASE 1                      !***** DON'T REMOVE THIS LINE *****
   DISP "in Cap_tox"
                                      !
   INTEGER D,G,S,B,Stat
     !Steps=ABS(Vf_stop-Vf_start)/Vf_step+1
     !REAL C
   DIM St$[256],Err$[256]
                                      !
    !-------------------------------------------------------------------------------
    !Discharge
    !-------------------------------------------------------------------------------
   D=Pins(1)
   G=Pins(2)
   S=Pins(3)
   B=Pins(4)
   IF D<>0 THEN CALL Connect(FNPort(0,9),D)
   IF G<>0 THEN CALL Connect(FNPort(0,9),G)
   IF S<>0 THEN CALL Connect(FNPort(0,9),S)
   IF B<>0 THEN CALL Connect(FNPort(0,9),B)
    !-------------------------------------------------------------------------------
   Wait_th(.1)
                                      !
   IF C0=0 THEN 
     Prober_down(St$,Err$)            ! Chuck Down to measure offset C0
     IF St$<>"OK" THEN 
       Tox=999
       PRINT "Tox=999"
       SUBEXIT
     ELSE
    !-------------------------------------------------------------------------------
    !Connect Pins
    !-------------------------------------------------------------------------------
       IF D<>0 THEN CALL Connect(FNPort(1,7),D)
       IF S<>0 THEN CALL Connect(FNPort(1,7),S)
       IF B<>0 THEN CALL Connect(FNPort(1,7),B)
       IF G<>0 THEN CALL Connect(FNPort(1,8),G)
    !-------------------------------------------------------------------------------
    !
       Set_cmu84(Integ,Sl)
       Set_freq(D,Freq)
       Force_v(D,Vf,Vf,.1)
       Wait_th(.1)
       Measure_cmu84(C0)
       PRINT "offset C0=";C0
     END IF
     Prober_up(St$,Err$)              ! Chuck Up
   END IF
                                      !
   Wait_th(.1)
    !-------------------------------------------------------------------------------
    !Connect Pins
    !-------------------------------------------------------------------------------
   IF D<>0 THEN CALL Connect(FNPort(1,7),D)
   IF S<>0 THEN CALL Connect(FNPort(1,7),S)
   IF B<>0 THEN CALL Connect(FNPort(1,7),B)
   IF G<>0 THEN CALL Connect(FNPort(1,8),G)
   Set_cmu84(Integ,Sl)
   Set_freq(D,Freq)
   REAL Ht,Dt
   Ht=0
   Dt=.001
   Set_cv84(Vf_start,Vf_stop,Steps,Ht,Dt)
     !Force_v(H,Vf,Vf,.1)
   Wait_th(De)
   INTEGER Stats(1500)
   REAL Cap(1500),Cond(1500),Bias(1500),Mrange
   Mrange=0
   Sweep_cv84(Mrange,Cap(*),Cond(*),Bias(*))
     !Measure_cmu84(C,G)
 Save_file:      !
   ON ERROR GOTO Nofile
   ASSIGN @File TO D_path$&"/"&D_file$&".cv";APPEND
   OFF ERROR 
   OUTPUT @File USING "K,K";"VF_START=";Vf_start
   OUTPUT @File USING "K,K";"VF_STOP=";Vf_stop
   OUTPUT @File USING "K,K";"Step=";Steps
   OUTPUT @File USING "K,K";"C0=";C0
   OUTPUT @File USING "K,K";"Step No.";",";"Capacitance";",";"Conductance";",";"Bias"
   INTEGER I
   FOR I=1 TO Steps
     OUTPUT @File USING "K,K";I;",";Cap(I)-C0;",";Cond(I);",";Bias(I)
   NEXT I
   ASSIGN @File TO *
        !
        !
                                         ! Disconnect
   Disable_port
   Connect
   SUBEXIT
 Nofile:      !
   CREATE D_path$&"/"&D_file$&".cv",2
   GOTO Save_file
 SUBEND
 Curve_i_v_r_4t:SUB Curve_i_v_r_4t(REAL Imin,Imax,INTEGER Isteps,Flg,REAL Sqr,Count,INTEGER Unit,Pins(*),Adc,REAL Iv,INTEGER Integ,REAL Vcomp,Hold,Delay,D_path$,D_file$)
 !***** DON'T REMOVE THIS LINE *************************************
 !
 !  Type : Algorithm
 !  Name : Curve_I_V_R_4T
 !  Vers : 1
 !  Desc : wat_standard 4 terminals resistance measurement
 !  Date : 04/06/2023
 !  Time : 18:25:28
 !  User : specs
 !
 !***** DON'T REMOVE THIS LINE *************************************
 !
 !  Input Variables:
 !
 !     #  Name            Type Size     Description
 !    --- --------------- ---- -------- --------------------------------
 !    Measurement Parameters:
 !      1 IMIN            R    -        CURRENT TO FORCE
 !      2 IMAX            R    -        CURRENT TO FORCE
 !      3 ISTEPS          I    -
 !      4 FLG             I    -        unit flag (0: R 1: R/sqr 2: R/co
 !      5 SQR             R    -        SQR=(L/W), use to calculate R=R/
 !      6 COUNT           R    -        VIA COUNTS
 !      7 UNIT            I    -        0:ohm, 1: Kohm, 2: mohm, 3: Mohm
 !
 !    Device Terminals:
 !      1 FH              I    -        Force high
 !      2 FL              I    -        Force low
 !      3 SH              I    -        Sense high
 !      4 SL              I    -        Sense low
 !
 !    Device Parameters:
 !      1 ADC             I    -        ADC TYPE (0:HI-SPEED, 1:HI-RESOL
 !      2 IV              R    -        SAMPLING NUMBER WHEN MANUAL INTE
 !      3 INTEG           I    -        INTEGRATION TIME (0:MAN. 1:S, 2:
 !      4 VCOMP           R    -        VOLTAGE COMPLIANCE
 !      5 HOLD            R    -        HOLD TIME
 !      6 DELAY           R    -        DELAY TIME
 !      7 D_path          S    -
 !      8 D_file          S    -
 !
 !  Output Variables:
 !
 !***** DON'T REMOVE THIS LINE *************************************
   OPTION BASE 1                      !***** DON'T REMOVE THIS LINE *****
   DISP "in R4t"
                                      !
   INTEGER Fh,Fl,Sh,Sl
   REAL Vhi,Vlo
   REAL Vsh(10),Vsl(10),If(10),V(10),R(10)
                                      !
   Fh=Pins(1)
   Fl=Pins(2)
   Sh=Pins(3)
   Sl=Pins(4)
                                      ! Connect device
   Connect(FNGnd,Fh,Fl,Sh,Sl)
   Wait_th(.1)
   Connect(FNPort(0,2),Fh)
   Connect(FNPort(0,1),Sh)
   Connect(FNPort(0,3),Sl)
                                      ! ADC mode
   Set_smu_ch(Fh,Adc,0)
   Set_adc(Adc,Integ,Iv)
   Set_smu_ch(Sh,Adc)
   Set_adc_v(Adc,Integ)
   Set_smu_ch(Sl,Adc)
   Set_adc_v(Adc,Integ)
     ! Set_wait_time(Ss,Sm)
                                      ! Force 0A to two terminals
   Force_i(Sh,0,0,20)
   Force_i(Sl,0,0,20)
                                      ! Spot measurement
   Force_i(Fh,Iforce,Iforce,Vcomp)
   Wait_th(Hold)
   Measure_v(Sh,Vhi,0)
   Measure_v(Sl,Vlo,0)
   Vm=ABS(Vhi-Vlo)
                                      ! R calculation
     !IF Vm<0 THEN
     !  Res=999
     !  SUBEXIT
     !END IF
                                      !
   SELECT Flg
   CASE 0
     Res=Vm/(Iforce+1.E-30)
   CASE 1
     Res=(Vm/(Iforce+1.E-30))/Sqr
   CASE 2
     Res=(Vm/(Iforce+1.E-30))/Count
   END SELECT
                                      ! ----------------------------
   SELECT Unit
   CASE 0
     Res=Res                          ! ohm
   CASE 1
     Res=Res*1.E-3                    ! Kohm
   CASE 2
     Res=Res*1.E+3                    ! mohm
   CASE 3
     Res=Res*1.E-6                    ! Mohm
   CASE ELSE
     Res=Res
   END SELECT
                                      !
  !Res=Res*T/D
   PRINT "Res=",Res
   !--------------------------------------------------------------------------------------
   !Sweep
   !--------------------------------------------------------------------------------------
   Set_iv(Fh,2,0,Imin,Imax,Isteps,0,0,Vcomp)
   PRINT "Imax=";Imax,"Isteps=";Isteps,"vcomp=";Vcomp
   PRINT "condition"
   Sweep_iv(Sh,1,0,Vsh(*),If(*))
   Sweep_iv(Sl,1,0,Vsl(*))
   PRINT "Vsh(*)=";Vsh(*),"Vsl(*)=";Vsl(*)
 Save_file:              !
   ON ERROR GOTO Nofile
   ASSIGN @File TO D_path$&"/"&D_file$&".csv";APPEND
   OFF ERROR 
   OUTPUT @File USING "K,K";"Imin=";Imin;",";"Imax=";Imax;",";"Isteps=";Isteps
   OUTPUT @File USING "K,K";"Number";",";"V";",";"I";",";"R"
              !
   INTEGER I
   FOR I=1 TO Isteps
     IF If(I)<>0 THEN 
       V(I)=Vsh(I)-Vsl(I)
       R(I)=V(I)/If(I)
     ELSE
       R(I)=999
     END IF
     OUTPUT @File USING "K,K";I;",";V(I);",";If(I);",";R(I)
   NEXT I
              !
   ASSIGN @File TO *
         !
         !
   Disable_port
   Connect
                                                 !
   SUBEXIT
 Nofile:       !
   CREATE D_path$&"/"&D_file$&".csv",2
   GOTO Save_file
                                      ! Disable ports and pins
   Disable_port(FNPort(0,1),FNPort(0,2),FNPort(0,3))
   Connect(0,Fh,Fl,Sh,Sl)
 SUBEND
 Curve_sweep_vd:SUB Curve_sweep_vd(REAL Vg,Vdmin,Vdmax,Vdstep,Vb,D_path$,D_file$,INTEGER Pins(*),Filter_mode,Adc,REAL Iv,INTEGER Integ,REAL Hold,Delay,P_comp,Compliance)
 !***** DON'T REMOVE THIS LINE *************************************
 !
 !  Type : Algorithm
 !  Name : Curve_sweep_Vd
 !  Vers : 1
 !  Desc : Sweep Vd, measeure Id,Ig,Is,Ib curve, Vd connect FNPORT(0
 !       : ,3) which is HPSMU.
 !  Date : 12/16/2005
 !  Time : 13:47:32
 !  User : wat
 !
 !***** DON'T REMOVE THIS LINE *************************************
 !
 !  Input Variables:
 !
 !     #  Name            Type Size     Description
 !    --- --------------- ---- -------- --------------------------------
 !    Measurement Parameters:
 !      1 VG              R    -        VOLTAGE ON GATE
 !      2 VDMIN           R    -        START SWEEP VOLTAGE ON HIGH
 !      3 VDMAX           R    -        END SWEEP VOLTAGE ON HIGH
 !      4 VDSTEP          R    -        STEP VOLTAGE
 !      5 VB              R    -        VOLTAGE ON BULK
 !      6 D_path          S    -        SAVE FILE PATH
 !      7 D_file          S    -        SAVE FILE NAME
 !
 !    Device Terminals:
 !      1 DRAIN           I    -
 !      2 GATE            I    -
 !      3 SOURCE          I    -
 !      4 BULK            I    -
 !
 !    Device Parameters:
 !      1 FILTER_MODE     I    -        0,HIGH SPEED MEASURE; 1, REDUCE
 !      2 ADC             I    -        1,ADC TYPE (0:HI-SPEED, 1:HI-RES
 !      3 IV              R    -        SAMPLING NUMBER WHEN MANUAL INTE
 !      4 INTEG           I    -        1,2,3,INTEGRATION TIME (0:MAN, 1
 !      5 HOLD            R    -        HOLD TIME BEFORE STARTS SWEEP ME
 !      6 DELAY           R    -        DELAY TIME EVERY STEP: RAMP RATE
 !      7 P_COMP          R    -        FOR NORMAL MPSMU, P_COMP=2 ; FOR
 !      8 COMPLIANCE      R    -        COMPLIANCE *Vdmax<2 MPSMU; COMPL
 !
 !  Output Variables:
 !
 !***** DON'T REMOVE THIS LINE *************************************
   OPTION BASE 1
           !
   INTEGER Steps
   Steps=ABS(Vdmax-Vdmin)/Vdstep
       !
   INTEGER Drain,Gate,Source,Bulk
   Drain=Pins(1)
   Gate=Pins(2)
   Source=Pins(3)
   Bulk=Pins(4)                                 !
       !
   Connect(FNGnd,Drain,Gate,Source,Bulk)
   Connect(FNPort(0,3),Drain)
   Connect(FNPort(0,1),Gate)
   Connect(FNPort(0,2),Source)
   Connect(FNPort(0,4),Bulk)
       !
   Set_smu_ch(Drain,Adc,Filter_mode)
   Set_adc(Adc,Integ,Iv)
                                               !
   Force_v(Gate,Vg,Vg,.1)
   Force_v(Source,0,0,.1)
   Force_v(Bulk,Vb,Vb,.1)
       !
   INTEGER Mode,Stop_mode
   REAL Range
   Mode=1
   Range=0
   Stop_mode=1
       !
   Set_iv(Drain,Mode,Range,Vdmin,Vdmax,Steps,Hold,Delay,Compliance,P_comp,Stop_mode)
       !
   INTEGER Meas_mode
   REAL Meas_range
   REAL Dmeasure(1500),Dvsweep(1500),Dsync(1500),Dtime(1500)
   REAL Gmeasure(1500),Gvsweep(1500),Gsync(1500),Gtime(1500)
   REAL Smeasure(1500),Svsweep(1500),Ssync(1500),Stime(1500)
   REAL Bmeasure(1500),Bvsweep(1500),Bsync(1500),Btime(1500)
   INTEGER Dstatus(1500),Gstatus(1500),Sstatus(1500),Bstatus(1500)
       !
   Meas_mode=2
   Meas_range=0
   Set_timestamp(1)
   Reset_timestamp
   Sweep_iv(Drain,Meas_mode,Meas_range,Dmeasure(*),Dvsweep(*),Dsync(*),Dstatus(*),Dtime(*))
   Sweep_iv(Gate,Meas_mode,Meas_range,Gmeasure(*),Gvsweep(*),Gsync(*),Gstatus(*),Gtime(*))
   Sweep_iv(Source,Meas_mode,Meas_range,Smeasure(*),Svsweep(*),Ssync(*),Sstatus(*),Stime(*))
   Sweep_iv(Bulk,Meas_mode,Meas_range,Bmeasure(*),Bvsweep(*),Bsync(*),Bstatus(*),Btime(*))
   Set_timestamp(0)
       !
            !
 Save_file:        !
   ON ERROR GOTO Nofile
   ASSIGN @File TO D_path$&"/"&D_file$&".csv";APPEND
   OFF ERROR 
            !
   OUTPUT @File USING "K,K";"Vgs=";Vg;",";"Vbulk=";Vb
   OUTPUT @File USING "K,K";"Vdmin=";Vdmin;",";"Vdmax=";Vdmax;",";"Vdstep=";Vdstep
   OUTPUT @File USING "K,K";"Step Number";",";"Time";",";"Vdrain";",";"Idrain";",";"Igate";",";"Isource";",";"Ibulk"
            !
   INTEGER I
   FOR I=1 TO Steps
     OUTPUT @File USING "K,K";I;",";Dtime(I);",";Dvsweep(I);",";Dmeasure(I);",";Gmeasure(I);",";Smeasure(I);",";Bmeasure(I)
   NEXT I
            !
   ASSIGN @File TO *
   GOTO End
       !
 Nofile:     !
   CREATE D_path$&"/"&D_file$&".csv",2
   GOTO Save_file
       !
 End:     !
   Disable_port
   Connect
 SUBEND
 Curve_sweep_vg:SUB Curve_sweep_vg(REAL Vd,Vgmin,Vgmax,Vgstep,Vb,D_path$,D_file$,INTEGER Pins(*),Filter_mode,Adc,REAL Iv,INTEGER Integ,REAL Hold,Delay,P_comp,Compliance)
 !***** DON'T REMOVE THIS LINE *************************************
 !
 !  Type : Algorithm
 !  Name : Curve_sweep_Vg
 !  Vers : 1
 !  Desc : Sweep Vg, measeure Id,Ig,Is,Ib curve, Vg connect FNPORT(0
 !       : ,3) which is HPSMU.
 !  Date : 12/16/2005
 !  Time : 13:47:32
 !  User : wat
 !
 !***** DON'T REMOVE THIS LINE *************************************
 !
 !  Input Variables:
 !
 !     #  Name            Type Size     Description
 !    --- --------------- ---- -------- --------------------------------
 !    Measurement Parameters:
 !      1 VD              R    -        VOLTAGE ON DRAIN
 !      2 VGMIN           R    -        START SWEEP VOLTAGE ON HIGH
 !      3 VGMAX           R    -        END SWEEP VOLTAGE ON HIGH
 !      4 VGSTEP          R    -        STEP VOLTAGE
 !      5 VB              R    -        VOLTAGE ON BULK
 !      6 D_path          S    -        SAVE FILE PATH
 !      7 D_file          S    -        SAVE FILE NAME
 !
 !    Device Terminals:
 !      1 DRAIN           I    -
 !      2 GATE            I    -
 !      3 SOURCE          I    -
 !      4 BULK            I    -
 !
 !    Device Parameters:
 !      1 FILTER_MODE     I    -        0,HIGH SPEED MEASURE; 1, REDUCE
 !      2 ADC             I    -        1,ADC TYPE (0:HI-SPEED, 1:HI-RES
 !      3 IV              R    -        SAMPLING NUMBER WHEN MANUAL INTE
 !      4 INTEG           I    -        1,2,3,INTEGRATION TIME (0:MAN, 1
 !      5 HOLD            R    -        HOLD TIME BEFORE STARTS SWEEP ME
 !      6 DELAY           R    -        DELAY TIME EVERY STEP: RAMP RATE
 !      7 P_COMP          R    -        FOR NORMAL MPSMU, P_COMP=2 ; FOR
 !      8 COMPLIANCE      R    -        COMPLIANCE *Vdmax<2 MPSMU; COMPL
 !
 !  Output Variables:
 !
 !***** DON'T REMOVE THIS LINE *************************************
   OPTION BASE 1
           !
   INTEGER Steps
   Steps=ABS(Vgmax-Vgmin)/Vgstep
       !
   INTEGER Drain,Gate,Source,Bulk
   Drain=Pins(1)
   Gate=Pins(2)
   Source=Pins(3)
   Bulk=Pins(4)                                 !
       !
   Connect(FNGnd,Drain,Gate,Source,Bulk)
   Connect(FNPort(0,1),Drain)
   Connect(FNPort(0,3),Gate)
   Connect(FNPort(0,2),Source)
   Connect(FNPort(0,4),Bulk)
       !
   Set_smu_ch(Gate,Adc,Filter_mode)
   Set_adc(Adc,Integ,Iv)
                                               !
   Force_v(Drain,Vd,Vd,.1)
   Force_v(Source,0,0,.1)
   Force_v(Bulk,Vb,Vb,.1)
       !
   INTEGER Mode,Stop_mode
   REAL Range
   Mode=1
   Range=0
   Stop_mode=1
       !
   Set_iv(Gate,Mode,Range,Vgmin,Vgmax,Steps,Hold,Delay,Compliance,P_comp,Stop_mode)
       !
   INTEGER Meas_mode
   REAL Meas_range
   REAL Dmeasure(1500),Dvsweep(1500),Dsync(1500),Dtime(1500)
   REAL Gmeasure(1500),Gvsweep(1500),Gsync(1500),Gtime(1500)
   REAL Smeasure(1500),Svsweep(1500),Ssync(1500),Stime(1500)
   REAL Bmeasure(1500),Bvsweep(1500),Bsync(1500),Btime(1500)
   INTEGER Dstatus(1500),Gstatus(1500),Sstatus(1500),Bstatus(1500)
       !
   Meas_mode=2
   Meas_range=0
   Set_timestamp(1)
   Reset_timestamp
   Sweep_iv(Drain,Meas_mode,Meas_range,Dmeasure(*),Dvsweep(*),Dsync(*),Dstatus(*),Dtime(*))
   Sweep_iv(Gate,Meas_mode,Meas_range,Gmeasure(*),Gvsweep(*),Gsync(*),Gstatus(*),Gtime(*))
   Sweep_iv(Source,Meas_mode,Meas_range,Smeasure(*),Svsweep(*),Ssync(*),Sstatus(*),Stime(*))
   Sweep_iv(Bulk,Meas_mode,Meas_range,Bmeasure(*),Bvsweep(*),Bsync(*),Bstatus(*),Btime(*))
   Set_timestamp(0)
       !
            !
 Save_file:        !
   ON ERROR GOTO Nofile
   ASSIGN @File TO D_path$&"/"&D_file$&".csv";APPEND
   OFF ERROR 
            !
   OUTPUT @File USING "K,K";"Vds=";Vd;",";"Vbulk=";Vb
   OUTPUT @File USING "K,K";"Vgmin=";Vgmin;",";"Vgmax=";Vgmax;",";"Vgstep=";Vgstep
   OUTPUT @File USING "K,K";"Step Number";",";"Time";",";"Vgate";",";"Idrain";",";"Igate";",";"Isource";",";"Ibulk"
            !
   INTEGER I
   FOR I=1 TO Steps
     OUTPUT @File USING "K,K";I;",";Gtime(I);",";Gvsweep(I);",";Dmeasure(I);",";Gmeasure(I);",";Smeasure(I);",";Bmeasure(I)
   NEXT I
            !
   ASSIGN @File TO *
   GOTO End
       !
 Nofile:     !
   CREATE D_path$&"/"&D_file$&".csv",2
   GOTO Save_file
       !
 End:     !
   Disable_port
   Connect
 SUBEND
 Cv_r4t:SUB Cv_r4t(REAL Iforce,Spec,INTEGER Pins(*),Adc,REAL Iv,INTEGER Integ,REAL Vcomp,Hold,Ro,Istr,Ttf,Rf,R1)
 !***** DON'T REMOVE THIS LINE *************************************
 !
 !  Type : Algorithm
 !  Name : CV_R4t
 !  Vers : 1
 !  Desc : wat_standard 4 terminals resistance measurement
 !  Date : 12/14/2010
 !  Time : 09:23:43
 !  User : wat
 !
 !***** DON'T REMOVE THIS LINE *************************************
 !
 !  Input Variables:
 !
 !     #  Name            Type Size     Description
 !    --- --------------- ---- -------- --------------------------------
 !    Measurement Parameters:
 !      1 IFORCE          R    -        CURRENT TO FORCE
 !      2 SPEC            R    -        Resistor shift SPEC
 !
 !    Device Terminals:
 !      1 FH              I    -        Force high
 !      2 FL              I    -        Force low
 !      3 SH              I    -        Sense high
 !      4 SL              I    -        Sense low
 !
 !    Device Parameters:
 !      1 ADC             I    -        ADC TYPE (0:HI-SPEED, 1:HI-RESOL
 !      2 IV              R    -        SAMPLING NUMBER WHEN MANUAL INTE
 !      3 INTEG           I    -        INTEGRATION TIME (0:MAN. 1:S, 2:
 !      4 VCOMP           R    -        VOLTAGE COMPLIANCE
 !      5 HOLD            R    -        HOLD TIME
 !
 !  Output Variables:
 !
 !     #  Name            Type Size     Description
 !    --- --------------- ---- -------- --------------------------------
 !    Output Parameters:
 !      1 Ro              R    -        RESISTANCE OR RHO
 !      2 Istr            R    -        Istress
 !      3 TTF             R    -        fail time
 !      4 Rf              R    -        fail RESISTANCE
 !      5 R1              R    -        Istr 0s resistor
 !
 !***** DON'T REMOVE THIS LINE *************************************
   OPTION BASE 1                      !***** DON'T REMOVE THIS LINE *****
   DISP "in R4t"
                                      !
   INTEGER Fh,Fl,Sh,Sl,It
   REAL Vhi,Vlo,Rf1,Vm,Diff
   It=0
   Rf1=999
                                      !
   Fh=Pins(1)
   Fl=Pins(2)
   Sh=Pins(3)
   Sl=Pins(4)
                                      ! Connect device
   Connect(FNGnd,Fh,Fl,Sh,Sl)
   Wait_th(.1)
   Connect(FNPort(0,4),Fh)
   Connect(FNPort(0,1),Sh)
   Connect(FNPort(0,2),Sl)
                                      ! ADC mode
   Set_smu_ch(Fh,Adc,0)
   Set_adc(Adc,Integ,Iv)
   Set_smu_ch(Sh,Adc)
   Set_adc_v(Adc,Integ)
   Set_smu_ch(Sl,Adc)
   Set_adc_v(Adc,Integ)
     ! Set_wait_time(Ss,Sm)
                                      ! Force 0A to two terminals
   Force_i(Sh,0,0,20)
   Force_i(Sl,0,0,20)
                                      ! Spot measurement
   Force_i(Fh,Iforce,Iforce,Vcomp)
   Wait_th(Hold)
   Measure_v(Sh,Vhi,0)
   Measure_v(Sl,Vlo,0)
   Vm=ABS(Vhi-Vlo)
   Ro=Vm/Iforce
                                     !Spot measure End
   Istr=(-.1061*Ro+51.75)/1000
   IF Istr>.2 THEN GOTO En
                                    !Calcurate Istress End
   Connect(0,Fh)
   Connect(FNPort(0,4),Fh)
   Force_i(Fh,Istr,Istr,Vcomp)
   Ro=Ro+1.E-24
     ! avoid devied 0
                                    ! Force I stress End
                                    ! Start stress cycle
   FOR It=1 TO 300
     !   WAIT (1)
     Measure_v(Sh,Vhi,0)
     Measure_v(Sl,Vlo,0)
     Rf1=ABS(Vhi-Vlo)/Istr
     IF It=1 THEN R1=Rf1
     Diff=ABS((Rf1-R1)/(R1+1.E-24))
     IF Diff>Spec THEN GOTO En
     WAIT (1)
   NEXT It
                                   ! Stress cycle end
 En:     !
   Rf=Rf1
   Ttf=It-1
                                      ! R calculation
   PRINT "Ro=",Ro
   PRINT "istr=",Istr
   PRINT "Rf=",Rf
   PRINT "TTF=",Ttf
                                      ! Disable ports and pins
   Disable_port(FNPort(0,1),FNPort(0,2),FNPort(0,3))
   Connect(0,Fh,Fl,Sh,Sl)
 SUBEND
 Dibl:SUB Dibl(REAL Vd_lin,Vt_lin,Vd_sat,Vt_sat,Dibl)
 !***** DON'T REMOVE THIS LINE *************************************
 !
 !  Type : Algorithm
 !  Name : DIBL
 !  Vers : 1
 !  Desc : Calculate DIBL=(Vtlin-Vtsat)/(Vdsat-Vdlin)
 !  Date : 03/14/2002
 !  Time : 19:12:31
 !  User : wat
 !
 !***** DON'T REMOVE THIS LINE *************************************
 !
 !  Input Variables:
 !
 !     #  Name            Type Size     Description
 !    --- --------------- ---- -------- --------------------------------
 !    Measurement Parameters:
 !      1 VD_LIN          R    -
 !      2 VT_LIN          R    -
 !      3 VD_SAT          R    -
 !      4 VT_SAT          R    -
 !
 !  Output Variables:
 !
 !     #  Name            Type Size     Description
 !    --- --------------- ---- -------- --------------------------------
 !    Output Parameters:
 !      1 DIBL            R    -
 !
 !***** DON'T REMOVE THIS LINE *************************************
   OPTION BASE 1 !***** DON'T REMOVE THIS LINE *****
   DISP "in CALC_DIBL"
   Dibl=(Vt_lin-Vt_sat)/(Vd_sat-Vd_lin+1.E-20)
   PRINT "DIBL=";Dibl
 SUBEND
 Dibl_tb:SUB Dibl_tb(REAL Vd_lin,Vt_lin,Vd_sat,Vt_sat,Dibl)
 !***** DON'T REMOVE THIS LINE *************************************
 !
 !  Type : Algorithm
 !  Name : DIBL_TB
 !  Vers : 1
 !  Desc : Calculate DIBL=(Vtlin-Vtsat)/(Vdsat-Vdlin)
 !  Date : 03/14/2002
 !  Time : 19:12:31
 !  User : wat
 !
 !***** DON'T REMOVE THIS LINE *************************************
 !
 !  Input Variables:
 !
 !     #  Name            Type Size     Description
 !    --- --------------- ---- -------- --------------------------------
 !    Measurement Parameters:
 !      1 VD_LIN          R    -
 !      2 VT_LIN          R    -
 !      3 VD_SAT          R    -
 !      4 VT_SAT          R    -
 !
 !  Output Variables:
 !
 !     #  Name            Type Size     Description
 !    --- --------------- ---- -------- --------------------------------
 !    Output Parameters:
 !      1 DIBL            R    -
 !
 !***** DON'T REMOVE THIS LINE *************************************
   OPTION BASE 1 !***** DON'T REMOVE THIS LINE *****
   DISP "in CALC_DIBL"
   Dibl=(Vt_lin-Vt_sat)/(Vd_sat-Vd_lin+1.E-20)
   PRINT "DIBL=";Dibl
 SUBEND
 Discharge_i:SUB Discharge_i(REAL Vdcom,Vgcom,Vscom,Vbcom,Hold,INTEGER Pins(*))
 !***** DON'T REMOVE THIS LINE *************************************
 !
 !  Type : Algorithm
 !  Name : DISCHARGE_I
 !  Vers : 1
 !  Desc : Discharge device for V compliance
 !  Date : 10/15/2010
 !  Time : 15:32:05
 !  User : wat
 !
 !***** DON'T REMOVE THIS LINE *************************************
 !
 !  Input Variables:
 !
 !     #  Name            Type Size     Description
 !    --- --------------- ---- -------- --------------------------------
 !    Measurement Parameters:
 !      1 VDCOM           R    -        DRAIN V COMPLIANCE
 !      2 VGCOM           R    -        GATE V COMPLIANCE
 !      3 VSCOM           R    -        SOURCE V COMPLIANCE
 !      4 VBCOM           R    -        BULK V COMPLIANCE
 !      5 HOLD            R    -        HOLD TIME
 !
 !    Device Terminals:
 !      1 DRAIN           I    -        DRAIN TERMINAL
 !      2 GATE            I    -        GATE TERMINAL
 !      3 SOURCE          I    -        SOURCE TERMINAL
 !      4 BULK            I    -        WELL OR BULK
 !
 !  Output Variables:
 !
 !***** DON'T REMOVE THIS LINE *************************************
   OPTION BASE 1                      !***** DON'T REMOVE THIS LINE *****
   DISP "in DISCHARGE_DEVICE"
                                      !
   INTEGER Gate,Drain,Source,Bulk,Stat
                                      !
   Drain=Pins(1)
   Gate=Pins(2)
   Source=Pins(3)
   Bulk=Pins(4)
                                      ! Connect device
   Connect(FNPort(0,1),Drain)
   Connect(FNPort(0,2),Gate)
   Connect(FNPort(0,3),Source)
   Connect(FNPort(0,4),Bulk)
                                   ! Discharge device for I compliance
   Force_i(Drain,0,0,Vdcom)
   Force_i(Gate,0,0,Vgcom)
   Force_i(Source,0,0,Vscom)
   Force_i(Bulk,0,0,Vbcom)
                                       !Wait hold time
   Wait_th(Hold)
                                      !
                                      !Disable ports and pins
   Disable_port
   Connect
 SUBEND
 Discharge_pc:SUB Discharge_pc
 !***** DON'T REMOVE THIS LINE *************************************
 !
 !  Type : Algorithm
 !  Name : DISCHARGE_PC
 !  Vers : 1
 !  Desc : Description for this Algorithm spec.
 !  Date : 11/19/2004
 !  Time : 14:30:41
 !  User : wat
 !
 !***** DON'T REMOVE THIS LINE *************************************
 !
 !  Input Variables:
 !
 !  Output Variables:
 !
 !***** DON'T REMOVE THIS LINE *************************************
   OPTION BASE 1 !***** DON'T REMOVE THIS LINE *****
   Connect_th(FNPort(0,9),1,49)
   Wait_th(.1)
   Connect
 SUBEND
 Dummy:SUB Dummy(REAL Input,Offset,Output)
 !***** DON'T REMOVE THIS LINE *************************************
 !
 !  Type : Algorithm
 !  Name : DUMMY
 !  Vers : 1
 !  Desc : Output to data file
 !  Date : 01/15/2003
 !  Time : 14:41:25
 !  User : wat
 !
 !***** DON'T REMOVE THIS LINE *************************************
 !
 !  Input Variables:
 !
 !     #  Name            Type Size     Description
 !    --- --------------- ---- -------- --------------------------------
 !    Measurement Parameters:
 !      1 Input           R    -
 !      2 Offset          R    -
 !
 !  Output Variables:
 !
 !     #  Name            Type Size     Description
 !    --- --------------- ---- -------- --------------------------------
 !    Output Parameters:
 !      1 Output          R    -
 !
 !***** DON'T REMOVE THIS LINE *************************************
   OPTION BASE 1                  !***** DON'T REMOVE THIS LINE *****
   Output=Input+Offset
 SUBEND
 Erase:SUB Erase(REAL Vd,Vsg,Vcg,Vs,Vb,Width,Delay,Leading,Trailing,INTEGER Pins(*),Floating,Type,REAL Amplitude2,Base,Load,Pno,Period)
 !***** DON'T REMOVE THIS LINE *************************************
 !
 !  Type : Algorithm
 !  Name : Erase
 !  Vers : 1
 !  Desc : Send EE cell erase pulse
 !  Date : 08/20/2002
 !  Time : 14:29:35
 !  User : wat
 !
 !***** DON'T REMOVE THIS LINE *************************************
 !
 !  Input Variables:
 !
 !     #  Name            Type Size     Description
 !    --- --------------- ---- -------- --------------------------------
 !    Measurement Parameters:
 !      1 VD              R    -
 !      2 VSG             R    -
 !      3 VCG             R    -        AMPLITUDE1
 !      4 VS              R    -
 !      5 VB              R    -
 !      6 WIDTH           R    -
 !      7 DELAY           R    -
 !      8 LEADING         R    -
 !      9 TRAILING        R    -
 !
 !    Device Terminals:
 !      1 DRAIN           I    -        DRAIN TERMINAL
 !      2 SGATE           I    -        SELECT GATE
 !      3 CGATE           I    -        CONTROL GATE
 !      4 SOURCE          I    -        SOURCE
 !      5 BULK            I    -        WELL OR BULK
 !
 !    Device Parameters:
 !      1 FLOATING        I    -        -1 for floating and 1 for 0v
 !      2 TYPE            I    -
 !      3 AMPLITUDE2      R    -
 !      4 BASE            R    -
 !      5 LOAD            R    -
 !      6 PNO             R    -
 !      7 PERIOD          R    -
 !
 !  Output Variables:
 !
 !***** DON'T REMOVE THIS LINE *************************************
   OPTION BASE 1                  !***** DON'T REMOVE THIS LINE *****
   INTEGER Drain,Sgate,Cgate,Source,Bulk
     !
   Drain=Pins(1)
   Sgate=Pins(2)
   Cgate=Pins(3)
   Source=Pins(4)
   Bulk=Pins(5)
     ! Connect
   Connect(FNGnd,Drain,Sgate,Cgate,Source,Bulk)
     ! Folating or 0V
   IF Floating=-1 THEN 
     Connect(0,Source)
     Connect(FNPort(0,1),Sgate)
     Connect(FNPort(3,1),Cgate)
     !
   ELSE
     Connect(FNPort(0,1),Sgate)
     Connect(FNPort(3,1),Cgate)
     ! Force Voltage
     Force_v(Sgate,Vsg,Vsg,.1)
   END IF
     ! Set pulse level: 1 for 2-level and 2 for 3-level
   Set_type_pg(Cgate,Type)
     ! Set pulse voltage and impedance
   Set_level_pg(Cgate,Vcg,Amplitudte2,Base,Load)
     ! Set pulse timing
   Set_time_pg(Cgate,Width,Delay,Leading,Trailing)
     ! Force pulse
   Force_pg(Pno,Period)
     !
   Disable_port
   Connect
 SUBEND
 Erase_tb:SUB Erase_tb(REAL Vd,Vsg,Vcg,Vs,Vb,Width,Delay,Leading,Trailing,INTEGER Pins(*),Floating,Type,REAL Amplitude2,Base,Load,Pno,Period)
 !***** DON'T REMOVE THIS LINE *************************************
 !
 !  Type : Algorithm
 !  Name : Erase_TB
 !  Vers : 1
 !  Desc : Send EE cell erase pulse
 !  Date : 08/20/2002
 !  Time : 14:29:35
 !  User : wat
 !
 !***** DON'T REMOVE THIS LINE *************************************
 !
 !  Input Variables:
 !
 !     #  Name            Type Size     Description
 !    --- --------------- ---- -------- --------------------------------
 !    Measurement Parameters:
 !      1 VD              R    -
 !      2 VSG             R    -
 !      3 VCG             R    -        AMPLITUDE1
 !      4 VS              R    -
 !      5 VB              R    -
 !      6 WIDTH           R    -
 !      7 DELAY           R    -
 !      8 LEADING         R    -
 !      9 TRAILING        R    -
 !
 !    Device Terminals:
 !      1 DRAIN           I    -        DRAIN TERMINAL
 !      2 SGATE           I    -        SELECT GATE
 !      3 CGATE           I    -        CONTROL GATE
 !      4 SOURCE          I    -        SOURCE
 !      5 BULK            I    -        WELL OR BULK
 !
 !    Device Parameters:
 !      1 FLOATING        I    -        -1 for floating and 1 for 0v
 !      2 TYPE            I    -
 !      3 AMPLITUDE2      R    -
 !      4 BASE            R    -
 !      5 LOAD            R    -
 !      6 PNO             R    -
 !      7 PERIOD          R    -
 !
 !  Output Variables:
 !
 !***** DON'T REMOVE THIS LINE *************************************
   OPTION BASE 1                  !***** DON'T REMOVE THIS LINE *****
   INTEGER Drain,Sgate,Cgate,Source,Bulk
     !
   Drain=Pins(1)
   Sgate=Pins(2)
   Cgate=Pins(3)
   Source=Pins(4)
   Bulk=Pins(5)
     ! Connect
   Connect(FNGnd,Drain,Sgate,Cgate,Source,Bulk)
     ! Folating or 0V
   IF Floating=-1 THEN 
     Connect(0,Source)
     Connect(FNPort(0,1),Sgate)
     Connect(FNPort(3,1),Cgate)
     !
   ELSE
     Connect(FNPort(0,1),Sgate)
     Connect(FNPort(3,1),Cgate)
     ! Force Voltage
     Force_v(Sgate,Vsg,Vsg,.1)
   END IF
     ! Set pulse level: 1 for 2-level and 2 for 3-level
   Set_type_pg(Cgate,Type)
     ! Set pulse voltage and impedance
   Set_level_pg(Cgate,Vcg,Amplitudte2,Base,Load)
     ! Set pulse timing
   Set_time_pg(Cgate,Width,Delay,Leading,Trailing)
     ! Force pulse
   Force_pg(Pno,Period)
     !
   Disable_port
   Connect
 SUBEND
 Fisv:SUB Fisv(REAL Ih,INTEGER Pins(*),Adc,REAL Iv,INTEGER Integ,REAL Vhcomp,Hold,Vh)
 !***** DON'T REMOVE THIS LINE *************************************
 !
 !  Type : Algorithm
 !  Name : Fisv
 !  Vers : 1
 !  Desc : Force Id, measure Vd
 !  Date : 10/28/2002
 !  Time : 14:21:59
 !  User : wat
 !
 !***** DON'T REMOVE THIS LINE *************************************
 !
 !  Input Variables:
 !
 !     #  Name            Type Size     Description
 !    --- --------------- ---- -------- --------------------------------
 !    Measurement Parameters:
 !      1 IH              R    -        FORCE CURRENT TO DRAIN
 !
 !    Device Terminals:
 !      1 H               I    -
 !      2 L               I    -
 !      3 Bulk            I    -        For three terminal measurement,
 !
 !    Device Parameters:
 !      1 ADC             I    -        ADC TYPE (0:HI-SPEED, 1:HI-RESOL
 !      2 IV              R    -        SAMPLING NUMBER WHEN MANUAL INTE
 !      3 INTEG           I    -        INTEGRATION TIME (0:MAN, 1:S, 2:
 !      4 VHCOMP          R    -        DRAIN VOLTAGE COMPLIANCE
 !      5 HOLD            R    -        HOLD TIME BEFORE STARTS SWEEP ME
 !
 !  Output Variables:
 !
 !     #  Name            Type Size     Description
 !    --- --------------- ---- -------- --------------------------------
 !    Output Parameters:
 !      1 VH              R    -        DRAIN VOLTAGE
 !
 !***** DON'T REMOVE THIS LINE *************************************
   OPTION BASE 1                   !***** DON'T REMOVE THIS LINE *****
   DISP "in Fisv"
   INTEGER H,L,Bulk,Stat
      !
   H=Pins(1)
   L=Pins(2)
   Bulk=Pins(3)
  !
   IF Bulk>0 THEN 
     Connect(FNGnd,Bulk)
   END IF
      ! Connect
   Connect(FNPort(0,2),H)
   Connect(FNGnd,L)
      ! ADC mode
   Set_smu_ch(H,Adc,0)
   Set_adc(Adc,Integ,Iv)
  ! Set_wait_time(Ss,Sm)
      ! Perform measurement
   Force_i(H,Ih,Ih,Vhcomp)
   Wait_th(Hold)
   Measure_v(H,Vh,0)
      !
   Port_status(H,Stat)
   IF Stat<>0 THEN Vh=Vhcomp
   PRINT "Vh=";Vh,"   Stat=";Stat
      ! Disconnect
   Disable_port
   Connect
  !
 SUBEND
 Fisv_cis:SUB Fisv_cis(REAL Il,Vh,Vb,INTEGER Pins(*),Adc,REAL Iv,INTEGER Integ,REAL Vhcomp,Hold,Vl)
 !***** DON'T REMOVE THIS LINE *************************************
 !
 !  Type : Algorithm
 !  Name : Fisv_CIS
 !  Vers : 1
 !  Desc : Force Id, measure Vd
 !  Date : 08/06/2013
 !  Time : 16:57:02
 !  User : wat
 !
 !***** DON'T REMOVE THIS LINE *************************************
 !
 !  Input Variables:
 !
 !     #  Name            Type Size     Description
 !    --- --------------- ---- -------- --------------------------------
 !    Measurement Parameters:
 !      1 IL              R    -        FORCE CURRENT TO DRAIN
 !      2 VH              R    -        FORCE VOLT TO HIGH
 !      3 VB              R    -        FORCE VOLT TO HIGH
 !
 !    Device Terminals:
 !      1 H               I    -
 !      2 L               I    -
 !      3 Bulk            I    -        For three terminal measurement,
 !
 !    Device Parameters:
 !      1 ADC             I    -        ADC TYPE (0:HI-SPEED, 1:HI-RESOL
 !      2 IV              R    -        SAMPLING NUMBER WHEN MANUAL INTE
 !      3 INTEG           I    -        INTEGRATION TIME (0:MAN, 1:S, 2:
 !      4 VHCOMP          R    -        DRAIN VOLTAGE COMPLIANCE
 !      5 HOLD            R    -        HOLD TIME BEFORE STARTS SWEEP ME
 !
 !  Output Variables:
 !
 !     #  Name            Type Size     Description
 !    --- --------------- ---- -------- --------------------------------
 !    Output Parameters:
 !      1 VL              R    -        DRAIN VOLTAGE
 !
 !***** DON'T REMOVE THIS LINE *************************************
   OPTION BASE 1                       !***** DON'T REMOVE THIS LINE *****
   DISP "in Fisv"
   INTEGER H,L,Bulk,Stat
                                      !
   H=Pins(1)
   L=Pins(2)
   Bulk=Pins(3)
      !
   IF Bulk>0 THEN 
     Connect(FNGnd,Bulk)
   END IF
                                      ! Connect
   Connect(FNPort(0,2),H)
   Connect(FNPort(0,1),L)
   Set_smu_ch(L,Adc,0)                ! ADC mode
   Set_smu_ch(H,Adc,0)
   Set_adc(Adc,Integ,Iv)
      ! Set_wait_time(Ss,Sm)
   Force_i(L,Il,Il,.01)               ! Perform measurement
   Force_v(H,Vh,Vh,.01)
   Wait_th(Hold)
   Measure_v(L,Vl,0)
                                      !
   Port_status(H,Stat)
   IF Stat<>0 THEN Vl=Vhcomp
   PRINT "Vl=";Vl,"   Stat=";Stat
                                      ! Disconnect
   Disable_port
   Connect
      !
 SUBEND
 Fisv_cis_swp:SUB Fisv_cis_swp(REAL Il,Vh,Vb,INTEGER Pins(*),Adc,REAL Iv,INTEGER Integ,REAL Vhcomp,Hold,Vl)
 !***** DON'T REMOVE THIS LINE *************************************
 !
 !  Type : Algorithm
 !  Name : Fisv_CIS_SWP
 !  Vers : 1
 !  Desc : Force Id, measure Vd
 !  Date : 08/06/2013
 !  Time : 16:57:02
 !  User : wat
 !
 !***** DON'T REMOVE THIS LINE *************************************
 !
 !  Input Variables:
 !
 !     #  Name            Type Size     Description
 !    --- --------------- ---- -------- --------------------------------
 !    Measurement Parameters:
 !      1 IL              R    -        FORCE CURRENT TO DRAIN
 !      2 VH              R    -        FORCE VOLT TO HIGH
 !      3 VB              R    -        FORCE VOLT TO HIGH
 !
 !    Device Terminals:
 !      1 H               I    -
 !      2 L               I    -
 !      3 Bulk            I    -        For three terminal measurement,
 !
 !    Device Parameters:
 !      1 ADC             I    -        ADC TYPE (0:HI-SPEED, 1:HI-RESOL
 !      2 IV              R    -        SAMPLING NUMBER WHEN MANUAL INTE
 !      3 INTEG           I    -        INTEGRATION TIME (0:MAN, 1:S, 2:
 !      4 VHCOMP          R    -        DRAIN VOLTAGE COMPLIANCE
 !      5 HOLD            R    -        HOLD TIME BEFORE STARTS SWEEP ME
 !
 !  Output Variables:
 !
 !     #  Name            Type Size     Description
 !    --- --------------- ---- -------- --------------------------------
 !    Output Parameters:
 !      1 VL              R    -        DRAIN VOLTAGE
 !
 !***** DON'T REMOVE THIS LINE *************************************
   OPTION BASE 1                        !***** DON'T REMOVE THIS LINE *****
   DISP "in Fisv"
   INTEGER H,L,Bulk,Stat,Nstep,I
                                       !
   H=Pins(1)
   L=Pins(2)
   Bulk=Pins(3)
       !
   IF Bulk>0 THEN 
     Connect(FNGnd,Bulk)
   END IF
                                       ! Connect
   Connect(FNPort(0,2),H)
   Connect(FNPort(0,1),L)
   Set_smu_ch(L,Adc,0)                 ! ADC mode
   Set_smu_ch(H,Adc,0)
   Set_adc(Adc,Integ,Iv)
       ! Set_wait_time(Ss,Sm)
   Force_i(L,Il,Il,Vhcomp)
   FOR I=0 TO 100
     Vlh=.05*I
     Force_v(H,Vlh,Vlh,.01)              ! Perform measurement
     Wait_th(Hold)
     Measure_v(L,Vlf,0)
                                       !
     !\Port_status(H,Stat)
      !IF Stat<>0 THEN Vl=Vhcomp
     PRINT "Vh=";Vlh,"vlf=";Vlf
     IF Vlh>=Vh OR I=100 THEN GOTO Break
   NEXT I
 Break:       !
   Vl=Vlf
                                       ! Disconnect
   Disable_port
   Connect
       !
 SUBEND
 Fisv_tb:SUB Fisv_tb(REAL Ih,INTEGER Pins(*),Adc,REAL Iv,INTEGER Integ,REAL Vhcomp,Hold,Mode,Vh)
 !***** DON'T REMOVE THIS LINE *************************************
 !
 !  Type : Algorithm
 !  Name : Fisv_TB
 !  Vers : 1
 !  Desc : Force Id, measure Vd
 !  Date : 09/01/2014
 !  Time : 14:40:17
 !  User : wat
 !
 !***** DON'T REMOVE THIS LINE *************************************
 !
 !  Input Variables:
 !
 !     #  Name            Type Size     Description
 !    --- --------------- ---- -------- --------------------------------
 !    Measurement Parameters:
 !      1 IH              R    -        FORCE CURRENT TO DRAIN
 !
 !    Device Terminals:
 !      1 H               I    -        Current force terminal
 !      2 L               I    -        SMU or GROUND
 !      3 Bulk            I    -        For three terminal measurement,
 !
 !    Device Parameters:
 !      1 ADC             I    -        ADC TYPE (0:HI-SPEED, 1:HI-RESOL
 !      2 IV              R    -        SAMPLING NUMBER WHEN MANUAL INTE
 !      3 INTEG           I    -        INTEGRATION TIME (0:MAN, 1:S, 2:
 !      4 VHCOMP          R    -        H  VOLTAGE COMPLIANCE
 !      5 HOLD            R    -        HOLD TIME BEFORE STARTS  MEASURE
 !      6 MODE            R    -        0: SMU+GROUND; 1:SMU+SMU
 !
 !  Output Variables:
 !
 !     #  Name            Type Size     Description
 !    --- --------------- ---- -------- --------------------------------
 !    Output Parameters:
 !      1 VH              R    -        H VOLTAGE
 !
 !***** DON'T REMOVE THIS LINE *************************************
   OPTION BASE 1                   !***** DON'T REMOVE THIS LINE *****
   DISP "in Fisv_TB"
   INTEGER H,L,Bulk,Stat
      !
   H=Pins(1)
   L=Pins(2)
   Bulk=Pins(3)
  !
   IF Bulk>0 THEN 
     Connect(FNGnd,Bulk)
   END IF
   Connect(FNPort(0,9),H,L)
   Wait_th(Hold)
   Connect
   IF Mode=1 THEN 
     Connect(FNPort(0,5),L)
     Force_v(L,0,0,.1)
     Wait_th(.001)
   END IF
      ! Connect
   Connect(FNPort(0,2),H)
   IF Mode=0 THEN 
     Connect(FNGnd,L)
   END IF
      ! ADC mode
   Set_smu_ch(H,Adc,0)
   Set_adc(Adc,Integ,Iv)
  ! Set_wait_time(Ss,Sm)
      ! Perform measurement
   Force_i(H,Ih,Ih,Vhcomp)
   Wait_th(Hold)
   Measure_v(H,Vh,0)
      !
   Port_status(H,Stat)
   IF Stat<>0 THEN Vh=Vhcomp
   PRINT "Vh=";Vh,"   Stat=";Stat
      ! Disconnect
 Disconnect:                        !disable used ports, disconnect pins
   Disable_port
   Connect
  !
 SUBEND
 Fvsi:SUB Fvsi(REAL Vh,INTEGER Pins(*),Adc,REAL Iv,INTEGER Integ,REAL Ihcomp,Hold,Ih)
 !***** DON'T REMOVE THIS LINE *************************************
 !
 !  Type : Algorithm
 !  Name : Fvsi
 !  Vers : 1
 !  Desc : force Vd, measure Id.
 !  Date : 08/06/2002
 !  Time : 10:20:58
 !  User : wat
 !
 !***** DON'T REMOVE THIS LINE *************************************
 !
 !  Input Variables:
 !
 !     #  Name            Type Size     Description
 !    --- --------------- ---- -------- --------------------------------
 !    Measurement Parameters:
 !      1 VH              R    -        FORCE CURRENT TO DRAIN
 !
 !    Device Terminals:
 !      1 H               I    -
 !      2 L               I    -
 !
 !    Device Parameters:
 !      1 ADC             I    -        ADC TYPE (0:HI-SPEED, 1:HI-RESOL
 !      2 IV              R    -        SAMPLING NUMBER WHEN MANUAL INTE
 !      3 INTEG           I    -        INTEGRATION TIME (0:MAN, 1:S, 2:
 !      4 IHCOMP          R    -        DRAIN VOLTAGE COMPLIANCE
 !      5 HOLD            R    -        HOLD TIME BEFORE STARTS SWEEP ME
 !
 !  Output Variables:
 !
 !     #  Name            Type Size     Description
 !    --- --------------- ---- -------- --------------------------------
 !    Output Parameters:
 !      1 IH              R    -        DRAIN VOLTAGE
 !
 !***** DON'T REMOVE THIS LINE *************************************
   OPTION BASE 1                   !***** DON'T REMOVE THIS LINE *****
   DISP "in Fvsi"
   INTEGER H,L,Stat
   H=Pins(1)
   L=Pins(2)
      ! Connect
   Connect(FNGnd,H,L)
   Connect(FNPort(0,2),H)
      ! ADC mode
   Set_smu_ch(H,Adc,0)
   Set_adc(Adc,Integ,Iv)
  ! Set_wait_time(Ss,Sm)
      ! Perform measurement
   Force_v(H,Vh,Vh,Ihcomp)
   Wait_th(Hold)
   Measure_i(H,Ih,0)
  !  Ih=ABS(Ih)
   Port_status(H,Stat)
   IF Pst<>0 THEN Ih=Ihcomp
   PRINT "Ih=";Ih,"   Stat=";Stat
      ! Disable ports and pins
   Disable_port
   Connect
 SUBEND
 Fvsi_tb:SUB Fvsi_tb(REAL Vh,Vl,INTEGER Unit,REAL Wd,Ln,Bridge,INTEGER Pins(*),Adc,REAL Iv,INTEGER Integ,REAL Ihcomp,Hold,Mode,Irng,Mode1,Ih)
 !***** DON'T REMOVE THIS LINE *************************************
 !
 !  Type : Algorithm
 !  Name : Fvsi_TB
 !  Vers : 1
 !  Desc : Force V, measure I
 !       : 2014 base on Fvsi set up TB alg
 !  Date : 12/11/2014
 !  Time : 08:41:38
 !  User : wat
 !
 !***** DON'T REMOVE THIS LINE *************************************
 !
 !  Input Variables:
 !
 !     #  Name            Type Size     Description
 !    --- --------------- ---- -------- --------------------------------
 !    Measurement Parameters:
 !      1 VH              R    -        H FORCE VOLTAGE
 !      2 VL              R    -        L FORCE VOLTAGE
 !      3 UNIT            I    -        0 A; 1 mA; 2 uA; 3 pA; 4 LOG10
 !      4 WD              R    -        Ih*WD
 !      5 LN              R    -        Ih/LN
 !      6 BRIDGE          R    -        0: in device leakage ; 1: Two de
 !
 !    Device Terminals:
 !      1 H               I    -        H terminal V force
 !      2 L               I    -        L terminal V force
 !      3 Bulk            I    -        For three terminal measurement,
 !
 !    Device Parameters:
 !      1 ADC             I    -        ADC TYPE (0:HI-SPEED, 1:HI-RESOL
 !      2 IV              R    -        SAMPLING NUMBER WHEN MANUAL INTE
 !      3 INTEG           I    -        INTEGRATION TIME (0:MAN, 1:S, 2:
 !      4 IHCOMP          R    -        H CURRENT COMPLANCE
 !      5 HOLD            R    -        HOLD TIME BEFORE STARTS  MEASURE
 !      6 MODE            R    -        0: SMU+GROUND; 1:SMU+SMU
 !      7 IRNG            R    -        CURRENT MEASURE RINGE
 !      8 MODE1           R    -        0 Auto measure Ih=Ih*Wd/Ln; 1 Ih
 !
 !  Output Variables:
 !
 !     #  Name            Type Size     Description
 !    --- --------------- ---- -------- --------------------------------
 !    Output Parameters:
 !      1 IH              R    -        H CURRENT
 !
 !***** DON'T REMOVE THIS LINE *************************************
   OPTION BASE 1                   !***** DON'T REMOVE THIS LINE *****
   DISP "in Fvsi_TB"
   INTEGER H,L,Bulk,Stat
       !
   H=Pins(1)
   L=Pins(2)
   Bulk=Pins(3)
  !
   IF Bulk>0 THEN 
     Connect(FNGnd,Bulk)
   END IF
   Connect(FNPort(0,9),H,L)
   Wait_th(.001)
   Connect
   IF Mode=1 THEN 
     Connect(FNPort(0,1),L)
     Force_v(L,Vl,Vl,.1)
     Wait_th(.005)
   END IF
       ! Connect
   Connect(FNPort(0,2),H)
   IF Mode=0 THEN 
     Connect(FNGnd,L)
   END IF
       ! ADC mode
   Set_smu_ch(H,Adc,0)
   Set_adc(Adc,Integ,Iv)
  ! Set_wait_time(Ss,Sm)
       ! Perform measurement
   Force_v(H,Vh,Vh,Ihcomp)
   Wait_th(Hold)
   IF Bridge=0 THEN 
     Measure_i(H,Ih,Irng)
   END IF
   IF Bridge=1 THEN 
     Measure_i(H,Ih,0)
   END IF
       !
   Port_status(H,Stat)
   IF Stat<>0 THEN Ih=Ihcomp
   IF Mode1=1 THEN 
     Ih=ABS(Ih)*Wd/Ln
   END IF
   IF Mode1=-1 THEN 
     Ih=-ABS(Ih)*Wd/Ln
   END IF
   Ih=Ih*Wd/Ln
   SELECT Unit
   CASE 0
     Ih=Ih                            ! Uint=A
   CASE 1
     Ih=Ih*1.E+3                      !Uint=mA
   CASE 2
     Ih=Ih*1.E+6                      !Unit=uA
   CASE 3
     Ih=Ih*1.E+12                     !Unit=pA
   CASE 4
     Ih=LGT(ABS(Ih)+1.E-30)           !Unit=LOG10
   END SELECT
   PRINT "Ih=";Ih,"   Stat=";Stat
       ! Disconnect
 Disconnect:                         !disable used ports, disconnect pins
   Disable_port
   Connect
  !
 SUBEND
 Gamma:SUB Gamma(REAL Vt_vb0,Vt_vb,Vb,Phi,Gamma)
 !***** DON'T REMOVE THIS LINE *************************************
 !
 !  Type : Algorithm
 !  Name : Gamma
 !  Vers : 1
 !  Desc : Gamma=ABS(Vt(Vb)-Vt(Vb=0))/[(ABS(VB=2.7)+2*phi)^0.5-(2*ph
 !       : i)^0.5]
 !       :  phi=0.443744
 !  Date : 08/07/2002
 !  Time : 22:41:17
 !  User : wat
 !
 !***** DON'T REMOVE THIS LINE *************************************
 !
 !  Input Variables:
 !
 !     #  Name            Type Size     Description
 !    --- --------------- ---- -------- --------------------------------
 !    Measurement Parameters:
 !      1 VT_VB0          R    -        Vtlin at Vb=0
 !      2 VT_VB           R    -        Vtlin at bias Vb
 !      3 VB              R    -        Bias voltage on Bulk
 !
 !    Device Parameters:
 !      1 PHI             R    -
 !
 !  Output Variables:
 !
 !     #  Name            Type Size     Description
 !    --- --------------- ---- -------- --------------------------------
 !    Output Parameters:
 !      1 GAMMA           R    -
 !
 !***** DON'T REMOVE THIS LINE *************************************
   OPTION BASE 1 !***** DON'T REMOVE THIS LINE *****
   DISP "in Gamma"
   IF Vb<>0 THEN 
     Gamma=ABS(Vt_vb-Vt_vb0)/((ABS(Vb)+2*Phi)^.5-(2*Phi)^.5)
   ELSE
     Gamma=999
   END IF
   PRINT "Gamma=",Gamma
 SUBEND
 Gamma_tb:SUB Gamma_tb(REAL Vt_vb0,Vt_vb,Vb,Phi,Gamma)
 !***** DON'T REMOVE THIS LINE *************************************
 !
 !  Type : Algorithm
 !  Name : Gamma_TB
 !  Vers : 1
 !  Desc : Gamma=ABS(Vt(Vb)-Vt(Vb=0))/[(ABS(VB=2.7)+2*phi)^0.5-(2*ph
 !       : i)^0.5]
 !       : phi=0.443744
 !  Date : 08/07/2002
 !  Time : 22:41:17
 !  User : wat
 !
 !***** DON'T REMOVE THIS LINE *************************************
 !
 !  Input Variables:
 !
 !     #  Name            Type Size     Description
 !    --- --------------- ---- -------- --------------------------------
 !    Measurement Parameters:
 !      1 VT_VB0          R    -        Vtlin at Vb=0
 !      2 VT_VB           R    -        Vtlin at bias Vb
 !      3 VB              R    -        Bias voltage on Bulk
 !
 !    Device Parameters:
 !      1 PHI             R    -
 !
 !  Output Variables:
 !
 !     #  Name            Type Size     Description
 !    --- --------------- ---- -------- --------------------------------
 !    Output Parameters:
 !      1 GAMMA           R    -
 !
 !***** DON'T REMOVE THIS LINE *************************************
   OPTION BASE 1 !***** DON'T REMOVE THIS LINE *****
   DISP "in Gamma"
   IF Vb<>0 THEN 
     Gamma=ABS(Vt_vb-Vt_vb0)/((ABS(Vb)+2*Phi)^.5-(2*Phi)^.5)
   ELSE
     Gamma=999
   END IF
   PRINT "Gamma=",Gamma
 SUBEND
 I_v_diode:SUB I_v_diode(REAL Vmin,Vmax,Vstep,INTEGER Pins(*),Adc,REAL Iv,INTEGER Integ,REAL Hold,D_path$,D_file$)
 !***** DON'T REMOVE THIS LINE *************************************
 !
 !  Type : Algorithm
 !  Name : I_V_DIODE
 !  Vers : 1
 !  Desc : Id vs Vd curve
 !  Date : 04/18/2023
 !  Time : 17:47:23
 !  User : specs
 !
 !***** DON'T REMOVE THIS LINE *************************************
 !
 !  Input Variables:
 !
 !     #  Name            Type Size     Description
 !    --- --------------- ---- -------- --------------------------------
 !    Measurement Parameters:
 !      1 VMIN            R    -        START SWEEP VOLTAGE ON HIGH
 !      2 VMAX            R    -        END SWEEP VOLTAGE ON HIGH
 !      3 VSTEP           R    -
 !
 !    Device Terminals:
 !      1 HIGH            I    -
 !      2 LOW             I    -
 !
 !    Device Parameters:
 !      1 ADC             I    -        1,ADC TYPE (0:HI-SPEED, 1:HI-RES
 !      2 IV              R    -        SAMPLING NUMBER WHEN MANUAL INTE
 !      3 INTEG           I    -        1,2,3,INTEGRATION TIME (0:MAN, 1
 !      4 HOLD            R    -        HOLD TIME BEFORE STARTS SWEEP ME
 !      5 D_path          S    -
 !      6 D_file          S    -
 !
 !  Output Variables:
 !
 !***** DON'T REMOVE THIS LINE *************************************
   OPTION BASE 1
             !
   INTEGER Steps
   Steps=ABS(Vmax-Vmin)/Vstep+1
   INTEGER High,Low
   High=Pins(1)
   Low=Pins(2)
   Connect(FNGnd,High,Low)
   Connect(FNPort(0,1),High)
   Connect(FNPort(0,2),Low)
         !
  !Set_smu_ch(High,Adc)
   Set_adc(Adc,Integ,Iv)
                                                 !
         !
   INTEGER Mode,Stop_mode
   REAL Range,Delay,Compliance,P_comp
         !
   Mode=1
   Range=0
   Delay=0.
   Compliance=.1
   P_comp=2
   Stop_mode=1
         !
   PRINT "high=";High,"low=";Low
   Set_iv(High,Mode,Range,Vmin,Vmax,Steps,Hold,Delay,Compliance,P_comp,Stop_mode)
         !
   REAL Im(1500),Vsweep(1500)
   REAL Meas_range
         !
   INTEGER Meas_mode
   Meas_mode=2
   Sweep_iv(High,Meas_mode,Meas_range,Im(*),Vsweep(*))
         !
         !
 Save_file:              !
   ON ERROR GOTO Nofile
   ASSIGN @File TO D_path$&"/"&D_file$&".csv";APPEND
   OFF ERROR 
   OUTPUT @File USING "K,K";"Vmin=";Vmin;",";"Vmax=";Vmax;",";"Vstep=";Vstep
   OUTPUT @File USING "K,K";"Step Number";",";"V";",";"Im"
              !
   INTEGER I
   FOR I=1 TO Steps
     OUTPUT @File USING "K,K";I;",";Vsweep(I);",";Im(I)
   NEXT I
              !
   ASSIGN @File TO *
         !
         !
   Disable_port
   Connect
                                                 !
   SUBEXIT
 Nofile:       !
   CREATE D_path$&"/"&D_file$&".csv",2
   GOTO Save_file
 SUBEND
 Id_vd_loop:SUB Id_vd_loop(REAL Vgmin,Vgmax,Vgstep,Vdmin,Vdmax,Vdstep,Vs,Vb,INTEGER Pins(*),Adc,REAL Iv,INTEGER Integ,REAL Hold,D_path$,D_file$)
 !***** DON'T REMOVE THIS LINE *************************************
 !
 !  Type : Algorithm
 !  Name : Id_Vd_loop
 !  Vers : 1
 !  Desc : Id vs Vd curve
 !  Date : 04/06/2023
 !  Time : 16:30:59
 !  User : specs
 !
 !***** DON'T REMOVE THIS LINE *************************************
 !
 !  Input Variables:
 !
 !     #  Name            Type Size     Description
 !    --- --------------- ---- -------- --------------------------------
 !    Measurement Parameters:
 !      1 VGMIN           R    -        START  VOLTAGE BIAS ON HIGH
 !      2 VGMAX           R    -        END  VOLTAGE BIAS ON HIGH
 !      3 VGSTEP          R    -
 !      4 VDMIN           R    -        START SWEEP VOLTAGE ON HIGH
 !      5 VDMAX           R    -        END SWEEP VOLTAGE ON HIGH
 !      6 VDSTEP          R    -
 !      7 VS              R    -        VOLTAGE ON SOURCE
 !      8 VB              R    -        VOLTAGE ON BULK
 !
 !    Device Terminals:
 !      1 DRAIN           I    -
 !      2 GATE            I    -
 !      3 SOURCE          I    -
 !      4 BULK            I    -
 !
 !    Device Parameters:
 !      1 ADC             I    -        1,ADC TYPE (0:HI-SPEED, 1:HI-RES
 !      2 IV              R    -        SAMPLING NUMBER WHEN MANUAL INTE
 !      3 INTEG           I    -        1,2,3,INTEGRATION TIME (0:MAN, 1
 !      4 HOLD            R    -        HOLD TIME BEFORE STARTS SWEEP ME
 !      5 D_path          S    -
 !      6 D_file          S    -
 !
 !  Output Variables:
 !
 !***** DON'T REMOVE THIS LINE *************************************
   OPTION BASE 1
             !
   INTEGER Steps
   Steps=ABS(Vdmax-Vdmin)/Vdstep+1
    !--------------------------------------------------------------------------------
    !Set Bias                            Edited By AndyWang  2022/11/25
    !--------------------------------------------------------------------------------
   REAL Vg(1500)
  !PAUSE
   INTEGER Vg_steps
   Vg_steps=(Vgmax-Vgmin)/Vgstep
   Vg1=Vgmin
   PRINT "vg_steps=";Vg_steps
   IF Vg_steps>0 THEN 
     FOR I=1 TO ABS(Vg_steps)
       Vg(I)=Vg1
       PRINT "vg=";Vg(I)
       IF Vg(I)>Vgmax THEN 
         GOTO Go_on
       END IF
       Vg1=Vg1+Vgstep
     NEXT I
   ELSE
     FOR I=1 TO ABS(Vg_steps)
       Vg(I)=Vg1
       PRINT "vg=";Vg(I)
       IF Vg(I)<Vgmax THEN 
         GOTO Go_on
       END IF
       Vg1=Vg1-Vgstep
     NEXT I
   END IF
 Go_on:   !
    !--------------------------------------------------------------------------------
         !
   INTEGER Drain,Gate,Source,Bulk
   Drain=Pins(1)
   Gate=Pins(2)
   Source=Pins(3)
   Bulk=Pins(4)                                   !
         !
   Connect(FNGnd,Drain,Gate,Source,Bulk)
   Connect(FNPort(0,1),Drain)
   Connect(FNPort(0,2),Gate)
   Connect(FNPort(0,3),Source)
   Connect(FNPort(0,4),Bulk)
         !
        !Set_smu_ch(Drain,Adc,O)
   Set_adc(Adc,Integ,Iv)
                                                 !
   Force_v(Source,Vs,Vs,.1)
   Force_v(Bulk,Vb,Vb,.1)
         !
   INTEGER Mode,Stop_mode
   REAL Range,Delay,Compliance,P_comp
         !
   Mode=1
   Range=0
   Delay=0.
   Compliance=.1
   P_comp=2
   Stop_mode=1
         !
   Set_iv(Drain,Mode,Range,Vdmin,Vdmax,Steps,Hold,Delay,Compliance,P_comp,Stop_mode)
         !
   REAL Id(1500),Ig(1500),Is(1500),Ib(1500),Vsweep(1500)
   REAL Meas_range
         !
   INTEGER Meas_mode
   Meas_mode=2
   FOR J=1 TO ABS(Vg_steps)
     Force_v(Gate,Vg(J),Vg(J),.1)
     Sweep_iv(Drain,Meas_mode,Meas_range,Id(*),Vsweep(*))
         !
         !
 Save_file:              !
     ON ERROR GOTO Nofile
     ASSIGN @File TO D_path$&"/"&D_file$&".cv";APPEND
     OFF ERROR 
     OUTPUT @File USING "K,K";"Vgs=";Vg(J)
     OUTPUT @File USING "K,K";"Vdmin=";Vdmin;",";"Vdmax=";Vdmax;",";"Vdstep=";Vdstep
     OUTPUT @File USING "K,K";"Step Number";",";"Vd";",";"Id"
              !
     INTEGER I
     FOR I=1 TO Steps
       OUTPUT @File USING "K,K";I;",";Vsweep(I);",";Id(I)
     NEXT I
              !
     ASSIGN @File TO *
   NEXT J
         !
         !
   Disable_port
   Connect
                                                 !
   SUBEXIT
 Nofile:       !
   CREATE D_path$&"/"&D_file$&".cv",2
   GOTO Save_file
 SUBEND
 Id_vg_loop:SUB Id_vg_loop(REAL Vgmin,Vgmax,Vgstep,Vdmin,Vdmax,Vdstep,Vs,Vb,INTEGER Pins(*),Adc,REAL Iv,INTEGER Integ,REAL Hold,D_path$,D_file$)
 !***** DON'T REMOVE THIS LINE *************************************
 !
 !  Type : Algorithm
 !  Name : Id_Vg_loop
 !  Vers : 1
 !  Desc : Id vs Vd curve
 !  Date : 11/25/2022
 !  Time : 18:29:37
 !  User : wat
 !
 !***** DON'T REMOVE THIS LINE *************************************
 !
 !  Input Variables:
 !
 !     #  Name            Type Size     Description
 !    --- --------------- ---- -------- --------------------------------
 !    Measurement Parameters:
 !      1 VGMIN           R    -        START  VOLTAGE BIAS ON HIGH
 !      2 VGMAX           R    -        END  VOLTAGE BIAS ON HIGH
 !      3 VGSTEP          R    -
 !      4 VDMIN           R    -        START SWEEP VOLTAGE ON HIGH
 !      5 VDMAX           R    -        END SWEEP VOLTAGE ON HIGH
 !      6 VDSTEP          R    -
 !      7 VS              R    -        VOLTAGE ON SOURCE
 !      8 VB              R    -        VOLTAGE ON BULK
 !
 !    Device Terminals:
 !      1 DRAIN           I    -
 !      2 GATE            I    -
 !      3 SOURCE          I    -
 !      4 BULK            I    -
 !
 !    Device Parameters:
 !      1 ADC             I    -        1,ADC TYPE (0:HI-SPEED, 1:HI-RES
 !      2 IV              R    -        SAMPLING NUMBER WHEN MANUAL INTE
 !      3 INTEG           I    -        1,2,3,INTEGRATION TIME (0:MAN, 1
 !      4 HOLD            R    -        HOLD TIME BEFORE STARTS SWEEP ME
 !      5 D_path          S    -
 !      6 D_file          S    -
 !
 !  Output Variables:
 !
 !***** DON'T REMOVE THIS LINE *************************************
   OPTION BASE 1
             !
 !-----------------------------------------------------------------------------------------
 !Declare
 !-----------------------------------------------------------------------------------------
   INTEGER Steps
   Steps=ABS(Vgmax-Vgmin)/Vgstep+1
   REAL Vg(1500)
   REAL Vd(1500)
   INTEGER Vd_steps
  !Vd_steps=ABS(Vdmax-Vdmin)/Vdstep+1
  !PAUSE
   Vd_steps=(Vdmax-Vdmin)/Vdstep
   PRINT "vd_steps=";Vd_steps
   Vd1=Vdmin
   IF Vd_steps>0 THEN 
     FOR I=1 TO ABS(Vd_steps)
       Vd(I)=Vd1
       PRINT "vd=";Vd(I)
       IF Vd(I)>Vdmax THEN 
         GOTO Go_on
       END IF
       Vd1=Vd1+Vdstep
     NEXT I
   ELSE
     FOR I=1 TO ABS(Vd_steps)
       Vd(I)=Vd1
       PRINT "vd=";Vd(I)
       IF Vd(I)<Vdmax THEN 
         GOTO Go_on
       END IF
       Vd1=Vd1-Vdstep
     NEXT I
   END IF
 Go_on:   !
         !
   INTEGER Drain,Gate,Source,Bulk
   Drain=Pins(1)
   Gate=Pins(2)
   Source=Pins(3)
   Bulk=Pins(4)                                   !
         !
   PRINT "trace connect"
  !PAUSE
   !--------------------------------------------------------------------------------------
   !Connect
   !--------------------------------------------------------------------------------------
   Connect(FNGnd,Drain,Gate,Source,Bulk)  !Discharge
   Connect(FNPort(0,1),Drain)
   Connect(FNPort(0,2),Gate)
   Connect(FNPort(0,3),Source)
   Connect(FNPort(0,4),Bulk)
   Set_adc(Adc,Integ,Iv)
   Force_v(Source,Vs,Vs,.1)
   Force_v(Bulk,Vb,Vb,.1)
         !
   INTEGER Mode,Stop_mode
   REAL Range,Delay,Compliance,P_comp
         !
   Mode=1
   Range=0
   Delay=0.
   Compliance=.1
   P_comp=2
   Stop_mode=1
         !
   !--------------------------------------------------------------------------------------
   !Measure
   !--------------------------------------------------------------------------------------
   Set_iv(Gate,Mode,Range,Vgmin,Vgmax,Steps,Hold,Delay,Compliance,P_comp,Stop_mode)
         !
  !PAUSE
   REAL Id(1500),Ig(1500),Is(1500),Ib(1500),Vsweep(1500)
   REAL Meas_range
         !
   INTEGER Meas_mode
   Meas_mode=2
   FOR J=1 TO ABS(Vd_steps)
     Force_v(Drain,Vd(J),Vd(J),.1)
     Sweep_iv(Drain,Meas_mode,Meas_range,Id(*),Vsweep(*))
         !
         !
   !--------------------------------------------------------------------------------------
   !Data Output
   !--------------------------------------------------------------------------------------
 Save_file:              !
     ON ERROR GOTO Nofile
     ASSIGN @File TO D_path$&"/"&D_file$&".cv";APPEND
     OFF ERROR 
     OUTPUT @File USING "K,K";"Vds=";Vd(J)
     OUTPUT @File USING "K,K";"Vgmin=";Vgmin;",";"Vgmax=";Vgmax;",";"Vgstep=";Vgstep
     OUTPUT @File USING "K,K";"Step Number";",";"Vg";",";"Id"
              !
     INTEGER I
     FOR I=1 TO Steps
       OUTPUT @File USING "K,K";I;",";Vsweep(I);",";Id(I)
     NEXT I
              !
     ASSIGN @File TO *
   NEXT J
         !
         !
   !---------------------------------------------------------------------------------------
   !Disconnect
   !---------------------------------------------------------------------------------------
   Disable_port
   Connect
                                                 !
   SUBEXIT
 Nofile:       !
   CREATE D_path$&"/"&D_file$&".cv",2
   GOTO Save_file
 SUBEND
 Idoff:SUB Idoff(REAL E,Vd,INTEGER Unit,REAL T,D,INTEGER Pins(*),Adc,REAL Iv,INTEGER Integ,REAL Hold,Idrng,INTEGER Mode,Flag,REAL Icom,Id)
 !***** DON'T REMOVE THIS LINE *************************************
 !
 !  Type : Algorithm
 !  Name : Idoff
 !  Vers : 1
 !  Desc : Ids measurement at Vg=0 and specified Vds
 !  Date : 11/23/2022
 !  Time : 13:07:17
 !  User : wat
 !
 !***** DON'T REMOVE THIS LINE *************************************
 !
 !  Input Variables:
 !
 !     #  Name            Type Size     Description
 !    --- --------------- ---- -------- --------------------------------
 !    Measurement Parameters:
 !      1 E               R    -        VD* E
 !      2 VD              R    -        APPLIED VOLTAGE
 !      3 UNIT            I    -        0: MKS, 1:pA, 2:uA, 3:mA
 !      4 T               R    -        Idoff * T
 !      5 D               R    -        Idoff / D
 !
 !    Device Terminals:
 !      1 DRAIN           I    -        DRAIN TERMINAL
 !      2 GATE            I    -        GATE TERMINAL
 !      3 SOURCE          I    -        SOURCE TERMINAL
 !      4 BULK            I    -        WELL OR BULK
 !
 !    Device Parameters:
 !      1 ADC             I    -        ADC TYPE (0:HI-SPEED, 1:HI-RESOL
 !      2 IV              R    -        SAMPLING NUMBER WHEN MANUAL INTE
 !      3 INTEG           I    -        INTEGRATION TIME (0:MAN, 1:S, 2:
 !      4 HOLD            R    -        HOLD TIME
 !      5 IDRNG           R    -        GATE CURRENT MEASUREMENT RANGE (
 !      6 MODE            I    -        0:no abs 1:for NMOS -1:for PMOS
 !      7 FLAG            I    -        1:compute common logarithm(must
 !      8 ICOM            R    -        Icompliance for Drain
 !
 !  Output Variables:
 !
 !     #  Name            Type Size     Description
 !    --- --------------- ---- -------- --------------------------------
 !    Output Parameters:
 !      1 ID              R    -        DRAIN CURRENT @VG=0
 !
 !***** DON'T REMOVE THIS LINE *************************************
   OPTION BASE 1                   !***** DON'T REMOVE THIS LINE *****
   DISP "in Idoff"
                                  !
   INTEGER Gate,Drain,Source,Bulk,Stat
                                  !
   Drain=Pins(1)
   Gate=Pins(2)
   Source=Pins(3)
   Bulk=Pins(4)
                                  ! Connect device
   Connect(FNGnd,Gate,Drain,Source,Bulk)
   Connect(FNPort(0,1),Drain)
   !IF Mode=1 THEN
   !Connect(FNPort(0,5),Source)
   !Force_v(Source,0,0,.1)
   !END IF
                                  ! ADC mode
   Set_smu_ch(Drain,Adc,0)
   Set_adc(Adc,Integ,Iv)
   ! Set_wait_time(Ss,Sm)
                                  ! Spot measurement
   Force_v(Drain,E*Vd,E*Vd,Icom)    !Add Coefficient to VD AndyWang
   Wait_th(Hold)
   Measure_i(Drain,Id,Idrng)
   Port_status(Drain,Stat)
   IF Mode=1 THEN 
     Id=ABS(Id)
   ELSE
     IF Mode=-1 THEN 
       Id=-ABS(Id)
     END IF
   END IF
                                  !
   Id=Id*T/D
   IF Flag=1 THEN Id=-LGT(ABS(Id)+1.E-20)     ! get Idoff=-log(Idmeas)
   SELECT Unit
   CASE 0
     Id=Id                        !:unit: A
   CASE 1
     Id=Id*1.E+12                 !:unit: pA
   CASE 2
     Id=Id*1.E+6                  !:unit: uA
   CASE 3
     Id=Id*1.E+3                  !:unit: mA
   CASE ELSE
     Id=Id                        !:unit: A
   END SELECT
   PRINT "Idoff=",Id;"Stat",Stat
                                  ! Disable ports and pins
   Disable_port
   Connect
 SUBEND
 Idoff_tb:SUB Idoff_tb(REAL Type,Vd,Vg,Vb,INTEGER Unit,REAL D,T,INTEGER Pins(*),Adc,REAL Iv,INTEGER Integ,REAL Hold,Chuck_hold,Idrng,INTEGER Mode,REAL Connect,Icomp,Id)
 !***** DON'T REMOVE THIS LINE *************************************
 !
 !  Type : Algorithm
 !  Name : Idoff_TB
 !  Vers : 1
 !  Desc : Drain current measurement at specified bias point.
 !       : 2014 base on Idoff set up TB alg
 !  Date : 11/07/2014
 !  Time : 16:00:41
 !  User : wat
 !
 !***** DON'T REMOVE THIS LINE *************************************
 !
 !  Input Variables:
 !
 !     #  Name            Type Size     Description
 !    --- --------------- ---- -------- --------------------------------
 !    Measurement Parameters:
 !      1 Type            R    -        1:Nmos -1Pmos
 !      2 VD              R    -        DRAIN TO SOURCE BIAS
 !      3 VG              R    -        GATE TO SOURCE BIAS
 !      4 VB              R    -        BULK TO SOURCE BIAS
 !      5 UNIT            I    -        0: MKS, 1:pA, 2:uA, 3:mA,4:LOG10
 !      6 D               R    -        Ioff / D
 !      7 T               R    -        Ioff*T
 !
 !    Device Terminals:
 !      1 DRAIN           I    -        DRAIN TERMINAL
 !      2 GATE            I    -        GATE TERMINAL
 !      3 SOURCE          I    -        SOURCE TERMINAL
 !      4 BULK            I    -        WELL OR BULK
 !
 !    Device Parameters:
 !      1 ADC             I    -        ADC TYPE (0:HI-SPEED, 1:HI-RESOL
 !      2 IV              R    -        SAMPLING NUMBER WHEN MANUAL INTE
 !      3 INTEG           I    -        INTEGRATION TIME (0:MAN, 1:S, 2:
 !      4 HOLD            R    -        HOLD TIME BEFORE STARTS SWEEP ME
 !      5 CHUCK_HOLD      R    -        HOLD TIME BETWEEN CHECK DOWN AND
 !      6 IDRNG           R    -        DRAIN CURRENT MEASUREMENT RANGE
 !      7 MODE            I    -        0:SOURCE CONNECT GND 1:SOURCE CO
 !      8 CONNECT         R    -        Connect=1 double contact
 !      9 ICOMP           R    -        Id, Ig, Ib, Icomp
 !
 !  Output Variables:
 !
 !     #  Name            Type Size     Description
 !    --- --------------- ---- -------- --------------------------------
 !    Output Parameters:
 !      1 ID              R    -        DRAIN SATURATION CURRENT
 !
 !***** DON'T REMOVE THIS LINE *************************************
   OPTION BASE 1                    !***** DON'T REMOVE THIS LINE *****
   DISP "in Idsat & Ioff "
       !
   INTEGER Gate,Drain,Source,Bulk,Stat,Stb
   REAL Id1
       !
   IF Vg>=100 THEN GOSUB Disconnect
   Drain=Pins(1)
   Gate=Pins(2)
   Source=Pins(3)
   Bulk=Pins(4)
       ! Connect device
   Connect(FNGnd,Gate,Drain,Source,Bulk)
   Connect(FNPort(0,2),Gate)
   Connect(FNPort(0,1),Drain)
   Connect(FNPort(0,4),Bulk)
       ! ADC mode
   Set_smu_ch(Drain,Adc,1)
    ! IF Ioff=0 THEN
   Set_adc(Adc,Integ,Iv)
    !END IF
    !F Ioff=1 THEN
    !et_adc(Adc,Integ,16)
    !ND IF
   IF Mode=1 THEN 
     Connect(FNPort(0,5),Source)
     Force_v(Source,0,0,.1)
   END IF
       ! Spot measurement
   IF Connect=1 THEN 
     Vd=Type*ABS(Vd)
     Vg=Type*ABS(Vg)
     Force_v(Bulk,Vb,Vb,Icomp)
     Force_v(Gate,Vg,Vg,Icomp)
     Force_v(Drain,Vd,Vd,Icomp)
     Wait_th(Hold)
     Measure_i(Drain,Id,Idrng)
     Id1=Id
     Disable_port
       ! Chuck down then up
     Prober_output("D",Status$,Error$)
     Prober_srq(5,Stb)
     Wait_th(Chuck_hold)
     Prober_output("Z",Status$,Error$)
       ! Re-measure
     Prober_srq(5,Stb)
   END IF
   Vd=Type*ABS(Vd)
   Vg=Type*ABS(Vg)
   Force_v(Bulk,Vb,Vb,Icomp)
   Force_v(Gate,Vg,Vg,Icomp)
   Force_v(Drain,Vd,Vd,Icomp)
   Wait_th(Hold)
    !F Ioff=1 THEN
    !ait_th(.3)
    !Measure_i(Drain,Id,Id,1.E-9)
    !END IF
    !IF Ioff=0 THEN
   Measure_i(Drain,Id,Idrng)
    !END IF
    !
   Port_status(Drain,Stat)
       !
   Id=ABS(Id)*Type*T/D
   SELECT Unit
   CASE 0
     Id=Id                          !:unit: A
   CASE 1
     Id=Id*1.E+12                   !:unit: pA
   CASE 2
     Id=Id*1.E+6                    !:unit: uA
   CASE 3
     Id=Id*1.E+3                    !:unit: mA
   CASE 4
     Id=LGT(ABS(Id)+1.E-30)         !:unit: LOG10
   END SELECT
   PRINT "Id1=";Id1
   PRINT "Ids=";Id,"Stat";Stat
       !Disable ports and pins
 Disconnect:     !
   Disable_port
   Connect
 SUBEND
 Idsat:SUB Idsat(REAL Vd,Vg,Vb,INTEGER Unit,REAL T,D,INTEGER Pins(*),Adc,REAL Iv,INTEGER Integ,REAL Hold,Idrng,INTEGER Mode,Flag,Flag2,REAL Id)
 !***** DON'T REMOVE THIS LINE *************************************
 !
 !  Type : Algorithm
 !  Name : Idsat
 !  Vers : 1
 !  Desc : Drain current measurement at specified bias point.
 !  Date : 10/17/2003
 !  Time : 15:49:50
 !  User : wat
 !
 !***** DON'T REMOVE THIS LINE *************************************
 !
 !  Input Variables:
 !
 !     #  Name            Type Size     Description
 !    --- --------------- ---- -------- --------------------------------
 !    Measurement Parameters:
 !      1 VD              R    -        DRAIN TO SOURCE BIAS
 !      2 VG              R    -        GATE TO SOURCE BIAS
 !      3 VB              R    -        BULK TO SOURCE BIAS
 !      4 UNIT            I    -        0: MKS, 1:pA, 2:uA, 3:mA
 !      5 T               R    -        Idsat * T
 !      6 D               R    -        Idsat / D
 !
 !    Device Terminals:
 !      1 DRAIN           I    -        DRAIN TERMINAL
 !      2 GATE            I    -        GATE TERMINAL
 !      3 SOURCE          I    -        SOURCE TERMINAL
 !      4 BULK            I    -        WELL OR BULK
 !
 !    Device Parameters:
 !      1 ADC             I    -        ADC TYPE (0:HI-SPEED, 1:HI-RESOL
 !      2 IV              R    -        SAMPLING NUMBER WHEN MANUAL INTE
 !      3 INTEG           I    -        INTEGRATION TIME (0:MAN, 1:S, 2:
 !      4 HOLD            R    -        HOLD TIME BEFORE STARTS SWEEP ME
 !      5 IDRNG           R    -        DRAIN CURRENT MEASUREMENT RANGE
 !      6 MODE            I    -        0:SOURCE CONNECT GND 1:SOURCE CO
 !      7 FLAG            I    -        1:compute common logrithm(must s
 !      8 FLAG2           I    -        1:measure Isource(must set MODE=
 !
 !  Output Variables:
 !
 !     #  Name            Type Size     Description
 !    --- --------------- ---- -------- --------------------------------
 !    Output Parameters:
 !      1 ID              R    -        DRAIN SATURATION CURRENT
 !
 !***** DON'T REMOVE THIS LINE *************************************
   OPTION BASE 1                    !***** DON'T REMOVE THIS LINE *****
   DISP "in Idsat"
                                    !
   INTEGER Gate,Drain,Source,Bulk,Stat
   REAL Is
                                    !
   Drain=Pins(1)
   Gate=Pins(2)
   Source=Pins(3)
   Bulk=Pins(4)
                                    ! Connect device
   Connect(FNGnd,Gate,Drain,Source,Bulk)
   Connect(FNPort(0,1),Gate)
   Connect(FNPort(0,2),Drain)
   Connect(FNPort(0,3),Bulk)
   IF Mode=1 THEN 
     Connect(FNPort(0,5),Source)
     Force_v(Source,0,0,.1)
   END IF
                                    ! ADC mode
   Set_smu_ch(Drain,Adc,0)
   Set_adc(Adc,Integ,Iv)
   !Set_wait_time(Ss,Sm)
                                    ! Spot measurement
   Force_v(Bulk,Vb,Vb,.01)
   Force_v(Gate,Vg,Vg,.01)
   Force_v(Drain,Vd,Vd,.05)
   Wait_th(Hold)
   Measure_i(Drain,Id,Idrng)
   Port_status(Drain,Stat)
   IF Flag2=1 THEN 
     Measure_i(Source,Is)
     Id=Is
   END IF
                                    !
   Id=Id*T/D
   IF Flag=1 THEN Id=-LGT(ABS(Id)+1.E-20)
   SELECT Unit
   CASE 0
     Id=Id                            !:unit: A
   CASE 1
     Id=Id*1.E+12                     !:unit: pA
   CASE 2
     Id=Id*1.E+6                      !:unit: uA
   CASE 3
     Id=Id*1.E+3                      !:unit: mA
   CASE ELSE
     Id=Id                            !:unit: A
   END SELECT
   PRINT "Ids=";Id,"Stat";Stat
                                    !Disable ports and pins
   Disable_port
   Connect
 SUBEND
 Idsat5:SUB Idsat5(REAL Vd,Vcg,Vsg,Vb,INTEGER Unit,REAL T,D,INTEGER Pins(*),Adc,REAL Iv,INTEGER Integ,REAL Hold,Idrng,Id)
 !***** DON'T REMOVE THIS LINE *************************************
 !
 !  Type : Algorithm
 !  Name : Idsat5
 !  Vers : 1
 !  Desc : Drain current measurement at specified bias point.
 !  Date : 08/14/2002
 !  Time : 21:56:10
 !  User : wat
 !
 !***** DON'T REMOVE THIS LINE *************************************
 !
 !  Input Variables:
 !
 !     #  Name            Type Size     Description
 !    --- --------------- ---- -------- --------------------------------
 !    Measurement Parameters:
 !      1 VD              R    -        DRAIN TO SOURCE BIAS
 !      2 VCG             R    -        CONTROL GATE TO SOURCE BIAS
 !      3 VSG             R    -        SELECT GATE TO SOURCE BIAS
 !      4 VB              R    -        BULK TO SOURCE BIAS
 !      5 UNIT            I    -        0: MKS, 1:pA, 2:uA, 3:mA
 !      6 T               R    -        Idsat * T
 !      7 D               R    -        Idsat / D
 !
 !    Device Terminals:
 !      1 DRAIN           I    -        DRAIN TERMINAL
 !      2 SGATE           I    -        SELECT GATE TERMINAL
 !      3 CGATE           I    -        CONTROL GATE TERMINAL
 !      4 SOURCE          I    -        SOURCE TERMINAL
 !      5 BULK            I    -        WELL OR BULK TERMINAL
 !
 !    Device Parameters:
 !      1 ADC             I    -        ADC TYPE (0:HI-SPEED, 1:HI-RESOL
 !      2 IV              R    -        SAMPLING NUMBER WHEN MANUAL INTE
 !      3 INTEG           I    -        INTEGRATION TIME (0:MAN, 1:S, 2:
 !      4 HOLD            R    -        HOLD TIME BEFORE STARTS SWEEP ME
 !      5 IDRNG           R    -        DRAIN CURRENT MEASUREMENT RANGE
 !
 !  Output Variables:
 !
 !     #  Name            Type Size     Description
 !    --- --------------- ---- -------- --------------------------------
 !    Output Parameters:
 !      1 ID              R    -        DRAIN SATURATION CURRENT
 !
 !***** DON'T REMOVE THIS LINE *************************************
   OPTION BASE 1                       !***** DON'T REMOVE THIS LINE *****
   DISP "in Idsat"
                                       !
   INTEGER Cgate,Sgate,Drain,Source,Bulk,Stat
                                       !
   Drain=Pins(1)
   Sgate=Pins(2)
   Source=Pins(4)
   Cgate=Pins(3)
   Bulk=Pins(5)
                                       ! Connect device
   Connect(FNGnd,Cgate,Sgate,Drain,Source,Bulk)
   Connect(FNPort(0,1),Cgate)
   Connect(FNPort(0,2),Sgate)
   Connect(FNPort(0,3),Drain)
   Connect(FNPort(0,4),Bulk)
                                       ! ADC mode
   Set_smu_ch(Drain,Adc,0)
   Set_adc(Adc,Integ,Iv)
      !Set_wait_time(Ss,Sm)
                                       ! Spot measurement
   Force_v(Bulk,Vb,Vb,.01)
   Force_v(Cgate,Vcg,Vcg,.1)
   Force_v(Sgate,Vsg,Vsg,.1)
   Force_v(Drain,Vd,Vd,.1)
   Wait_th(Hold)
   Measure_i(Drain,Id,Idrng)
   Port_status(Drain,Stat)
                                       !
   Id=Id*T/D
   SELECT Unit
   CASE 0
     Id=Id                               !:unit: A
   CASE 1
     Id=Id*1.E+12                        !:unit: pA
   CASE 2
     Id=Id*1.E+6                         !:unit: uA
   CASE 3
     Id=Id*1.E+3                         !:unit: mA
   CASE ELSE
     Id=Id                               !:unit: A
   END SELECT
   PRINT "Ids=";Id,"Stat";Stat
                                       !Disable ports and pins
   Disable_port
   Connect
 SUBEND
 Idsat_noupdw:SUB Idsat_noupdw(REAL Vd,Vg,Vb,INTEGER Unit,REAL T,D,INTEGER Pins(*),Adc,REAL Iv,INTEGER Integ,REAL Hold,Idrng,INTEGER Mode,REAL Icom,Id)
 !***** DON'T REMOVE THIS LINE *************************************
 !
 !  Type : Algorithm
 !  Name : Idsat_NoUpDw
 !  Vers : 1
 !  Desc : Drain current measurement at specified bias point.
 !  Date : 11/06/2007
 !  Time : 16:50:17
 !  User : wat
 !
 !***** DON'T REMOVE THIS LINE *************************************
 !
 !  Input Variables:
 !
 !     #  Name            Type Size     Description
 !    --- --------------- ---- -------- --------------------------------
 !    Measurement Parameters:
 !      1 VD              R    -        DRAIN TO SOURCE BIAS
 !      2 VG              R    -        GATE TO SOURCE BIAS
 !      3 VB              R    -        BULK TO SOURCE BIAS
 !      4 UNIT            I    -        0: MKS, 1:pA, 2:uA, 3:mA
 !      5 T               R    -        Idsat * T
 !      6 D               R    -        Idsat / D
 !
 !    Device Terminals:
 !      1 DRAIN           I    -        DRAIN TERMINAL
 !      2 GATE            I    -        GATE TERMINAL
 !      3 SOURCE          I    -        SOURCE TERMINAL
 !      4 BULK            I    -        WELL OR BULK
 !
 !    Device Parameters:
 !      1 ADC             I    -        ADC TYPE (0:HI-SPEED, 1:HI-RESOL
 !      2 IV              R    -        SAMPLING NUMBER WHEN MANUAL INTE
 !      3 INTEG           I    -        INTEGRATION TIME (0:MAN, 1:S, 2:
 !      4 HOLD            R    -        HOLD TIME BEFORE STARTS SWEEP ME
 !      5 IDRNG           R    -        DRAIN CURRENT MEASUREMENT RANGE
 !      6 MODE            I    -        0:SOURCE CONNECT GND 1:SOURCE CO
 !      7 ICOM            R    -        Icompliance for Gate & Drain
 !
 !  Output Variables:
 !
 !     #  Name            Type Size     Description
 !    --- --------------- ---- -------- --------------------------------
 !    Output Parameters:
 !      1 ID              R    -        DRAIN SATURATION CURRENT
 !
 !***** DON'T REMOVE THIS LINE *************************************
   OPTION BASE 1                       !***** DON'T REMOVE THIS LINE *****
   DISP "in Idsat"
                                       !
   INTEGER Gate,Drain,Source,Bulk,Stat,Stb
      !REAL Id1
                                       !
   IF Vg>=100 THEN GOSUB Disconnect
   Drain=Pins(1)
   Gate=Pins(2)
   Source=Pins(3)
   Bulk=Pins(4)
                                       ! Connect device
   Connect(FNGnd,Gate,Drain,Source,Bulk)
   Connect(FNPort(0,1),Gate)
   Connect(FNPort(0,2),Drain)
   Connect(FNPort(0,3),Bulk)
                                       ! ADC mode
   Set_smu_ch(Drain,Adc,0)
   Set_adc(Adc,Integ,Iv)
      !Set_wait_time(Ss,Sm)
                                       ! Spot measurement
   Force_v(Bulk,Vb,Vb,.01)
   Force_v(Gate,Vg,Vg,Icom)
   Force_v(Drain,Vd,Vd,Icom)
      !Wait_th(Hold)
      !Measure_i(Drain,Id,Idrng)
      !Id1=Id
      !Disable_port
                                       ! Chuck down then up
      !Prober_output("D",Status$,Error$)
      !Prober_srq(5,Stb)
      !Wait_th(Chuck_hold)
      !Prober_output("Z",Status$,Error$)
                                       ! Re-measure
      !Prober_srq(5,Stb)
      !Force_v(Bulk,Vb,Vb,.01)
      !Force_v(Gate,Vg,Vg,Icom)
      !Force_v(Drain,Vd,Vd,Icom)
   IF Mode=1 THEN 
     Connect(FNPort(0,5),Source)
     Force_v(Source,0,0,.1)
   END IF
   Wait_th(Hold)
   Measure_i(Drain,Id,Idrng)
       !
   Port_status(Drain,Stat)
                                       !
   Id=Id*T/D
   SELECT Unit
   CASE 0
     Id=Id                               !:unit: A
   CASE 1
     Id=Id*1.E+12                        !:unit: pA
   CASE 2
     Id=Id*1.E+6                         !:unit: uA
   CASE 3
     Id=Id*1.E+3                         !:unit: mA
   CASE ELSE
     Id=Id                               !:unit: A
   END SELECT
      !PRINT "Id1=";Id1
   PRINT "Ids=";Id,"Stat";Stat
                                       !Disable ports and pins
 Disconnect:      !
   Disable_port
   Connect
 SUBEND
 Idsat_tb:SUB Idsat_tb(REAL Type,Vd,Vg,Vb,INTEGER Unit,REAL D,INTEGER Pins(*),Adc,REAL Iv,INTEGER Integ,REAL Hold,Chuck_hold,Idrng,INTEGER Mode,REAL Connect,Icomp,Id)
 !***** DON'T REMOVE THIS LINE *************************************
 !
 !  Type : Algorithm
 !  Name : Idsat_TB
 !  Vers : 1
 !  Desc : Drain current measurement at specified bias point.
 !       : 2014 base on Idsat set up TB alg
 !  Date : 11/07/2014
 !  Time : 18:17:57
 !  User : wat
 !
 !***** DON'T REMOVE THIS LINE *************************************
 !
 !  Input Variables:
 !
 !     #  Name            Type Size     Description
 !    --- --------------- ---- -------- --------------------------------
 !    Measurement Parameters:
 !      1 Type            R    -        1:Nmos -1Pmos
 !      2 VD              R    -        DRAIN TO SOURCE BIAS
 !      3 VG              R    -        GATE TO SOURCE BIAS
 !      4 VB              R    -        BULK TO SOURCE BIAS
 !      5 UNIT            I    -        0: MKS, 1:pA, 2:uA, 3:mA,4:LOG10
 !      6 D               R    -        Idsat / D
 !
 !    Device Terminals:
 !      1 DRAIN           I    -        DRAIN TERMINAL
 !      2 GATE            I    -        GATE TERMINAL
 !      3 SOURCE          I    -        SOURCE TERMINAL
 !      4 BULK            I    -        WELL OR BULK
 !
 !    Device Parameters:
 !      1 ADC             I    -        ADC TYPE (0:HI-SPEED, 1:HI-RESOL
 !      2 IV              R    -        SAMPLING NUMBER WHEN MANUAL INTE
 !      3 INTEG           I    -        INTEGRATION TIME (0:MAN, 1:S, 2:
 !      4 HOLD            R    -        HOLD TIME BEFORE STARTS SWEEP ME
 !      5 CHUCK_HOLD      R    -        HOLD TIME BETWEEN CHECK DOWN AND
 !      6 IDRNG           R    -        DRAIN CURRENT MEASUREMENT RANGE
 !      7 MODE            I    -        0:SOURCE CONNECT GND 1:SOURCE CO
 !      8 CONNECT         R    -        Connect=1 double contact
 !      9 ICOMP           R    -        Id, Ig, Ib, Icomp
 !
 !  Output Variables:
 !
 !     #  Name            Type Size     Description
 !    --- --------------- ---- -------- --------------------------------
 !    Output Parameters:
 !      1 ID              R    -        DRAIN SATURATION CURRENT
 !
 !***** DON'T REMOVE THIS LINE *************************************
   OPTION BASE 1                  !***** DON'T REMOVE THIS LINE *****
   DISP "in Idsat & Ioff "
     !
   INTEGER Gate,Drain,Source,Bulk,Stat,Stb
   REAL Id1
     !
   IF Vg>=100 THEN GOSUB Disconnect
   Drain=Pins(1)
   Gate=Pins(2)
   Source=Pins(3)
   Bulk=Pins(4)
     ! Connect device
   Connect(FNGnd,Gate,Drain,Source,Bulk)
   Connect(FNPort(0,1),Gate)
   Connect(FNPort(0,2),Drain)
   Connect(FNPort(0,4),Bulk)
     ! ADC mode
   Set_smu_ch(Drain,Adc,0)
  ! IF Ioff=0 THEN
   Set_adc(Adc,Integ,Iv)
  !END IF
  !F Ioff=1 THEN
  !et_adc(Adc,Integ,16)
  !ND IF
   IF Mode=1 THEN 
     Connect(FNPort(0,5),Source)
     Force_v(Source,0,0,.1)
   END IF
     ! Spot measurement
   IF Connect=1 THEN 
     Vd=Type*ABS(Vd)
     Vg=Type*ABS(Vg)
     Force_v(Bulk,Vb,Vb,Icomp)
     Force_v(Gate,Vg,Vg,Icomp)
     Force_v(Drain,Vd,Vd,Icomp)
     Wait_th(Hold)
     Measure_i(Drain,Id,Idrng)
     Id1=Id
     Disable_port
     ! Chuck down then up
     Prober_output("D",Status$,Error$)
     Prober_srq(5,Stb)
     Wait_th(Chuck_hold)
     Prober_output("Z",Status$,Error$)
     ! Re-measure
     Prober_srq(5,Stb)
   END IF
   Vd=Type*ABS(Vd)
   Vg=Type*ABS(Vg)
   Force_v(Bulk,Vb,Vb,Icomp)
   Force_v(Gate,Vg,Vg,Icomp)
   Force_v(Drain,Vd,Vd,Icomp)
   Wait_th(Hold)
  !F Ioff=1 THEN
  !ait_th(.3)
  !Measure_i(Drain,Id,Id,1.E-9)
  !END IF
  !IF Ioff=0 THEN
   Measure_i(Drain,Id,Idrng)
  !END IF
  !
   Port_status(Drain,Stat)
     !
   Id=ABS(Id)*Type/D
   SELECT Unit
   CASE 0
     Id=Id                        !:unit: A
   CASE 1
     Id=Id*1.E+12                 !:unit: pA
   CASE 2
     Id=Id*1.E+6                  !:unit: uA
   CASE 3
     Id=Id*1.E+3                  !:unit: mA
   CASE 4
     Id=LGT(ABS(Id)+1.E-30)       !:unit: LOG10
   END SELECT
   PRINT "Id1=";Id1
   PRINT "Ids=";Id,"Stat";Stat
     !Disable ports and pins
 Disconnect:   !
   Disable_port
   Connect
 SUBEND
 Idsat_updown:SUB Idsat_updown(REAL Vd,Vg,Vb,INTEGER Unit,REAL T,D,INTEGER Pins(*),Adc,REAL Iv,INTEGER Integ,REAL Hold,Chuck_hold,Idrng,INTEGER Mode,REAL Icom,Id)
 !***** DON'T REMOVE THIS LINE *************************************
 !
 !  Type : Algorithm
 !  Name : Idsat_updown
 !  Vers : 1
 !  Desc : Drain current measurement at specified bias point.
 !  Date : 06/15/2004
 !  Time : 08:57:35
 !  User : wat
 !
 !***** DON'T REMOVE THIS LINE *************************************
 !
 !  Input Variables:
 !
 !     #  Name            Type Size     Description
 !    --- --------------- ---- -------- --------------------------------
 !    Measurement Parameters:
 !      1 VD              R    -        DRAIN TO SOURCE BIAS
 !      2 VG              R    -        GATE TO SOURCE BIAS
 !      3 VB              R    -        BULK TO SOURCE BIAS
 !      4 UNIT            I    -        0: MKS, 1:pA, 2:uA, 3:mA
 !      5 T               R    -        Idsat * T
 !      6 D               R    -        Idsat / D
 !
 !    Device Terminals:
 !      1 DRAIN           I    -        DRAIN TERMINAL
 !      2 GATE            I    -        GATE TERMINAL
 !      3 SOURCE          I    -        SOURCE TERMINAL
 !      4 BULK            I    -        WELL OR BULK
 !
 !    Device Parameters:
 !      1 ADC             I    -        ADC TYPE (0:HI-SPEED, 1:HI-RESOL
 !      2 IV              R    -        SAMPLING NUMBER WHEN MANUAL INTE
 !      3 INTEG           I    -        INTEGRATION TIME (0:MAN, 1:S, 2:
 !      4 HOLD            R    -        HOLD TIME BEFORE STARTS SWEEP ME
 !      5 CHUCK_HOLD      R    -        HOLD TIME BETWEEN CHECK DOWN AND
 !      6 IDRNG           R    -        DRAIN CURRENT MEASUREMENT RANGE
 !      7 MODE            I    -        0:SOURCE CONNECT GND 1:SOURCE CO
 !      8 ICOM            R    -        Icompliance for Gate & Drain
 !
 !  Output Variables:
 !
 !     #  Name            Type Size     Description
 !    --- --------------- ---- -------- --------------------------------
 !    Output Parameters:
 !      1 ID              R    -        DRAIN SATURATION CURRENT
 !
 !***** DON'T REMOVE THIS LINE *************************************
   OPTION BASE 1                   !***** DON'T REMOVE THIS LINE *****
   DISP "in Idsat"
                                  !
   INTEGER Gate,Drain,Source,Bulk,Stat,Stb
   REAL Id1
                                  !
   IF Vg>=100 THEN GOSUB Disconnect
   Drain=Pins(1)
   Gate=Pins(2)
   Source=Pins(3)
   Bulk=Pins(4)
                                  ! Connect device
   Connect(FNGnd,Gate,Drain,Source,Bulk)
   Connect(FNPort(0,1),Gate)
   Connect(FNPort(0,2),Drain)
   Connect(FNPort(0,3),Bulk)
                                  ! ADC mode
   Set_smu_ch(Drain,Adc,0)
   Set_adc(Adc,Integ,Iv)
   !Set_wait_time(Ss,Sm)
                                  ! Spot measurement
   Force_v(Bulk,Vb,Vb,.01)
   Force_v(Gate,Vg,Vg,Icom)
   Force_v(Drain,Vd,Vd,Icom)
   Wait_th(Hold)
   Measure_i(Drain,Id,Idrng)
   Id1=Id
   Disable_port
                                  ! Chuck down then up
   Prober_output("D",Status$,Error$)
   Prober_srq(5,Stb)
   Wait_th(Chuck_hold)
   Prober_output("Z",Status$,Error$)
                                  ! Re-measure
   Prober_srq(5,Stb)
   Force_v(Bulk,Vb,Vb,.01)
   Force_v(Gate,Vg,Vg,Icom)
   Force_v(Drain,Vd,Vd,Icom)
   IF Mode=1 THEN 
     Connect(FNPort(0,5),Source)
     Force_v(Source,0,0,.1)
   END IF
   Wait_th(Hold)
   Measure_i(Drain,Id,Idrng)
   !
   Port_status(Drain,Stat)
                                  !
   Id=Id*T/D
   SELECT Unit
   CASE 0
     Id=Id                          !:unit: A
   CASE 1
     Id=Id*1.E+12                   !:unit: pA
   CASE 2
     Id=Id*1.E+6                    !:unit: uA
   CASE 3
     Id=Id*1.E+3                    !:unit: mA
   CASE ELSE
     Id=Id                          !:unit: A
   END SELECT
   PRINT "Id1=";Id1
   PRINT "Ids=";Id,"Stat";Stat
                                  !Disable ports and pins
 Disconnect:    !
   Disable_port
   Connect
 SUBEND
 Idsat_updown_hv:SUB Idsat_updown_hv(REAL Vd,Vg,Vb,INTEGER Unit,REAL T,D,INTEGER Pins(*),Adc,REAL Iv,INTEGER Integ,REAL Hold,Chuck_hold,Idrng,INTEGER Mode,REAL Id)
 !***** DON'T REMOVE THIS LINE *************************************
 !
 !  Type : Algorithm
 !  Name : Idsat_updown_hv
 !  Vers : 1
 !  Desc : wat_standard QD Drain current measurement at specified bi
 !       : as point.
 !  Date : 09/08/2003
 !  Time : 20:42:25
 !  User : wat
 !
 !***** DON'T REMOVE THIS LINE *************************************
 !
 !  Input Variables:
 !
 !     #  Name            Type Size     Description
 !    --- --------------- ---- -------- --------------------------------
 !    Measurement Parameters:
 !      1 VD              R    -        DRAIN TO SOURCE BIAS
 !      2 VG              R    -        GATE TO SOURCE BIAS
 !      3 VB              R    -        BULK TO SOURCE BIAS
 !      4 UNIT            I    -        0: MKS, 1:pA, 2:uA, 3:mA
 !      5 T               R    -        Idsat * T
 !      6 D               R    -        Idsat / D
 !
 !    Device Terminals:
 !      1 DRAIN           I    -        DRAIN TERMINAL
 !      2 GATE            I    -        GATE TERMINAL
 !      3 SOURCE          I    -        SOURCE TERMINAL
 !      4 BULK            I    -        WELL OR BULK
 !
 !    Device Parameters:
 !      1 ADC             I    -        ADC TYPE (0:HI-SPEED, 1:HI-RESOL
 !      2 IV              R    -        SAMPLING NUMBER WHEN MANUAL INTE
 !      3 INTEG           I    -        INTEGRATION TIME (0:MAN, 1:S, 2:
 !      4 HOLD            R    -        HOLD TIME BEFORE STARTS SWEEP ME
 !      5 CHUCK_HOLD      R    -        HOLD TIME BETWEEN CHECK DOWN AND
 !      6 IDRNG           R    -        DRAIN CURRENT MEASUREMENT RANGE
 !      7 MODE            I    -        0:SOURCE CONNECT GND 1:SOURCE CO
 !
 !  Output Variables:
 !
 !     #  Name            Type Size     Description
 !    --- --------------- ---- -------- --------------------------------
 !    Output Parameters:
 !      1 ID              R    -        DRAIN SATURATION CURRENT
 !
 !***** DON'T REMOVE THIS LINE *************************************
   OPTION BASE 1                      !***** DON'T REMOVE THIS LINE *****
   DISP "in Idsat"
                                      !
   INTEGER Gate,Drain,Source,Bulk,Stat,Stb
   REAL Id1
                                      !
   Drain=Pins(1)
   Gate=Pins(2)
   Source=Pins(3)
   Bulk=Pins(4)
                                      ! Connect device
   Connect_th(FNGnd,1,49)
   Wait_th(.01)
   Connect
   Connect(FNGnd,Gate,Drain,Source,Bulk)
   Connect(FNPort(0,1),Gate)
   Connect(FNPort(0,2),Drain)
   Connect(FNPort(0,3),Bulk)
                                      ! ADC mode
   Set_smu_ch(Drain,Adc,0)
   Set_adc(Adc,Integ,Iv)
     !Set_wait_time(Ss,Sm)
   IF Mode=1 THEN 
     Connect(FNPort(0,5),Source)
     Force_v(Source,0,0,.05)
   END IF
                                      ! Spot measurement
   Force_v(Bulk,Vb,Vb,.01)
   Force_v(Gate,Vg,Vg,.05)
   Force_v(Drain,Vd,Vd,.05)
   Wait_th(Hold)
   Measure_i(Drain,Id,Idrng)
   Id1=Id
   Disable_port
                                      ! Chuck down then up
   Prober_output("D",Status$,Error$)
   Prober_srq(5,Stb)
   Wait_th(Chuck_hold)
   Prober_output("Z",Status$,Error$)
                                      ! Re-measure
   Prober_srq(5,Stb)
   Force_v(Bulk,Vb,Vb,.01)
   Force_v(Gate,Vg,Vg,.05)
   Force_v(Drain,Vd,Vd,.05)
   Wait_th(Hold)
   Measure_i(Drain,Id,Idrng)
      !
   Port_status(Drain,Stat)
                                      !
   Id=Id*T/D
   SELECT Unit
   CASE 0
     Id=Id                              !:unit: A
   CASE 1
     Id=Id*1.E+12                       !:unit: pA
   CASE 2
     Id=Id*1.E+6                        !:unit: uA
   CASE 3
     Id=Id*1.E+3                        !:unit: mA
   CASE ELSE
     Id=Id                              !:unit: A
   END SELECT
   PRINT "Id1=";Id1
   PRINT "Ids=";Id,"Stat";Stat
                                      !Disable ports and pins
   Disable_port
   Connect
 SUBEND
 Idsgb_tb:SUB Idsgb_tb(REAL Type,Vd,Vg,Vb,INTEGER Unit,REAL T,D,Ioff,INTEGER Pins(*),Adc,REAL Iv,INTEGER Integ,REAL Hold,Chuck_hold,Idrng,INTEGER Mode,REAL Connect,Id)
 !***** DON'T REMOVE THIS LINE *************************************
 !
 !  Type : Algorithm
 !  Name : Idsgb_TB
 !  Vers : 1
 !  Desc : Drain current measurement at specified bias point.
 !  Date : 09/04/2014
 !  Time : 14:11:56
 !  User : wat
 !
 !***** DON'T REMOVE THIS LINE *************************************
 !
 !  Input Variables:
 !
 !     #  Name            Type Size     Description
 !    --- --------------- ---- -------- --------------------------------
 !    Measurement Parameters:
 !      1 Type            R    -        1:Nmos -1Pmos
 !      2 VD              R    -        DRAIN TO SOURCE BIAS
 !      3 VG              R    -        GATE TO SOURCE BIAS
 !      4 VB              R    -        BULK TO SOURCE BIAS
 !      5 UNIT            I    -        0: MKS, 1:pA, 2:uA, 3:mA,4:LOG10
 !      6 T               R    -        Idsat * T
 !      7 D               R    -        Idsat / D
 !      8 IOFF            R    -        0:Idsat; 1:Ioff
 !
 !    Device Terminals:
 !      1 DRAIN           I    -        DRAIN TERMINAL
 !      2 GATE            I    -        GATE TERMINAL
 !      3 SOURCE          I    -        SOURCE TERMINAL
 !      4 BULK            I    -        WELL OR BULK
 !
 !    Device Parameters:
 !      1 ADC             I    -        ADC TYPE (0:HI-SPEED, 1:HI-RESOL
 !      2 IV              R    -        SAMPLING NUMBER WHEN MANUAL INTE
 !      3 INTEG           I    -        INTEGRATION TIME (0:MAN, 1:S, 2:
 !      4 HOLD            R    -        HOLD TIME BEFORE STARTS SWEEP ME
 !      5 CHUCK_HOLD      R    -        HOLD TIME BETWEEN CHECK DOWN AND
 !      6 IDRNG           R    -        DRAIN CURRENT MEASUREMENT RANGE
 !      7 MODE            I    -        0:SOURCE CONNECT GND 1:SOURCE CO
 !      8 CONNECT         R    -        Connect=1 double contact
 !
 !  Output Variables:
 !
 !     #  Name            Type Size     Description
 !    --- --------------- ---- -------- --------------------------------
 !    Output Parameters:
 !      1 ID              R    -        DRAIN SATURATION CURRENT
 !
 !***** DON'T REMOVE THIS LINE *************************************
   OPTION BASE 1                   !***** DON'T REMOVE THIS LINE *****
   DISP "in Idsat & Ioff "
      !
   INTEGER Gate,Drain,Source,Bulk,Stat,Stb
   REAL Id1
      !
   IF Vg>=100 THEN GOSUB Disconnect
   Drain=Pins(1)
   Gate=Pins(2)
   Source=Pins(3)
   Bulk=Pins(4)
      ! Connect device
   Connect(FNGnd,Gate,Drain,Source,Bulk)
   Connect(FNPort(0,1),Gate)
   Connect(FNPort(0,2),Drain)
   Connect(FNPort(0,4),Bulk)
      ! ADC mode
   Set_smu_ch(Drain,Adc,0)
   IF Ioff=0 THEN 
     Set_adc(Adc,Integ,Iv)
   END IF
   IF Ioff=1 THEN 
     Set_adc(Adc,Integ,16)
   END IF
   IF Mode=1 THEN 
     Connect(FNPort(0,5),Source)
     Force_v(Source,0,0,.1)
   END IF
      ! Spot measurement
   IF Connect=1 THEN 
     Vd=Type*ABS(Vd)
     Vg=Type*ABS(Vg)
     Force_v(Bulk,Vb,Vb,.1)
     Force_v(Gate,Vg,Vg,.1)
     Force_v(Drain,Vd,Vd,.1)
     Wait_th(Hold)
     Measure_i(Drain,Id,Idrng)
     Id1=Id
     Disable_port
      ! Chuck down then up
     Prober_output("D",Status$,Error$)
     Prober_srq(5,Stb)
     Wait_th(Chuck_hold)
     Prober_output("Z",Status$,Error$)
      ! Re-measure
     Prober_srq(5,Stb)
   END IF
   Vd=Type*ABS(Vd)
   Vg=Type*ABS(Vg)
   Force_v(Bulk,Vb,Vb,.1)
   Force_v(Gate,Vg,Vg,.1)
   Force_v(Drain,Vd,Vd,.1)
   Wait_th(Hold)
   IF Ioff=1 THEN 
     Wait_th(.3)
     Measure_i(Drain,Id,Id,1.E-9)
   END IF
   IF Ioff=0 THEN 
     Measure_i(Drain,Id,Idrng)
   END IF
   !
   Port_status(Drain,Stat)
      !
   Id=ABS(Id)*Type*T/D
   SELECT Unit
   CASE 0
     Id=Id                         !:unit: A
   CASE 1
     Id=Id*1.E+12                  !:unit: pA
   CASE 2
     Id=Id*1.E+6                   !:unit: uA
   CASE 3
     Id=Id*1.E+3                   !:unit: mA
   CASE 4
     Id=LGT(ABS(Id)+1.E-30)        !:unit: LOG10
   END SELECT
   PRINT "Id1=";Id1
   PRINT "Ids=";Id,"Stat";Stat
      !Disable ports and pins
 Disconnect:    !
   Disable_port
   Connect
 SUBEND
 Ileak:SUB Ileak(REAL Vh,INTEGER Unit,REAL T,D,INTEGER Pins(*),Adc,REAL Iv,INTEGER Integ,REAL Hold,Irng,INTEGER Mode,Flag,REAL Ileak)
 !***** DON'T REMOVE THIS LINE *************************************
 !
 !  Type : Algorithm
 !  Name : Ileak
 !  Vers : 1
 !  Desc : Gate leakage current measurement
 !  Date : 10/22/2003
 !  Time : 15:55:15
 !  User : wat
 !
 !***** DON'T REMOVE THIS LINE *************************************
 !
 !  Input Variables:
 !
 !     #  Name            Type Size     Description
 !    --- --------------- ---- -------- --------------------------------
 !    Measurement Parameters:
 !      1 VH              R    -        APPLIED VOLTAGE
 !      2 UNIT            I    -        0: MKS, 1:pA, 2:uA, 3:mA
 !      3 T               R    -        Ig * T
 !      4 D               R    -        Ig / D
 !
 !    Device Terminals:
 !      1 H               I    -        Gate (for Gate leak) / Drain (fo
 !      2 L               I    -        Bulk or substract
 !
 !    Device Parameters:
 !      1 ADC             I    -        ADC TYPE (0:HI-SPEED, 1:HI-RESOL
 !      2 IV              R    -        SAMPLING NUMBER WHEN MANUAL INTE
 !      3 INTEG           I    -        INTEGRATION TIME (0:MAN. 1:S, 2:
 !      4 HOLD            R    -        HOLD TIME
 !      5 IRNG            R    -        GATE CURRENT MEASUREMENT RANGE (
 !      6 MODE            I    -        0:LOW CONNECT GNDU 1:LOW CONNECT
 !      7 FLAG            I    -        1:output abs(Ileak)
 !
 !  Output Variables:
 !
 !     #  Name            Type Size     Description
 !    --- --------------- ---- -------- --------------------------------
 !    Output Parameters:
 !      1 ILEAK           R    -        GATE LEAKAGE CURRENT
 !
 !***** DON'T REMOVE THIS LINE *************************************
   OPTION BASE 1                 !***** DON'T REMOVE THIS LINE *****
   DISP "in Ileak"
    !
   INTEGER H,L,Stat
    !
   H=Pins(1)
   L=Pins(2)
    ! Connect device
   Connect(FNGnd,H,L)
   Connect(FNPort(0,1),H)
   IF Mode=1 THEN 
     Connect(FNPort(0,5),L)
     Force_v(L,0,0,.05)
   END IF
    ! ADC mode
   Set_smu_ch(H,Adc,0)
   Set_adc(Adc,Integ,Iv)
  ! Set_wait_time(Ss,Sm)
    ! Perform spot measurement
   Force_v(H,Vh,Vh,.05)
   Wait_th(Hold)
   Measure_i(H,Ileak,Irng)
   Port_status(H,Stat)
   IF Flag=1 THEN Ileak=ABS(Ileak)
   Ileak=Ileak*T/D
    !
   SELECT Unit
   CASE 0
     Ileak=Ileak                     !:unit: A
   CASE 1
     Ileak=Ileak*1.E+12              !:unit: pA
   CASE 2
     Ileak=Ileak*1.E+6               !:unit: uA
   CASE 3
     Ileak=Ileak*1.E+3               !:unit: mA
   CASE ELSE
     Ileak=Ileak                     !:unit: A
   END SELECT
   PRINT "ILEAK=";Ileak,"Stat";Stat
    ! Disable ports and pins
   Disable_port
   Connect
 SUBEND
 Ileak_hv:SUB Ileak_hv(REAL Vh,INTEGER Unit,REAL T,D,INTEGER Pins(*),Adc,REAL Iv,INTEGER Integ,REAL Hold,Irng,INTEGER Mode,Flag,REAL Ileak)
 !***** DON'T REMOVE THIS LINE *************************************
 !
 !  Type : Algorithm
 !  Name : Ileak_HV
 !  Vers : 1
 !  Desc : Gate leakage current measurement
 !  Date : 10/14/2013
 !  Time : 13:10:22
 !  User : wat
 !
 !***** DON'T REMOVE THIS LINE *************************************
 !
 !  Input Variables:
 !
 !     #  Name            Type Size     Description
 !    --- --------------- ---- -------- --------------------------------
 !    Measurement Parameters:
 !      1 VH              R    -        APPLIED VOLTAGE
 !      2 UNIT            I    -        0: MKS, 1:pA, 2:uA, 3:mA
 !      3 T               R    -        Ig * T
 !      4 D               R    -        Ig / D
 !
 !    Device Terminals:
 !      1 H               I    -        Gate (for Gate leak) / Drain (fo
 !      2 L               I    -        Bulk or substract
 !
 !    Device Parameters:
 !      1 ADC             I    -        ADC TYPE (0:HI-SPEED, 1:HI-RESOL
 !      2 IV              R    -        SAMPLING NUMBER WHEN MANUAL INTE
 !      3 INTEG           I    -        INTEGRATION TIME (0:MAN. 1:S, 2:
 !      4 HOLD            R    -        HOLD TIME
 !      5 IRNG            R    -        GATE CURRENT MEASUREMENT RANGE (
 !      6 MODE            I    -        0:LOW CONNECT GNDU 1:LOW CONNECT
 !      7 FLAG            I    -        1:output abs(Ileak) -1:output -a
 !
 !  Output Variables:
 !
 !     #  Name            Type Size     Description
 !    --- --------------- ---- -------- --------------------------------
 !    Output Parameters:
 !      1 ILEAK           R    -        GATE LEAKAGE CURRENT
 !
 !***** DON'T REMOVE THIS LINE *************************************
   OPTION BASE 1                    !***** DON'T REMOVE THIS LINE *****
   DISP "in Ileak"
                                    !
   INTEGER H,L,Stat
                                    !
   H=Pins(1)
   L=Pins(2)
                                    ! Connect device
   Connect(FNGnd,H,L)
   Connect(FNPort(0,1),H)
   IF Mode=1 THEN 
     Connect(FNPort(0,5),L)
     Force_v(L,0,0,.1)
   END IF
                                    ! ADC mode
   Set_smu_ch(H,Adc,0)
   Set_adc(Adc,Integ,Iv)
    ! Set_wait_time(Ss,Sm)
                                    ! Perform spot measurement
   Force_v(H,Vh,Vh,.04)
   Wait_th(Hold)
   Measure_i(H,Ileak,Irng)
   Port_status(H,Stat)
   IF Flag=1 THEN Ileak=ABS(Ileak)
   IF Flag=-1 THEN Ileak=-ABS(Ileak)
   Ileak=Ileak*T/D
                                    !
   SELECT Unit
   CASE 0
     Ileak=Ileak                          !:unit: A
   CASE 1
     Ileak=Ileak*1.E+12                   !:unit: pA
   CASE 2
     Ileak=Ileak*1.E+6                    !:unit: uA
   CASE 3
     Ileak=Ileak*1.E+3                    !:unit: mA
   CASE ELSE
     Ileak=Ileak                          !:unit: A
   END SELECT
   PRINT "ILEAK=";Ileak,"Stat";Stat
                                    ! Disable ports and pins
   Disable_port
   Connect
 SUBEND
 Ileak_pn:SUB Ileak_pn(REAL Vssa,Vpad,Vdda,Ilim,INTEGER Unit,REAL T,D,INTEGER Pins(*),Adc,REAL Iv,INTEGER Integ,REAL Hold,Irng,INTEGER Mode,Flag,REAL Ileak)
 !***** DON'T REMOVE THIS LINE *************************************
 !
 !  Type : Algorithm
 !  Name : Ileak_PN
 !  Vers : 1
 !  Desc : ESD PN leakage current measurement with 3 terminal
 !  Date : 05/23/2011
 !  Time : 16:08:22
 !  User : wat
 !
 !***** DON'T REMOVE THIS LINE *************************************
 !
 !  Input Variables:
 !
 !     #  Name            Type Size     Description
 !    --- --------------- ---- -------- --------------------------------
 !    Measurement Parameters:
 !      1 VSSA            R    -        APPLIED VOLTAGE
 !      2 VPAD            R    -        APPLIED VOLTAGE
 !      3 VDDA            R    -        APPLIED VOLTAGE
 !      4 Ilim            R    -        current limitation
 !      5 UNIT            I    -        0: MKS, 1:pA, 2:uA, 3:mA
 !      6 T               R    -        Ig * T
 !      7 D               R    -        Ig / D
 !
 !    Device Terminals:
 !      1 Ssa             I    -        SSA Terminal
 !      2 Pad             I    -        PAD Terminal
 !      3 Dda             I    -        DDA Terminal
 !
 !    Device Parameters:
 !      1 ADC             I    -        ADC TYPE (0:HI-SPEED, 1:HI-RESOL
 !      2 IV              R    -        SAMPLING NUMBER WHEN MANUAL INTE
 !      3 INTEG           I    -        INTEGRATION TIME (0:MAN. 1:S, 2:
 !      4 HOLD            R    -        HOLD TIME
 !      5 IRNG            R    -        GATE CURRENT MEASUREMENT RANGE (
 !      6 MODE            I    -        0:LOW CONNECT GNDU 1:LOW CONNECT
 !      7 FLAG            I    -        1:compute common logrithm(must s
 !
 !  Output Variables:
 !
 !     #  Name            Type Size     Description
 !    --- --------------- ---- -------- --------------------------------
 !    Output Parameters:
 !      1 ILEAK           R    -        ESD LEAKAGE CURRENT
 !
 !***** DON'T REMOVE THIS LINE *************************************
   OPTION BASE 1                      !***** DON'T REMOVE THIS LINE *****
   DISP "in Ileak_PN"
                                      !
   INTEGER Ssa,Pad,Dda,Stat
                                      !
   Ssa=Pins(1)
   Pad=Pins(2)
   Dda=Pins(3)
                                      !
   Connect(FNGnd,Ssa,Pad,Dda)
   Connect(FNPort(0,1),Pad)
   Connect(FNPort(0,2),Dda)
   Connect(FNPort(0,3),Ssa)
                                      ! ADC mode
   Set_smu_ch(Pad,Adc,0)
   Set_adc(Adc,Integ,Iv)
                                      ! Perform spot measurement
   Force_v(Dda,Vdda,Vdda,Ilim)
   Force_v(Pad,Vpad,Vpad,Ilim)
   Force_v(Ssa,Vssa,Vssa,Ilim)
   Wait_th(Hold)
   Measure_i(FNPort(0,1),Ileak,Irng)
   Port_status(FNPort(0,1),Stat)
   Ileak=Ileak*T/D
   IF Flag=1 THEN Ileak=ABS(LGT(ABS(Ileak)+(1.E-20)))
                                      !
   SELECT Unit
   CASE 0
     Ileak=Ileak                            !:unit: A
   CASE 1
     Ileak=Ileak*1.E+12                     !:unit: pA
   CASE 2
     Ileak=Ileak*1.E+6                      !:unit: uA
   CASE 3
     Ileak=Ileak*1.E+3                      !:unit: mA
   CASE ELSE
     Ileak=Ileak                            !:unit: A
   END SELECT
                                      !
   PRINT "ILEAK=";Ileak,"Stat";Stat
                                      ! Disable ports and pins
   Disable_port
   Connect
 SUBEND
 In_out:SUB In_out(REAL In,Ratio,Out)
 !***** DON'T REMOVE THIS LINE *************************************
 !
 !  Type : Algorithm
 !  Name : In_out
 !  Vers : 1
 !  Desc : How to save an hidden parameter. Out = In * Ratio.
 !  Date : 05/31/2002
 !  Time : 16:11:26
 !  User : wat
 !
 !***** DON'T REMOVE THIS LINE *************************************
 !
 !  Input Variables:
 !
 !     #  Name            Type Size     Description
 !    --- --------------- ---- -------- --------------------------------
 !    Measurement Parameters:
 !      1 In              R    -
 !      2 Ratio           R    -
 !
 !  Output Variables:
 !
 !     #  Name            Type Size     Description
 !    --- --------------- ---- -------- --------------------------------
 !    Output Parameters:
 !      1 Out             R    -
 !
 !***** DON'T REMOVE THIS LINE *************************************
   OPTION BASE 1 !***** DON'T REMOVE THIS LINE *****
  !
   Out=In*Ratio
  !
 SUBEND
 Isoff:SUB Isoff(REAL E,Vd,INTEGER Unit,REAL T,D,INTEGER Pins(*),Adc,REAL Iv,INTEGER Integ,REAL Hold,Isrng,INTEGER Mode,Flag,REAL Icom,Is)
 !***** DON'T REMOVE THIS LINE *************************************
 !
 !  Type : Algorithm
 !  Name : Isoff
 !  Vers : 1
 !  Desc : Ids measurement at Vg=0 and specified Vds
 !  Date : 02/06/2023
 !  Time : 14:57:50
 !  User : wat
 !
 !***** DON'T REMOVE THIS LINE *************************************
 !
 !  Input Variables:
 !
 !     #  Name            Type Size     Description
 !    --- --------------- ---- -------- --------------------------------
 !    Measurement Parameters:
 !      1 E               R    -        VD* E
 !      2 VD              R    -        APPLIED VOLTAGE
 !      3 UNIT            I    -        0: MKS, 1:pA, 2:uA, 3:mA
 !      4 T               R    -        Idoff * T
 !      5 D               R    -        Idoff / D
 !
 !    Device Terminals:
 !      1 DRAIN           I    -        DRAIN TERMINAL
 !      2 GATE            I    -        GATE TERMINAL
 !      3 SOURCE          I    -        SOURCE TERMINAL
 !      4 BULK            I    -        WELL OR BULK
 !
 !    Device Parameters:
 !      1 ADC             I    -        ADC TYPE (0:HI-SPEED, 1:HI-RESOL
 !      2 IV              R    -        SAMPLING NUMBER WHEN MANUAL INTE
 !      3 INTEG           I    -        INTEGRATION TIME (0:MAN, 1:S, 2:
 !      4 HOLD            R    -        HOLD TIME
 !      5 ISRNG           R    -        GATE CURRENT MEASUREMENT RANGE (
 !      6 MODE            I    -        0:no abs 1:for NMOS -1:for PMOS
 !      7 FLAG            I    -        1:compute common logarithm(must
 !      8 ICOM            R    -        Icompliance for Drain
 !
 !  Output Variables:
 !
 !     #  Name            Type Size     Description
 !    --- --------------- ---- -------- --------------------------------
 !    Output Parameters:
 !      1 IS              R    -        SOURCE CURRENT @VG=0
 !
 !***** DON'T REMOVE THIS LINE *************************************
   OPTION BASE 1                   !***** DON'T REMOVE THIS LINE *****
   DISP "in Idoff"
                                  !
   INTEGER Gate,Drain,Source,Bulk,Stat
                                  !
   Drain=Pins(1)
   Gate=Pins(2)
   Source=Pins(3)
   Bulk=Pins(4)
                                  ! Connect device
   Connect(FNGnd,Gate,Drain,Source,Bulk)
   Connect(FNPort(0,1),Drain)
   !IF Mode=1 THEN
   Connect(FNPort(0,2),Source)    !Edited by AndyWang 20230206
   !END IF
                                  ! ADC mode
   Set_smu_ch(Drain,Adc,0)
   Set_adc(Adc,Integ,Iv)
   ! Set_wait_time(Ss,Sm)
                                  ! Spot measurement
   Force_v(Drain,E*Vd,E*Vd,Icom)    !Add Coefficient to VD AndyWang
   Wait_th(Hold)
   Measure_i(Source,Is,Isrng)
   Port_status(Drain,Stat)
   IF Mode=1 THEN 
     Is=ABS(Is)
   ELSE
     IF Mode=-1 THEN 
       Is=-ABS(Is)
     END IF
   END IF
                                  !
   Is=Is*T/D
   IF Flag=1 THEN Is=-LGT(ABS(Is)+1.E-20)     ! get Idoff=-log(Idmeas)
   SELECT Unit
   CASE 0
     Is=Is                        !:unit: A
   CASE 1
     Is=Is*1.E+12                 !:unit: pA
   CASE 2
     Is=Is*1.E+6                  !:unit: uA
   CASE 3
     Is=Is*1.E+3                  !:unit: mA
   CASE ELSE
     Is=Is                        !:unit: A
   END SELECT
   PRINT "Isoff=",Is;"Stat",Stat
                                  ! Disable ports and pins
   Disable_port
   Connect
 SUBEND
 Isubmax:SUB Isubmax(REAL Vd,Vb,Vgmin,Vgmax,Vgstep,INTEGER Unit,REAL T,D,INTEGER Pins(*),Adc,REAL Iv,INTEGER Integ,REAL Isbmx,Vg)
 !***** DON'T REMOVE THIS LINE *************************************
 !
 !  Type : Algorithm
 !  Name : Isubmax
 !  Vers : 1
 !  Desc : Maximum hot-carrier substrate current (Returns Vgs, Ids,
 !       : M-factor)
 !  Date : 05/25/2022
 !  Time : 16:06:33
 !  User : keysight
 !
 !***** DON'T REMOVE THIS LINE *************************************
 !
 !  Input Variables:
 !
 !     #  Name            Type Size     Description
 !    --- --------------- ---- -------- --------------------------------
 !    Measurement Parameters:
 !      1 VD              R    -        DRAIN TO SOURCE BIAS
 !      2 VB              R    -        BULK TO SOURCE BIAS
 !      3 VGMIN           R    -        START GATE VOLTAGE
 !      4 VGMAX           R    -        STOP GATE VOLTAGE
 !      5 VGSTEP          R    -        STEP GATE VOLTAGE
 !      6 UNIT            I    -        0: MKS, 1:pA, 2:uA, 3:mA, 4:nA
 !      7 T               R    -        Isbmx * T
 !      8 D               R    -        Isbmx / D
 !
 !    Device Terminals:
 !      1 DRAIN           I    -        DRAIN TERMINAL
 !      2 GATE            I    -        GATE TERMINAL
 !      3 SOURCE          I    -        SOURCE TERMINAL
 !      4 BULK            I    -        WELL OR BULK
 !
 !    Device Parameters:
 !      1 ADC             I    -        ADC TYPE (0:HI-SPEED, 1:HI-RESOL
 !      2 IV              R    -        SAMPLING NUMBER WHEN MANUAL INTE
 !      3 INTEG           I    -        INTEGRATION TIME (0:MAN, 1:S, 2:
 !
 !  Output Variables:
 !
 !     #  Name            Type Size     Description
 !    --- --------------- ---- -------- --------------------------------
 !    Output Parameters:
 !      1 ISBMX           R    -        MAXIMUM VALUE OF ISUB
 !      2 VG              R    -        GATE VOLTAGE @ISBMX
 !
 !***** DON'T REMOVE THIS LINE *************************************
   OPTION BASE 1                  !***** DON'T REMOVE THIS LINE *****
   DISP "in Isubmax"
     !
   INTEGER Gate,Drain,Source,Bulk,Stat,Steps,Pol
   REAL Isb(1001),Vgs(1001)
     !
   Drain=Pins(1)
   Gate=Pins(2)
   Source=Pins(3)
   Bulk=Pins(4)
     ! Connect device terminals
   Connect(FNGnd,Gate,Drain,Source,Bulk)
   Connect(FNPort(0,1),Drain)
   Connect(FNPort(0,2),Gate)
   Connect(FNPort(0,3),Bulk)
     ! ADC mode
   Set_smu_ch(Drain,Adc,0)
   Set_adc(Adc,Integ,Iv)
  ! Set_wait_time(Ss,Sm)
     ! Calculate # of gate steps
   Steps=ABS((Vgmax-Vgmin)/(Vgstep)+1)
   REDIM Isb(Steps),Vgs(Steps)
     ! Set polarity, Sweep measure
   Pol=1
   IF Vgmax<0 THEN Pol=-1
   Force_v(Bulk,Vb,Vb,.1)
   Force_v(Drain,Vd,Vd,.1)
   Set_iv(Gate,1,Vgmax,Vgmin,Vgmax,Steps,0,0,.1)
   Sweep_iv(Bulk,2,0,Isb(*),Vgs(*))
     ! To find the Isubmax
   Isbmx=ABS(Isb(1))
   Vg=Vgs(1)
   FOR I=2 TO Steps
     IF ABS(Isb(I))>Isbmx THEN 
       Isbmx=ABS(Isb(I))
       Vg=Vgs(I)
     END IF
   NEXT I
   Isbmx=Isbmx*Pol*T/D
     ! Convert the unit
   SELECT Unit
   CASE 0
     Isbmx=Isbmx                      !:unit: A
   CASE 1
     Isbmx=Isbmx*1.E+12               !:unit: pA
   CASE 2
     Isbmx=Isbmx*1.E+6                !:unit: uA
   CASE 3
     Isbmx=Isbmx*1.E+3                !:unit: mA
   CASE 4
     Isbmx=Isbmx*1.E+9                !:unit: nA
   CASE ELSE
     Isbmx=Isbmx                      !:unit: A
   END SELECT
   PRINT "Isbmx=";Isbmx
           ! Disconnect
   Disable_port
   Connect
 SUBEND
 Isubmax_tb:SUB Isubmax_tb(REAL Type,Vd,Vb,Vgmin,Vgmax,Vgstep,INTEGER Unit,REAL T,D,INTEGER Pins(*),Adc,REAL Iv,INTEGER Integ,REAL Isbmx)
 !***** DON'T REMOVE THIS LINE *************************************
 !
 !  Type : Algorithm
 !  Name : Isubmax_TB
 !  Vers : 1
 !  Desc : Maximum hot-carrier substrate current (Returns Vgs, Ids,
 !       : M-factor)
 !       : 2014 base on Isubmax set up TB alg
 !  Date : 10/09/2014
 !  Time : 13:20:35
 !  User : wat
 !
 !***** DON'T REMOVE THIS LINE *************************************
 !
 !  Input Variables:
 !
 !     #  Name            Type Size     Description
 !    --- --------------- ---- -------- --------------------------------
 !    Measurement Parameters:
 !      1 TYPE            R    -        1:Nmos;-1:Pmos
 !      2 VD              R    -        DRAIN TO SOURCE BIAS default Vd=
 !      3 VB              R    -        BULK TO SOURCE BIAS default Vb=0
 !      4 VGMIN           R    -        START GATE VOLTAGE Default Vgmin
 !      5 VGMAX           R    -        STOP GATE VOLTAGE  Default Vgmax
 !      6 VGSTEP          R    -        STEP GATE VOLTAGE   Default Vgst
 !      7 UNIT            I    -        0: A, 1:pA, 2:nA, 3:uA, 4:mA, 5:
 !      8 T               R    -        Isbmx * T
 !      9 D               R    -        Isbmx / D
 !
 !    Device Terminals:
 !      1 DRAIN           I    -        DRAIN TERMINAL
 !      2 GATE            I    -        GATE TERMINAL
 !      3 SOURCE          I    -        SOURCE TERMINAL
 !      4 BULK            I    -        WELL OR BULK
 !
 !    Device Parameters:
 !      1 ADC             I    -        ADC TYPE (0:HI-SPEED, 1:HI-RESOL
 !      2 IV              R    -        SAMPLING NUMBER WHEN MANUAL INTE
 !      3 INTEG           I    -        INTEGRATION TIME (0:MAN, 1:S, 2:
 !
 !  Output Variables:
 !
 !     #  Name            Type Size     Description
 !    --- --------------- ---- -------- --------------------------------
 !    Output Parameters:
 !      1 ISBMX           R    -        MAXIMUM VALUE OF ISUB
 !
 !***** DON'T REMOVE THIS LINE *************************************
   OPTION BASE 1                  !***** DON'T REMOVE THIS LINE *****
   ON ERROR GOSUB System_error
   DISP "Isubmax_TB"
     !
   INTEGER Gate,Drain,Source,Bulk,Steps,Pol
   IF Type<>1 AND Type<>-1 THEN GOSUB Par_error
   IF T<=0 OR D<=0 THEN GOSUB Par_error
   REAL Isb(1001),Vgs(1001)
     !
   Drain=Pins(1)
   Gate=Pins(2)
   Source=Pins(3)
   Bulk=Pins(4)
     ! Connect device terminals
   Connect(FNGnd,Gate,Drain,Source,Bulk)
   Connect(FNPort(0,1),Drain)
   Connect(FNPort(0,4),Gate)
   Connect(FNPort(0,2),Bulk)
     ! ADC mode
   Set_smu_ch(Bulk,Adc,0)
   Set_adc(Adc,Integ,Iv)
   Steps=ABS((Vgmax-Vgmin)/(Vgstep)+1)
   REDIM Isb(Steps),Vgs(Steps)
     ! Set polarity, Sweep measure
   Vd=ABS(Vd)*Type
   Vgmin=ABS(Vgmin)*Type
   Vgmax=ABS(Vgmax)*Type
   Pol=1
   IF Vgmax<0 THEN Pol=-1
   Force_v(Bulk,Vb,Vb,.1)
   Force_v(Drain,Vd,Vd,.1)
   Set_iv(Gate,1,Vgmax,Vgmin,Vgmax,Steps,0,0,.1)
   Sweep_iv(Bulk,2,0,Isb(*),Vgs(*))
     ! To find the Isubmax
   Isbmx=ABS(Isb(1))
   Vg=Vgs(1)
   FOR I=2 TO Steps
     IF ABS(Isb(I))>Isbmx THEN 
       Isbmx=ABS(Isb(I))
       Vg=Vgs(I)
     END IF
   NEXT I
   Isbmx=Isbmx*Pol*T/D
     ! Convert the unit
   SELECT Unit
   CASE 0
     Isbmx=Isbmx                      !:unit: A
   CASE 1
     Isbmx=Isbmx*1.E+12               !:unit: pA
   CASE 2
     Isbmx=Isbmx*1.E+9                !:unit: nA
   CASE 3
     Isbmx=Isbmx*1.E+6                !:unit: uA
   CASE 4
     Isbmx=Isbmx*1.E+3                !:unit: mA
   CASE 5
     Isbmx=LGT(ABS(Isbmx)+1.E-30)                  !:unit: LOG10
   END SELECT
   PRINT "Isbmx=";Isbmx
           ! Disconnect
  !-------------------------------------
   GOSUB Disconnect
   SUBEXIT
  !*****************error handling block*****************
 System_error:                           ! system error handling
   Isbmx=ERRN*1.E+32
   PRINT ERRN;ERRM$
   GOSUB Disconnect
   SUBEXIT
 Par_error:                             !user defined error handing
   Isbmx=2.E+30
   GOSUB Disconnect
   SUBEXIT
  !**************hardware clean block************************
 Disconnect:                            !Disable used ports,disconnent pins
   Disable_port
   Connect
   OFF ERROR 
  !
 SUBEND
 Log:SUB Log(REAL A,T,D,C)
 !***** DON'T REMOVE THIS LINE *************************************
 !
 !  Type : Algorithm
 !  Name : LOG
 !  Vers : 1
 !  Desc : Calculate ABS(A)*T/D
 !  Date : 11/05/2003
 !  Time : 13:29:15
 !  User : wat
 !
 !***** DON'T REMOVE THIS LINE *************************************
 !
 !  Input Variables:
 !
 !     #  Name            Type Size     Description
 !    --- --------------- ---- -------- --------------------------------
 !    Measurement Parameters:
 !      1 A               R    -        ABS(A)
 !      2 T               R    -        ABS(A)*T
 !      3 D               R    -        ABS(A)/D
 !
 !  Output Variables:
 !
 !     #  Name            Type Size     Description
 !    --- --------------- ---- -------- --------------------------------
 !    Output Parameters:
 !      1 C               R    -        C=ABS(A)*T/D
 !
 !***** DON'T REMOVE THIS LINE *************************************
   OPTION BASE 1 !***** DON'T REMOVE THIS LINE *****
   C=LGT(A)*T/D
 SUBEND
 Max_abs:SUB Max_abs(REAL A,B,C,D,Max_abs)
 !***** DON'T REMOVE THIS LINE *************************************
 !
 !  Type : Algorithm
 !  Name : MAX_ABS
 !  Vers : 1
 !  Desc : MAX(abs(A),abs(B),abs(C),abs(D))
 !  Date : 03/21/2019
 !  Time : 11:27:00
 !  User : keysight
 !
 !***** DON'T REMOVE THIS LINE *************************************
 !
 !  Input Variables:
 !
 !     #  Name            Type Size     Description
 !    --- --------------- ---- -------- --------------------------------
 !    Measurement Parameters:
 !      1 A               R    -
 !      2 B               R    -
 !      3 C               R    -
 !      4 D               R    -
 !
 !  Output Variables:
 !
 !     #  Name            Type Size     Description
 !    --- --------------- ---- -------- --------------------------------
 !    Output Parameters:
 !      1 MAX_ABS         R    -
 !
 !***** DON'T REMOVE THIS LINE *************************************
   OPTION BASE 1
                     ! MAX_ABS
   Max_abs=MAX(ABS(A),ABS(B),ABS(C),ABS(D))
                     !
 SUBEND
 Min:SUB Min(REAL A,B,C,D,E)
 !***** DON'T REMOVE THIS LINE *************************************
 !
 !  Type : Algorithm
 !  Name : Min
 !  Vers : 1
 !  Desc : Calculate Min
 !  Date : 06/07/2012
 !  Time : 09:25:50
 !  User : wat
 !
 !***** DON'T REMOVE THIS LINE *************************************
 !
 !  Input Variables:
 !
 !     #  Name            Type Size     Description
 !    --- --------------- ---- -------- --------------------------------
 !    Measurement Parameters:
 !      1 A               R    -        Data A
 !      2 B               R    -        Data B
 !      3 C               R    -        Data C
 !      4 D               R    -        Data D
 !
 !  Output Variables:
 !
 !     #  Name            Type Size     Description
 !    --- --------------- ---- -------- --------------------------------
 !    Output Parameters:
 !      1 E               R    -        D=Min(A,B,C,D)
 !
 !***** DON'T REMOVE THIS LINE *************************************
   OPTION BASE 1 !***** DON'T REMOVE THIS LINE *****
   E=MIN(A,B,C,D)
 SUBEND
 Min_abs:SUB Min_abs(REAL A,B,C,D,Min_abs)
 !***** DON'T REMOVE THIS LINE *************************************
 !
 !  Type : Algorithm
 !  Name : MIN_ABS
 !  Vers : 1
 !  Desc : MIN(abs(A),abs(B),abs(C),abs(D))
 !  Date : 12/15/2010
 !  Time : 10:18:33
 !  User : wat
 !
 !***** DON'T REMOVE THIS LINE *************************************
 !
 !  Input Variables:
 !
 !     #  Name            Type Size     Description
 !    --- --------------- ---- -------- --------------------------------
 !    Measurement Parameters:
 !      1 A               R    -
 !      2 B               R    -
 !      3 C               R    -
 !      4 D               R    -
 !
 !  Output Variables:
 !
 !     #  Name            Type Size     Description
 !    --- --------------- ---- -------- --------------------------------
 !    Output Parameters:
 !      1 MIN_ABS         R    -
 !
 !***** DON'T REMOVE THIS LINE *************************************
   OPTION BASE 1
                                                  ! MIN_ABS
   Min_abs=MIN(ABS(A),ABS(B),ABS(C),ABS(D))
                                                  !
 SUBEND
 Prog:SUB Prog(REAL Vsg,Vcg,Vb,Vd,Width,Delay,Leading,Trailing,INTEGER Pins(*),Type,REAL Amplitude2,Base,Load,Pno,Period)
 !***** DON'T REMOVE THIS LINE *************************************
 !
 !  Type : Algorithm
 !  Name : PROG
 !  Vers : 1
 !  Date : 08/19/2002
 !  Time : 12:11:38
 !  User : specs
 !
 !***** DON'T REMOVE THIS LINE *************************************
 !
 !  Input Variables:
 !
 !     #  Name            Type Size     Description
 !    --- --------------- ---- -------- --------------------------------
 !    Measurement Parameters:
 !      1 VSG             R    -
 !      2 VCG             R    -
 !      3 VB              R    -
 !      4 VD              R    -        AMPLITUDE1
 !      5 WIDTH           R    -
 !      6 DELAY           R    -
 !      7 LEADING         R    -
 !      8 TRAILING        R    -
 !
 !    Device Terminals:
 !      1 DRAIN           I    -        DRAIN TERMINAL
 !      2 SGATE           I    -        SELECT GATE
 !      3 CGATE           I    -        CONTROL GATE
 !      4 SOURCE          I    -        SOURCE
 !      5 BULK            I    -        WELL OR BULK
 !
 !    Device Parameters:
 !      1 TYPE            I    -
 !      2 AMPLITUDE2      R    -
 !      3 BASE            R    -
 !      4 LOAD            R    -
 !      5 PNO             R    -
 !      6 PERIOD          R    -
 !
 !  Output Variables:
 !
 !***** DON'T REMOVE THIS LINE *************************************
   OPTION BASE 1
   INTEGER Drain,Sgate,Cgate,Source,Bulk
                 !
   Drain=Pins(1)
   Sgate=Pins(2)
   Cgate=Pins(3)
   Source=Pins(4)
   Bulk=Pins(5)
                 ! Grounding
   Connect(FNGnd,Drain,Sgate,Cgate,Source,Bulk)
                 ! Set Source terminal to open
   Connect(0,Source)
                 ! Connect
   Connect(FNPort(0,1),Sgate)
   Connect(FNPort(3,1),Drain)
                 ! Force voltage
   Force_v(Sgate,Vsg,Vsg,.1)
                 ! Set pulse level: 1 for 2-level and 2 for 3-level
   Set_type_pg(Drain,Type)
                 ! Set pulse voltage and impedance
   Set_level_pg(Drain,Vd,Amplitude2,Base,Load)
                 ! Set pulse timing
   Set_time_pg(Drain,Width,Delay,Leading,Trailing)
                 !
   Force_pg(Pno,Period)
                 !
   Disable_port
   Connect
 SUBEND
 Prog_tb:SUB Prog_tb(REAL Vsg,Vcg,Vb,Vd,Width,Delay,Leading,Trailing,INTEGER Pins(*),Type,REAL Amplitude2,Base,Load,Pno,Period)
 !***** DON'T REMOVE THIS LINE *************************************
 !
 !  Type : Algorithm
 !  Name : PROG_TB
 !  Vers : 1
 !  Date : 05/15/2019
 !  Time : 17:33:09
 !  User : keysight
 !
 !***** DON'T REMOVE THIS LINE *************************************
 !
 !  Input Variables:
 !
 !     #  Name            Type Size     Description
 !    --- --------------- ---- -------- --------------------------------
 !    Measurement Parameters:
 !      1 VSG             R    -        Default  1V
 !      2 VCG             R    -        Default  0V
 !      3 VB              R    -        Default  0V
 !      4 VD              R    -        Default  0V
 !      5 WIDTH           R    -        Default  0.001sec
 !      6 DELAY           R    -        Default 0.1sec
 !      7 LEADING         R    -        Default 0.00001sec
 !      8 TRAILING        R    -        Default 0.00001sec
 !
 !    Device Terminals:
 !      1 DRAIN           I    -        DRAIN TERMINAL
 !      2 SGATE           I    -        SELECT GATE
 !      3 CGATE           I    -        CONTROL GATE
 !      4 SOURCE          I    -        SOURCE
 !      5 BULK            I    -        WELL OR BULK
 !
 !    Device Parameters:
 !      1 TYPE            I    -
 !      2 AMPLITUDE2      R    -
 !      3 BASE            R    -
 !      4 LOAD            R    -
 !      5 PNO             R    -
 !      6 PERIOD          R    -
 !
 !  Output Variables:
 !
 !***** DON'T REMOVE THIS LINE *************************************
   OPTION BASE 1
   INTEGER Drain,Sgate,Cgate,Source,Bulk
                 !
   Drain=Pins(1)
   Sgate=Pins(2)
   Cgate=Pins(3)
   Source=Pins(4)
   Bulk=Pins(5)
                 ! Grounding
   Connect(FNGnd,Drain,Sgate,Cgate,Source,Bulk)
                 ! Set Source terminal to open
   Connect(0,Source)
                 ! Connect
   Connect(FNPort(0,1),Sgate)
   Connect(FNPort(3,1),Drain)
                 ! Force voltage
   Force_v(Sgate,Vsg,Vsg,.1)
                 ! Set pulse level: 1 for 2-level and 2 for 3-level
   Set_type_pg(Drain,Type)
                 ! Set pulse voltage and impedance
   Set_level_pg(Drain,Vd,Amplitude2,Base,Load)
                 ! Set pulse timing
   Set_time_pg(Drain,Width,Delay,Leading,Trailing)
                 !
   Force_pg(Pno,Period)
                 !
   Disable_port
   Connect
 SUBEND
 Qrvbd:SUB Qrvbd(REAL Type,Tox,Vstep,Vstop,Tstress,V_test,R_stop,Vstress,INTEGER Pins(*),REAL Vbd)
 !***** DON'T REMOVE THIS LINE *************************************
 !
 !  Type : Algorithm
 !  Name : QRvbd
 !  Vers : 1
 !  Date : 03/21/2019
 !  Time : 11:27:15
 !  User : keysight
 !
 !***** DON'T REMOVE THIS LINE *************************************
 !
 !  Input Variables:
 !
 !     #  Name            Type Size     Description
 !    --- --------------- ---- -------- --------------------------------
 !    Measurement Parameters:
 !      1 Type            R    -
 !      2 Tox             R    -        Oxide thickness
 !      3 Vstep           R    -        Step voltage
 !      4 Vstop           R    -        Stop voltage
 !      5 Tstress         R    -        Stress time
 !      6 V_test          R    -        Test voltage
 !      7 R_stop          R    -        Isolation spec
 !      8 Vstress         R    -
 !
 !    Device Terminals:
 !      1 Hi              I    -        Hi pin
 !      2 Lo              I    -        Lo pin
 !      3 Bulk            I    -        Bulk pin
 !
 !  Output Variables:
 !
 !     #  Name            Type Size     Description
 !    --- --------------- ---- -------- --------------------------------
 !    Output Parameters:
 !      1 Vbd             R    -        Breakdown voltage
 !
 !***** DON'T REMOVE THIS LINE *************************************
   OPTION BASE 1                   !***** DON'T REMOVE THIS LINE *****
   REAL Ileak,I_leak,Rmeas
   INTEGER Hi,Lo,Bulk
   Hi=Pins(1)
   Lo=Pins(2)
   Bulk=Pins(3)
   Set_smu_ch(FNPort(0,1),1,1)
   Set_adc(1,2)
  !Vstress=Type*Tox/100.0           ! Test Condition : 1MV/CM
      !  ACCUMULATION MODE TEST
   Ileak=0.
   I_leak=0.
   Connect(FNPort(0,9),Hi,Lo,Bulk)
   Connect(FNPort(0,1),Hi)
   Connect(FNPort(0,2),Lo,Bulk)
   Force_v(FNPort(0,2),0,0,1.E-1)
   Force_v(FNPort(0,1),Vstress,Vstress,5.E-2)
   Measure_i(FNPort(0,1),Ileak,1.E-4)
   Disable_port(FNPort(0,1),FNPort(0,2))
   PRINT Vstress,Ileak
  !IF ABS(Ileak)>1.E-6 THEN
  !  Vbd=0
  !  GOTO Je
  !END IF
 Loop:Vstress=Vstress+Vstep
   IF ABS(Vstress)>ABS(Vstop) THEN 
     Vbd=Vstop
     GOTO Je
   END IF
   Force_v(FNPort(0,2),0,0,1.E-1)
   Force_v(FNPort(0,1),Vstress,Vstress,5.E-2)
   Wait_th(Tstress)
   Measure_i(FNPort(0,1),Ileak,1.E-4)
   Disable_port(FNPort(0,1),FNPort(0,2))
   Force_v(FNPort(0,2),0,1.E-2)
   Force_v(FNPort(0,1),V_test,V_test)
   Measure_i(FNPort(0,1),I_leak,1.E-4)
   Disable_port(FNPort(0,1),FNPort(0,2))
   Rmeas=ABS(V_test/(I_leak+1.E-15))
   PRINT Vstress,Ileak,V_test,I_leak,Rmeas
   IF ABS(Rmeas)<1.E+5 THEN 
     Vbd=Vstress-Vstep
     GOTO Je
   END IF
   GOTO Loop
 Je:Connect(0,Hi,Lo,Bulk)
   Set_smu_ch(FNPort(0,1),0,0)
 SUBEND
 R2t_ctm:SUB R2t_ctm(REAL Vf,R0,Sqr,Count,INTEGER Unit,REAL T,D,INTEGER Pins(*),Adc,REAL Iv,INTEGER Integ,REAL Icomp,Hold,Res)
 !***** DON'T REMOVE THIS LINE *************************************
 !
 !  Type : Algorithm
 !  Name : R2t_ctm
 !  Vers : 1
 !  Desc : Res=(Vf/Im-(count/2)*Rs*SQR)/count
 !  Date : 05/27/2003
 !  Time : 08:53:16
 !  User : wat
 !
 !***** DON'T REMOVE THIS LINE *************************************
 !
 !  Input Variables:
 !
 !     #  Name            Type Size     Description
 !    --- --------------- ---- -------- --------------------------------
 !    Measurement Parameters:
 !      1 VF              R    -        VOLTAGE TO APPLY
 !      2 R0              R    -        Rs
 !      3 SQR             R    -        Sqr=(L/W)
 !      4 COUNT           R    -        VIA COUNTS
 !      5 UNIT            I    -        0:ohm, 1: Kohm, 2: mohm, 3: Mohm
 !      6 T               R    -        R * T
 !      7 D               R    -        R / D
 !
 !    Device Terminals:
 !      1 H               I    -        HIGH TERMINAL
 !      2 L               I    -        LOW TERMINAL
 !
 !    Device Parameters:
 !      1 ADC             I    -        ADC TYPE (0:HI-SPEED, 1:HI-RESOL
 !      2 IV              R    -        SAMPLING NUMBER WHEN MANUAL INTE
 !      3 INTEG           I    -        0:RES, 1: R/sqr or R/count)
 !      4 ICOMP           R    -        CURRENT COMPLIANCE
 !      5 HOLD            R    -        HOLD TIME
 !
 !  Output Variables:
 !
 !     #  Name            Type Size     Description
 !    --- --------------- ---- -------- --------------------------------
 !    Output Parameters:
 !      1 RES             R    -        RESISTANCE OR RHO
 !
 !***** DON'T REMOVE THIS LINE *************************************
   OPTION BASE 1                 !***** DON'T REMOVE THIS LINE *****
   DISP "in R2t_ctm"
    !
   INTEGER H,L,Stat
    !
   H=Pins(1)
   L=Pins(2)
    ! Connect device
   Connect(FNGnd,H,L)
   Wait_th(.1)
   Connect(FNPort(0,2),H)
    ! ADC mode
   Set_smu_ch(H,Adc,0)
   Set_adc(Adc,Integ,Iv)
  !Set_wait_time(Ss,Sm)
    ! Spot measurement
   Force_v(H,Vf,Vf,Icomp)
   Wait_th(Hold)
   Measure_i(H,Im,0)
   Port_status(H,Stat)
    ! Res value calculation
   Res=(Vf/(Im+1.E-30)-(Count/2)*R0*Sqr)/Count
   PRINT "Res=";Res,"Stat";Stat
    !
   IF Res<0 THEN 
     Res=999
     SUBEXIT
   END IF
     ! ---------------------------------
   SELECT Unit
   CASE 0
     Res=Res      ! ohm
   CASE 1
     Res=Res*1.E-3 ! Kohm
   CASE 2
     Res=Res*1.E+3 ! mohm
   CASE 3
     Res=Res*1.E-6 ! Mohm
   CASE ELSE
     Res=Res
   END SELECT
     !
   Res=Res*T/D
    ! Disable ports and pins
   Disable_port
   Connect
 SUBEND
 R2t_fi:SUB R2t_fi(REAL Iforce,INTEGER Flg,REAL Sqr,Count,INTEGER Unit,REAL T,D,INTEGER Pins(*),Adc,REAL Iv,INTEGER Integ,REAL Vcomp,Hold,Res)
 !***** DON'T REMOVE THIS LINE *************************************
 !
 !  Type : Algorithm
 !  Name : R2t_fi
 !  Vers : 1
 !  Desc : Res=Vm/If
 !  Date : 08/06/2002
 !  Time : 16:28:32
 !  User : wat
 !
 !***** DON'T REMOVE THIS LINE *************************************
 !
 !  Input Variables:
 !
 !     #  Name            Type Size     Description
 !    --- --------------- ---- -------- --------------------------------
 !    Measurement Parameters:
 !      1 IFORCE          R    -        CURRENT TO APPLY
 !      2 FLG             I    -        unit flag (0: R 1: R/sqr 2: R/co
 !      3 SQR             R    -        SQR=(L/W), use to calculate R=R/
 !      4 COUNT           R    -        VIA COUNTS
 !      5 UNIT            I    -        0:ohm, 1: Kohm, 2: mohm, 3: Mohm
 !      6 T               R    -        R * T
 !      7 D               R    -        R / D
 !
 !    Device Terminals:
 !      1 H               I    -        HIGH TERMINAL
 !      2 L               I    -        LOW TERMINAL
 !
 !    Device Parameters:
 !      1 ADC             I    -        ADC TYPE (0:HI-SPEED, 1:HI-RESOL
 !      2 IV              R    -        SAMPLING NUMBER WHEN MANUAL INTE
 !      3 INTEG           I    -        INTEGRATION TIME (0:MAN. 1:S, 2:
 !      4 VCOMP           R    -        VOLTAGE COMPLIANCE
 !      5 HOLD            R    -        HOLD TIME
 !
 !  Output Variables:
 !
 !     #  Name            Type Size     Description
 !    --- --------------- ---- -------- --------------------------------
 !    Output Parameters:
 !      1 RES             R    -        RESISTANCE OR RHO
 !
 !***** DON'T REMOVE THIS LINE *************************************
   OPTION BASE 1                  !***** DON'T REMOVE THIS LINE *****
   DISP "in R2t_fi"
   INTEGER H,L,Stat,Stb
     !
   H=Pins(1)
   L=Pins(2)
     !
     ! Connect
     !
   FOR I=1 TO 10
     Connect_th(FNPort(0,9),1,49)
     Wait_th(Hold)
   NEXT I
   Connect
  !
   Connect(FNPort(0,4),H)
   Connect(FNPort(0,9),L,49)
     ! ADC mode
     !
   Set_smu_ch(H,Adc,0)
   Set_adc(Adc,Integ,Iv)
  !Set_wait_time(Ss,Sm)
     ! Perform spot measurement
     !
   Force_i(H,Iforce,Iforce,Vcomp)
  !Force_v(L,0,0,1.E-2)
   Wait_th(Hold)
   Measure_v(H,Vm,0)
   PRINT "Vm1=";Vm
   Prober_output("D",Status$,Error$)
   Prober_srq(5,Stb)
   PRINT "Stb=";Stb
   Wait_th(Hold)
   Prober_output("Z",Status$,Error$)
   Prober_srq(5,Stb)
   PRINT "Stb=";Stb
   Measure_v(H,Vm,0)
   Port_status(H,Stat)
   PRINT "Vm=";Vm,"Stat=",Stat
     ! Resistance value calculation
   SELECT Flg
   CASE 0
     Res=ABS(Vm/Iforce)
   CASE 1
     Res=ABS((Vm/Iforce)/Sqr)
   CASE 2
     Res=ABS((Vm/Iforce)/Count)
   END SELECT
     ! ------------------------------------
   SELECT Unit
   CASE 0
     Res=Res      ! ohm
   CASE 1
     Res=Res*1.E-3 ! Kohm
   CASE 2
     Res=Res*1.E+3 ! mohm
   CASE 3
     Res=Res*1.E-6 ! Mohm
   CASE ELSE
     Res=Res
   END SELECT
     !
   Res=Res*T/D
     !
   IF Pst<>0 THEN Res=999
     ! Disable ports and pins
   Disable_port
   Connect
 SUBEND
 R2t_fi_3t:SUB R2t_fi_3t(REAL Iforce,INTEGER Flg,REAL Sqr,Count,INTEGER Unit,REAL T,D,INTEGER Pins(*),Adc,REAL Iv,INTEGER Integ,REAL Vcomp,Hold,Res)
 !***** DON'T REMOVE THIS LINE *************************************
 !
 !  Type : Algorithm
 !  Name : R2t_fi_3T
 !  Vers : 1
 !  Desc : Res=Vm/If
 !  Date : 03/01/2010
 !  Time : 10:28:21
 !  User : wat
 !
 !***** DON'T REMOVE THIS LINE *************************************
 !
 !  Input Variables:
 !
 !     #  Name            Type Size     Description
 !    --- --------------- ---- -------- --------------------------------
 !    Measurement Parameters:
 !      1 IFORCE          R    -        CURRENT TO APPLY
 !      2 FLG             I    -        unit flag (0: R 1: R/sqr 2: R/co
 !      3 SQR             R    -        SQR=(L/W), use to calculate R=R/
 !      4 COUNT           R    -        VIA COUNTS
 !      5 UNIT            I    -        0:ohm, 1: Kohm, 2: mohm, 3: Mohm
 !      6 T               R    -        R * T
 !      7 D               R    -        R / D
 !
 !    Device Terminals:
 !      1 H               I    -        HIGH TERMINAL
 !      2 L               I    -        LOW TERMINAL
 !      3 SUB             I    -        SUB
 !
 !    Device Parameters:
 !      1 ADC             I    -        ADC TYPE (0:HI-SPEED, 1:HI-RESOL
 !      2 IV              R    -        SAMPLING NUMBER WHEN MANUAL INTE
 !      3 INTEG           I    -        INTEGRATION TIME (0:MAN. 1:S, 2:
 !      4 VCOMP           R    -        VOLTAGE COMPLIANCE
 !      5 HOLD            R    -        HOLD TIME
 !
 !  Output Variables:
 !
 !     #  Name            Type Size     Description
 !    --- --------------- ---- -------- --------------------------------
 !    Output Parameters:
 !      1 RES             R    -        RESISTANCE OR RHO
 !
 !***** DON'T REMOVE THIS LINE *************************************
   OPTION BASE 1                     !***** DON'T REMOVE THIS LINE *****
   DISP "in R2t_fi"
   INTEGER H,L,Sub,Stat,Stb
                                    !
   H=Pins(1)
   L=Pins(2)
   Sub=Pins(3)
                                    ! Connect
                                    !
   FOR I=1 TO 10
     Connect_th(FNPort(0,9),1,49)
     Wait_th(Hold)
   NEXT I
   Connect
     !
   Connect(FNPort(0,4),H)
   Connect(FNPort(0,9),L,49)
   Connect(FNGnd,Sub)
                                    ! ADC mode
   Set_smu_ch(H,Adc,0)
   Set_adc(Adc,Integ,Iv)
     !Set_wait_time(Ss,Sm)
                                    ! Perform spot measurement
                                    !
   Force_i(H,Iforce,Iforce,Vcomp)
     !Force_v(L,0,0,1.E-2)
   Wait_th(Hold)
   Measure_v(H,Vm,0)
   PRINT "Vm1=";Vm
   Prober_output("D",Status$,Error$)
   Prober_srq(5,Stb)
   PRINT "Stb=";Stb
   Wait_th(Hold)
   Prober_output("Z",Status$,Error$)
   Prober_srq(5,Stb)
   PRINT "Stb=";Stb
   Measure_v(H,Vm,0)
   Port_status(H,Stat)
   PRINT "Vm=";Vm,"Stat=",Stat
                                    ! Resistance value calculation
   SELECT Flg
   CASE 0
     Res=ABS(Vm/Iforce)
   CASE 1
     Res=ABS((Vm/Iforce)/Sqr)
   CASE 2
     Res=ABS((Vm/Iforce)/Count)
   END SELECT
                                    ! ------------------------------------
   SELECT Unit
   CASE 0
     Res=Res          ! ohm
   CASE 1
     Res=Res*1.E-3    ! Kohm
   CASE 2
     Res=Res*1.E+3    ! mohm
   CASE 3
     Res=Res*1.E-6    ! Mohm
   CASE ELSE
     Res=Res
   END SELECT
                                    !
   Res=Res*T/D
                                    !
   IF Pst<>0 THEN Res=999
                                    ! Disable ports and pins
   Disable_port
   Connect
 SUBEND
 R2t_fi_all:SUB R2t_fi_all(REAL Iforce,INTEGER Flg,REAL Sqr,Count,INTEGER Unit,REAL T,D,INTEGER Pins(*),Adc,REAL Iv,INTEGER Integ,REAL Vcomp,Hold,Res)
 !***** DON'T REMOVE THIS LINE *************************************
 !
 !  Type : Algorithm
 !  Name : R2t_fi_all
 !  Vers : 1
 !  Desc : Res=Vm/If
 !  Date : 08/06/2002
 !  Time : 16:28:32
 !  User : wat
 !
 !***** DON'T REMOVE THIS LINE *************************************
 !
 !  Input Variables:
 !
 !     #  Name            Type Size     Description
 !    --- --------------- ---- -------- --------------------------------
 !    Measurement Parameters:
 !      1 IFORCE          R    -        CURRENT TO APPLY
 !      2 FLG             I    -        unit flag (0: R 1: R/sqr 2: R/co
 !      3 SQR             R    -        SQR=(L/W), use to calculate R=R/
 !      4 COUNT           R    -        VIA COUNTS
 !      5 UNIT            I    -        0:ohm, 1: Kohm, 2: mohm, 3: Mohm
 !      6 T               R    -        R * T
 !      7 D               R    -        R / D
 !
 !    Device Terminals:
 !      1 H               I    -        HIGH TERMINAL
 !      2 L               I    -        LOW TERMINAL
 !
 !    Device Parameters:
 !      1 ADC             I    -        ADC TYPE (0:HI-SPEED, 1:HI-RESOL
 !      2 IV              R    -        SAMPLING NUMBER WHEN MANUAL INTE
 !      3 INTEG           I    -        INTEGRATION TIME (0:MAN. 1:S, 2:
 !      4 VCOMP           R    -        VOLTAGE COMPLIANCE
 !      5 HOLD            R    -        HOLD TIME
 !
 !  Output Variables:
 !
 !     #  Name            Type Size     Description
 !    --- --------------- ---- -------- --------------------------------
 !    Output Parameters:
 !      1 RES             R    -        RESISTANCE OR RHO
 !
 !***** DON'T REMOVE THIS LINE *************************************
   OPTION BASE 1                    !***** DON'T REMOVE THIS LINE *****
   DISP "in R2t_fi"
   INTEGER H,L,Stat,Stb
                                    !
   H=Pins(1)
   L=Pins(2)
                                    !
                                    ! Connect
                                    !
   FOR I=1 TO 10
     Connect_th(FNPort(0,9),1,49)
     Wait_th(Hold)
   NEXT I
   Connect
    !
   Connect(FNPort(0,4),H)
   Connect(FNPort(0,9),L,49)
                                    ! ADC mode
                                    !
   Set_smu_ch(H,Adc,0)
   Set_adc(Adc,Integ,Iv)
    !Set_wait_time(Ss,Sm)
                                    ! Perform spot measurement
                                    !
   Force_i(H,Iforce,Iforce,Vcomp)
   !Force_v(L,0,0,1.E-2)
   Wait_th(Hold)
   Measure_v(H,Vm,0)
   PRINT "Vm1=";Vm
   !Prober_output("D",Status$,Error$)
   !Prober_srq(5,Stb)
   !PRINT "Stb=";Stb
   Wait_th(Hold)
   !Prober_output("Z",Status$,Error$)
   !Prober_srq(5,Stb)
   !PRINT "Stb=";Stb
   Measure_v(H,Vm,0)
   Port_status(H,Stat)
   PRINT "Vm=";Vm,"Stat=",Stat
                                    ! Resistance value calculation
   SELECT Flg
   CASE 0
     Res=ABS(Vm/Iforce)
   CASE 1
     Res=ABS((Vm/Iforce)/Sqr)
   CASE 2
     Res=ABS((Vm/Iforce)/Count)
   END SELECT
                                    ! ------------------------------------
   SELECT Unit
   CASE 0
     Res=Res          ! ohm
   CASE 1
     Res=Res*1.E-3    ! Kohm
   CASE 2
     Res=Res*1.E+3    ! mohm
   CASE 3
     Res=Res*1.E-6    ! Mohm
   CASE ELSE
     Res=Res
   END SELECT
                                    !
   Res=Res*T/D
                                    !
   IF Pst<>0 THEN Res=999
                                    ! Disable ports and pins
   Disable_port
   Connect
 SUBEND
 R2t_fv:SUB R2t_fv(REAL Vf,INTEGER Flg,REAL Sqr,Count,INTEGER Unit,REAL T,D,INTEGER Pins(*),Adc,REAL Iv,INTEGER Integ,REAL Icomp,Hold,Wait_th,Res)
 !***** DON'T REMOVE THIS LINE *************************************
 !
 !  Type : Algorithm
 !  Name : R2t_fv
 !  Vers : 1
 !  Desc : Res=Vf/Im
 !  Date : 03/25/2003
 !  Time : 15:49:59
 !  User : wat
 !
 !***** DON'T REMOVE THIS LINE *************************************
 !
 !  Input Variables:
 !
 !     #  Name            Type Size     Description
 !    --- --------------- ---- -------- --------------------------------
 !    Measurement Parameters:
 !      1 VF              R    -        VOLTAGE TO APPLY
 !      2 FLG             I    -        unit flag (0: R 1: R/sqr 2: R/co
 !      3 SQR             R    -        SQR=(L/W), use to calculate R=R/
 !      4 COUNT           R    -        VIA COUNTS
 !      5 UNIT            I    -        0:ohm, 1: Kohm, 2: mohm, 3: Mohm
 !      6 T               R    -        R * T
 !      7 D               R    -        R / D
 !
 !    Device Terminals:
 !      1 H               I    -        HIGH TERMINAL
 !      2 L               I    -        LOW TERMINAL
 !
 !    Device Parameters:
 !      1 ADC             I    -        ADC TYPE (0:HI-SPEED, 1:HI-RESOL
 !      2 IV              R    -        SAMPLING NUMBER WHEN MANUAL INTE
 !      3 INTEG           I    -        INTEGRATION TIME (0:MAN. 1:S, 2:
 !      4 ICOMP           R    -        CURRENT COMPLIANCE
 !      5 HOLD            R    -        HOLD TIME
 !      6 WAIT_TH         R    -        HOLD TIME AFTER DISCHARGE
 !
 !  Output Variables:
 !
 !     #  Name            Type Size     Description
 !    --- --------------- ---- -------- --------------------------------
 !    Output Parameters:
 !      1 RES             R    -        RESISTANCE OR RHO
 !
 !***** DON'T REMOVE THIS LINE *************************************
   OPTION BASE 1                  !***** DON'T REMOVE THIS LINE *****
   DISP "in R2t_fv"
     !
   INTEGER H,L,Stat
   H=Pins(1)
   L=Pins(2)
     ! Connect
   Connect(FNGnd,H,L)
   Wait_th(Wait_th)
   Connect(FNPort(0,4),H)
     ! ADC mode
   Set_smu_ch(H,Adc,0)
   Set_adc(Adc,Integ,Iv)
  !Set_wait_time(Ss,Sm)
     ! Pre_test
   Force_v(H,Vf,Vf,Icomp)
   Wait_th(.05)
   Measure_i(H,Im,0)
   Wait_th(.1)
     ! Perform spot measurement
   Force_v(H,Vf,Vf,Icomp)
   Wait_th(Hold)
   Measure_i(H,Im,0)
   Im=ABS(Im)
   Port_status(H,Stat)
     ! R calculation
   SELECT Flg
   CASE 0
     Res=ABS(Vf/(Im+1.E-30))
   CASE 1
     Res=ABS((Vf/(Im+1.E-30))/Sqr)
   CASE 2
     Res=ABS((Vf/(Im+1.E-30))/Count)
   END SELECT
   PRINT "Res=",Res;"Stat=",Stat
     ! -------------------------------
   SELECT Unit
   CASE 0
     Res=Res      ! ohm
   CASE 1
     Res=Res*1.E-3 ! Kohm
   CASE 2
     Res=Res*1.E+3 ! mohm
   CASE 3
     Res=Res*1.E-6 ! Mohm
   CASE ELSE
     Res=Res
   END SELECT
     !
   Res=Res*T/D
     !
   IF Pst<>0 THEN Res=999
     ! Disable ports and pins
   Disable_port
   Connect
 SUBEND
 R2t_fv_3t:SUB R2t_fv_3t(REAL Vf,INTEGER Flg,REAL Sqr,Count,INTEGER Unit,REAL T,D,INTEGER Pins(*),Adc,REAL Iv,INTEGER Integ,REAL Icomp,Hold,Wait_th,Res)
 !***** DON'T REMOVE THIS LINE *************************************
 !
 !  Type : Algorithm
 !  Name : R2t_fv_3T
 !  Vers : 1
 !  Desc : Res=Vf/Im
 !  Date : 03/01/2010
 !  Time : 10:28:21
 !  User : wat
 !
 !***** DON'T REMOVE THIS LINE *************************************
 !
 !  Input Variables:
 !
 !     #  Name            Type Size     Description
 !    --- --------------- ---- -------- --------------------------------
 !    Measurement Parameters:
 !      1 VF              R    -        VOLTAGE TO APPLY
 !      2 FLG             I    -        unit flag (0: R 1: R/sqr 2: R/co
 !      3 SQR             R    -        SQR=(L/W), use to calculate R=R/
 !      4 COUNT           R    -        VIA COUNTS
 !      5 UNIT            I    -        0:ohm, 1: Kohm, 2: mohm, 3: Mohm
 !      6 T               R    -        R * T
 !      7 D               R    -        R / D
 !
 !    Device Terminals:
 !      1 H               I    -        HIGH TERMINAL
 !      2 L               I    -        LOW TERMINAL
 !      3 SUB             I    -        SUB
 !
 !    Device Parameters:
 !      1 ADC             I    -        ADC TYPE (0:HI-SPEED, 1:HI-RESOL
 !      2 IV              R    -        SAMPLING NUMBER WHEN MANUAL INTE
 !      3 INTEG           I    -        INTEGRATION TIME (0:MAN. 1:S, 2:
 !      4 ICOMP           R    -        CURRENT COMPLIANCE
 !      5 HOLD            R    -        HOLD TIME
 !      6 WAIT_TH         R    -        HOLD TIME AFTER DISCHARGE
 !
 !  Output Variables:
 !
 !     #  Name            Type Size     Description
 !    --- --------------- ---- -------- --------------------------------
 !    Output Parameters:
 !      1 RES             R    -        RESISTANCE OR RHO
 !
 !***** DON'T REMOVE THIS LINE *************************************
   OPTION BASE 1                     !***** DON'T REMOVE THIS LINE *****
   DISP "in R2t_fv"
                                    !
   INTEGER H,L,Sub,Stat
   H=Pins(1)
   L=Pins(2)
   Sub=Pins(3)                      ! Connect
   Connect(FNGnd,H,L,Sub)
   Wait_th(Wait_th)
   Connect(FNPort(0,4),H)
                                    ! ADC mode
   Set_smu_ch(H,Adc,0)
   Set_adc(Adc,Integ,Iv)
     !Set_wait_time(Ss,Sm)
                                    ! Pre_test
   Force_v(H,Vf,Vf,Icomp)
   Wait_th(.05)
   Measure_i(H,Im,0)
   Wait_th(.1)
                                    ! Perform spot measurement
   Force_v(H,Vf,Vf,Icomp)
   Wait_th(Hold)
   Measure_i(H,Im,0)
   Im=ABS(Im)
   Port_status(H,Stat)
                                    ! R calculation
   SELECT Flg
   CASE 0
     Res=ABS(Vf/(Im+1.E-30))
   CASE 1
     Res=ABS((Vf/(Im+1.E-30))/Sqr)
   CASE 2
     Res=ABS((Vf/(Im+1.E-30))/Count)
   END SELECT
   PRINT "Res=",Res;"Stat=",Stat
                                    ! -------------------------------
   SELECT Unit
   CASE 0
     Res=Res          ! ohm
   CASE 1
     Res=Res*1.E-3    ! Kohm
   CASE 2
     Res=Res*1.E+3    ! mohm
   CASE 3
     Res=Res*1.E-6    ! Mohm
   CASE ELSE
     Res=Res
   END SELECT
                                    !
   Res=Res*T/D
                                    !
   IF Pst<>0 THEN Res=999
                                    ! Disable ports and pins
   Disable_port
   Connect
 SUBEND
 R3t_fi_tb:SUB R3t_fi_tb(REAL Iforce,INTEGER Flg,REAL Sqr,Count,INTEGER Unit,REAL Ln,Wn,INTEGER Pins(*),Adc,REAL Iv,INTEGER Integ,REAL Vcomp,Hold,Mode,Res)
 !***** DON'T REMOVE THIS LINE *************************************
 !
 !  Type : Algorithm
 !  Name : R3t_fi_TB
 !  Vers : 1
 !  Desc : Res=Vf/Im
 !       : Base on R2t_fv fine tune TJ M
 !       : 2014 base on R2t_fi set up TB alg
 !  Date : 10/09/2014
 !  Time : 13:20:35
 !  User : wat
 !
 !***** DON'T REMOVE THIS LINE *************************************
 !
 !  Input Variables:
 !
 !     #  Name            Type Size     Description
 !    --- --------------- ---- -------- --------------------------------
 !    Measurement Parameters:
 !      1 Iforce          R    -        CURRENT TO APPLY
 !      2 FLG             I    -        unit flag (0: R 1: R/sqr 2: R/co
 !      3 SQR             R    -        SQR=(L/W), use to calculate R=R/
 !      4 COUNT           R    -        VIA COUNTS
 !      5 UNIT            I    -        0:ohm, 1: Kohm, 2: mohm, 3: Mohm
 !      6 Ln              R    -        R * L
 !      7 Wn              R    -        R / W
 !
 !    Device Terminals:
 !      1 H               I    -        HIGH TERMINAL
 !      2 L               I    -        LOW TERMINAL
 !      3 SUB             I    -        SUB TERMINAL
 !
 !    Device Parameters:
 !      1 ADC             I    -        ADC TYPE (0:HI-SPEED, 1:HI-RESOL
 !      2 IV              R    -        SAMPLING NUMBER WHEN MANUAL INTE
 !      3 INTEG           I    -        INTEGRATION TIME (0:MAN. 1:S, 2:
 !      4 VCOMP           R    -        CURRENT COMPLIANCE
 !      5 HOLD            R    -        HOLD TIME
 !      6 MODE            R    -        0:Ground ;  1:SMU  Mode . Defaul
 !
 !  Output Variables:
 !
 !     #  Name            Type Size     Description
 !    --- --------------- ---- -------- --------------------------------
 !    Output Parameters:
 !      1 RES             R    -        RESISTANCE OR RHO
 !
 !***** DON'T REMOVE THIS LINE *************************************
   OPTION BASE 1                  !***** DON'T REMOVE THIS LINE *****
   DISP "in R2t_fv"
      !
   INTEGER H,L,Sub,Stat
   H=Pins(1)
   L=Pins(2)
   Sub=Pins(3)
      ! Connect
   Connect(FNGnd,H,L,Sub)
   Wait_th(.001)
  !IF Mode=1 THEN
  !Connect
  !Connect(FNPort(0,2),L,Sub)
  !END IF
   Connect(FNPort(0,4),H)
      ! ADC mode
   Set_smu_ch(H,Adc,0)
   Set_adc(Adc,Integ,Iv)
  !Set_wait_time(Ss,Sm)
      ! Pre_test
   Force_i(H,Iforce,Iforce,2)
   IF Mode=1 THEN 
     Connect(FNPort(0,2),L,Sub)
     Force_v(L,0,0,.01)
   END IF
   Wait_th(.001)
   Measure_v(H,Vm,0)
      ! Perform spot measurement
   Force_i(H,Iforce,Iforce,Vcomp)
   Wait_th(Hold)
   Measure_v(H,Vm,0)
   Vm=ABS(Vm)
   Port_status(H,Stat)
      ! R calculation
   SELECT Flg
   CASE 0
     Res=ABS(Vm/Iforce)
   CASE 1
     Res=ABS(Vm/Iforce)/Sqr
   CASE 2
     Res=ABS(Vm/Iforce)/Count
   END SELECT
   PRINT "Res=",Res;"Stat=",Stat
      ! -------------------------------
   SELECT Unit
   CASE 0
     Res=Res      ! ohm
   CASE 1
     Res=Res*1.E-3 ! Kohm
   CASE 2
     Res=Res*1.E+3 ! mohm
   CASE 3
     Res=Res*1.E-6 ! Mohm
   CASE ELSE
     Res=Res
   END SELECT
      !
   Res=Res*Ln/Wn
      !
   IF Pst<>0 THEN Res=999
      ! Disable ports and pins
   Disable_port
   Connect
 SUBEND
 R3t_fv_tb:SUB R3t_fv_tb(REAL Vf,INTEGER Flg,REAL Sqr,Count,INTEGER Unit,REAL Ln,Wn,INTEGER Pins(*),Adc,REAL Iv,INTEGER Integ,REAL Icomp,Hold,Mode,Res)
 !***** DON'T REMOVE THIS LINE *************************************
 !
 !  Type : Algorithm
 !  Name : R3t_fv_TB
 !  Vers : 1
 !  Desc : Res=Vf/Im
 !       : 2014 base on R2t_fv  set up TB alg
 !  Date : 10/09/2014
 !  Time : 13:20:35
 !  User : wat
 !
 !***** DON'T REMOVE THIS LINE *************************************
 !
 !  Input Variables:
 !
 !     #  Name            Type Size     Description
 !    --- --------------- ---- -------- --------------------------------
 !    Measurement Parameters:
 !      1 VF              R    -        VOLTAGE TO APPLY
 !      2 FLG             I    -        unit flag (0: R 1: R/sqr 2: R/co
 !      3 SQR             R    -        SQR=(L/W), use to calculate R=R/
 !      4 COUNT           R    -        VIA COUNTS
 !      5 UNIT            I    -        0:ohm, 1: Kohm, 2: mohm, 3: Mohm
 !      6 Ln              R    -        R * L
 !      7 Wn              R    -        R / W
 !
 !    Device Terminals:
 !      1 H               I    -        HIGH TERMINAL
 !      2 L               I    -        LOW TERMINAL
 !      3 SUB             I    -        SUB TERMINAL
 !
 !    Device Parameters:
 !      1 ADC             I    -        ADC TYPE (0:HI-SPEED, 1:HI-RESOL
 !      2 IV              R    -        SAMPLING NUMBER WHEN MANUAL INTE
 !      3 INTEG           I    -        INTEGRATION TIME (0:MAN. 1:S, 2:
 !      4 ICOMP           R    -        CURRENT COMPLIANCE
 !      5 HOLD            R    -        HOLD TIME
 !      6 MODE            R    -        0:Ground ;  1:SMU  Mode . Defaul
 !
 !  Output Variables:
 !
 !     #  Name            Type Size     Description
 !    --- --------------- ---- -------- --------------------------------
 !    Output Parameters:
 !      1 RES             R    -        RESISTANCE OR RHO
 !
 !***** DON'T REMOVE THIS LINE *************************************
   OPTION BASE 1                  !***** DON'T REMOVE THIS LINE *****
   DISP "in R2t_fv"
      !
   INTEGER H,L,Sub,Stat
   H=Pins(1)
   L=Pins(2)
   Sub=Pins(3)
      ! Connect
   Connect(FNGnd,H,L,Sub)
   Wait_th(.005)
  !IF Mode=1 THEN
  !Connect
  !Connect(FNPort(0,2),L,Sub)
  !END IF
   Connect(FNPort(0,4),H)
      ! ADC mode
   Set_smu_ch(H,Adc,0)
   Set_adc(Adc,Integ,Iv)
  !Set_wait_time(Ss,Sm)
      ! Pre_test
   Force_v(H,Vf,Vf,Icomp)
   IF Mode=1 THEN 
     Connect(FNPort(0,2),L,Sub)
     Force_v(L,0,0,Icomp)
   END IF
   Wait_th(.001)
   Measure_i(H,Im,0)
      ! Perform spot measurement
   Force_v(H,Vf,Vf,Icomp)
   Wait_th(Hold)
   Measure_i(H,Im,0)
   Im=ABS(Im)
   Port_status(H,Stat)
      ! R calculation
   SELECT Flg
   CASE 0
     Res=ABS(Vf/(Im+1.E-30))
   CASE 1
     Res=ABS((Vf/(Im+1.E-30))/Sqr)
   CASE 2
     Res=ABS((Vf/(Im+1.E-30))/Count)
   END SELECT
   PRINT "Res=",Res;"Stat=",Stat
      ! -------------------------------
   SELECT Unit
   CASE 0
     Res=Res      ! ohm
   CASE 1
     Res=Res*1.E-3 ! Kohm
   CASE 2
     Res=Res*1.E+3 ! mohm
   CASE 3
     Res=Res*1.E-6 ! Mohm
   CASE ELSE
     Res=Res
   END SELECT
      !
   Res=Res*Ln/Wn
      !
   IF Pst<>0 THEN Res=999
      ! Disable ports and pins
   Disable_port
   Connect
 SUBEND
 R4t:SUB R4t(REAL Iforce,INTEGER Flg,REAL Sqr,Count,INTEGER Unit,REAL T,D,INTEGER Pins(*),Adc,REAL Iv,INTEGER Integ,REAL Vcomp,Hold,Res)
 !***** DON'T REMOVE THIS LINE *************************************
 !
 !  Type : Algorithm
 !  Name : R4t
 !  Vers : 1
 !  Desc : wat_standard 4 terminals resistance measurement
 !  Date : 11/24/2022
 !  Time : 19:01:33
 !  User : wat
 !
 !***** DON'T REMOVE THIS LINE *************************************
 !
 !  Input Variables:
 !
 !     #  Name            Type Size     Description
 !    --- --------------- ---- -------- --------------------------------
 !    Measurement Parameters:
 !      1 IFORCE          R    -        CURRENT TO FORCE
 !      2 FLG             I    -        unit flag (0: R 1: R/sqr 2: R/co
 !      3 SQR             R    -        SQR=(L/W), use to calculate R=R/
 !      4 COUNT           R    -        VIA COUNTS
 !      5 UNIT            I    -        0:ohm, 1: Kohm, 2: mohm, 3: Mohm
 !      6 T               R    -        R * T
 !      7 D               R    -        R / D
 !
 !    Device Terminals:
 !      1 FH              I    -        Force high
 !      2 FL              I    -        Force low
 !      3 SH              I    -        Sense high
 !      4 SL              I    -        Sense low
 !      5 B               I    -        BULK
 !
 !    Device Parameters:
 !      1 ADC             I    -        ADC TYPE (0:HI-SPEED, 1:HI-RESOL
 !      2 IV              R    -        SAMPLING NUMBER WHEN MANUAL INTE
 !      3 INTEG           I    -        INTEGRATION TIME (0:MAN. 1:S, 2:
 !      4 VCOMP           R    -        VOLTAGE COMPLIANCE
 !      5 HOLD            R    -        HOLD TIME
 !
 !  Output Variables:
 !
 !     #  Name            Type Size     Description
 !    --- --------------- ---- -------- --------------------------------
 !    Output Parameters:
 !      1 RES             R    -        RESISTANCE OR RHO
 !
 !***** DON'T REMOVE THIS LINE *************************************
   OPTION BASE 1                      !***** DON'T REMOVE THIS LINE *****
   DISP "in R4t"
                                      !
   INTEGER Fh,Fl,Sh,Sl
   INTEGER B
   REAL Vhi,Vlo
                                      !
   Fh=Pins(1)
   Fl=Pins(2)
   Sh=Pins(3)
   Sl=Pins(4)
   B=Pins(5)
                                      ! Connect device
   Connect(FNGnd,Fh,Fl,Sh,Sl)
   IF B<>0 THEN CALL Connect(FNPort(0,9),B)
   Wait_th(.1)
   Connect(FNPort(0,2),Fh)
   Connect(FNPort(0,1),Sh)
   Connect(FNPort(0,3),Sl)
                                      ! ADC mode
   Set_smu_ch(Fh,Adc,0)
   Set_adc(Adc,Integ,Iv)
   Set_smu_ch(Sh,Adc)
   Set_adc_v(Adc,Integ)
   Set_smu_ch(Sl,Adc)
   Set_adc_v(Adc,Integ)
     ! Set_wait_time(Ss,Sm)
                                      ! Force 0A to two terminals
   Force_i(Sh,0,0,20)
   Force_i(Sl,0,0,20)
                                      ! Spot measurement
   Force_i(Fh,Iforce,Iforce,Vcomp)
   Wait_th(Hold)
   Measure_v(Sh,Vhi,0)
   Measure_v(Sl,Vlo,0)
   Vm=ABS(Vhi-Vlo)
                                      ! R calculation
     !IF Vm<0 THEN
     !  Res=999
     !  SUBEXIT
     !END IF
                                      !
   SELECT Flg
   CASE 0
     Res=Vm/(Iforce+1.E-30)
   CASE 1
     Res=(Vm/(Iforce+1.E-30))/Sqr
   CASE 2
     Res=(Vm/(Iforce+1.E-30))/Count
   END SELECT
                                      ! ----------------------------
   SELECT Unit
   CASE 0
     Res=Res                          ! ohm
   CASE 1
     Res=Res*1.E-3                    ! Kohm
   CASE 2
     Res=Res*1.E+3                    ! mohm
   CASE 3
     Res=Res*1.E-6                    ! Mohm
   CASE ELSE
     Res=Res
   END SELECT
                                      !
   Res=Res*T/D
   PRINT "Res=",Res
                                      ! Disable ports and pins
   Disable_port(FNPort(0,1),FNPort(0,2),FNPort(0,3))
   Connect(0,Fh,Fl,Sh,Sl)
 SUBEND
 R4t_fv:SUB R4t_fv(REAL Vforce,INTEGER Flg,REAL Sqr,Count,INTEGER Unit,REAL T,D,INTEGER Pins(*),Adc,REAL Iv,INTEGER Integ,REAL Icomp,Hold,Res)
 !***** DON'T REMOVE THIS LINE *************************************
 !
 !  Type : Algorithm
 !  Name : R4t_fv
 !  Vers : 1
 !  Desc : wat_standard 4 terminals resistance measurement
 !  Date : 04/06/2023
 !  Time : 15:38:48
 !  User : specs
 !
 !***** DON'T REMOVE THIS LINE *************************************
 !
 !  Input Variables:
 !
 !     #  Name            Type Size     Description
 !    --- --------------- ---- -------- --------------------------------
 !    Measurement Parameters:
 !      1 VFORCE          R    -        VOLTAGE TO FORCE
 !      2 FLG             I    -        unit flag (0: R 1: R/sqr 2: R/co
 !      3 SQR             R    -        SQR=(L/W), use to calculate R=R/
 !      4 COUNT           R    -        VIA COUNTS
 !      5 UNIT            I    -        0:ohm, 1: Kohm, 2: mohm, 3: Mohm
 !      6 T               R    -        R * T
 !      7 D               R    -        R / D
 !
 !    Device Terminals:
 !      1 FH              I    -        Force high
 !      2 FL              I    -        Force low
 !      3 SH              I    -        Sense high
 !      4 SL              I    -        Sense low
 !
 !    Device Parameters:
 !      1 ADC             I    -        ADC TYPE (0:HI-SPEED, 1:HI-RESOL
 !      2 IV              R    -        SAMPLING NUMBER WHEN MANUAL INTE
 !      3 INTEG           I    -        INTEGRATION TIME (0:MAN. 1:S, 2:
 !      4 ICOMP           R    -        CURRENT COMPLIANCE
 !      5 HOLD            R    -        HOLD TIME
 !
 !  Output Variables:
 !
 !     #  Name            Type Size     Description
 !    --- --------------- ---- -------- --------------------------------
 !    Output Parameters:
 !      1 RES             R    -        RESISTANCE OR RHO
 !
 !***** DON'T REMOVE THIS LINE *************************************
   OPTION BASE 1                      !***** DON'T REMOVE THIS LINE *****
   DISP "in R4t_fv"
                                      !
   INTEGER Fh,Fl,Sh,Sl
   INTEGER B
   REAL Vhi,Vlo,Im
                                      !
   Fh=Pins(1)
   Fl=Pins(2)
   Sh=Pins(3)
   Sl=Pins(4)
                                      ! Connect device
   Connect(FNGnd,Fh,Fl,Sh,Sl)
   Wait_th(.1)
   Connect(FNPort(0,2),Fh)
   Connect(FNPort(0,1),Sh)
   Connect(FNPort(0,3),Sl)
                                      ! ADC mode
   Set_smu_ch(Fh,Adc,0)
   Set_adc(Adc,Integ,Iv)
   Set_smu_ch(Sh,Adc)
   Set_adc_v(Adc,Integ)
   Set_smu_ch(Sl,Adc)
   Set_adc_v(Adc,Integ)
     ! Set_wait_time(Ss,Sm)
                                      ! Force 0A to two terminals
   Force_i(Sh,0,0,20)
   Force_i(Sl,0,0,20)
                                      ! Spot measurement
   Force_v(Fh,Vforce,Vforce,Icomp)
   Wait_th(Hold)
   Measure_v(Sh,Vhi,0)
   Measure_v(Sl,Vlo,0)
   Vm=ABS(Vhi-Vlo)
   Measure_i(Fh,Im,0)
                                      ! R calculation
     !IF Vm<0 THEN
     !  Res=999
     !  SUBEXIT
     !END IF
                                      !
   SELECT Flg
   CASE 0
     Res=Vm/(Im+1.E-30)
   CASE 1
     Res=(Vm/(Im+1.E-30))/Sqr
   CASE 2
     Res=(Vm/(Im+1.E-30))/Count
   END SELECT
                                      ! ----------------------------
   SELECT Unit
   CASE 0
     Res=Res                          ! ohm
   CASE 1
     Res=Res*1.E-3                    ! Kohm
   CASE 2
     Res=Res*1.E+3                    ! mohm
   CASE 3
     Res=Res*1.E-6                    ! Mohm
   CASE ELSE
     Res=Res
   END SELECT
                                      !
   Res=Res*T/D
   PRINT "Res=",Res
                                      ! Disable ports and pins
   Disable_port(FNPort(0,1),FNPort(0,2),FNPort(0,3))
   Connect(0,Fh,Fl,Sh,Sl)
 SUBEND
 R4t_vm:SUB R4t_vm(REAL Iforce,INTEGER Flg,REAL Sqr,Count,INTEGER Unit,REAL T,D,INTEGER Pins(*),Adc,REAL Iv,INTEGER Integ,REAL Vcomp,Hold,Res,Vm)
 !***** DON'T REMOVE THIS LINE *************************************
 !
 !  Type : Algorithm
 !  Name : R4t_Vm
 !  Vers : 1
 !  Desc : 4 terminals resistance measurement
 !  Date : 05/23/2011
 !  Time : 15:39:34
 !  User : wat
 !
 !***** DON'T REMOVE THIS LINE *************************************
 !
 !  Input Variables:
 !
 !     #  Name            Type Size     Description
 !    --- --------------- ---- -------- --------------------------------
 !    Measurement Parameters:
 !      1 IFORCE          R    -        CURRENT TO FORCE
 !      2 FLG             I    -        unit flag (0: R 1: R/sqr 2: R/co
 !      3 SQR             R    -        SQR=(L/W), use to calculate R=R/
 !      4 COUNT           R    -        VIA COUNTS
 !      5 UNIT            I    -        0:ohm, 1: Kohm, 2: mohm, 3: Mohm
 !      6 T               R    -        R * T
 !      7 D               R    -        R / D
 !
 !    Device Terminals:
 !      1 FH              I    -        Force high
 !      2 FL              I    -        Force low
 !      3 SH              I    -        Sense high
 !      4 SL              I    -        Sense low
 !
 !    Device Parameters:
 !      1 ADC             I    -        ADC TYPE (0:HI-SPEED, 1:HI-RESOL
 !      2 IV              R    -        SAMPLING NUMBER WHEN MANUAL INTE
 !      3 INTEG           I    -        INTEGRATION TIME (0:MAN. 1:S, 2:
 !      4 VCOMP           R    -        VOLTAGE COMPLIANCE
 !      5 HOLD            R    -        HOLD TIME
 !
 !  Output Variables:
 !
 !     #  Name            Type Size     Description
 !    --- --------------- ---- -------- --------------------------------
 !    Output Parameters:
 !      1 RES             R    -        RESISTANCE OR RHO
 !      2 Vm              R    -        Vm=|Vhi-Vlo|
 !
 !***** DON'T REMOVE THIS LINE *************************************
   OPTION BASE 1                       !***** DON'T REMOVE THIS LINE *****
   DISP "in R4t"
                                       !
   INTEGER Fh,Fl,Sh,Sl
   REAL Vhi,Vlo
                                       !
   Fh=Pins(1)
   Fl=Pins(2)
   Sh=Pins(3)
   Sl=Pins(4)
                                       ! Connect device
   Connect(FNGnd,Fh,Fl,Sh,Sl)
   Wait_th(.1)
   Connect(FNPort(0,2),Fh)
   Connect(FNPort(0,1),Sh)
   Connect(FNPort(0,3),Sl)
                                       ! ADC mode
   Set_smu_ch(Fh,Adc,0)
   Set_adc(Adc,Integ,Iv)
      ! Set_wait_time(Ss,Sm)
                                       ! Force 0A to two terminals
   Force_i(Sh,0,0,20)
   Force_i(Sl,0,0,20)
                                       ! Spot measurement
   Force_i(Fh,Iforce,Iforce,Vcomp)
   Wait_th(Hold)
   Measure_v(Sh,Vhi,0)
   Measure_v(Sl,Vlo,0)
   Vm=ABS(Vhi-Vlo)
                                       ! R calculation
      !IF Vm<0 THEN
      !  Res=999
      !  SUBEXIT
      !END IF
                                       !
   SELECT Flg
   CASE 0
     Res=Vm/(Iforce+1.E-30)
   CASE 1
     Res=(Vm/(Iforce+1.E-30))/Sqr
   CASE 2
     Res=(Vm/(Iforce+1.E-30))/Count
   END SELECT
                                       ! ----------------------------
   SELECT Unit
   CASE 0
     Res=Res                           ! ohm
   CASE 1
     Res=Res*1.E-3                     ! Kohm
   CASE 2
     Res=Res*1.E+3                     ! mohm
   CASE 3
     Res=Res*1.E-6                     ! Mohm
   CASE ELSE
     Res=Res
   END SELECT
                                       !
   Res=Res*T/D
   PRINT "Res=",Res
                                       ! Disable ports and pins
   Disable_port
   Connect
 SUBEND
 Radius:SUB Radius(REAL Radius)
 !***** DON'T REMOVE THIS LINE *************************************
 !
 !  Type : Algorithm
 !  Name : Radius
 !  Vers : 1
 !  Desc : distance from current testing position to wafer center
 !  Date : 03/22/2019
 !  Time : 11:09:16
 !  User : keysight
 !
 !***** DON'T REMOVE THIS LINE *************************************
 !
 !  Input Variables:
 !
 !  Output Variables:
 !
 !     #  Name            Type Size     Description
 !    --- --------------- ---- -------- --------------------------------
 !    Output Parameters:
 !      1 Radius          R    -
 !
 !***** DON'T REMOVE THIS LINE *************************************
   OPTION BASE 1 !***** DON'T REMOVE THIS LINE *****
   INTEGER Attr_idx,Die_idx,Diex,Diey,Center_diex,Center_diey,Die_distx,Die_disty
   REAL Wafer_radius,Die_width,Die_height,Abs_distx,Abs_disty,Dist_length
   Tpldiepos(Die_idx)                                 !Get die index
   Tpldieinfo(Die_idx,Diex,Diey)                      !Get die coordinates
                                                      !
   Tplattrindex("WAFER","SIZE",Attr_idx)
   Tplgetattr("WAFER",Attr_idx,Wafer_radius)
   Wafer_radius=Wafer_radius/2                        !Get wafer size and convert to radius
                                                      !
   Tplattrindex("WAFER","CENTERDIEX",Attr_idx)
   Tplgetattr("WAFER",Attr_idx,Center_diex)
   Tplattrindex("WAFER","CENTERDIEY",Attr_idx)
   Tplgetattr("WAFER",Attr_idx,Center_diey)           !Get center due coordinates
                                                      !
   Tplattrindex("WAFER","STEPX",Attr_idx)
   Tplgetattr("WAFER",Attr_idx,Die_width)
   Die_width=Die_width*1.E-3
   Tplattrindex("WAFER","STEPY",Attr_idx)
   Tplgetattr("WAFER",Attr_idx,Die_height)
   Die_height=Die_hight*1.E-3                         !Get die size and convert to mm
                                                      !
   Die_distx=ABS(Center_diex-Diex)
   Die_disty=ABS(Center_diey-Diey)
   Abs_distx=Die_distx*Die_width
   Abs_disty=Die_disty*Die_height
   Radius=SQRT(Abs_distx*Abs_distx+Abs_disty*Abs_disty) !Calculate absolute distance
 SUBEND
 Rc_fv:SUB Rc_fv(REAL V_force,INTEGER Count,REAL Rs,INTEGER Unit,REAL T,D,INTEGER Pins(*),REAL L,W,Icomp,Hold,INTEGER Adc,REAL Iv,INTEGER Integ,REAL Rc)
 !***** DON'T REMOVE THIS LINE *************************************
 !
 !  Type : Algorithm
 !  Name : Rc_fv
 !  Vers : 1
 !  Desc : Description for this Algorithm spec.
 !  Date : 09/27/2002
 !  Time : 16:30:13
 !  User : wat
 !
 !***** DON'T REMOVE THIS LINE *************************************
 !
 !  Input Variables:
 !
 !     #  Name            Type Size     Description
 !    --- --------------- ---- -------- --------------------------------
 !    Measurement Parameters:
 !      1 V_force         R    -
 !      2 COUNT           I    -
 !      3 Rs              R    -
 !      4 UNIT            I    -        0:ohm, 1: Kohm, 2: mohm, 3: Mohm
 !      5 T               R    -        R * T
 !      6 D               R    -        R / D
 !
 !    Device Terminals:
 !      1 High            I    -
 !      2 Low             I    -
 !      3 Bulk            I    -
 !
 !    Device Parameters:
 !      1 L               R    -
 !      2 W               R    -
 !      3 Icomp           R    -
 !      4 Hold            R    -
 !      5 ADC             I    -
 !      6 IV              R    -        SAMPLING NUMBER WHEN MANUAL INTE
 !      7 INTEG           I    -        INTEGRATION TIME (0:MAN. 1:S, 2:
 !
 !  Output Variables:
 !
 !     #  Name            Type Size     Description
 !    --- --------------- ---- -------- --------------------------------
 !    Output Parameters:
 !      1 Rc              R    -
 !
 !***** DON'T REMOVE THIS LINE *************************************
   OPTION BASE 1  !***** DON'T REMOVE THIS LINE *****
   DISP "in Rc_fv"
                                     !
   INTEGER High,Low,Bulk,Stat
   High=Pins(1)
   Low=Pins(2)
   Bulk=Pin(3)
                                     ! Connect
   Connect(FNGnd,Low,High)
   IF Bulk>0 THEN 
     Connect(FNGnd,Bulk)
   END IF
   Connect(FNPort(0,1),High)
                                     ! ADC mode
   Set_smu_ch(High,Adc,0)
   Set_adc(Adc,Integ,Iv)
     !Set_wait_time(Ss,Sm)
                                     ! Perform spot measurement
   Force_v(High,V_force,V_force,Icomp)
   Wait_th(Hold)
   Measure_i(High,Id,0)
   Port_status(High,Stat)
                                     ! R calculation
   Rm=ABS(V_force/(Id+1.E-30))
   Rc=Rm/Count-T*L/W*Rs
                                     !
   SELECT Unit
   CASE 0
     Rc=Rc           ! ohm
   CASE 1
     Rc=Rc*1.E-3     ! Kohm
   CASE 2
     Rc=Rc*1.E+3     ! mohm
   CASE 3
     Rc=Rc*1.E-6     ! Mohm
   CASE ELSE
     Rc=Rc
   END SELECT
                                     !
                                     !
   IF Stat<>0 THEN Rc=999
                                     ! Disable ports and pins
   Disable_port
   Connect
 SUBEND
 Ring_5t:SUB Ring_5t(REAL Stage,Vforce,INTEGER Flag,Pins(*),REAL Frequency,Delay_vdd)
 !***** DON'T REMOVE THIS LINE *************************************
 !
 !  Type : Algorithm
 !  Name : RING_5T
 !  Vers : 1
 !  Desc : Description for this Algorithm spec.
 !  Date : 12/19/2022
 !  Time : 18:31:58
 !  User : wat
 !
 !***** DON'T REMOVE THIS LINE *************************************
 !
 !  Input Variables:
 !
 !     #  Name            Type Size     Description
 !    --- --------------- ---- -------- --------------------------------
 !    Measurement Parameters:
 !      1 STAGE           R    -        stage number
 !      2 VFORCE          R    -        Applied voltage at power bus
 !      3 FLAG            I    -
 !
 !    Device Terminals:
 !      1 VDD_RO          I    -        PAD1
 !      2 VSS             I    -        PAD2
 !      3 VDD_IO          I    -        PAD4
 !      4 OUT             I    -        PAD5
 !      5 RING_IO         I    -        PAD6
 !
 !  Output Variables:
 !
 !     #  Name            Type Size     Description
 !    --- --------------- ---- -------- --------------------------------
 !    Output Parameters:
 !      1 FREQUENCY       R    -        frequency
 !      2 DELAY_VDD       R    -        delay period at vdd
 !
 !***** DON'T REMOVE THIS LINE *************************************
   OPTION BASE 1 !***** DON'T REMOVE THIS LINE *****
    !COM /Algo/ REAL Vdd
   INTEGER Vdd_ro,Vss,Vdd_io,Out,Ring_io,Sta,Sta_p,Sta_b,Enable
   REAL Fmea,Minf,Maxf,Rbw,I_powbus,I_buffer,Vd,Vdb
    !
   ON ERROR GOTO System_error
    !
   IF Stage<=0 THEN GOSUB Par_error
   IF Vcc=0 THEN Vcc=Vdd
   IF Vccb=0 THEN Vccb=Vdd
    !
   Set_smu_ch(FNPort(0,1),0)
   Set_smu_ch(FNPort(0,2),0)
   Set_adc(0,2)
    !
    !
   Minf=1.0E+5       ! sweep start freq.
   Maxf=2.0E+8       ! sweep stop freq.
   Rbw=5.E+3         ! resolution bandwidth
   Fcr=1.0E+2        ! freq. counter resolution
    !
   Vdd_ro=Pins(1)
   Vss=Pins(2)
   Vdd_io=Pins(3)
   Out=Pins(4)
   Ring_io=Pins(5)
    !
    !
   Connect(FNPort(0,1),Vdd_ro)
   Connect(FNPort(0,2),Vdd_io)
   Connect(FNPort(0,3),Vss)
    !
    !
   Connect(FNPort(3,3),Out) !    FNPort(3,3): HF port adapter btw HF 3 & 6
    !
   Force_v(Vdd_ro,Vforce,Vforce,.01)
    !
   Force_v(Vss,0,0,.01)
    !
   Force_v(Vdd_io,Vforce,Vforce,.01)
    !
   IF Flag=0 OR Flag=1 THEN 
     Connect(FNPort(0,4),Ring_io)
   END IF
    !
   IF Flag=0 THEN 
     Force_v(Ring_io,0,0,.01)
   END IF
    !
   IF Flag=1 THEN 
     Force_v(Ring_io,Vforce,Vforce,.01)
   END IF
    !
    !
    !Measure_i(Powbus,I_powbus)
    !Port_status(Powbus,Sta_p)
    !Measure_i(Buffer,I_buffer)
    !Port_status(Buffer,Sta_b)
    !
    !WAIT 3
    !PRINT "Powbus I & port status:";I_powbus;"  ";Sta_p
    !PRINT "Buffer I & port status:";I_buffer;"  ";Sta_b
    !
   PRINT "MAXF=";Maxf
   Set_spa(Minf,Maxf,Rbw,Sta)
    !
   WAIT 1
   Measure_spa(Fmea,Amp,Tdelay,Stage,Fcr,Sta)
   PRINT "no:";I;"--------- SPA meas status: ";Sta
   PRINT " Freq.   = ";Fmea*1.0E-6;" MHz"
   PRINT "   T     = ";1.0/Fmea*1.0E+9;" nsec"
    !PRINT "   Delay = ";Tdelay*1.0E+12;" psec"   ! this is the Delay calculated
    !
   Frequency=Fmea*1.0E-6 !unit:MHz,add output
    !
   Delay_vdd=(1.0/Fmea)/Stage/2.0*1.0E+12  ! unit= psec
   PRINT "   Delay = ";Delay_vdd;" psec"    !
    !                                              !
    !Measure_i(Powbus,Ienable)
    !Ienable=Ienable*1.E+9/Stage   !unit:nA/stage
    !PRINT "On status current: ",Ienable
    !
    !Force_v(Enable,Venb_off,Venb_off,1.0E-2)
    !
    !WAIT 3
    !Measure_i(Powbus,Ienb_off)
    !
    !Ienb_off=Ienb_off*1.E+12/Stage
    !PRINT "Off status current: ",Ienb_off
    !
    !
   GOSUB Disconnect
   SUBEXIT
    !***Error Handling Block******************************************
 System_error:      ! System Error Handing
   Delay_vdd=ERRN*1.E+16
   PRINT ERRN;ERRM$
   GOSUB Disconnect
   SUBEXIT
 Par_error:      ! User defined Error Hanging
   Delay_vdd=2.E+18
   GOSUB Disconnect
   SUBEXIT
 Meas_error:      ! Set output flag values for smu error
   Delay_vdd=3.E+17
   GOSUB Disconnect
   SUBEXIT
    !***Hardware Clean Block******************************************
 Disconnect:      ! Disables used ports, disconnects pins.
   Disable_spa(Sta)
   PRINT "SPA disable status:",Sta
   Disable_port
   Connect
    !
 SUBEND
 Rkv:SUB Rkv(REAL W,N0,Itest,Vbs,INTEGER Pins(*),REAL Rkv)
 !***** DON'T REMOVE THIS LINE *************************************
 !
 !  Type : Algorithm
 !  Name : RKV
 !  Vers : 1
 !  Desc : Measure resistance using a Kelvin structur
 !  Date : 07/06/2006
 !  Time : 16:28:28
 !  User : wat
 !
 !***** DON'T REMOVE THIS LINE *************************************
 !
 !  Input Variables:
 !
 !     #  Name            Type Size     Description
 !    --- --------------- ---- -------- --------------------------------
 !    Measurement Parameters:
 !      1 W               R    -        Line width
 !      2 N0              R    -        Squares of sheet resistance
 !      3 ITEST           R    -        Force current
 !      4 VBS             R    -        Bulk voltage
 !
 !    Device Terminals:
 !      1 IFORCE          I    -        Iforce
 !      2 VMEA1           I    -        Vmea1
 !      3 VMEA2           I    -        Vmea2
 !      4 COM             I    -        Com
 !      5 BULK            I    -        Bulk
 !
 !  Output Variables:
 !
 !     #  Name            Type Size     Description
 !    --- --------------- ---- -------- --------------------------------
 !    Output Parameters:
 !      1 RKV             R    -
 !
 !***** DON'T REMOVE THIS LINE *************************************
   OPTION BASE 1                !***** DON'T REMOVE THIS LINE *****
   DISP "Rkv"
   ON ERROR GOTO System_error
   INTEGER Iforce,Vmea1,Vmea2,Com,Bulk
    !REAL Vm1,Vm2
    !
   Set_smu_ch(FNPort(0,1),0,0)
   Set_adc(0,2)
    ! Set_smu(1)
    !
   Iforce=Pins(1)
   Vmea1=Pins(2)
   Vmea2=Pins(3)
   Com=Pins(4)
   Bulk=Pins(5)
    !------- error handling ----------
   IF N0<1 THEN GOSUB Par_error
   IF W<=0 THEN GOSUB Par_error
   IF Itest<0 THEN GOSUB Par_error
    !
   IF Itest=0 THEN 
     Itest=1.E-6
   ELSE
     Itest=Itest
   END IF
   IF Bulk=0 THEN 
     Connect(FNPort(0,9),Iforce,Com)
   ELSE
     Connect(FNPort(0,9),Iforce,Com,Bulk)
     Connect(FNPort(0,4),Bulk)
     Force_v(Bulk,Vbs,Vbs,1.E-1)
   END IF
    !
   Connect(FNPort(0,3),Iforce)
   Connect(FNPort(0,9),Com)
   Connect(FNPort(1,5),Vmea1)
   Connect(FNPort(1,6),Vmea2)
    !
   Force_i(Iforce,Itest,0,30)
    !Force_i(Vmea1,0,1.E-9,30)
    !Force_i(Vmea2,0,1.E-9,30)
   Wait_th(.01)
   Measure_v3458(Vm1)
    !Measure_v(Vmea1,Vm1,0)
    !Measure_v(Vmea2,Vm2,0)
    !
    !IF Vm2>39 OR Vm1>39 THEN GOSUB Meas_error
   Rkv=ABS((Vm1)/Itest)/N0
    !Itest_ac=Itest
   PRINT "Rkv=",Rkv
   GOSUB Disconnect
   SUBEXIT
    !***Error Handling Block******************************************
 System_error:    ! System Error Handing
   Rkv=ERRN*1.E+32
   PRINT ERRN;ERRM$
   GOSUB Disconnect
   SUBEXIT
 Par_error:    ! User defined Error Hanging
   Rkv=2.E+30
   GOSUB Disconnect
   SUBEXIT
 Meas_error:    ! Set output flag values for smu error
   Rkv=3.E+30
   GOSUB Disconnect
   SUBEXIT
    !***Hardware Clean Block******************************************
 Disconnect:    ! Disables used ports, disconnects pins.
   Disable_port
   Connect(0,Iforce,Vmea1,Vmea2,Com,Bulk)
   OFF ERROR 
    !
 SUBEND
 Sram_read:SUB Sram_read(REAL V_high,V_low,INTEGER Pins(*),REAL Snf_min,Snt_min)
 !***** DON'T REMOVE THIS LINE *************************************
 !
 !  Type : Algorithm
 !  Name : SRAM_read
 !  Vers : 1
 !  Desc : Description for this Algorithm spec.
 !  Date : 09/24/2021
 !  Time : 21:30:51
 !  User : specs
 !
 !***** DON'T REMOVE THIS LINE *************************************
 !
 !  Input Variables:
 !
 !     #  Name            Type Size     Description
 !    --- --------------- ---- -------- --------------------------------
 !    Measurement Parameters:
 !      1 v_high          R    -
 !      2 v_low           R    -
 !
 !    Device Terminals:
 !      1 VDD             I    -
 !      2 GND             I    -
 !      3 BL              I    -
 !      4 BLB             I    -
 !      5 SNT             I    -
 !      6 SNF             I    -
 !      7 WL              I    -
 !      8 NWell           I    -
 !      9 PWell           I    -
 !     10 WLB             I    -
 !
 !  Output Variables:
 !
 !     #  Name            Type Size     Description
 !    --- --------------- ---- -------- --------------------------------
 !    Output Parameters:
 !      1 SNF_min         R    -
 !      2 SNT_min         R    -
 !
 !***** DON'T REMOVE THIS LINE *************************************
   OPTION BASE 1     !***** DON'T REMOVE THIS LINE *****
   ON ERROR GOSUB Err_handle
     !
     !==========
     !source
     !==========
   INTEGER High,Low,Gndu,Smu3,Smu4
   High=FNPort(0,1)
   Low=FNPort(0,2)
   Smu3=FNPort(0,3)
   Smu4=FNPort(0,4)
   Gndu=FNPort(0,9)
     !
     !
     !==========
     !terminal
     !==========
   INTEGER Vdd,Vss,Gnd,Bl,Blb,Snt,Snf,Wl,Nwell,Pwell,Wlb
   Vdd=Pins(1)
   Gnd=Pins(2)
   Vss=Gnd
   Bl=Pins(3)
   Blb=Pins(4)
   Snt=Pins(5)
   Snf=Pins(6)
   Wl=Pins(7)
   Nwell=Pins(8)
   Pwell=Pins(9)
   Wlb=Pins(10)
     !==========
     !connect
     !==========
   Connect(High,Wl,Bl,Blb,Vdd,Nwell)      !Connect  high
   Connect(Gndu,Vss)         !connect GNDU
   Connect(Low,Pwell)      !Connect  low
   Connect(Smu3,Snt)               !connect SMU#3 to SNT
   Connect(Smu4,Snf)               !connect SMU#4 to SNF
     !
     !==========
     !force
     !==========
   Force_v(High,V_high)
   Force_v(Low,V_low)
     !
     !==========
     !set_iv(sweep SNT)
     !==========
   INTEGER Sweep_mode
   Sweep_mode=1    !linear single voltage sweep
   Output_range=0      !auto range
   V_start=V_low
   V_stop=V_high
   INTEGER Sweep_step
   Sweep_step=11
     !----------
   Hold_time=.001
   Delay_time=1.E-6
   I_comp=1.E-3
   Set_iv(Snt,Sweep_mode,Output_range,V_start,V_stop,Sweep_step,Hold_time,Delay_time,I_comp)
     !
     !==========
     !measure(measure SNF)
     !==========
   INTEGER Meas_mode
   Meas_mode=2
   Meas_range=.1
   REAL Snt_sweep(11)
   REAL Snf_meas(11)
   Sweep_iv(Snf,Meas_mode,Meas_range,Snf_meas(*),Snt_sweep(*))
     !
     !==========
     !set_iv(sweep SNF)
     !==========
   Set_iv(Snf,Sweep_mode,Output_range,V_start,V_stop,Sweep_step,Hold_time,Delay_time,I_comp)
     !
     !==========
     !measure(measure SNT)
     !==========
   REAL Snf_sweep(11)
   REAL Snt_meas(11)
   Sweep_iv(Snt,Meas_mode,Meas_range,Snt_meas(*),Snf_sweep(*))
     !
     !==========
     !output
     !==========
   PRINT "sweep  SNT =",Snt_sweep(*)
   PRINT "measure SNF =",Snf_meas(*)
   PRINT "The minimun of measure SNF =",MIN(Snf_meas(*))
   PRINT "sweep  SNF =",Snf_sweep(*)
   PRINT "measure SNT =",Snt_meas(*)
   PRINT "The minimun of measure SNT =",MIN(Snt_meas(*))
   Snt_min=MIN(Snt_meas(*))
   Snf_min=MIN(Snf_meas(*))
     !
     !==========
     !Error handle end
     !==========
    !GOTO end
     !
 Err_handle:    !
   PRINT "Err num is";ERRN
   PRINT "Err message is";ERRM$
 SUBEND
 Sram_write:SUB Sram_write(REAL V_high,V_low,INTEGER Pins(*),REAL Snf_min,Snt_min)
 !***** DON'T REMOVE THIS LINE *************************************
 !
 !  Type : Algorithm
 !  Name : SRAM_write
 !  Vers : 1
 !  Desc : Description for this Algorithm spec.
 !  Date : 09/24/2021
 !  Time : 21:30:51
 !  User : specs
 !
 !***** DON'T REMOVE THIS LINE *************************************
 !
 !  Input Variables:
 !
 !     #  Name            Type Size     Description
 !    --- --------------- ---- -------- --------------------------------
 !    Measurement Parameters:
 !      1 v_high          R    -
 !      2 v_low           R    -
 !
 !    Device Terminals:
 !      1 VDD             I    -
 !      2 GND             I    -
 !      3 BL              I    -
 !      4 BLB             I    -
 !      5 SNT             I    -
 !      6 SNF             I    -
 !      7 WL              I    -
 !      8 NWell           I    -
 !      9 PWell           I    -
 !     10 WLB             I    -
 !
 !  Output Variables:
 !
 !     #  Name            Type Size     Description
 !    --- --------------- ---- -------- --------------------------------
 !    Output Parameters:
 !      1 SNF_min         R    -
 !      2 SNT_min         R    -
 !
 !***** DON'T REMOVE THIS LINE *************************************
   OPTION BASE 1      !***** DON'T REMOVE THIS LINE *****
   ON ERROR GOSUB Err_handle
      !
      !==========
      !source
      !==========
   INTEGER High,Low,Gndu,Smu3,Smu4
   High=FNPort(0,1)
   Low=FNPort(0,2)
   Smu3=FNPort(0,3)
   Smu4=FNPort(0,4)
   Gndu=FNPort(0,9)
      !
      !
      !==========
      !terminal
      !==========
   INTEGER Vdd,Vss,Gnd,Bl,Blb,Snt,Snf,Wl,Nwell,Pwell,Wlb
   Vdd=Pins(1)
   Gnd=Pins(2)
   Vss=Gnd
   Bl=Pins(3)
   Blb=Pins(4)
   Snt=Pins(5)
   Snf=Pins(6)
   Wl=Pins(7)
   Nwell=Pins(8)
   Pwell=Pins(9)
   Wlb=Pins(10)
      !==========
      !connect
      !==========
   Connect(High,Wl,Bl,Vdd,Nwell)       !Connect  high
   Connect(Gndu,Blb,Vss)          !connect GNDU
   Connect(Low,Pwell)       !Connect  low
   Connect(Smu3,Snt)                !connect SMU#3 to SNT
   Connect(Smu4,Snf)                !connect SMU#4 to SNF
      !
      !==========
      !force
      !==========
   Force_v(High,V_high)
   Force_v(Low,V_low)
      !
      !==========
      !set_iv(sweep SNT)
      !==========
   INTEGER Sweep_mode
   Sweep_mode=1     !linear single voltage sweep
   Output_range=0       !auto range
   V_start=V_low
   V_stop=V_high
   INTEGER Sweep_step
   Sweep_step=11
      !----------
   Hold_time=.001
   Delay_time=1.E-6
   I_comp=1.E-3
   Set_iv(Snt,Sweep_mode,Output_range,V_start,V_stop,Sweep_step,Hold_time,Delay_time,I_comp)
      !
      !==========
      !measure(measure SNF)
      !==========
   INTEGER Meas_mode
   Meas_mode=2
   Meas_range=.1
   REAL Snt_sweep(11)
   REAL Snf_meas(11)
   Sweep_iv(Snf,Meas_mode,Meas_range,Snf_meas(*),Snt_sweep(*))
      !
      !==========
      !set_iv(sweep SNF)
      !==========
   Set_iv(Snf,Sweep_mode,Output_range,V_start,V_stop,Sweep_step,Hold_time,Delay_time,I_comp)
      !
      !==========
      !measure(measure SNT)
      !==========
   REAL Snf_sweep(11)
   REAL Snt_meas(11)
   Sweep_iv(Snt,Meas_mode,Meas_range,Snt_meas(*),Snf_sweep(*))
      !
      !==========
      !output
      !==========
   PRINT "sweep  SNT =",Snt_sweep(*)
   PRINT "measure SNF =",Snf_meas(*)
   PRINT "The minimun of measure SNF =",MIN(Snf_meas(*))
   PRINT "sweep  SNF =",Snf_sweep(*)
   PRINT "measure SNT =",Snt_meas(*)
   PRINT "The minimun of measure SNT =",MIN(Snt_meas(*))
   Snt_min=MIN(Snt_meas(*))
   Snf_min=MIN(Snf_meas(*))
      !
      !==========
      !Error handle end
      !==========
     !GOTO end
      !
 Err_handle:     !
   PRINT "Err num is";ERRN
   PRINT "Err message is";ERRM$
 SUBEND
 Swing:SUB Swing(REAL Vd,Vt,Vbs,Vstep,Mcl1,Mcl2,INTEGER Pins(*),REAL Swing)
 !***** DON'T REMOVE THIS LINE *************************************
 !
 !  Type : Algorithm
 !  Name : Swing
 !  Vers : 1
 !  Desc : Swing=1000*Vstep/slope ,(slope~subthresheld); Add Mcl1 &
 !       : Mcl2
 !  Date : 02/07/2012
 !  Time : 16:17:49
 !  User : wat
 !
 !***** DON'T REMOVE THIS LINE *************************************
 !
 !  Input Variables:
 !
 !     #  Name            Type Size     Description
 !    --- --------------- ---- -------- --------------------------------
 !    Measurement Parameters:
 !      1 Vd              R    -        Drain voltage; common use Vd = 0
 !      2 Vt              R    -        Input by Vton(Vtop),N,PMOS +
 !      3 Vbs             R    -        Back bias;default = 0 V
 !      4 Vstep           R    -        Vg step; default = 0.01 V
 !      5 Mcl1            R    -
 !      6 Mcl2            R    -
 !
 !    Device Terminals:
 !      1 D               I    -        Drain
 !      2 G               I    -        Gate
 !      3 S               I    -        Source
 !      4 B               I    -        Bulk
 !
 !  Output Variables:
 !
 !     #  Name            Type Size     Description
 !    --- --------------- ---- -------- --------------------------------
 !    Output Parameters:
 !      1 Swing           R    -        Swing at linear region
 !
 !***** DON'T REMOVE THIS LINE *************************************
   OPTION BASE 1                                                                                                                       !***** DON'T REMOVE THIS LINE *****
              !
              !  Maverick Control
              !  PCM test Control
              !
       !COM /Maverick/ REAL Mcl(1:200,1:25)
       !COM /Pcm/ REAL Pcm(*)
   INTEGER Check_mcl,Check_pcm
              !
              !check whether the test spec for Mcl or not
              !
   Check_mcl=0
   Check_pcm=0
       !IF Mcl1<>0 AND Mcl2<>0 AND (Pcm(5000)=2 OR Mcl(200,1)=2) THEN
            !FOR Mcli=Mcl1 TO Mcl2
                 !IF Pcm(Mcli)=1 AND Pcm(5000)=2 THEN Check_pcm=Check_pcm+1
                 !IF Mcl(200,1)=2 THEN
                      !IF Mcl(Mcli,1)=1 AND Mcl(200,1)=2 THEN Check_mcl=Check_mcl+1
                 !END IF
                !  PRINT Mcl(Mcli,1),Check_mcl
            !NEXT Mcli
            !IF Check_mcl=0 AND Check_pcm=0 THEN
                 !Swing=9.E+98! 12A default
                 !GOTO Maverick_end
            !END IF
       !END IF
             !
   INTEGER D,G,S,B
   D=Pins(1)
   G=Pins(2)
   S=Pins(3)
   B=Pins(4)
   Disable_port
   Connect
   INTEGER Npoint
   Set_adc(1,2)
   Vb=0
   IF NPAR>=7 THEN Vb=Vbs
   Vt2=ABS(DROUND(Vt,2))                                                                                                             ! add 'abs' function
   IF ABS(Vt2)>1 OR Vt2<.2 THEN Vt2=1
   Vgmin=0
   Vgmax=SGN(Vd)*(Vt2)
   PRINT "Vt2=";Vt2
   IF Vt2=0 THEN 
     Vgmax=SGN(Vd)*(.3)
   END IF
   Npoint=INT(ABS(Vgmax-Vgmin)/Vstep)+1
   PRINT "Npoint=";Npoint
   ALLOCATE Id(Npoint)
        !
   CALL Disable_port
   CALL Connect
        !
   CALL Connect(FNPort(0,9),D,G,S,B)
   CALL Connect(FNPort(0,1),D)
   CALL Connect(FNPort(0,2),G)
   CALL Connect(FNPort(0,3),B)
   CALL Force_v(FNPort(0,3),Vb,Vb,.1)
   CALL Force_v(FNPort(0,1),Vd,Vd,1.E-4)
   CALL Set_iv(G,1,20,Vgmin,Vgmax,Npoint,.1,.01,1.E-7)         !1E-6 ---> 1E-7, 09/29 by YYR,hol
   CALL Sweep_iv(D,2,0,Id(*))
   CALL Disable_port
   CALL Connect
   Swing=0
   Maxdif=0
   FOR I=2 TO Npoint-1
     IF ABS(Id(I))>ABS(Id(I-1)) AND ABS(Id(I+1))>ABS(Id(I)) AND ABS(Id(I-1))>1.E-10 AND ABS(Id(I))>2.E-10 THEN 
       IF Id(I)/Id(I-1)>0 THEN 
         Dif=LGT(Id(I)/Id(I-1))
         IF Dif>Maxdif THEN Maxdif=Dif
       END IF
     END IF
   NEXT I
   DEALLOCATE Id(*)
   IF Maxdif<>0 THEN Swing=1000*ABS(Vstep)/Maxdif
   Swing=Swing
 Maverick_end:                  !
 SUBEND
 Td_al_std:SUB Td_al_std(REAL Vd,N0,INTEGER Norm,Pins(*),REAL Idd,Iss,Ibl_iblb,Iwl)
 !***** DON'T REMOVE THIS LINE *************************************
 !
 !  Type : Algorithm
 !  Name : TD_AL_STD
 !  Vers : 1
 !  Desc : for sram test
 !  Date : 01/13/2009
 !  Time : 13:03:08
 !  User : wat
 !
 !***** DON'T REMOVE THIS LINE *************************************
 !
 !  Input Variables:
 !
 !     #  Name            Type Size     Description
 !    --- --------------- ---- -------- --------------------------------
 !    Measurement Parameters:
 !      1 VD              R    -        SRAM VCC
 !      2 N0              R    -
 !      3 NORM            I    -
 !
 !    Device Terminals:
 !      1 VDD             I    -
 !      2 VSS             I    -
 !      3 BL_BLB          I    -
 !      4 WL              I    -
 !
 !  Output Variables:
 !
 !     #  Name            Type Size     Description
 !    --- --------------- ---- -------- --------------------------------
 !    Output Parameters:
 !      1 IDD             R    -
 !      2 ISS             R    -
 !      3 IBL_IBLB        R    -
 !      4 IWL             R    -
 !
 !***** DON'T REMOVE THIS LINE *************************************
   OPTION BASE 1
    !
   INTEGER Vdd,Vss,Wordline,Bitline_blbar
    !
   Wait_th(1)
    !
   DISP "AL_STD"
    !
   Vdd=Pins(1)
   Vss=Pins(2)
   Bitline_blbar=Pins(3)
   Wordline=Pins(4)
    !
   Connect(FNPort(0,1),Vdd)
   Connect(FNPort(0,2),Vss)
   Connect(FNPort(0,3),Bitline_blbar)
   Connect(FNPort(0,4),Wordline)
    !
    !----------------------------------------------
    ! Bias forcing
    !----------------------------------------------
    !
   IF Vd=0 THEN 
     Vd=1.2
   ELSE
     Vd=Vd
   END IF
    !
   Force_v(Vss,0,0,.1)
   Force_v(Wordline,0,0,.1)
   Force_v(Vdd,Vd,Vd,.1)
   Force_v(Bitline_blbar,Vd,Vd,.1)
    !
   PRINT "Vdd=",Vd
    !
    !----------------------------------------------
    ! Measurement
    !----------------------------------------------
    !
   Wait_th(.05)
    !
   Measure_i(Vdd,Idd,0)
   Measure_i(Vss,Iss,0)
   Measure_i(Bitline_blbar,Ibl_iblb,0)
   Measure_i(Wordline,Iwl,0)
    !
    !Wait_th(2)
    !
    !Measure_i(Vdd,Idd_2,0)
    !Measure_i(Vss,Iss_2,0)
    !Measure_i(Bitline_blbar,Ibl_iblb_2,0)
    !Measure_i(Wordline,Iwl_2,0)
    !
   Idd=Idd+Ibl_iblb
    !Idd_2=Idd_2+Ibl_iblb_2
    !
   IF Norm=1 THEN 
     Idd=Idd*1.E+12/N0
     Iss=Iss*1.E+12/N0
     Ibl_iblb=Ibl_iblb*1.E+12/N0
     Iwl=Iwl*1.E+12/N0
    !
    !Idd_2=Idd_2*1.E+12/N0
    !Iss_2=Iss_2*1.E+12/N0
    !Ibl_iblb_2=Ibl_iblb_2*1.E+12/N0
    !Iwl_2=Iwl_2*1.E+12/N0
   ELSE
     Idd=Idd*1.E+12
     Iss=Iss*1.E+12
     Ibl_iblb=Ibl_iblb*1.E+12
     Iwl=Iwl*1.E+12
    !
    !Idd_2=Idd_2*1.E+12
    !Iss_2=Iss_2*1.E+12
    !Ibl_iblb_2=Ibl_iblb_2*1.E+12
    !Iwl_2=Iwl_2*1.E+12
   END IF
    !
   Disable_port
   Connect
    !
   SUBEXIT
    !
    !***Error Handling Block******************************************
 System_error:     ! System Error Handing
   Idd=ERRN*1.E+32
   Iss=ERRN*1.E+32
   PRINT ERRN;ERRM$
   GOSUB Disconnect
   SUBEXIT
 Par_error:        ! User defined Error Hanging
   Idd=2.E+30
   Iss=2.E+30
   GOSUB Disconnect
   SUBEXIT
 Meas_error:       ! Set output flag values for smu errror
   Idd=3.E+30
   Iss=3.E+30
   GOSUB Disconnect
   SUBEXIT
    !***Hardware Clean Block******************************************
 Disconnect:       ! Disables used ports, disconnects pins.
   Disable_port
   Connect
   OFF ERROR 
    !
 SUBEND
 Td_bvds:SUB Td_bvds(INTEGER P,REAL W,L,Idcri,Vgs,Vs,Vbs,INTEGER Flag,Pins(*),REAL Vcomp,INTEGER Mode,REAL Bvds)
 !***** DON'T REMOVE THIS LINE *************************************
 !
 !  Type : Algorithm
 !  Name : TD_BVDS
 !  Vers : 1
 !  Desc : Measure the source to drain punch-through/ breakdown volt
 !       : age
 !  Date : 11/22/2011
 !  Time : 14:35:44
 !  User : wat
 !
 !***** DON'T REMOVE THIS LINE *************************************
 !
 !  Input Variables:
 !
 !     #  Name            Type Size     Description
 !    --- --------------- ---- -------- --------------------------------
 !    Measurement Parameters:
 !      1 P               I    -        1:NMOS, -1:PMOS
 !      2 W               R    -        Channel Width
 !      3 L               R    -        Channel Length
 !      4 IDCRI           R    -        Test current density
 !      5 VGS             R    -        Gate voltage
 !      6 VS              R    -        Source voltage
 !      7 VBS             R    -        Body voltage
 !      8 FLAG            I    -        Normalize flag, 1: IDCRI is curr
 !
 !    Device Terminals:
 !      1 D               I    -        Drain terminal
 !      2 G               I    -        Gate Terminal
 !      3 S               I    -        Source terminal
 !      4 B               I    -        Bulk terminal
 !
 !    Device Parameters:
 !      1 VCOMP           R    -        Drain Compliance Voltage
 !      2 MODE            I    -        1:Force Idcri,then force Vg; -1:
 !
 !  Output Variables:
 !
 !     #  Name            Type Size     Description
 !    --- --------------- ---- -------- --------------------------------
 !    Output Parameters:
 !      1 BVDS            R    -        Source/Drain Punch-Through Break
 !
 !***** DON'T REMOVE THIS LINE *************************************
   OPTION BASE 1                    !***** DON'T REMOVE THIS LINE *****
   ON ERROR GOSUB System_error
   DISP "Bvds"
   INTEGER Drain,Gate,Source,Bulk
     !
     !Set_smu_ch(FNPort(0,1),0,0)
   Set_smu(1)
     !Set_adc(0,1)
     !
   Drain=Pins(1)
   Gate=Pins(2)
   Source=Pins(3)
   Bulk=Pins(4)
     !
   IF Idcri<0 OR Vg<0 THEN GOSUB Par_error
   IF W<=0 OR L<=0 THEN GOSUB Par_error
   IF P<>-1 AND P<>1 THEN GOSUB Par_error
     !
     !----------------- connection ---------------------------------
   IF Drain<=0 OR Gate<=0 OR Bulk<=0 THEN GOSUB Par_error
   Connect(FNPort(0,9),Drain,Gate,Bulk)
   IF Source<>0 THEN CALL Connect(FNPort(0,4),Source)
   Connect(FNPort(0,1),Drain)
   Connect(FNPort(0,2),Bulk)
      !
   Connect(FNPort(0,3),Gate)
      !
   IF Flag=1 THEN                                ! normalize
     IF Idcri=0 THEN 
       Idcri=1.E-7*W
     ELSE
       Idcri=Idcri*W
     END IF
   ELSE
     IF Idcri=0 THEN 
       Idcri=1.E-7
     ELSE
       Idcri=Idcri
     END IF
   END IF
      !
   Idcri=P*Idcri
   Vbs=Vbs*P
   Vg=Vgs*P*(-1)                               !Add 2nd May 2004 jianhong
      !
   IF Mode=1 THEN 
     Force_i(Drain,Idcri,Idcri,Vcomp)
     Force_v(Bulk,Vbs,Vbs,1.E-2)
     Force_v(Gate,Vg,Vg,1.E-2)                !Add 2nd May 2004 jianhong
     IF Source<>0 THEN CALL Force_v(Source,Vs,Vs,1.E-2)
     Wait_th(.2)
     Measure_v(Drain,Bvds,0)
     PRINT "Bvds=";Bvds
   ELSE                                       ! Add 2007/03/12 Sami
     Force_v(Bulk,Vbs,Vbs,1.E-2)
     Force_v(Gate,Vg,Vg,1.E-2)
     IF Source<>0 THEN CALL Force_v(Source,Vs,Vs,1.E-2)
     Force_i(Drain,Idcri,Idcri,Vcomp)
     Wait_th(.2)
     Measure_v(Drain,Bvds,0)
     PRINT "Bvds=";Bvds
   END IF
      !
   GOSUB Disconnect
   SUBEXIT
     !***Error Handling Block******************************************
 System_error:    ! System Error Handing
   Bvds=ERRN*1.E+32
   PRINT ERRN;ERRM$
   GOSUB Disconnect
   SUBEXIT
 Par_error:    ! User defined Error Hanging
   Bvds=2.E+30
   GOSUB Disconnect
   SUBEXIT
 Meas_error:    ! Set output flag values for smu error
   Bvds=3.E+30
   GOSUB Disconnect
   SUBEXIT
     !***Hardware Clean Block******************************************
 Disconnect:    ! Disables used ports, disconnects pins.
   Disable_port
   Connect
   OFF ERROR 
   RETURN 
     !
 SUBEND
 Ttr_cap_tox:SUB Ttr_cap_tox(REAL Vf,Area,C0,Darea,De,INTEGER Pins(*),REAL Sl,Freq,INTEGER Integ,REAL E0,Ed,Offset,Tox,Cap,G)
 !***** DON'T REMOVE THIS LINE *************************************
 !
 !  Type : Algorithm
 !  Name : TTR_Cap_tox
 !  Vers : 1
 !  Desc : Capacitance measurement at given bias. Returns capacitanc
 !       : e, conductance and
 !       : oxide thickness.
 !  Date : 07/24/2006
 !  Time : 14:39:34
 !  User : wat
 !
 !***** DON'T REMOVE THIS LINE *************************************
 !
 !  Input Variables:
 !
 !     #  Name            Type Size     Description
 !    --- --------------- ---- -------- --------------------------------
 !    Measurement Parameters:
 !      1 VF              R    -        VOLTAGE TO APPLY
 !      2 AREA            R    -        AREA OF ACTIVE REGION
 !      3 C0              R    -        offset capacitance of probe-card
 !      4 Darea           R    -        Cap/Darea for pf/um2
 !      5 De              R    -        Delay time before measure
 !
 !    Device Terminals:
 !      1 H               I    -        CMH ( recommend to bulk/sub or c
 !      2 L               I    -        CML ( recommend to gate/drain )
 !
 !    Device Parameters:
 !      1 SL              R    -        TEST SIGNAL LEVEL
 !      2 FREQ            R    -        MEASUREMENT FREQUENCY
 !      3 INTEG           I    -        INTEGRATION TIME (1:S, 2:M, 3:L)
 !      4 E0              R    -        Permitivity of free space ( F/cm
 !      5 ED              R    -        DIELECTRIC CONSTANT OF INSULATOR
 !      6 Offset          R    -
 !
 !  Output Variables:
 !
 !     #  Name            Type Size     Description
 !    --- --------------- ---- -------- --------------------------------
 !    Output Parameters:
 !      1 TOX             R    -        OXIDE THICKNESS
 !      2 CAP             R    -        OXIDE CAPACITANCE
 !      3 G               R    -        OXIDE CONDUCTANCE
 !
 !***** DON'T REMOVE THIS LINE *************************************
   OPTION BASE 1                       !***** DON'T REMOVE THIS LINE *****
   DISP "in Cap_tox"
                                       !
   INTEGER H,L,Stat
   REAL C
   DIM St$[256],Err$[256]
                                       !
   H=Pins(1)
   L=Pins(2)
   Connect(FNGnd,H,L)
      !Wait_th(.1)
                                       !
   IF C0=0 THEN 
     Prober_down(St$,Err$)             ! Chuck Down to measure offset C0
     IF St$<>"OK" THEN 
       Tox=999
       SUBEXIT
     ELSE
       Connect(FNPort(1,7),H)          ! connect device
       Connect(FNPort(1,8),L)
       Set_cmu84(Integ,Sl)
       Set_freq(H,Freq)
       Force_v(H,Vf,Vf,.1)
       Wait_th(.005)
       Measure_cmu84(C0)
       PRINT "offset C0=";C0
     END IF
     Prober_up(St$,Err$)               ! Chuck Up
   END IF
                                       !
   Wait_th(.005)
   Connect(FNPort(1,7),H)
   Connect(FNPort(1,8),L)
   Set_cmu84(Integ,Sl)
   Set_freq(H,Freq)
   Force_v(H,Vf,Vf,.1)
   Wait_th(De)
   Measure_cmu84(C,G)
   PRINT "offset C0=";C0
   PRINT "Cap total=";C,"G=";G
   C=C-C0
   Port_status(H,Stat)
   PRINT "Cm =";C," stat=",Stat
                                          ! Calculate Tox
   IF C<>0 THEN                           !
     Tox=Ed*E0*Area/C+Offset              ! E0: F/cm   = F/(1.0E+8)A
   ELSE                                   ! Area: um^2 = (1.0E+4)^2 A^2
     Tox=999                              !            =1.0E+8 A^2
     SUBEXIT
   END IF
   PRINT "Tox=",Tox;" Anstrom"            !
                                          ! So Tox unit = A
   Cap=C*1.0E+12/Darea                    ! Cap unit : pF
                                          !
   SELECT Stat
   CASE 1
     PRINT " Analog bridge is unbalanced"
   CASE 2
     PRINT " A/D converter is not working"
   CASE 3
     PRINT " Signal source is overloaded"
   CASE 4
     PRINT " Automatic level control (ALC) is unable to keep constant level"
   END SELECT
                                          ! Disconnect
   Disable_port
   Connect
 SUBEND
 Ttr_cap_tox_3t:SUB Ttr_cap_tox_3t(REAL Vf,Area,C0,Darea,De,INTEGER Pins(*),REAL Sl,Freq,INTEGER Integ,REAL E0,Ed,Offset,Tox,Cap,G)
 !***** DON'T REMOVE THIS LINE *************************************
 !
 !  Type : Algorithm
 !  Name : TTR_Cap_tox_3T
 !  Vers : 1
 !  Desc : Capacitance measurement at given bias. Returns capacitanc
 !       : e, conductance and
 !       : oxide thickness.
 !  Date : 03/14/2011
 !  Time : 16:25:15
 !  User : wat
 !
 !***** DON'T REMOVE THIS LINE *************************************
 !
 !  Input Variables:
 !
 !     #  Name            Type Size     Description
 !    --- --------------- ---- -------- --------------------------------
 !    Measurement Parameters:
 !      1 VF              R    -        VOLTAGE TO APPLY
 !      2 AREA            R    -        AREA OF ACTIVE REGION
 !      3 C0              R    -        offset capacitance of probe-card
 !      4 Darea           R    -        Cap/Darea for pf/um2
 !      5 De              R    -        delay time
 !
 !    Device Terminals:
 !      1 H               I    -        CMH ( recommend to bulk/sub or c
 !      2 L               I    -        CML ( recommend to gate/drain )
 !      3 Bulk            I    -        BULK
 !
 !    Device Parameters:
 !      1 SL              R    -        TEST SIGNAL LEVEL
 !      2 FREQ            R    -        MEASUREMENT FREQUENCY
 !      3 INTEG           I    -        INTEGRATION TIME (1:S, 2:M, 3:L)
 !      4 E0              R    -        Permitivity of free space ( F/cm
 !      5 ED              R    -        DIELECTRIC CONSTANT OF INSULATOR
 !      6 Offset          R    -
 !
 !  Output Variables:
 !
 !     #  Name            Type Size     Description
 !    --- --------------- ---- -------- --------------------------------
 !    Output Parameters:
 !      1 TOX             R    -        OXIDE THICKNESS
 !      2 CAP             R    -        OXIDE CAPACITANCE
 !      3 G               R    -        OXIDE CONDUCTANCE
 !
 !***** DON'T REMOVE THIS LINE *************************************
   OPTION BASE 1                       !***** DON'T REMOVE THIS LINE *****
   DISP "in Cap_tox"
                                       !
   INTEGER H,L,Stat
   REAL C
   DIM St$[256],Err$[256]
                                       !
   H=Pins(1)
   L=Pins(2)
       !
   Connect_th(FNPort(0,9),1,49)
   Wait_th(.01)
   Connect
       !
   Connect(FNGnd,H,L)
   IF Bulk<>0 THEN CALL Connect(FNPort(0,9),Bulk)
                                       !
   IF C0=0 THEN 
     Prober_down(St$,Err$)             ! Chuck Down to measure offset C0
     IF St$<>"OK" THEN 
       Tox=999
       SUBEXIT
     ELSE
       Connect(FNPort(1,7),H)          ! connect device
       Connect(FNPort(1,8),L)
       Set_cmu84(Integ,Sl)
       Set_freq(H,Freq)
       Force_v(H,Vf,Vf,.1)
       Wait_th(.1)
       Measure_cmu84(C0)
       PRINT "offset C0=";C0
     END IF
     Prober_up(St$,Err$)               ! Chuck Up
   END IF
                                       !
   Wait_th(.005)
   Connect(FNPort(1,7),H)
   Connect(FNPort(1,8),L)
   Set_cmu84(Integ,Sl)
   Set_freq(H,Freq)
   Force_v(H,Vf,Vf,.1)
   Wait_th(De)
   Measure_cmu84(C,G)
   PRINT "offset C0=";C0
   PRINT "Cap total=";C,"G=";G
   C=C-C0
   Port_status(H,Stat)
   PRINT "Cm =";C," stat=",Stat
                                          ! Calculate Tox
   IF C<>0 THEN                           !
     Tox=Ed*E0*Area/C+Offset              ! E0: F/cm   = F/(1.0E+8)A
   ELSE                                   ! Area: um^2 = (1.0E+4)^2 A^2
     Tox=999                              !            =1.0E+8 A^2
     SUBEXIT
   END IF
   PRINT "Tox=",Tox;" Anstrom"            !
                                          ! So Tox unit = A
   Cap=C*1.0E+12/Darea                    ! Cap unit : pF
                                          !
   SELECT Stat
   CASE 1
     PRINT " Analog bridge is unbalanced"
   CASE 2
     PRINT " A/D converter is not working"
   CASE 3
     PRINT " Signal source is overloaded"
   CASE 4
     PRINT " Automatic level control (ALC) is unable to keep constant level"
   END SELECT
                                          ! Disconnect
   Disable_port
   Connect
 SUBEND
 Ttr_r2t_ctm:SUB Ttr_r2t_ctm(REAL Vf,R0,Sqr,Count,INTEGER Unit,REAL T,D,INTEGER Pins(*),Adc,REAL Iv,INTEGER Integ,REAL Icomp,Hold,Res)
 !***** DON'T REMOVE THIS LINE *************************************
 !
 !  Type : Algorithm
 !  Name : TTR_R2t_ctm
 !  Vers : 1
 !  Desc : Res=(R_average-(count/2)*Rs*SQR)/count,RCFV 999 count poi
 !       : nt function
 !  Date : 05/15/2019
 !  Time : 17:33:09
 !  User : keysight
 !
 !***** DON'T REMOVE THIS LINE *************************************
 !
 !  Input Variables:
 !
 !     #  Name            Type Size     Description
 !    --- --------------- ---- -------- --------------------------------
 !    Measurement Parameters:
 !      1 VF              R    -        VOLTAGE TO APPLY
 !      2 R0              R    -        Rs
 !      3 SQR             R    -        Sqr=(L/W)
 !      4 COUNT           R    -        VIA COUNTS
 !      5 UNIT            I    -        0:ohm, 1: Kohm, 2: mohm, 3: Mohm
 !      6 T               R    -        R * T
 !      7 D               R    -        R / D
 !
 !    Device Terminals:
 !      1 H               I    -        HIGH TERMINAL
 !      2 L               I    -        LOW TERMINAL
 !
 !    Device Parameters:
 !      1 ADC             I    -        ADC TYPE (0:HI-SPEED, 1:HI-RESOL
 !      2 IV              R    -        SAMPLING NUMBER WHEN MANUAL INTE
 !      3 INTEG           I    -        0:RES, 1: R/sqr or R/count)
 !      4 ICOMP           R    -        CURRENT COMPLIANCE
 !      5 HOLD            R    -        HOLD TIME
 !
 !  Output Variables:
 !
 !     #  Name            Type Size     Description
 !    --- --------------- ---- -------- --------------------------------
 !    Output Parameters:
 !      1 RES             R    -        RESISTANCE OR RHO
 !
 !***** DON'T REMOVE THIS LINE *************************************
   OPTION BASE 1                    !***** DON'T REMOVE THIS LINE *****
   DISP "in R2t_ctm"
                                    !
   INTEGER H,L,Stat
                                    !
   H=Pins(1)
   L=Pins(2)
                                    ! Connect device
    !Connect(FNGnd,H,L)
   Connect_th(FNGnd,1,49)
   Wait_th(.01)
   Connect
   Connect(FNGnd,H,L)
   Connect(FNPort(0,2),H)
                                    ! ADC mode
   Set_smu_ch(H,Adc,0)
   Set_adc(Adc,Integ,Iv)
    !Set_wait_time(Ss,Sm)
                                    ! Spot measurement
   Re_test=1
 Start_test:    !
   Force_v(H,Vf,Vf,Icomp)
   Wait_th(Hold)
    !Wait_th(1)
   Measure_i(H,Im,0)
   Port_status(H,Stat)
                                    ! Res value calculation
   Res=(Vf/(Im+1.E-30)-(Count/2)*R0*Sqr)/Count
   PRINT "Res=";Res,"Stat";Stat
                                    !
   IF Re_test=1 AND Res<0 THEN 
     Re_test=2
     GOTO Start_test
   END IF
   IF Res<0 THEN 
     Res=999
     CALL Rcfv_addpoint
     SUBEXIT
   END IF
                                     ! ---------------------------------
   SELECT Unit
   CASE 0
     Res=Res           ! ohm
   CASE 1
     Res=Res*1.E-3     ! Kohm
   CASE 2
     Res=Res*1.E+3     ! mohm
   CASE 3
     Res=Res*1.E-6     ! Mohm
   CASE ELSE
     Res=Res
   END SELECT
                                     !
   Res=Res*T/D
                                    ! Disable ports and pins
   Disable_port
   Connect
 SUBEND
 Ttr_r2t_fi:SUB Ttr_r2t_fi(REAL Iforce,INTEGER Flg,REAL Sqr,Count,INTEGER Unit,REAL T,D,INTEGER Pins(*),Adc,REAL Iv,INTEGER Integ,REAL Vcomp,Hold,Res)
 !***** DON'T REMOVE THIS LINE *************************************
 !
 !  Type : Algorithm
 !  Name : TTR_R2t_fi
 !  Vers : 1
 !  Desc : Res=Vm/If
 !  Date : 08/06/2002
 !  Time : 16:28:32
 !  User : wat
 !
 !***** DON'T REMOVE THIS LINE *************************************
 !
 !  Input Variables:
 !
 !     #  Name            Type Size     Description
 !    --- --------------- ---- -------- --------------------------------
 !    Measurement Parameters:
 !      1 IFORCE          R    -        CURRENT TO APPLY
 !      2 FLG             I    -        unit flag (0: R 1: R/sqr 2: R/co
 !      3 SQR             R    -        SQR=(L/W), use to calculate R=R/
 !      4 COUNT           R    -        VIA COUNTS
 !      5 UNIT            I    -        0:ohm, 1: Kohm, 2: mohm, 3: Mohm
 !      6 T               R    -        R * T
 !      7 D               R    -        R / D
 !
 !    Device Terminals:
 !      1 H               I    -        HIGH TERMINAL
 !      2 L               I    -        LOW TERMINAL
 !
 !    Device Parameters:
 !      1 ADC             I    -        ADC TYPE (0:HI-SPEED, 1:HI-RESOL
 !      2 IV              R    -        SAMPLING NUMBER WHEN MANUAL INTE
 !      3 INTEG           I    -        INTEGRATION TIME (0:MAN. 1:S, 2:
 !      4 VCOMP           R    -        VOLTAGE COMPLIANCE
 !      5 HOLD            R    -        HOLD TIME
 !
 !  Output Variables:
 !
 !     #  Name            Type Size     Description
 !    --- --------------- ---- -------- --------------------------------
 !    Output Parameters:
 !      1 RES             R    -        RESISTANCE OR RHO
 !
 !***** DON'T REMOVE THIS LINE *************************************
   OPTION BASE 1                       !***** DON'T REMOVE THIS LINE *****
   DISP "in R2t_fi"
   INTEGER H,L,Stat,Stb
                                       !
   H=Pins(1)
   L=Pins(2)
                                       !
                                       ! Connect
                                       !
      !FOR I=1 TO 5
   Connect_th(FNPort(0,9),1,49)
   Wait_th(Hold)
      !NEXT I
   Connect
       !
   Connect(FNPort(0,4),H)
   Connect(FNPort(0,9),L,49)
                                       ! ADC mode
                                       !
   Set_smu_ch(H,Adc,0)
   Set_adc(Adc,Integ,Iv)
       !Set_wait_time(Ss,Sm)
                                       ! Perform spot measurement
                                       !
   Force_i(H,Iforce,Iforce,Vcomp)
      !Force_v(L,0,0,1.E-2)
   Wait_th(Hold)
   Measure_v(H,Vm,0)
   PRINT "Vm1=";Vm
   Prober_output("D",Status$,Error$)
   Prober_srq(5,Stb)
   PRINT "Stb=";Stb
   Wait_th(Hold)
   Prober_output("Z",Status$,Error$)
   Prober_srq(5,Stb)
   PRINT "Stb=";Stb
   Measure_v(H,Vm,0)
   Port_status(H,Stat)
   PRINT "Vm=";Vm,"Stat=",Stat
                                       ! Resistance value calculation
   SELECT Flg
   CASE 0
     Res=ABS(Vm/Iforce)
   CASE 1
     Res=ABS((Vm/Iforce)/Sqr)
   CASE 2
     Res=ABS((Vm/Iforce)/Count)
   END SELECT
                                       ! ------------------------------------
   SELECT Unit
   CASE 0
     Res=Res             ! ohm
   CASE 1
     Res=Res*1.E-3       ! Kohm
   CASE 2
     Res=Res*1.E+3       ! mohm
   CASE 3
     Res=Res*1.E-6       ! Mohm
   CASE ELSE
     Res=Res
   END SELECT
                                       !
   Res=Res*T/D
                                       !
   IF Pst<>0 THEN Res=999
                                       ! Disable ports and pins
   Disable_port
   Connect
 SUBEND
 Ttr_r2t_fv:SUB Ttr_r2t_fv(REAL Vf,INTEGER Flg,REAL Sqr,Count,INTEGER Unit,REAL T,D,INTEGER Pins(*),Adc,REAL Iv,INTEGER Integ,REAL Icomp,Hold,Wait_th,Res)
 !***** DON'T REMOVE THIS LINE *************************************
 !
 !  Type : Algorithm
 !  Name : TTR_R2t_fv
 !  Vers : 1
 !  Desc : Res=Vf/Im
 !  Date : 03/25/2003
 !  Time : 15:49:59
 !  User : wat
 !
 !***** DON'T REMOVE THIS LINE *************************************
 !
 !  Input Variables:
 !
 !     #  Name            Type Size     Description
 !    --- --------------- ---- -------- --------------------------------
 !    Measurement Parameters:
 !      1 VF              R    -        VOLTAGE TO APPLY
 !      2 FLG             I    -        unit flag (0: R 1: R/sqr 2: R/co
 !      3 SQR             R    -        SQR=(L/W), use to calculate R=R/
 !      4 COUNT           R    -        VIA COUNTS
 !      5 UNIT            I    -        0:ohm, 1: Kohm, 2: mohm, 3: Mohm
 !      6 T               R    -        R * T
 !      7 D               R    -        R / D
 !
 !    Device Terminals:
 !      1 H               I    -        HIGH TERMINAL
 !      2 L               I    -        LOW TERMINAL
 !
 !    Device Parameters:
 !      1 ADC             I    -        ADC TYPE (0:HI-SPEED, 1:HI-RESOL
 !      2 IV              R    -        SAMPLING NUMBER WHEN MANUAL INTE
 !      3 INTEG           I    -        INTEGRATION TIME (0:MAN. 1:S, 2:
 !      4 ICOMP           R    -        CURRENT COMPLIANCE
 !      5 HOLD            R    -        HOLD TIME
 !      6 WAIT_TH         R    -        HOLD TIME AFTER DISCHARGE
 !
 !  Output Variables:
 !
 !     #  Name            Type Size     Description
 !    --- --------------- ---- -------- --------------------------------
 !    Output Parameters:
 !      1 RES             R    -        RESISTANCE OR RHO
 !
 !***** DON'T REMOVE THIS LINE *************************************
   OPTION BASE 1                       !***** DON'T REMOVE THIS LINE *****
   DISP "in R2t_fv"
                                       !
   INTEGER H,L,Stat
   H=Pins(1)
   L=Pins(2)
                                       ! Connect
   Connect(FNGnd,H,L)
   Wait_th(Wait_th)
   Connect(FNPort(0,4),H)
                                       ! ADC mode
   Set_smu_ch(H,Adc,0)
   Set_adc(Adc,Integ,Iv)
       !Set_wait_time(Ss,Sm)
                                       ! Pre_test
   Force_v(H,Vf,Vf,Icomp)
   Wait_th(.01)
   Measure_i(H,Im,0)
       ! Wait_th(.05)
                                       ! Perform spot measurement
   Force_v(H,Vf,Vf,Icomp)
   Wait_th(Hold)
   Measure_i(H,Im,0)
   Im=ABS(Im)
   Port_status(H,Stat)
                                       ! R calculation
   SELECT Flg
   CASE 0
     Res=ABS(Vf/(Im+1.E-30))
   CASE 1
     Res=ABS((Vf/(Im+1.E-30))/Sqr)
   CASE 2
     Res=ABS((Vf/(Im+1.E-30))/Count)
   END SELECT
   PRINT "Res=",Res;"Stat=",Stat
                                       ! -------------------------------
   SELECT Unit
   CASE 0
     Res=Res             ! ohm
   CASE 1
     Res=Res*1.E-3       ! Kohm
   CASE 2
     Res=Res*1.E+3       ! mohm
   CASE 3
     Res=Res*1.E-6       ! Mohm
   CASE ELSE
     Res=Res
   END SELECT
                                       !
   Res=Res*T/D
                                       !
   IF Pst<>0 THEN Res=999
                                       ! Disable ports and pins
   Disable_port
   Connect
 SUBEND
 Vbk:SUB Vbk(INTEGER P,REAL Ar,Pe,INTEGER N,REAL Ijtest,INTEGER Mode,Pins(*),REAL Vjbk)
 !***** DON'T REMOVE THIS LINE *************************************
 !
 !  Type : Algorithm
 !  Name : VBK
 !  Vers : 1
 !  Desc : Measure the junction breakdown voltage
 !  Date : 09/28/2006
 !  Time : 09:46:05
 !  User : wat
 !
 !***** DON'T REMOVE THIS LINE *************************************
 !
 !  Input Variables:
 !
 !     #  Name            Type Size     Description
 !    --- --------------- ---- -------- --------------------------------
 !    Measurement Parameters:
 !      1 P               I    -        1: NMOS, -1: PMOS
 !      2 AR              R    -        Area of junction in um^2
 !      3 PE              R    -        Peripheral length of diode in um
 !      4 N               I    -        Finger numbers of AA
 !      5 IJTEST          R    -        Force current btw Hi & Lo in uA
 !      6 MODE            I    -        Measurement Mode, 0: Force curre
 !
 !    Device Terminals:
 !      1 FORCE           I    -        Force terminal
 !      2 COM             I    -        Sence terminal
 !
 !  Output Variables:
 !
 !     #  Name            Type Size     Description
 !    --- --------------- ---- -------- --------------------------------
 !    Output Parameters:
 !      1 VJBK            R    -        Reverse bias junction voltage at
 !
 !***** DON'T REMOVE THIS LINE *************************************
   OPTION BASE 1             !***** DON'T REMOVE THIS LINE *****
   ON ERROR GOSUB System_error
   DISP "Vbk"
   INTEGER Force,Com
   REAL Ijt
   !-------------------------------------
   !Set_smu_ch(FNPort(0,1),0,0)
   !Set_smu(1)
   !Set_adc(0,1)
   !-------------------------------------
   Force=Pins(1)
   Com=Pins(2)
   !
   IF Ar<=0 THEN GOSUB Par_error
   IF P<>1 AND P<>-1 THEN GOSUB Par_error
   IF Ijtest<0 THEN GOSUB Par_error
   IF Ijtest>1.E-5 THEN GOSUB Par_error
   IF Ijtest=1.E-5 THEN GOSUB Par_error
   !
   IF Ijtest=0 THEN 
     Ijt=1.E-6
   ELSE
     Ijt=Ijtest
   END IF
   !
   Connect(FNPort(0,9),Force,Com)
   Connect(FNPort(0,1),Force)
   !
   Set_smu_ch(Force,1,0)
   Set_adc(1,2)
   IF Mode=0 THEN 
     Ijt=Ijt*P
     Force_i(Force,Ijt,Ijt,50)
   !Force_v(Force,Vbs,Vbs,1.E-2)
     Wait_th(.05)
     Measure_v(Force,Vjbk,0)
   END IF
   PRINT "Vjbk=",Vjbk
   !
   IF Mode=1 THEN 
     Vstep=.1
     I=1
     REPEAT
       Vsta=(I-1)*Vstep*P
   !
       Force_v(Force,Vsta,10,1.2E-6)
       Wait_th(.05)
       Measure_i(Force,Imeas,1.E-7)
       PRINT "V=",Vsta;"I=",Imeas
       I=I+1
     UNTIL (ABS(Vsta)=20 OR ABS(Imeas)=Ijt OR ABS(Imeas)>Ijt)
     Vjbk=Vsta
   END IF
   PRINT "Vjbk=",Vjbk
   GOSUB Disconnect
   SUBEXIT
   !***Error Handling Block******************************************
 System_error:   ! System Error Handing
   Vjbk=ERRN*1.E+32
   PRINT ERRN;ERRM$
   GOSUB Disconnect
   SUBEXIT
 Par_error:   ! User defined Error Hanging
   Vjbk=2.E+30
   GOSUB Disconnect
   SUBEXIT
 Meas_error:   ! Set output flag values for smu error
   Vjbk=3.E+30
   GOSUB Disconnect
   SUBEXIT
   !***Hardware Clean Block******************************************
 Disconnect:   ! Disables used ports, disconnects pins.
   Disable_port
   Connect(0,Force,Com)
   OFF ERROR 
   !
 SUBEND
 Vsf_ibias:SUB Vsf_ibias(REAL Vbe,Vce,Vsub,INTEGER Unit,REAL Ie,Velimit,T,D,INTEGER Pins(*),Adc,REAL Iv,INTEGER Integ,REAL Hold,Ibrng,Icrng,Verng,Ib,Ic,Betapnp,Ve)
 !***** DON'T REMOVE THIS LINE *************************************
 !
 !  Type : Algorithm
 !  Name : VSF_IBIAS
 !  Vers : 1
 !  Desc : PNP Ic Ib Beta current measurement at specified bias poin
 !       : t.
 !  Date : 05/29/2013
 !  Time : 14:46:16
 !  User : wat
 !
 !***** DON'T REMOVE THIS LINE *************************************
 !
 !  Input Variables:
 !
 !     #  Name            Type Size     Description
 !    --- --------------- ---- -------- --------------------------------
 !    Measurement Parameters:
 !      1 VBE             R    -        Base TO Emitter BIAS
 !      2 VCE             R    -        Collector TO Emitter BIAS
 !      3 VSUB            R    -
 !      4 UNIT            I    -        0: MKS, 1:pA, 2:uA, 3:mA
 !      5 IE              R    -        Current forced in Emitter
 !      6 VELIMIT         R    -        Voltage limit in measuring Emitt
 !      7 T               R    -        *T
 !      8 D               R    -        /D
 !
 !    Device Terminals:
 !      1 B               I    -        Base TERMINAL
 !      2 C               I    -        Collector TERMINAL
 !      3 E               I    -        Emitter TERMINAL
 !      4 Psub            I    -        Substrate TERMINAL
 !
 !    Device Parameters:
 !      1 ADC             I    -        ADC TYPE (0:HI-SPEED, 1:HI-RESOL
 !      2 IV              R    -        SAMPLING NUMBER WHEN MANUAL INTE
 !      3 INTEG           I    -        INTEGRATION TIME (0:MAN, 1:S, 2:
 !      4 HOLD            R    -        HOLD TIME BEFORE STARTS SWEEP ME
 !      5 IBRNG           R    -        Bias CURRENT MEASUREMENT RANGE (
 !      6 ICRNG           R    -        Collet CURRENT MEASUREMENT RANGE
 !      7 VERNG           R    -        Emitter voltage measurement rang
 !
 !  Output Variables:
 !
 !     #  Name            Type Size     Description
 !    --- --------------- ---- -------- --------------------------------
 !    Output Parameters:
 !      1 IB              R    -        Base CURRENT
 !      2 IC              R    -        Collector CURRENT
 !      3 BETAPNP         R    -        Ic/Ib
 !      4 VE              R    -        Emitter Voltage
 !
 !***** DON'T REMOVE THIS LINE *************************************
   OPTION BASE 1                       !***** DON'T REMOVE THIS LINE *****
   DISP "in BETAPNP"
                                       !
   INTEGER E,B,C,Statb,Statc,State,Psub
                                       !
   B=Pins(1)
   C=Pins(2)
   E=Pins(3)
   Psub=Pins(4)
                                       ! Connect device
   IF Psub>0 THEN 
     Connect(FNGnd,B,C,E,Psub)
   ELSE
     Connect(FNGnd,B,C,E)
   END IF
   Connect(FNPort(0,1),B)
   Connect(FNPort(0,2),C)
   Connect(FNPort(0,3),E)
   Connect(FNPort(0,4),Psub)
                                       ! ADC mode
   Set_smu_ch(B,Adc,0)
   Set_adc(Adc,Integ,Iv)
   Set_smu_ch(C,Adc,0)
   Set_adc(Adc,Integ,Iv)
   Set_smu_ch(E,Adc,0)
   Set_adc(Adc,Integ,Iv)
                                       ! Spot measurement
   Force_v(C,Vce,Vce,.1)
   Force_v(B,Vbe,Vbe,.1)
   Force_v(Psub,Vsub,Vsub,.1)
   Force_i(E,Ie,Ie,Velimit)
   Wait_th(Hold)
   Measure_i(B,Ib,Ibrng)
   Measure_i(C,Ic,Icrng)
   Measure_v(E,Ve,Verng)
   Betapnp=Ic/(Ib+1.E-24)
   Port_status(B,Statb)
   Port_status(C,Statc)
   Port_status(E,State)
                                       !
   Ic=Ic*T/D
   Ib=Ib*T/D
   SELECT Unit
   CASE 0
     Ic=Ic                               !:unit: A
     Ib=Ib
   CASE 1
     Ic=Ic*1.E+12                        !:unit: pA
     Ib=Ib*1.E+12
   CASE 2
     Ic=Ic*1.E+6                         !:unit: uA
     Ib=Ib*1.E+6
   CASE 3
     Ic=Ic*1.E+3                         !:unit: mA
     Ib=Ib*1.E+3
   CASE ELSE
     Ic=Ic                               !:unit: A
     Ib=Ib
   END SELECT
   PRINT "Ic=";Ic,"Statc";Statc
   PRINT "Ib=";Ib,"Statb";Statb
   PRINT "State";State
                                       !Disable ports and pins
   Disable_port
   Connect
 SUBEND
 Vsf_ibias_6t:SUB Vsf_ibias_6t(REAL Vbe,Vce,Vsub,INTEGER Unit,REAL Ie,Velimit,Vh,Vg,INTEGER Pins(*),Adc,REAL Iv,INTEGER Integ,REAL Hold,Ibrng,Icrng,Verng,Ib,Ic,Betapnp,Ve)
 !***** DON'T REMOVE THIS LINE *************************************
 !
 !  Type : Algorithm
 !  Name : VSF_IBIAS_6T
 !  Vers : 1
 !  Desc : For CIS CTM testkey test 6T.
 !  Date : 05/29/2013
 !  Time : 15:19:40
 !  User : wat
 !
 !***** DON'T REMOVE THIS LINE *************************************
 !
 !  Input Variables:
 !
 !     #  Name            Type Size     Description
 !    --- --------------- ---- -------- --------------------------------
 !    Measurement Parameters:
 !      1 VBE             R    -        Base TO Emitter BIAS
 !      2 VCE             R    -        Collector TO Emitter BIAS
 !      3 VSUB            R    -
 !      4 UNIT            I    -        0: MKS, 1:pA, 2:uA, 3:mA
 !      5 IE              R    -        Current forced in Emitter
 !      6 VELIMIT         R    -        Voltage limit in measuring Emitt
 !      7 VH              R    -
 !      8 VG              R    -
 !
 !    Device Terminals:
 !      1 B               I    -        Base TERMINAL
 !      2 C               I    -        Collector TERMINAL
 !      3 E               I    -        Emitter TERMINAL
 !      4 Psub            I    -        Substrate TERMINAL
 !      5 H               I    -        H TERMINAL
 !      6 G               I    -        G TERMINAL
 !
 !    Device Parameters:
 !      1 ADC             I    -        ADC TYPE (0:HI-SPEED, 1:HI-RESOL
 !      2 IV              R    -        SAMPLING NUMBER WHEN MANUAL INTE
 !      3 INTEG           I    -        INTEGRATION TIME (0:MAN, 1:S, 2:
 !      4 HOLD            R    -        HOLD TIME BEFORE STARTS SWEEP ME
 !      5 IBRNG           R    -        Bias CURRENT MEASUREMENT RANGE (
 !      6 ICRNG           R    -        Collet CURRENT MEASUREMENT RANGE
 !      7 VERNG           R    -        Emitter voltage measurement rang
 !
 !  Output Variables:
 !
 !     #  Name            Type Size     Description
 !    --- --------------- ---- -------- --------------------------------
 !    Output Parameters:
 !      1 IB              R    -        Base CURRENT
 !      2 IC              R    -        Collector CURRENT
 !      3 BETAPNP         R    -        Ic/Ib
 !      4 VE              R    -        Emitter Voltage
 !
 !***** DON'T REMOVE THIS LINE *************************************
   OPTION BASE 1                       !***** DON'T REMOVE THIS LINE *****
   DISP "in BETAPNP"
                                       !
   INTEGER E,B,C,Statb,Statc,State,Psub,H,G
                                       !
   B=Pins(1)
   C=Pins(2)
   E=Pins(3)
   Psub=Pins(4)
   H=Pins(5)
   G=Pins(6)
                                       ! Connect device
   IF Psub>0 THEN 
     Connect(FNGnd,B,C,E,Psub)
   ELSE
     Connect(FNGnd,B,C,E)
   END IF
   Connect(FNPort(0,1),B)
   Connect(FNPort(0,2),C)
   Connect(FNPort(0,3),E)
   Connect(FNPort(0,4),Psub)
   Connect(FNPort(0,5),H)
   Connect(FNPort(0,6),G)
                                       ! ADC mode
   Set_smu_ch(B,Adc,0)
   Set_adc(Adc,Integ,Iv)
   Set_smu_ch(C,Adc,0)
   Set_adc(Adc,Integ,Iv)
   Set_smu_ch(E,Adc,0)
   Set_adc(Adc,Integ,Iv)
                                       ! Spot measurement
   Force_v(C,Vce,Vce,.1)
   Force_v(B,Vbe,Vbe,.1)
   Force_v(Psub,Vsub,Vsub,.1)
   Force_i(E,Ie,Ie,Velimit)
   Force_v(H,Vh,Vh,.1)
   Force_v(G,Vg,Vg,.1)
   Wait_th(Hold)
   Measure_i(B,Ib,Ibrng)
   Measure_i(C,Ic,Icrng)
   Measure_v(E,Ve,Verng)
   Betapnp=Ic/(Ib+1.E-24)
   Port_status(B,Statb)
   Port_status(C,Statc)
   Port_status(E,State)
                                       !
     ! Ic=Ic*T/D
     ! Ib=Ib*T/D
   SELECT Unit
   CASE 0
     Ic=Ic                               !:unit: A
     Ib=Ib
   CASE 1
     Ic=Ic*1.E+12                        !:unit: pA
     Ib=Ib*1.E+12
   CASE 2
     Ic=Ic*1.E+6                         !:unit: uA
     Ib=Ib*1.E+6
   CASE 3
     Ic=Ic*1.E+3                         !:unit: mA
     Ib=Ib*1.E+3
   CASE ELSE
     Ic=Ic                               !:unit: A
     Ib=Ib
   END SELECT
   PRINT "Ic=";Ic,"Statc";Statc
   PRINT "Ib=";Ib,"Statb";Statb
   PRINT "State";State
                                       !Disable ports and pins
   Disable_port
   Connect
 SUBEND
 Vt:SUB Vt(REAL Vd,Vb,Idtarg,Vgmin,Vgmax,INTEGER Pins(*),Adc,REAL Iv,INTEGER Integ,REAL Vgstep,INTEGER Vgskip,Vbmod,REAL Vt)
 !***** DON'T REMOVE THIS LINE *************************************
 !
 !  Type : Algorithm
 !  Name : Vt
 !  Vers : 1
 !  Desc : Threshold voltage at specified Vd. Vt is defined as a Vg
 !       : when Id reaches
 !       : specified target.
 !  Date : 09/19/2003
 !  Time : 13:38:09
 !  User : wat
 !
 !***** DON'T REMOVE THIS LINE *************************************
 !
 !  Input Variables:
 !
 !     #  Name            Type Size     Description
 !    --- --------------- ---- -------- --------------------------------
 !    Measurement Parameters:
 !      1 VD              R    -        DRAIN TO SOURCE BIAS
 !      2 VB              R    -        BULK TO SOURCE BIAS
 !      3 IDTARG          R    -        DRAIN CURRENT AT VT
 !      4 VGMIN           R    -        START GATE VOLTAGE
 !      5 VGMAX           R    -        STOP GATE VOLTAGE
 !
 !    Device Terminals:
 !      1 DRAIN           I    -        DRAIN TERMINAL
 !      2 GATE            I    -        GATE TERMINAL
 !      3 SOURCE          I    -        SOURCE TERMINAL
 !      4 BULK            I    -        WELL OR BULK
 !
 !    Device Parameters:
 !      1 ADC             I    -        ADC TYPE (0:HI-SPEED, 1:HI-RESOL
 !      2 IV              R    -        SAMPLING NUMBER WHEN MANUAL INTE
 !      3 INTEG           I    -        INTEGRATION TIME (0:MAN. 1:S, 2:
 !      4 VGSTEP          R    -        STEP GATE VOLTAGE
 !      5 VGSKIP          I    -        NUMBER OF STEPS TO SKIP IN THE F
 !      6 VBMOD           I    -        VB MODE (0:FORCE VOTAGE,1:FLOATI
 !
 !  Output Variables:
 !
 !     #  Name            Type Size     Description
 !    --- --------------- ---- -------- --------------------------------
 !    Output Parameters:
 !      1 VT              R    -        THRESHOLD VOLTAGE
 !
 !***** DON'T REMOVE THIS LINE *************************************
   OPTION BASE 1                 !***** DON'T REMOVE THIS LINE *****
   DISP "Vt"
    !
   INTEGER Gate,Drain,Source,Bulk,Stat
    !
   Drain=Pins(1)
   Gate=Pins(2)
   Source=Pins(3)
   Bulk=Pins(4)
    ! Connect device terminals
   Connect(FNGnd,Gate,Drain,Source,Bulk)
   Connect(FNPort(0,1),Drain)
   Connect(FNPort(0,2),Gate)
   Connect(FNPort(0,4),Bulk)
    ! ADC mode
   Set_smu_ch(Drain,Adc,0)
   Set_adc(Adc,Integ,Iv)
  !Set_wait_time(Ss,Sm)
    ! VB MODE SELECT
   IF Vbmod=1 THEN 
     Connect(FNPort(0,4),0)
   ELSE
     Force_v(Bulk,Vb,Vb,.1)
   END IF
    !Search measurement
   Force_v(Drain,Vd,Vd,.1)
   Set_lsearch(Gate,Drain,8,Vgmin,Vgmax,Vgstep,Idtarg,0,.01,0,Vgskip,1)
   Search(Vt,Stat,Idm)
    !
   PRINT "Vt=";Vt,"Stat";Stat
   IF Stat<>0 THEN Vt=Vgmax
    ! Disable ports and pins
   Disable_port
   Connect
 SUBEND
 Vt5:SUB Vt5(REAL Vd,Vsg,Vb,Idtarg,Vcgmin,Vcgmax,INTEGER Pins(*),Adc,REAL Iv,INTEGER Integ,REAL Vgstep,INTEGER Vgskip,REAL Vt)
 !***** DON'T REMOVE THIS LINE *************************************
 !
 !  Type : Algorithm
 !  Name : Vt5
 !  Vers : 1
 !  Desc : Threshold voltage at specified Vd. Vt is defined as a Vg
 !       : when Id reaches
 !       : specified target.
 !  Date : 10/09/2002
 !  Time : 12:13:31
 !  User : wat
 !
 !***** DON'T REMOVE THIS LINE *************************************
 !
 !  Input Variables:
 !
 !     #  Name            Type Size     Description
 !    --- --------------- ---- -------- --------------------------------
 !    Measurement Parameters:
 !      1 VD              R    -        DRAIN TO SOURCE BIAS
 !      2 VSG             R    -        SELECT GATE VOLTAGE
 !      3 VB              R    -        BULK TO SOURCE BIAS
 !      4 IDTARG          R    -        DRAIN CURRENT AT VT
 !      5 VCGMIN          R    -        START GATE VOLTAGE
 !      6 VCGMAX          R    -        STOP GATE VOLTAGE
 !
 !    Device Terminals:
 !      1 DRAIN           I    -        DRAIN TERMINAL
 !      2 SGATE           I    -        SELECT GATE TERMINAL
 !      3 CGATE           I    -        CONTROL GATE
 !      4 SOURCE          I    -        SOURCE TERMINAL
 !      5 BULK            I    -        WELL OR BULK
 !
 !    Device Parameters:
 !      1 ADC             I    -        ADC TYPE (0:HI-SPEED, 1:HI-RESOL
 !      2 IV              R    -        SAMPLING NUMBER WHEN MANUAL INTE
 !      3 INTEG           I    -        INTEGRATION TIME (0:MAN. 1:S, 2:
 !      4 VGSTEP          R    -        STEP GATE VOLTAGE
 !      5 VGSKIP          I    -        NUMBER OF STEPS TO SKIP IN THE F
 !
 !  Output Variables:
 !
 !     #  Name            Type Size     Description
 !    --- --------------- ---- -------- --------------------------------
 !    Output Parameters:
 !      1 VT              R    -        THRESHOLD VOLTAGE
 !
 !***** DON'T REMOVE THIS LINE *************************************
   OPTION BASE 1                    !***** DON'T REMOVE THIS LINE *****
   DISP "Vt"
                                    !
   INTEGER Sgate,Cgate,Drain,Source,Bulk,Stat
                                    !
   Drain=Pins(1)
   Sgate=Pins(2)
   Cgate=Pins(3)
   Source=Pins(4)
   Bulk=Pins(5)
                                    ! Connect device terminals
   Connect(FNGnd,Cgate,Sgate,Drain,Source,Bulk)
   Connect(FNPort(0,1),Drain)
   Connect(FNPort(0,2),Cgate)
   Connect(FNPort(0,3),Sgate)
   Connect(FNPort(0,4),Bulk)
                                    ! ADC mode
   Set_smu_ch(Drain,Adc,0)
   Set_adc(Adc,Integ,Iv)
    !Set_wait_time(Ss,Sm)
                                    ! Search measurement
   Force_v(Bulk,Vb,Vb,.1)
   Force_v(Sgate,Vsg,Vsg,.001)
   Force_v(Drain,Vd,Vd,.1)
   Set_lsearch(Cgate,Drain,8,Vcgmin,Vcgmax,Vgstep,Idtarg,0,.01,0,Vgskip,1)
   Search(Vt,Stat,Idm)
                                    !
   PRINT "Vt=";Vt,"Stat";Stat
   IF Stat<>0 THEN Vt=Vgmax
                                    ! Disable ports and pins
   Disable_port
   Connect
 SUBEND
 Vt_gm:SUB Vt_gm(REAL Vgmin,Vgmax,Vgstep,Vd,Vb,INTEGER Chtyp,Pins(*),Adc,REAL Iv,INTEGER Integ,Num,Vgskip,REAL Idst,INTEGER Mode,REAL Vt,Gm)
 !***** DON'T REMOVE THIS LINE *************************************
 !
 !  Type : Algorithm
 !  Name : Vt_gm
 !  Vers : 1
 !  Desc : Linear extrapolated threshold voltage measurement.
 !       : Maximum gm is also measured.
 !  Date : 03/26/2003
 !  Time : 15:07:46
 !  User : wat
 !
 !***** DON'T REMOVE THIS LINE *************************************
 !
 !  Input Variables:
 !
 !     #  Name            Type Size     Description
 !    --- --------------- ---- -------- --------------------------------
 !    Measurement Parameters:
 !      1 VGMIN           R    -        START GATE VOLTAGE
 !      2 VGMAX           R    -        STOP GATE VOLTAGE
 !      3 VGSTEP          R    -        STEP GATE VOLTAGE
 !      4 VD              R    -        DRAIN TO SOURCE BIAS
 !      5 VB              R    -        BULK TO SOURCE BIAS
 !      6 CHTYP           I    -        1: N-CHANNEL, -1: P-CHANNEL
 !
 !    Device Terminals:
 !      1 DRAIN           I    -        DRAIN TERMINAL
 !      2 GATE            I    -        GATE TERMINAL
 !      3 SOURCE          I    -        SOURCE TERMINAL
 !      4 BULK            I    -        WELL OR BULK
 !
 !    Device Parameters:
 !      1 ADC             I    -        ADC TYPE (0:HI-SPEED, 1:HI-RESOL
 !      2 IV              R    -        SAMPLING NUMBER WHEN MANUAL INTE
 !      3 INTEG           I    -        INTEGRATION TIME (0:MAN. 1:S, 2:
 !      4 NUM             I    -        NUMBER OF POINTS TO TAKE INTO CA
 !      5 VGSKIP          I    -        NUMBER OF STEPS TO SKIP IN THE F
 !      6 IDST            R    -        CURRENT VALUE WHERE FINE SWEEP I
 !      7 Mode            I    -        1 for sqr ID
 !
 !  Output Variables:
 !
 !     #  Name            Type Size     Description
 !    --- --------------- ---- -------- --------------------------------
 !    Output Parameters:
 !      1 VT              R    -        LINEAR EXTRAPOLATED THRESHOLD VO
 !      2 GM              R    -        TRANSCONDUCTANCE
 !
 !***** DON'T REMOVE THIS LINE *************************************
   OPTION BASE 1                !***** DON'T REMOVE THIS LINE *****
   DISP "in VTL"
   !
   INTEGER Gate,Drain,Source,Bulk,Stat
   REAL Id,Id_pre               ! Id returned from Measure_vth
   !
   Drain=Pins(1)
   Gate=Pins(2)
   Source=Pins(3)
   Bulk=Pins(4)
   ! Connect device
   Connect_th(FNPort(0,4),1,49)
   Force_v(FNPort(0,4),0,0,.1)
   Wait_th(.03)
   Connect
   Connect(FNGnd,Drain,Gate,Source,Bulk)
   Connect(FNPort(0,1),Drain)
   Connect(FNPort(0,2),Gate)
   Connect(FNPort(0,3),Bulk)
   ! ADC mode
   Set_smu_ch(Drain,Adc,0)
   Set_adc(Adc,Integ,Iv)
  ! Set_wait_time(Ss,Sm)
   ! Sweep measurement
   Force_v(Bulk,Vb,Vb,.1)
   Force_v(Drain,Vd,Vd,.1)
   Wait_th(.05)
   !
   ! Pre_test
   Force_v(Gate,1,1,.1)
   Measure_i(Drain,Id_pre)
   ! Pre_test judge
 Re_test:    !
   Set_vth(Gate,Drain,Vgmin,Vgmax,Vgstep,Idst,0,Vgskip,1,0,.1,0,Chtyp)
   Measure_vth(Mode,Vt,Stat,Gm,Id,Num,Vd)
   PRINT "1st Vtgm=";Vt,"at Id=";Id,"  Stat=";Stat
   !
   IF Stat<>0 THEN 
     Idst=Idst/10.0
     Set_vth(Gate,Drain,Vgmin,Vgmax,Vgstep,Idst,0,Vgskip,1,0,.1,0,Chtyp)
     Measure_vth(Mode,Vt,Stat,Gm,Id,Num,Vd)
     PRINT "2nd Vtgm=";Vt,"at Id=";Id,"  Stat=";Stat
   END IF
  !
   IF Stat<>0 THEN 
     Idst=Idst*100.0
     Set_vth(Gate,Drain,Vgmin,Vgmax,Vgstep,Idst,0,Vgskip,1,0,.1,0,Chtyp)
     Measure_vth(Mode,Vt,Stat,Gm,Id,Num,Vd)
     PRINT "3nd Vtgm=";Vt,"at Id=";Id,"  Stat=";Stat
   END IF
  ! Status check
  !  1 or 256 : Idst not found                        512 : Search ended
  !  2   : Abnormal data (Oscillating, Abort etc.)    1024: No max. slope found
  !  3   : Abnormal compliance loop                   2048: Max. slope is zero
   PRINT "Vt=";Vt,"  Stat";Stat
       !Disable ports and pins
   Disable_port
   Connect
 SUBEND
 Vt_gm_tb:SUB Vt_gm_tb(INTEGER Type,REAL Vstart,Vgmin,Vgmax,Vgstep,Vd,Vb,Idst,Hold,INTEGER Pins(*),Adc,REAL Iv,INTEGER Integ,Num,Vgskip,Mode,REAL Vt,Gm)
 !***** DON'T REMOVE THIS LINE *************************************
 !
 !  Type : Algorithm
 !  Name : VT_GM_TB
 !  Vers : 1
 !  Desc : Linear extrapolated threshold voltage measurement.
 !       : Maximum gm is also measured
 !       : 2014 base on Vt_gm set up TB alg
 !  Date : 11/07/2014
 !  Time : 15:49:30
 !  User : wat
 !
 !***** DON'T REMOVE THIS LINE *************************************
 !
 !  Input Variables:
 !
 !     #  Name            Type Size     Description
 !    --- --------------- ---- -------- --------------------------------
 !    Measurement Parameters:
 !      1 Type            I    -        1: Nmos, -1: Pmos
 !      2 Vstart          R    -        -1: Nmos sweep from "-"Vgmin,and
 !      3 VGMIN           R    -        START GATE VOLTAGE
 !      4 VGMAX           R    -        STOP GATE VOLTAGE
 !      5 VGSTEP          R    -        STEP GATE VOLTAGE
 !      6 VD              R    -        DRAIN TO SOURCE BIAS
 !      7 VB              R    -        BULK TO SOURCE BIAS
 !      8 IDST            R    -        CURRENT VALUE WHERE FINE SWEEP I
 !      9 Hold            R    -        Hold time for measure
 !
 !    Device Terminals:
 !      1 DRAIN           I    -        DRAIN TERMINAL
 !      2 GATE            I    -        GATE TERMINAL
 !      3 SOURCE          I    -        SOURCE TERMINAL
 !      4 BULK            I    -        WELL OR BULK
 !
 !    Device Parameters:
 !      1 ADC             I    -        ADC TYPE (0:HI-SPEED, 1:HI-RESOL
 !      2 IV              R    -        SAMPLING NUMBER WHEN MANUAL INTE
 !      3 INTEG           I    -        INTEGRATION TIME (0:MAN. 1:S, 2:
 !      4 NUM             I    -        NUMBER OF POINTS TO TAKE INTO CA
 !      5 VGSKIP          I    -        NUMBER OF STEPS TO SKIP IN THE F
 !      6 Mode            I    -        0: Linear region; 1: Sturated re
 !
 !  Output Variables:
 !
 !     #  Name            Type Size     Description
 !    --- --------------- ---- -------- --------------------------------
 !    Output Parameters:
 !      1 VT              R    -        LINEAR EXTRAPOLATED THRESHOLD VO
 !      2 GM              R    -        TRANSCONDUCTANCE
 !
 !***** DON'T REMOVE THIS LINE *************************************
   OPTION BASE 1                !***** DON'T REMOVE THIS LINE *****
   DISP "VT_GM_TB"
   ON ERROR GOSUB System_error
    !
   INTEGER Gate,Drain,Source,Bulk,Stat
   REAL Id,Id_pre               ! Id returned from Measure_vth
    !
   Drain=Pins(1)
   Gate=Pins(2)
   Source=Pins(3)
   Bulk=Pins(4)
    ! Connect device
   Connect_th(FNPort(0,4),1,49)
   Force_v(FNPort(0,4),0,0,.1)
   Wait_th(.01)
   Connect
   Connect(FNGnd,Drain,Gate,Source,Bulk)
   Connect(FNPort(0,1),Drain)
   Connect(FNPort(0,2),Gate)
   Connect(FNPort(0,4),Bulk)
    ! ADC mode
   Set_smu_ch(Drain,Adc,0)
   Set_adc(Adc,Integ,Iv)
  ! Set_wait_time(Ss,Sm)
    ! Sweep measurement
   Vd=ABS(Vd)*Type
   Force_v(Bulk,Vb,Vb,.1)
   Force_v(Drain,Vd,Vd,.1)
   Wait_th(Hold)
    !
    ! Pre_test
   Force_v(Gate,1,1,.1)
   Measure_i(Drain,Id_pre)
    ! Pre_test judge
 Re_test:     !
   Idst=ABS(Idst)
   Vgmin=ABS(Vgmin)*Type*Vstart
   Vgmax=ABS(Vgmax)*Type
   Vgstep=ABS(Vgstep)
   Set_vth(Gate,Drain,Vgmin,Vgmax,Vgstep,Idst,0,Vgskip,1,0,.1,0,Type)
   Measure_vth(Mode,Vt,Stat,Gm,Id,Num,Vd)
   PRINT "1st Vtgm=";Vt,"at Id=";Id,"  Stat=";Stat
    !
   IF Stat<>0 THEN 
     Idst=Idst/10
     Set_vth(Gate,Drain,Vgmin,Vgmax,Vgstep,Idst,0,Vgskip,1,0,.1,0,Type)
     Measure_vth(Mode,Vt,Stat,Gm,Id,Num,Vd)
     PRINT "2nd Vtgm=";Vt,"at Id=";Id,"  Stat=";Stat
   END IF
  !
   IF Stat<>0 THEN 
     Idst=Idst/100
     Set_vth(Gate,Drain,Vgmin,Vgmax,Vgstep,Idst,0,Vgskip,1,0,.1,0,Type)
     Measure_vth(Mode,Vt,Stat,Gm,Id,Num,Vd)
     PRINT "3nd Vtgm=";Vt,"at Id=";Id,"  Stat=";Stat
   END IF
  !
   IF Stat<>0 THEN 
     Idst=0
     Set_vth(Gate,Drain,Vgmin,Vgmax,Vgstep,Idst,0,Vgskip,1,0,.1,0,Type)
     Measure_vth(Mode,Vt,Stat,Gm,Id,Num,Vd)
     PRINT "Final Vtgm=";Vt,"At Id=";Id,"Stat=";Stat
   END IF
  !
  ! Status check
  !  1 or 256 : Idst not found                        512 : Search ended
  !  2   : Abnormal data (Oscillating, Abort etc.)    1024: No max. slope found
  !  3   : Abnormal compliance loop                   2048: Max. slope is zero
   PRINT "Vt=";Vt,"  Stat";Stat
   GOSUB Disconnect
   SUBEXIT
        !Disable ports and pins
  !**************Error handling block ****************
 System_error:                              !  System Error handling
   Vt=ERRN*1.0E+32
   PRINT ERRN;ERRM$
  !
   GOTO Disconnect
   SUBEXIT
 Disconnect:                            !
   Disable_port
   Connect
 SUBEND
 Vt_tb:SUB Vt_tb(INTEGER Type,REAL Vd,Vb,Idtarg,Vgstart,Vgmin,Vgmax,Vgstep,W,L,INTEGER Pins(*),Adc,REAL Iv,INTEGER Integ,Vgskip,Vbmod,REAL Vt)
 !***** DON'T REMOVE THIS LINE *************************************
 !
 !  Type : Algorithm
 !  Name : VT_TB
 !  Vers : 1
 !  Desc : Threshold voltage at specified Vd. Vt is defined as a Vg
 !       : when Id reaches specified target.
 !       : 2014 base on Vt set TB alg
 !  Date : 03/21/2019
 !  Time : 11:26:40
 !  User : keysight
 !
 !***** DON'T REMOVE THIS LINE *************************************
 !
 !  Input Variables:
 !
 !     #  Name            Type Size     Description
 !    --- --------------- ---- -------- --------------------------------
 !    Measurement Parameters:
 !      1 Type            I    -        1:NMOS;-1 PMOS
 !      2 VD              R    -        DRAIN TO SOURCE BIAS
 !      3 VB              R    -        BULK TO SOURCE BIAS
 !      4 IDTARG          R    -        DRAIN CURRENT AT VT
 !      5 Vgstart         R    -        -1: Nmos sweep from "-"Vgmin,and
 !      6 VGMIN           R    -        START GATE VOLTAGE
 !      7 VGMAX           R    -        STOP GATE VOLTAGE
 !      8 VGSTEP          R    -        STEP GATE VOLTAGE
 !      9 W               R    -        *W
 !     10 L               R    -        /L
 !
 !    Device Terminals:
 !      1 DRAIN           I    -        DRAIN TERMINAL
 !      2 GATE            I    -        GATE TERMINAL
 !      3 SOURCE          I    -        SOURCE TERMINAL
 !      4 BULK            I    -        WELL OR BULK
 !
 !    Device Parameters:
 !      1 ADC             I    -        ADC TYPE (0:HI-SPEED, 1:HI-RESOL
 !      2 IV              R    -        SAMPLING NUMBER WHEN MANUAL INTE
 !      3 INTEG           I    -        INTEGRATION TIME (0:MAN. 1:S, 2:
 !      4 VGSKIP          I    -        NUMBER OF STEPS TO SKIP IN THE F
 !      5 VBMOD           I    -        VB MODE (0:FORCE VOTAGE,1:FLOATI
 !
 !  Output Variables:
 !
 !     #  Name            Type Size     Description
 !    --- --------------- ---- -------- --------------------------------
 !    Output Parameters:
 !      1 VT              R    -        THRESHOLD VOLTAGE
 !
 !***** DON'T REMOVE THIS LINE *************************************
   OPTION BASE 1                 !***** DON'T REMOVE THIS LINE *****
  !N ERROR GOSUB System_error
   DISP "VT_TB"
     !
   INTEGER Gate,Drain,Source,Bulk,Stat
     !
   Drain=Pins(1)
   Gate=Pins(2)
   Source=Pins(3)
   Bulk=Pins(4)
  !F Type<>1 AND Type<>-1 THEN GOSUB Par_error
  !F W<=0 OR L<=0 THEN GOSUB Par_error
     ! Connect device terminals
   Connect(FNGnd,Gate,Drain,Source,Bulk)
   Connect(FNPort(0,1),Drain)
   Connect(FNPort(0,2),Gate)
   Connect(FNPort(0,4),Bulk)
     ! ADC mode
   Set_smu_ch(Drain,Adc,0)
   Set_adc(Adc,Integ,Iv)
  !Set_wait_time(Ss,Sm)
     ! VB MODE SELECT
   IF Vbmod=1 THEN 
     Connect(FNPort(0,4),0)
   ELSE
     Force_v(Bulk,Vb,Vb,.1)
   END IF
   Idtarg=ABS(Idtarg)*Type*W/L
   Vd=ABS(Vd)*Type
   Vgmin=ABS(Vgmin)*Type*Vgstart
   Vgmax=ABS(Vgmax)*Type
     !Search measurement
   Force_v(Drain,Vd,Vd,.1)
   Set_lsearch(Gate,Drain,8,Vgmin,Vgmax,Vgstep,Idtarg,0,.01,0,Vgskip,1)
   Search(Vt,Stat,Idm)
     !
   PRINT "Vt=";Vt,"Stat";Stat
   IF Stat<>0 THEN Vt=Vgmax
   GOSUB Disconnect
  !******************Error Handling block*********
  !ystem_error:                        ! System error
  !t=ERRN*1.E+32
  !RINT ERRN;ERRM$
  !OSUB Disconnect
  !UBEXIT
 Par_error:                            ! User define
   Vt=2.E+30
   GOSUB Disconnect
   SUBEXIT
  !*****************hardware clean block*********************
     ! Disable ports and pins
 Disconnect:                          !
   Disable_port
   Connect
   OFF ERROR 
 SUBEND
 Vth_gm_std:SUB Vth_gm_std(REAL Vds,Vbs,Vg_start,Vg_stop,INTEGER Vg_points,REAL Delay_s,INTEGER Pins(*),REAL Vth,Gm)
 !***** DON'T REMOVE THIS LINE *************************************
 !
 !  Type : Algorithm
 !  Name : vth_gm_std
 !  Vers : 1
 !  Desc : Description for this Algorithm spec.
 !  Date : 08/16/2004
 !  Time : 10:06:50
 !  User : pcm02
 !
 !***** DON'T REMOVE THIS LINE *************************************
 !
 !  Input Variables:
 !
 !     #  Name            Type Size     Description
 !    --- --------------- ---- -------- --------------------------------
 !    Measurement Parameters:
 !      1 vds             R    -
 !      2 vbs             R    -
 !      3 vg_start        R    -
 !      4 vg_stop         R    -
 !      5 vg_points       I    -
 !      6 delay_s         R    -
 !
 !    Device Terminals:
 !      1 drain           I    -
 !      2 gate            I    -
 !      3 source          I    -
 !      4 subst           I    -
 !
 !  Output Variables:
 !
 !     #  Name            Type Size     Description
 !    --- --------------- ---- -------- --------------------------------
 !    Output Parameters:
 !      1 Vth             R    -
 !      2 gm              R    -
 !
 !***** DON'T REMOVE THIS LINE *************************************
   OPTION BASE 1                                !***** DON'T REMOVE THIS LINE *****
   INTEGER Drain,Gate,Source,Subst
   Drain=Pins(1)
   Gate=Pins(2)
   Source=Pins(3)
   Subst=Pins(4)
   INTEGER I
   REAL Vgs(300)
   REAL Ids(300)
   Gm=0.
   Slope=0.
   Id_gm=0.
   Vg_gm=0.
   Gm=0.
   Vth=0
                                !
   Connect_th(FNPort(0,4),1,49)                               !KC for discharge
   Force_v(FNPort(0,4),0)                                     !
               ! Wait_th(.1)                                   !
   Connect                                                    !
                                !
                                   !
                                   ! Set ADC mode
                                   ! HR ADC , MEDIUM mode
                                   !
                ! JL SMU3>SMU1 200326
   Set_smu_ch(FNPort(0,1),1)                                    ! Change the HS ADC with SHORT mode KC 1 to 3
   Set_adc(1,1)                        !Alex (1,2)->(1,1) 20181128
                                     !
   Connect(FNPort(0,1),Drain)                                !KC 1 to 3
   Connect(FNPort(0,2),Gate)
   Connect(FNPort(0,9),Source)
   IF (Subst>0) THEN 
     Connect(FNPort(0,5),Subst)
     Force_v(FNPort(0,5),Vbs)
   END IF
                                   !
   Force_v(FNPort(0,1),Vds,Vds,.01)                                 !KC 1 to 3
   Set_iv(FNPort(0,2),1,Vg_stop,Vg_start,Vg_stop,Vg_points,0,Delay_s)
   Sweep_iv(FNPort(0,1),2,0,Ids(*),Vgs(*))                                !KC 1 to 3
   FOR I=2 TO Vg_points STEP 1
     Slope=(Ids(I+1)-Ids(I))/(Vgs(I+1)-Vgs(I))-(Ids(I+1)-Ids(I-1))/(Vgs(I+1)-Vgs(I-1))+(Ids(I)-Ids(I-1))/(Vgs(I)-Vgs(I-1))
     IF (Slope>Gm) THEN 
       Gm=Slope
       Id_gm=Ids(I-1)
       Vg_gm=Vgs(I-1)
     END IF
   NEXT I
                                   !
   IF Gm<>0 THEN 
     Vth=Vg_gm-Id_gm/(Gm)-Vds/2.0
   ELSE
     Vth=999.0
     Gm=999.0
   END IF
                                   !
   Set_smu_ch(FNPort(0,1),0)                                    ! Change the HS ADC with SHORT mode KC 1 to 3
   Set_adc(0,1)
                                   !
                                   !
   Disable_port
   Connect
 SUBEND
 Vth_gm_ttr:SUB Vth_gm_ttr(INTEGER P,REAL W,L,Vbs,Vgstart,INTEGER Flag_volt,Pins(*),REAL Vth)
 !***** DON'T REMOVE THIS LINE *************************************
 !
 !  Type : Algorithm
 !  Name : VTH_GM_TTR
 !  Vers : 1
 !  Desc : Extract the threshold voltage from Gmax at linear region
 !       : 1.modified for initial driving on 9/28
 !       : 2.revised GmMax on 12/25
 !  Date : 07/29/2006
 !  Time : 11:00:30
 !  User : wat
 !
 !***** DON'T REMOVE THIS LINE *************************************
 !
 !  Input Variables:
 !
 !     #  Name            Type Size     Description
 !    --- --------------- ---- -------- --------------------------------
 !    Measurement Parameters:
 !      1 P               I    -        1: NMOS, -1: PMOS
 !      2 W               R    -        Channel Width
 !      3 L               R    -        Channel Length
 !      4 VBS             R    -        Body voltage
 !      5 VGSTART         R    -        Start voltage for Vth search
 !      6 FLAG_VOLT       I    -        FLAG:0 vdd=0.1v, FLAG:1 vdd=0.05
 !
 !    Device Terminals:
 !      1 D               I    -        Drain terminal
 !      2 G               I    -        Gate terminal
 !      3 S               I    -        Source terminal
 !      4 B               I    -        Bulk terminal
 !
 !  Output Variables:
 !
 !     #  Name            Type Size     Description
 !    --- --------------- ---- -------- --------------------------------
 !    Output Parameters:
 !      1 VTH             R    -        Theshold voltage from Gm maximun
 !
 !***** DON'T REMOVE THIS LINE *************************************
   OPTION BASE 1  !***** DON'T REMOVE THIS LINE *****
     !OM /Algo/ REAL Vdd
     !
   DISP "Vth_gm"
   INTEGER Drain,Gate,Source,Bulk,I,K
   REAL Vd,Z,Idn,Vb,Idl(20)
     !
   Set_smu_ch(FNPort(0,1),0)
   Set_adc(0,2)
     !Set_smu(2)
     !
     !----  connection ----
     !
   Drain=Pins(1)
   Gate=Pins(2)
   Source=Pins(3)
   Bulk=Pins(4)
     !
   IF W<=0 OR L<=0 THEN GOSUB Par_error
   IF P<>1 AND P<>-1 THEN GOSUB Par_error
   IF Vbs>10 OR Vbs<-10 THEN GOSUB Par_error
     !
   DIM Id(201),Gm(201),Vg(201)
     !
   Connect(FNPort(0,9),Drain,Gate,Source,Bulk)
   Connect(FNPort(0,1),Drain)
   Connect(FNPort(0,2),Gate)
   Connect(FNPort(0,4),Bulk)
     !
     !-------------- initial drive on Gate and Drain --------------
   Vd=1.*P            ! Vds is decided by Input_vdd at 1st line of spec.
   Force_v(Bulk,0,0,1.E-2)  ! for initial drive
   Force_v(Gate,Vd,Vd,1.E-2)
   Force_v(Drain,Vd,Vd,1.E-2)  ! for initial drive
   Wait_th(.01)
   Force_v(Gate,0,0,1.E-2)
   Force_v(Drain,0,0,1.E-2)
     !--------------
     !
   IF Flag_volt=0 THEN Vd=.1
   IF Flag_volt=1 THEN Vd=.05
   Vd=Vd*P
   Vb=Vbs*P
   Force_v(Drain,Vd,Vd,1.E-2)
   Force_v(Bulk,Vb,Vb,1.E-2)
     !
     !Set_iv(Gate,1,10,0,1*P,10,0,.1,1.E-2)             ! modify (9/28)
     !Sweep_iv(Drain,2,1.E-7,Idl(*))
   Force_v(Gate,0,0,1.E-2)
     !
     !
   IF P=1 THEN 
     Idn=1.E-7*W/L ! NMOS
   ELSE
     Idn=4.E-8*W/L ! PMOS
   END IF
   Ve=.025            ! Sweep step on Gate
   Gmax=0
     !
     !------ Vg(*) v.s. Id(*) -----
     !
   Gm(1)=0
   Vg(1)=P*Vgstart
   Force_v(Gate,Vg(1),20,1.E-1)
   Wait_th(.005)
   Measure_i(Drain,Id(1),1.E-10)
   Id(1)=ABS(Id(1))
   Gm(2)=0
   Vg(2)=Vg(1)+P*Ve
   Force_v(Gate,Vg(2),20,1.E-1)
   Wait_th(.005)
   Measure_i(Drain,Id(2),1.E-10)
   Id(2)=ABS(Id(2))
   I=2
   REPEAT
     I=I+1
     Vg(I)=Vg(1)+P*(I-1)*Ve
     Force_v(Gate,Vg(I),20,1.E-1)
     Wait_th(.005)
     Measure_i(Drain,Id(I),1.E-7)
     Id(I)=ABS(Id(I))
     X1=Vg(I-2)+Vg(I-1)+Vg(I)
     X2=Vg(I-2)^2+Vg(I-1)^2+Vg(I)^2
     Y1=Id(I-2)+Id(I-1)+Id(I)
     Y2=Vg(I-2)*Id(I-2)+Vg(I-1)*Id(I-1)+Vg(I)*Id(I)
     Z=3*X2-X1^2
     IF Z=0 THEN 
       Gm(I)=0
     ELSE
       Gm(I)=ABS((3*Y2-X1*Y1)/Z)
     END IF
     !
   UNTIL Gm(I-1)>=Gm(I-2) AND Gm(I)<Gm(I-1) AND Id(I)>=Idn OR ABS(Vg(I))>2.5
     !
     !--------------------------------------------------------------------------
     !              Add 5 point measurement data to confirm the GmMax (12/25)
     !--------------------------------------------------------------------------
     !
   IF ABS(Vg(I))<2 THEN 
 Sergm:       !
     K=I
     REPEAT
       K=K+1
       Vg(K)=Vg(1)+P*(K-1)*Ve
       Force_v(Gate,Vg(K),20,1.E-1)
       Wait_th(.005)
       Measure_i(Drain,Id(K),1.E-7)
       Id(K)=ABS(Id(K))
       X1=Vg(K-2)+Vg(K-1)+Vg(K)
       X2=Vg(K-2)^2+Vg(K-1)^2+Vg(K)^2
       Y1=Id(K-2)+Id(K-1)+Id(K)
       Y2=Vg(K-2)*Id(K-2)+Vg(K-1)*Id(K-1)+Vg(K)*Id(K)
       Z=3*X2-X1^2
       IF Z=0 THEN 
         Gm(K)=0
       ELSE
         Gm(K)=ABS((3*Y2-X1*Y1)/Z)
       END IF
     UNTIL Gm(K-1)>=Gm(K-2) AND Gm(K)<Gm(K-1) OR K>I+4
     IF Gm(I-1)<=Gm(K-1) THEN 
       I=K
       GOTO Sergm
     END IF
   END IF
     !-----------------------------------------------------------------------
     !
     !
   Vgmax=Vg(I-1)
   Gmax=Gm(I-1)
   Idmax=Id(I-1)
   IF Gmax=0 THEN 
     Vth=0
   ELSE
     Vth=Vgmax-(Idmax*P)/Gmax-Vd/2 ! Idmax, Gmax --> positive
   END IF
   GOSUB Disconnect
   SUBEXIT
     !***Error Handling Block******************************************
 System_error:     ! System Error Handing
   Vth=ERRN*1.E+32
   PRINT ERRN;ERRM$
   GOSUB Disconnect
   SUBEXIT
 Par_error:       ! User defined Error Hanging
   Vth=2.E+30
   GOSUB Disconnect
   SUBEXIT
 Meas_error:      ! Set output flag values for smu error
   Vth=3.E+30
   GOSUB Disconnect
   SUBEXIT
     !***Hardware Clean Block******************************************
 Disconnect:      ! Disables used ports, disconnects pins.
   Disable_port
   Connect(0,Drain,Gate,Source,Bulk)
   OFF ERROR 
 SUBEND
 Vth_lin:SUB Vth_lin(REAL Flag,Vbs,Vgstart,INTEGER Pins(*),Adc,REAL Iv,INTEGER Integ,P,REAL W,L,Vthi)
 !***** DON'T REMOVE THIS LINE *************************************
 !
 !  Type : Algorithm
 !  Name : Vth_lin
 !  Vers : 1
 !  Desc : Description for this Algorithm spec.
 !  Date : 01/21/2003
 !  Time : 13:07:17
 !  User : wat
 !
 !***** DON'T REMOVE THIS LINE *************************************
 !
 !  Input Variables:
 !
 !     #  Name            Type Size     Description
 !    --- --------------- ---- -------- --------------------------------
 !    Measurement Parameters:
 !      1 FLAG            R    -        CURRENT MEASURED FOR PMOS
 !      2 VBS             R    -        Body voltage
 !      3 VGSTART         R    -        START VOLTAGE FOR VTH SEARCH
 !
 !    Device Terminals:
 !      1 DRAIN           I    -        DRAIN TERMINAL
 !      2 GATE            I    -        GATE TERMINAL
 !      3 SOURCE          I    -        SOURCE TERMINAL
 !      4 BULK            I    -        BULK TERMINAL
 !
 !    Device Parameters:
 !      1 ADC             I    -        ADC TYPE (0:HI-SPEED, 1:HI-RESOL
 !      2 IV              R    -        SAMPLING NUMBER WHEN MANUAL INTE
 !      3 INTEG           I    -        INTEGRATION TIME (0:MAN. 1:S, 2:
 !      4 P               I    -        1: NMOS, -1: PMOS
 !      5 W               R    -        CHANNEL WITH
 !      6 L               R    -        CHANNEL LENGTH
 !
 !  Output Variables:
 !
 !     #  Name            Type Size     Description
 !    --- --------------- ---- -------- --------------------------------
 !    Output Parameters:
 !      1 VTHI            R    -        THESHOLD VOLTAGE FROM CONSTANT C
 !
 !***** DON'T REMOVE THIS LINE *************************************
   OPTION BASE 1  !***** DON'T REMOVE THIS LINE *****
   DISP "Vth_lin"
   INTEGER Drain,Gate,Source,Bulk,I
   REAL Vd,Vb,Ve,S1,S2,Idn,Z,Lgtid1,Lgtid2,Lgtidn,Id1,Id2,Vg1,Vg2,Id(201),Gm(201),Vg(201)
   !
   Drain=Pins(1)
   Gate=Pins(2)
   Source=Pins(3)
   Bulk=Pins(4)
   !
   Set_smu_ch(FNPort(0,1),0)
   Set_adc(0,2)
   !
   !
   IF W<0 OR L<0 THEN GOSUB Par_error
   IF P<>1 AND P<>-1 THEN GOSUB Par_error
   !
   Connect(FNPort(0,9),Drain,Gate,Source,Bulk)
   Connect(FNPort(0,1),Drain)
   Connect(FNPort(0,2),Gate)
   Connect(FNPort(0,3),Bulk)
   !
   Vd=.05*P
   Vb=Vbs*P
   Force_v(Drain,Vd,Vd,1.E-2)
   Force_v(Bulk,Vb,Vb,1.E-2)
   !
   IF Flag=0 THEN 
     Idn=1.E-7*W/L
   ELSE
     IF P=1 THEN 
       Idn=1.E-7*W/L
     ELSE
       Idn=4.E-8*W/L
     END IF
   END IF
   Lgtidn=LGT(Idn)
   !
   Yid1=1.E-10*W/L
   Yid2=1.E-8*W/L
   IF Yid1<1.E-11 THEN 
     Yid1=1.E-11
     Yid2=1.E-9
   END IF
   !
   Ve=.025
   Gmax=0
   Id1=0
   Id2=0
   Vg(1)=P*Vgstart
   Gm(1)=0
   !
   Force_v(Gate,Vg(1),20,1.E-2)
   Wait_th(.1)
   Measure_i(Drain,Id(1),1.E-10)
   Id(1)=ABS(Id(1))
   IF Id(1)>Idn THEN 
     GOSUB Meas_error
   END IF
   !
   Vg(2)=Vg(1)+P*Ve
   Gm(2)=0
   Force_v(Gate,Vg(2),20,1.E-2)
   Wait_th(.1)
   Measure_i(Drain,Id(2),1.E-10)
   Id(2)=ABS(Id(2))
   I=2
   REPEAT
     I=I+1
     Vg(I)=Vg(I)+P*(I-1)*Ve
     Force_v(Gate,Vg(I),20,1.E-2)
     Wait_th(.1)
     Measure_i(Drain,Id(I),1.E-7)
     Id(I)=ABS(Id(I))
     IF Id(I)>Yid1 THEN 
       X1=Vg(I-2)+Vg(I-1)+Vg(I)
       X2=Vg(I-2)^2+Vg(I-1)^2+Vg(I)^2
       Y1=Id(I-2)+Id(I-1)+Id(I)
       Y2=Vg(I-2)*Id(I-2)+Vg(I-1)*Id(I-1)+Vg(I)*Id(I)
       Z=3*X2-X1^2
       IF Z=0 THEN 
         Gm(I)=0
       ELSE
         Gm(I)=ABS((3*Y2-X1*Y1)/Z)
       END IF
    !
       IF Id1=0 THEN 
         IF Id(I)>=Yid2 THEN 
           Yid2=Id(I)*40
         END IF
         Vg1=ABS(Vg(I))
         Id1=LGT(Id(I))
       END IF
         !
       IF Id(I)>=Yid2 AND Id2=0 THEN 
         Vg2=ABS(Vg(I))
         Id2=LGT(Id(I))
       END IF
         !
       IF Id(I-1)<=Idn AND Id(I)>=Idn THEN 
         IF (Id(I)-Id(I-1))<>0 THEN 
           Lgtid1=LGT(Id(I-1))
           Lgtid2=LGT(Id(I))
           S1=Lgtidn-Lgtid1
           S2=Lgtid2-Lgtid1
           Vthi=Vg(I-1)+(Vg(I)-Vg(I-1))*S1/S2
         END IF
       END IF
     END IF
   UNTIL Gm(I-1)>=Gm(I-2) AND Gm(I)<Gm(I-1) AND Id(I)>=Idn OR ABS(Vg(I))>=3
   PRINT "Vthi=";Vthi
   GOSUB Disconnect
       !
 Par_error:       !
   Vthi=2.E+30
   PRINT "Vthi=";Vthi
   GOSUB Disconnect
   SUBEXIT
 Meas_error:     !
   Vthi=3.E+30
   GOSUB Disconnect
   SUBEXIT
 Disconnect:     !
   Disable_port
   Connect
   OFF ERROR 
 SUBEND
 Algo_tail:SUB Algo_tail
 SUBEND
